pkgname=uclibc
pkgver=0.9.30
pkgrel=2
pkgdesc="C library for developing embedded Linux systems"
url=http://uclibc.org
license="LGPL-2"
_mynamever=uClibc-$pkgver

subpackages="$pkgname-dev"
depends_dev="linux-headers"

source="http://uclibc.org/downloads/$_mynamever.tar.bz2
	pthreads-fno-omit-frame-pointer.patch
	uclibc-0.9.30-math.patch
	uclibcconfig
	"

_prepare() {
	local i gcc_major
	cd $srcdir/$_mynamever/
	
	# gcc-3.4.6 is buggy and need -fno-omit-framepointer for lipthreads.old
	gcc_major=$(gcc --version | head -n1 | awk '{print $3}'|cut -d . -f1)
	if [ "$gcc_major" = "3" ]; then
		msg "Applying patch for buggy gcc-3"
		patch -p1 < ../pthreads-fno-omit-frame-pointer.patch
	fi
	patch -p0 < ../uclibc-0.9.30-math.patch
}

_compile() {
	cd $srcdir/$_mynamever/
	cp ../uclibcconfig .config
	make silentoldconfig
	make || return 1
}

_install() {
	cd $srcdir/$_mynamever/
	make install DESTDIR=$pkgdir
}

build() {
	_prepare && _compile && _install
}

md5sums="e5766e2566e0297adebebbcc0aba1f2d  uClibc-0.9.30.tar.bz2
e427a6c39296d26f01ee275b2e503770  pthreads-fno-omit-frame-pointer.patch
b8234799550f8fffed430bc10d5fc47f  uclibc-0.9.30-math.patch
7e22bc978e25fcbeb1cbdc0f67d38e55  uclibcconfig"
