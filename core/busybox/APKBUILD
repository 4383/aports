# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=busybox
pkgver=1.14.1
pkgrel=2
pkgdesc="Size optimized toolbox of many common UNIX utilities"
url=http://busybox.net
license=GPL-2
depends=
install="$pkgname.post-install $pkgname.post-upgrade"
source="http://busybox.net/downloads/$pkgname-$pkgver.tar.bz2
	$pkgname-1.12.1-vi-path.patch
	$pkgname-1.11.1-bb.patch
	busybox-1.14.1-ftpd.patch
	busybox-1.14.1-httpd.patch
	busybox-1.14.1-modprobe.patch
	busybox-1.14.1-telnetd.patch
	busybox-1.14.1-ash.patch
	bb-tar-numeric-owner.patch
	$install
	busyboxconfig"

build() {
	cd "$srcdir"/$pkgname-$pkgver

	#patches
	for i in ../*.patch; do
		msg "Applying $i"
		if ! patch -p1 -i $i; then
			error "$i failed"
			return 1
		fi
	done

	# we set the install prefix with sed since it might differ depending
	# on abuild version
	sed -e "s:^CONFIG_PREFIX=.*:CONFIG_PREFIX=\"$pkgdir\":" \
		../busyboxconfig > .config

	make silentoldconfig || return 1
	make || return 1
	make install DESTDIR="$pkgdir"
	mkdir -p "$pkgdir"/usr/sbin "$pkgdir"/usr/bin "$pkgdir"/tmp
	chmod 1777 "$pkgdir"/tmp
	# we need /bin/sh to be able to execute post-install
	ln -s /bin/busybox "$pkgdir"/bin/sh
}

md5sums="d5186821d4f4cf6017452c7c8730cf19  busybox-1.14.1.tar.bz2
f5a8ae3145aa249868c1a1abc319c228  busybox-1.12.1-vi-path.patch
4c0f3b486eaa0674961b7ddcd0c60a9b  busybox-1.11.1-bb.patch
b49e33a98d7be2a52d772f3600c4aa78  busybox-1.14.1-ftpd.patch
9bdb6b91d7dd21253b3725c84e21347e  busybox-1.14.1-httpd.patch
11877bde19afe1f6e1f55d9b5c9ee900  busybox-1.14.1-modprobe.patch
9020600467cdb1a1df7df41a1ba0c6e9  busybox-1.14.1-telnetd.patch
fa809c927ac3793452fdf521c84e5803  busybox-1.14.1-ash.patch
0b5b2d7db201f90cd08f4a3164ee29a1  bb-tar-numeric-owner.patch
56b78c358797cd15fb64719a48939267  busybox.post-install
56b78c358797cd15fb64719a48939267  busybox.post-upgrade
6d9cd13b546d9c6063d36c0d3d963887  busyboxconfig"
