# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=mosquitto
pkgver=1.2.2
pkgrel=0
pkgdesc="An Open Source MQTT v3.1 Broker"
url="http://mosquitto.org/"
arch="all"
license="BSD"
depends=""
depends_dev=""
makedepends="$depends_dev openssl-dev python-dev"
install=""
subpackages="$pkgname-dev $pkgname-doc py-$pkgname:_py $pkgname-libs++:_pp
	$pkgname-libs $pkgname-utils"
source="http://mosquitto.org/files/source/mosquitto-$pkgver.tar.gz"

_builddir="$srcdir"/mosquitto-$pkgver
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	sed -i "s|prefix=/usr/local|prefix=/usr|" config.mk
	# dont strip
	sed -i "s|(INSTALL) -s|(INSTALL)|g" \
		lib/Makefile src/Makefile client/Makefile
}

build() {
	cd "$_builddir"
	make WITH_MEMORY_TRACKING=no prefix=/usr || return 1
}

package() {
	cd "$_builddir"
	make prefix=/usr DESTDIR="$pkgdir" install || return 1
	rm -f "$pkgdir"/usr/lib/*.la
}

_py() {
	pkgdesc="Python binding to mosquitto"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/python* "$subpkgdir"/usr/lib/
}

_pp() {
	pkgdesc="C++ wrapper for libmosquitto"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libmosquittopp.so.* "$subpkgdir"/usr/lib/
}

utils() {
	pkgdesc="utilities for mosquitto"
	mkdir -p "$subpkgdir"/usr
	mv "$pkgdir"/usr/bin "$subpkgdir"/usr/
}

md5sums="fcf329dc409660efb2ebbe980867d476  mosquitto-1.2.2.tar.gz"
sha256sums="45888a10fa619d9d52260df41d61edd25f99d518ce4da0c2a52e66d2d4e63d85  mosquitto-1.2.2.tar.gz"
sha512sums="50f008c98fe88c6a796c6ec52998b5339813f923abca8d610e6319c9b1d8651d2b75937a994da572031be544224618af773cd12f2da756cbfc4d3a1b74730f34  mosquitto-1.2.2.tar.gz"
