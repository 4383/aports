# Contributor: Stuart Cardall <developer@it-offshore.co.uk>
# Maintainer: Stuart Cardall <developer@it-offshore.co.uk>
pkgname=xpra
pkgver=0.16.3
pkgrel=0
pkgdesc="Xpra is 'screen for X' & allows you to run X programs, usually on a remote host over SSH or encrypted tcp."
url="http://xpra.org"
arch="all"
license="GPLv2+"
depends="py-gobject py-gtk py-imaging xf86-video-dummy xvfb setxkbmap xorg-server py-numpy py-pillow py-gtkglext py-lz4 \
	py-rencode py-opencl"
# cython only depends until cython patch applies
depends_dev="python-dev cython-dev cython libx11-dev libxtst-dev libxcomposite-dev libxdamage-dev libxrandr-dev
		py-gobject-dev py-gtk-dev libxkbfile-dev gtk+2.0-dev x264-dev x265-dev libvpx-dev ffmpeg-dev libwebp-dev"
makedepends="$depends_dev cython"
subpackages="$pkgname-dev $pkgname-doc $pkgname-tests"
source="http://xpra.org/src/$pkgname-$pkgver.tar.xz
	fix-xdummy-musl-detect.patch
	"

_builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
        cd "$_builddir" # https://www.xpra.org/trac/ticket/1080
	CFLAGS="$CFLAGS -fno-strict-aliasing"
	# dummy patch applied in http://xpra.org/trac/changeset/12475/xpra
	# sed fix applied in http://xpra.org/trac/changeset/12471/xpra
	sed -i setup.py \
                -e '/GDK_BINDINGS_PACKAGES = PYGTK_PACKAGES/s/"xfixes"/"x11", "xext", "xfixes"/' \
                -e 's/pkgconfig("xtst", "xfixes", "xcomposite", "xdamage", "xext")\
			/pkgconfig("x11", "xtst", "xfixes", "xcomposite", "xdamage", "xext")/' \
                -e 's/pkgconfig("xcomposite", "xdamage", "xext")/pkgconfig("x11", "xcomposite", "xdamage", "xext")/'
	python setup.py build \
		--with-csc_opencl \
		--with-bundle_tests \
	|| return 1
}

package() {
        cd "$_builddir"
        python setup.py install --prefix=/usr --root="$pkgdir" || return 1
}

tests() {
        cd "$_builddir"
	mkdir -p "$subpkgdir"/usr/share/xpra
	cp -rf tests "$subpkgdir"/usr/share/xpra/
}

md5sums="9f81ac22991083ee49e01f62ae113a56  xpra-0.16.3.tar.xz
b19a1fd26e94be8db372c8555152218d  fix-xdummy-musl-detect.patch"
sha256sums="1516ab10eb348092077ffb698bce234d06a234a5748e422fdf92f34922fb39ea  xpra-0.16.3.tar.xz
eb88db7301a30441b710f38028f316f90e8cd3af213468d96a5d04d5c64a69ef  fix-xdummy-musl-detect.patch"
sha512sums="1a6bbd01837e702e98ffcaffe12a2e5320108ef50f0fcc64a80735fb53a2b41e4cdda0e0a2d1a3b5f2159a81da4a7c2cac458ab4c2eed4de17adb4e963218590  xpra-0.16.3.tar.xz
0ddc4a4359cc257a77445b4bc747bdb79ae8f049078c9dcb531fc41555e8d74842cf599edbd29a2f13bd977a20922df6ab4e51839dba7d4aae865897f2b872fc  fix-xdummy-musl-detect.patch"
