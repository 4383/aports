# Contributor: Stuart Cardall <developer@it-offshore.co.uk>
# Maintainer: Stuart Cardall <developer@it-offshore.co.uk>
pkgname=xpra
pkgver=0.16.3
pkgrel=0
pkgdesc="Xpra is 'screen for X' & allows you to run X programs, usually on a remote host over SSH or encrypted tcp."
url="http://xpra.org"
arch="all"
license="GPLv2+"
depends="py-gobject py-gtk py-imaging xf86-video-dummy xvfb setxkbmap xorg-server"
depends_dev="python-dev cython-dev libx11-dev libxtst-dev libxcomposite-dev libxdamage-dev libxrandr-dev
		py-gobject-dev py-gtk-dev libxkbfile-dev gtk+2.0-dev x264-dev x265-dev libvpx-dev ffmpeg-dev libwebp-dev"
makedepends="$depends_dev cython"
subpackages="$pkgname-dev $pkgname-doc"
source="http://xpra.org/src/$pkgname-$pkgver.tar.xz"

_builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
        cd "$_builddir" # https://www.xpra.org/trac/ticket/1080
	CFLAGS="$CFLAGS -fno-strict-aliasing"
	# fixes lazy loading by xorg under musl http://xpra.org/trac/ticket/820
	sed -i setup.py \
                -e '/GDK_BINDINGS_PACKAGES = PYGTK_PACKAGES/s/"xfixes"/"x11", "xext", "xfixes"/' \
                -e 's/pkgconfig("xtst", "xfixes", "xcomposite", "xdamage", "xext")\
			/pkgconfig("x11", "xtst", "xfixes", "xcomposite", "xdamage", "xext")/' \
                -e 's/pkgconfig("xcomposite", "xdamage", "xext")/pkgconfig("x11", "xcomposite", "xdamage", "xext")/'
	python setup.py build || return 1
}

package() {
        cd "$_builddir"
        python setup.py install --prefix=/usr --root="$pkgdir" || return 1
}

md5sums="9f81ac22991083ee49e01f62ae113a56  xpra-0.16.3.tar.xz"
sha256sums="1516ab10eb348092077ffb698bce234d06a234a5748e422fdf92f34922fb39ea  xpra-0.16.3.tar.xz"
sha512sums="1a6bbd01837e702e98ffcaffe12a2e5320108ef50f0fcc64a80735fb53a2b41e4cdda0e0a2d1a3b5f2159a81da4a7c2cac458ab4c2eed4de17adb4e963218590  xpra-0.16.3.tar.xz"
