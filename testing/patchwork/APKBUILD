# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=patchwork
pkgver=0_git20150420
pkgrel=2
pkgdesc="Web-based patch tracking system "
url="http://jk.ozlabs.org/projects/patchwork/"
arch="noarch"
license="GPL"
depends="py-django1.5 py-django-registration git"
depends_dev=""
makedepends="$depends_dev"
install=""
subpackages="$pkgname-doc $pkgname-apache2-wsgi:apache2_wsgi $pkgname-mysql 4pkgname-postgresql"
source="http://dev.alpinelinux.org/archive/$pkgname/$pkgname-$pkgver.tar.gz
	0001-support-busybox-readlink.patch
	patchwork.wsgi.conf"
giturl="git://ozlabs.org/home/jk/git/patchwork"
disturl="dev.alpinelinux.org:/archive/$pkgname/"
_builddir="$srcdir"/$pkgname-$pkgver

build() {
	cd "$_builddir"
	return 0
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"/usr/share/webapps/$pkgname
	install -Dm644 COPYING \
		"$pkgdir"/usr/share/doc/$pkgname/COPYING || return 1
	rm -f COPYING
	install -Dm644 apps/settings.py \
		"$pkgdir"/etc/$pkgname/local_settings.py || return 1
	mv * "$pkgdir"/usr/share/webapps/$pkgname
	cd "$pkgdir"/usr/share/webapps/patchwork/apps
	ln -sf /etc/patchwork/local_settings.py || return 1
}

apache2_wsgi() {
	pkgdesc="$pkgname apache2 wsgi support"
	depends="apache2 apache2-mod-wsgi"
	install_if="apache2-mod-wsgi"
	install -Dm644 "$srcdir"/patchwork.wsgi.conf \
		"$subpkgdir"/etc/apache2/conf.d/patchwork.wsgi.conf || return 1
}

mysql() {
	pkgdesc="$pkgname mysql support"
	depends="py-mysqldb"
	mkdir -p "$subpkgdir"
}

postgresql() {
	pkgdesc="$pkgname postgresql support"
	depends="py-psycopg2"
	mkdir -p "$subpkgdir"
}

md5sums="d327c8ca2f219f597855afadaa520c1d  patchwork-0_git20150420.tar.gz
597e39e9742fa8352b3d34f59f8d404e  0001-support-busybox-readlink.patch
17ca0f41552a80e2a1110a181b78c41b  patchwork.wsgi.conf"
sha256sums="769f6839f4e25321ecedaf8e7561e1a5e71e2fdb942c33aefb0798f651ed0914  patchwork-0_git20150420.tar.gz
b87b6ab985e30e75d641d31cfae76420eb3dc5e90b7484f217dd92454e3495af  0001-support-busybox-readlink.patch
e7b63c9cd749f3d055ddb6d32e95e04fd34891992bb97bac86385fdbb87f252a  patchwork.wsgi.conf"
sha512sums="5e0f93afa3d9afbb97a7e44e355f0f6fae87e77ea8a7d960637984f8f33751a0acd937efc583e6ec6405ca3ff7eb86d100b8ae66e565961afac572fd72587a25  patchwork-0_git20150420.tar.gz
09fc0d88ce766bce53a0789276e6ad3e52049771e3945ae6a9e6b61cc706f5a44d398de5ae23055b2d205fd3844b84fca538617142e194c5ca149263b9afa0bb  0001-support-busybox-readlink.patch
fc63ad24751d7c7e8beabc7a84034b2086c251be3dfcda26c02aefdd5b369bcda32962f80ddf2d9fa775d625d5d33fde04e2c80485fc9aa3cae886bf363e15f1  patchwork.wsgi.conf"
