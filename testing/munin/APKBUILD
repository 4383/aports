# Contributor: Stefan Wagner <stw@bit-strickerei.de>
# Maintainer: Stefan Wagner <stw@bit-strickerei.de>
pkgname=munin
pkgver=2.0.25
pkgrel=0
pkgdesc="A distributed monitoring/graphing tool"
url="http://munin-monitoring.org/"
arch="noarch"
license="GPL"
perl_modules="perl-rrd perl-net-snmp perl-log-log4perl perl-html-template
	perl-net-ssleay perl-net-server perl-date-manip perl-io-socket-inet6
	perl-file-copy-recursive perl-fcgi perl-uri"
depends="$pkgname-node"
makedepends="perl perl-module-build"
install="$pkgname.post-install"
subpackages="$pkgname-node"
source="http://downloads.munin-monitoring.org/munin/stable/$pkgver/$pkgname-$pkgver.tar.gz
	munin-config.patch
	munin.cron.d
	munin-node.initd
	munin.logrotate
	munin-node.logrotate"

_builddir="$srcdir/$pkgname-$pkgver"
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
			*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1
		esac
	done
}

build() {
	cd "$_builddir"
	make -j1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install-master-prime || return 1
	rm -r "$pkgdir"/usr/share/man

	install -m644 -D "$srcdir"/munin.cron.d \
		"$pkgdir"/etc/munin/munin.cron.sample || return 1
	install -m644 -D "$srcdir"/munin.logrotate \
		"$pkgdir"/etc/logrotate.d/munin
}

node() {
	depends="bash rrdtool perl $perl_modules"
	install="$subpkgname.pre-install"

	mkdir -p "$subpkgdir"

	cd "$_builddir"
	make DESTDIR="$subpkgdir" install-common-prime install-node-prime install-plugins-prime || return 1
	rm -r "$subpkgdir"/usr/share/man || return 1

	install -m644 -D "$srcdir"/munin-node.logrotate \
		"$pkgdir"/etc/logrotate.d/munin-node || return 1
	install -m755 -D "$srcdir"/"$subpkgname".initd \
		"$subpkgdir"/etc/init.d/"$subpkgname"
}

md5sums="b418a667ce42665557329a7ac3bd1b93  munin-2.0.25.tar.gz
e664a92c03c2f8757006fccf67c6fc2b  munin-config.patch
b474180bc97e870be7a80d1824fe1ceb  munin.cron.d
a1bcfd3b2f696b2e56eff81fae5049d8  munin-node.initd
90ec26232e622fe3c708b519543bd937  munin.logrotate
f75f125ee68eb60347eb8d57c616eaa1  munin-node.logrotate"
sha256sums="6832bc5839d03639e4309178d9370697fc8a80a83d9b6653953f40161e949694  munin-2.0.25.tar.gz
2d505499b1afc81f23129b4d361645eda3c6e02236fddc9104b4ed245efd21c3  munin-config.patch
f388434231dfd645be85654ac35a09315feac2f923e297f2aa8c11392e2ae4dc  munin.cron.d
59269b33d23813969f7e9700cb3bb60c687fb502fcfed1ce23985e8b673d9da9  munin-node.initd
691b40eff51dafac2a5bef5a9c858f25dcb33e3633196ebfcc13353f203689d7  munin.logrotate
8d1d05ff21328f008acba361d2776651bd2cff44229f7ec570f03c525c9b6d46  munin-node.logrotate"
sha512sums="a29563cfef26b05237b3813b44b5582563f2f75477ae3c076540cfb4f3e83f89193bd05fd7eae208d9d1bae58aff75977cc2c5f4de81225f0cbb2ba2c41effa9  munin-2.0.25.tar.gz
b664a0646b98a301b007670cb38bc397d4d4eeb03873f9d74a5b29d9a5e2c4727ca55840f792f2912d0d25a568224c6bf1e8a92e77850dd8b38d93a6426e4c8e  munin-config.patch
194b742b2ff8312c4c42a8a77d1d9a80bc53ced2343248c36f4229b0b0d366e898487fb5e415f1f5ccea7210a7a86e25de5e45193dbb5d26d2d6a195f0597642  munin.cron.d
4b2a49a7bcb64eef65eee3b77ce86ca2cd8afef681922fdb830cb382f334c07356576f1151f4423f066ba8ac1c2d9a51cf9ff3d4dd4b18a5c1e2c95abcd9a940  munin-node.initd
0f4768033f63103cb41b3f3869ebe378098f85409a909afa311a49587cb6afcffe2b2199821cd41a08f41bbeba3d37121561406978960e3345fbccfd230040e6  munin.logrotate
34cdc04e83067d2fc839efaf06d96da892d76b77555a4b7b633f9a88fb86dc5f4413fe7a4f6c540e95724b23e8a4ad0ff37f521d44046bfcf18cb0428b94e6e2  munin-node.logrotate"
