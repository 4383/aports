# Contributor: William Pitcock <nenolod@dereferenced.org>
# Maintainer: William Pitcock <nenolod@dereferenced.org>
pkgname=openvswitch
pkgver=1.11.0
pkgrel=0
pkgdesc="an open virtual switch"
url="http://openvswitch.org/"
arch="all"
license="GPL"
depends=""
depends_dev="openssl-dev"
depends_monitor="py-twisted py-twisted-web2 py-qt"
makedepends="perl $depends_dev $depends_monitor"
install="openvswitch.post-install openvswitch.post-upgrade"
subpackages="$pkgname-doc $pkgname-monitor"
source="http://openvswitch.org/releases/openvswitch-$pkgver.tar.gz
	ovsdb-server.initd
	ovsdb-server.confd
	ovs-controller.initd
	ovs-controller.confd
	ovs-vswitchd.initd
	ovs-vswitchd.confd"

_builddir="$srcdir"/openvswitch-$pkgver
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		|| return 1
	make || return 1
}

monitor() {
	depends="openvswitch $depends_monitor"
	mkdir -p "$subpkgdir"/usr/share/openvswitch
	mv "$pkgdir"/usr/share/openvswitch/python "$subpkgdir"/usr/share/openvswitch/python
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	rm -f "$pkgdir"/usr/lib/*.la

	install -Dm755 "$srcdir"/ovsdb-server.initd "$pkgdir"/etc/init.d/ovsdb-server
	install -Dm755 "$srcdir"/ovs-controller.initd "$pkgdir"/etc/init.d/ovs-controller
	install -Dm755 "$srcdir"/ovs-vswitchd.initd "$pkgdir"/etc/init.d/ovs-vswitchd

	install -Dm644 "$srcdir"/ovsdb-server.confd "$pkgdir"/etc/conf.d/ovsdb-server
	install -Dm644 "$srcdir"/ovs-controller.confd "$pkgdir"/etc/conf.d/ovs-controller
	install -Dm644 "$srcdir"/ovs-vswitchd.confd "$pkgdir"/etc/conf.d/ovs-vswitchd
}

md5sums="81231a77dcd38181dbc1cb701e4fc9d0  openvswitch-1.11.0.tar.gz
8cc7f62777212fab9fc1c8c506a32e65  ovsdb-server.initd
9c2c1d774be02f2e69609bcc4f24a370  ovsdb-server.confd
4e6e5afd1dc2d3bc1043dab19cd9f61f  ovs-controller.initd
0f5ce60dda512b29d4e20cb832e062d4  ovs-controller.confd
623db751bbdc390d9e9c076c0ce9a6b2  ovs-vswitchd.initd
2d1e0111ea62779f49e14d62678294b2  ovs-vswitchd.confd"
sha256sums="007d7d3f2deabe5a3845d1045d23b6b1de174497a8e436091541221dd71833da  openvswitch-1.11.0.tar.gz
c598cf6d78e7343d1491bc303c4079e20b7687a9ff4f9fa501e62f925fd722f5  ovsdb-server.initd
15c508d134fed8cda13e2d394fc7c20b9868294a30e73a952ebffd31df129251  ovsdb-server.confd
4e83dd7990ae17752ebc45e6e1648258827fd7cbe900b68d2867860e30641b2c  ovs-controller.initd
950996914d7991550ead5fcfb5b262c60b5f53df6796c111105baa2a89a39431  ovs-controller.confd
14219de96680153d681254228ab47bfc00b0f8a2b79d7690a2d3bede7b64932b  ovs-vswitchd.initd
cc189d5ca24708ff775a4de312df3f611c65714724b8901ec6527c9e3f22e14a  ovs-vswitchd.confd"
sha512sums="9c338a9e376c845ae5f273030263dbae52fa268350d943e65987d6840d9647194f715e36517c829be32200f1064e13a585bd5b2acb9fa2a7f32199bd4be31459  openvswitch-1.11.0.tar.gz
a57ce90d58a3d9a2b2ae9dd1e1b4f9565a1bf6e205882be98b60bc02f4481cf884e18e1b40f80a99e79e6eebee0f5fca2844915a2acf90218a9d351b71e85de6  ovsdb-server.initd
a9aab68cf5188ebdff520e8ae1bc90018fab13fea5cf7c36dda42a4acdeb842de8344191f2f52213ea173a73e647fe48e7bd29ce6974c9bf3880d0f91a3713aa  ovsdb-server.confd
b8f44f0ccbbafb5183acdebefb12b5fac3e3bd40a83fa70b7be2298ce95c58bd3eca38d7168785143a62730703bdde21adb4e56d330abfe3281d9118f4146c2e  ovs-controller.initd
e8f28b01a080d4ba11db7f17e61d4352241194e723fc198cc1c7ce60717be297025b892633599be3e1dc86dec525c1be41b9f22a5c06b8a4c267555195c92dc9  ovs-controller.confd
aa37a7d6510399b90341673ea55ed0322a68d201ea722a508de1715559818abdeee4fa7983ff03487bba1ee7e54a195591f51be0b5df5fba89762fb9db2e94eb  ovs-vswitchd.initd
346aea099f51707d2b4fc9fdc8c1502582723fb4e00c4d5d1624b0378c94dfb76674fa95e2af894f36169df52109dbe441ee6a45aa744584d9e4c74d15a46c1d  ovs-vswitchd.confd"
