# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=xf86-video-virtualbox
pkgdesc="Xorg Virtual box video driver"
pkgver=4.2.12
_ver=${pkgver/_rc/_RC}
pkgrel=0
arch="all"
url='http://virtualbox.org'
license="GPL custom"
makedepends="
	dev86 iasl kbuild>=0.1.9998_pre20120806-r1 yasm zlib-dev sed
	libxinerama-dev libxrandr-dev libxmu-dev libxdmcp-dev libxau-dev
	libxext-dev libxfixes-dev libiconv-dev libx11-dev xorg-server-dev
	mesa-dev"
source="http://download.virtualbox.org/virtualbox/$_ver/VirtualBox-$_ver.tar.bz2
	uclibc-gnu_linux.patch
	futimens.patch
	uclibc-spawn.patch
	xf86-video-virtualbox-4-makeself-check.patch
	xf86-video-virtualbox-link-lazy.patch
	LocalConfig.kmk
	"

_builddir="$srcdir/VirtualBox-${_ver}"

prepare() {
	cd "$_builddir"
	local i
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	# the kmk_sed they ship and use is linked to glibc...
	sed -i -e 's:KBUILD_SED=.*:KBUILD_SED="busybox sed":' configure
	rm -r kBuild/bin tools
	cp "$srcdir"/LocalConfig.kmk .
}

build() {
	cd "$_builddir"
	cp "$srcdir/LocalConfig.kmk" .
	./configure --disable-docs \
		--nofatal \
		--disable-java \
		--disable-pulse \
		--disable-opengl \
		--disable-kmods \
		--disable-xpcom \
		--disable-sdl-ttf \
		--build-headless \
		|| return 1
	. ./env.sh
	for i in Runtime Additions/common/VBoxGuestLib \
			Additions/x11/x11stubs Additions/x11/vboxvideo; do
		cd "$_builddir"/src/VBox/$i
		kmk TOOL_YASM_AS=yasm || return 1
	done
}

package() {
	cd "$_builddir"/out/linux.*/release/bin/additions
	install -Dm755 vboxvideo_drv_112.so \
		"$pkgdir"/usr/lib/xorg/modules/drivers/vboxvideo_drv.so
}

md5sums="654e45054ae6589452508d37403dc800  VirtualBox-4.2.12.tar.bz2
072ee2114b3771e7bdbff5211f342755  uclibc-gnu_linux.patch
10f65154d3ff17d88fad5ed384e20276  futimens.patch
cbf8efac5a1bfc3ac7c97f875b03e678  uclibc-spawn.patch
44efb3c4be214daa453a317d527f1f30  xf86-video-virtualbox-4-makeself-check.patch
383ef2c2f6cc6fcbbf4eba8391e4fa89  xf86-video-virtualbox-link-lazy.patch
c9eeb26fa65a0cf2c086a724cded4932  LocalConfig.kmk"
sha256sums="eb65ecac94f63d6292a967d39cb5e28326404c10d0e8c2c50399eedb59c17ee6  VirtualBox-4.2.12.tar.bz2
1bf547f849bf325e443f74ce7fbfb3657d9b2918b4c888efac304eac929a0fae  uclibc-gnu_linux.patch
deaa739129ec23a05d5aa43ad8af3e93086ca340696fde3e5d1539e1c7347adb  futimens.patch
3f7dc48be48e22357ae5e22387bc1799365732b32e44bb931fb18a17ebc68084  uclibc-spawn.patch
31ddafbeef6d35696d76de06988412f888fd5403854952bb00ceab99f5ed4966  xf86-video-virtualbox-4-makeself-check.patch
9d614e226a35bdcc2afbf7a4d40f86ab956a20d116650a02358536fbc67256e3  xf86-video-virtualbox-link-lazy.patch
cb8fa480b7d7be939a24bf7dd860d8cb9a90a203c416c0dbc74fab1231a9a2eb  LocalConfig.kmk"
sha512sums="b345bf6fcae92c02b5943d89b3ca36522930744b0282a4c25815b76033a055388dde428adb2226eb8051e3a418f1edbf83b1a04ab340663e601757504a9fab6d  VirtualBox-4.2.12.tar.bz2
d2bba9de80c40bc258b025a8e3395a4b0b7781d70d5528993f0fff57e9fc015306b483d4da14e22aed3f188ffda8685aa51e13943f48c17ae18a2a66d15d7bbb  uclibc-gnu_linux.patch
1da850bc30399ecde501eba5403ef1add1ae108d38394b01cd7f5cdf0462b855793d564d3adc1f770983b36529d77f3f7b0269fb65152468084a0a44c38e1638  futimens.patch
626953a557c1ae81047ed04a9909fc11c588dc7c1f7cd20b9f8917624cba7e53bd1c16825e361600980a4c85f0aab9cc2561d695b232cb02783cdb16573858f9  uclibc-spawn.patch
7f60a857213b1b045247f5a041ebed60099f0f634b7d843bd85062eb4cf8504e8d5907b43df852dc49465248e2cbe3d998acefeb676113ca9a38e72da6d926a7  xf86-video-virtualbox-4-makeself-check.patch
a96edff5f399095272ecd15aaf8dc40616a76ce7cb63f333981184671f20fdffcae889decf0615aa09ea48c5b0ac69527d6c8f29a3b0e5e96d6b4a74d283a9bc  xf86-video-virtualbox-link-lazy.patch
d3e587ab4f08970065f847f48da4dc97e7b1f7a81b5efb7aa4df17f3f0927749e9672154bc97ed205907d57e6c2761ce7dd2a1a4776f3d8409d7e147cb079a43  LocalConfig.kmk"
