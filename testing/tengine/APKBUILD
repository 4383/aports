# Maintainer: Cameron Banta <cbanta@gmail.com>
# Contributor: Jeff Bilyk <jbilyk@gmail.com>
# Contributor: Bart≈Çomiej Piotrowski <nospam@bpiotrowski.pl>

pkgname=tengine
pkgver=2.0.3
pkgrel=0
pkgdesc="lightweight HTTP and reverse proxy server"
url="http://tengine.taobao.org/"
arch="all"
license="Custom"
makedepends="pcre-dev openssl-dev zlib-dev"
source="http://tengine.taobao.org/download/tengine-$pkgver.tar.gz
	ipv6.patch
	musl-crypt-fix.patch
	musl-headers.patch

	tengine.initd
	tengine.logrotate
	"

_builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--conf-path=/etc/$pkgname/$pkgname.conf \
		--pid-path=/var/run/$pkgname.pid \
		--lock-path=/var/run/$pkgname.lock \
		--error-log-path=/var/log/$pkgname/error.log \
		--http-log-path=/var/log/$pkgname/access.log \
		--http-client-body-temp-path=/tmp/$pkgname/client-body \
		--http-proxy-temp-path=/tmp/$pkgname/proxy \
		--http-fastcgi-temp-path=/tmp/$pkgname/fastcgi \
		--user=http --group=http \
		--with-ipv6  \
		--with-http_ssl_module \
		--with-http_gzip_static_module \
		--with-mail --with-mail_ssl_module \
		|| return 1 
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.logrotate "$pkgdir"/etc/logrotate.d/$pkgname

	install -m644 -D LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

md5sums="8c891d51d5a066bca0d03c184c4287a7  tengine-2.0.3.tar.gz
801a87f7f9d27f8ad85b41a78b4c4461  ipv6.patch
3aeb488921109e60d02ed64d36790aeb  musl-crypt-fix.patch
be29516153528967cbd64eb9fedeac9e  musl-headers.patch
4faf8dff6ff1490edae1688baf1b2abb  tengine.initd
8823274a834332d3db4f62bf7dd1fb7d  tengine.logrotate"
sha256sums="ed024b6040e8f03df575fe7d7a9d274159e2543cd6854d89e173935e930fdfdb  tengine-2.0.3.tar.gz
a24ef5843ae0afa538b00c37eb7da7870f9d7f146f52a9668678f7296cf71d9b  ipv6.patch
8c398640bd379c1c6a2fafcd2b3848a72902e47924e8e2490b312c141eec5d70  musl-crypt-fix.patch
9ce768e10e3adab166b8d851060962bb2ef6e579be70cb75366e6b6ab0c1a738  musl-headers.patch
34e9b1dbb9f5fe4d71f7469ded3eb98fac02f57ecfbfd04ba623099766b4709c  tengine.initd
cea0c6f8de55a4c3a3eccc57910de1c3116634082c8e5b660630fb927a29f38d  tengine.logrotate"
sha512sums="34f03452bccd050a8680e3b21ae5e07ee16c477b68733318dc9026d67aac61783a32635ad036bb91b059951fdcfcccfe56374b650e3006700c67b299853e87a5  tengine-2.0.3.tar.gz
68d64a84568ec2df0366925ab282a05ebe21a85044b6c7844a47573cfd8cc8ed119cc772358bc3fff36e2d4fdf583a730592825f5f98632993ca86d1f8438d5f  ipv6.patch
21114c775e4bdd1f7b8b9abc143284945e96ed1d8c49904ddf918abad87b16253f918ba47976cd2df32f0fdb8a7dad399d4200e879db2da6cf93a28aab236a75  musl-crypt-fix.patch
d31b02ae2158c9176bedb114820d4fdcf3ee17eaaeb31f8db8d99cef6881609edc2e4aeb5034ecdb774e720247219fa3f1ae39ca255e9803cc46398f673e06fe  musl-headers.patch
e153ff131ca5a62f01744c45e97421db0776be518a84a8d09896955a996e5a0133c03cdfa7ac6b03bad75b5cbb839f49dcccbb210843010da42445706f239a12  tengine.initd
01b77cff16f6e8bfd7fa1d4d20f625bbcddd08f0509173452d060c342c93dc315a7b0560f4734323a5d29ea294de0491f2e3f32e5337574e1a28ebc005eceea8  tengine.logrotate"
