# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer:
pkgname=caddy
pkgver=0.8.2
pkgrel=1
pkgdesc="Fast, cross-platform HTTP/2 web server with automatic HTTPS"
url="https://caddyserver.com/"
arch="all"
license="ASL 2.0"
depends="libcap"
depends_dev=""
makedepends="$depends_dev go"
install="$pkgname.pre-install"
subpackages=""
pkgusers="$pkgname"
pkggroups="$pkgname"
source="http://dev.alpinelinux.org/archive/$pkgname/$pkgname-$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	"

_disturl="dev.alpinelinux.org:/archive/$pkgname/"
_gourl="github.com/mholt/caddy"
_builddir="$srcdir"/src/$_gourl

prepare() {
        local i
        cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

snapshot() {
        abuild clean && abuild deps
        export GOPATH="$srcdir"
        msg "Checking out v${pkgver} tag"
        # go get will not checkout a specific tag
	# so we run our own git checkout branch
	git clone --quiet --branch v${pkgver} \
		https://$_gourl $_builddir || return 1
        cd $_builddir
	# fetch deps
	go get -v -d || return 1
        cd "$srcdir"
        tar zcf $pkgname-$pkgver.tar.gz src || return 1
        rsync --progress -La $pkgname-$pkgver.tar.gz \
                $_disturl || return 1
        cd $startdir && abuild undeps
}

build() {
        cd "$_builddir" || return 1
        export GOPATH="$srcdir"
	go build -v -o ecaddy || return 1
}

package() {
	cd "$_builddir"
	install -Dm755 ecaddy "$pkgdir"/usr/sbin/caddy || return 1
	install -d -o caddy -g caddy $pkgdir/var/lib/caddy \
		$pkgdir/etc/caddy $pkgdir/var/www || return 1
	install -Dm755 $srcdir/$pkgname.initd \
		$pkgdir/etc/init.d/$pkgname || return 1
	install -Dm644 $srcdir/$pkgname.confd \
		$pkgdir/etc/conf.d/$pkgname || return 1
}

md5sums="fbac857f44eb017a8ec3cc5a232ac492  caddy-0.8.2.tar.gz
be960e64588cb71a443ba67cf48ef761  caddy.initd
a01dc274da3cfbe554fae94ac805d00d  caddy.confd"
sha256sums="a298af1e38ba37d5812d4733029e7bc7d3b79557094c61f450947fcae2045e96  caddy-0.8.2.tar.gz
5bd21633fd6425f1f795b69f258e22bde3f248da7c83367f538a7cdf50a453a7  caddy.initd
fbb6f12241ee5096e58d4fd9e05c4a5e402cf413279d5765c857e7487eb2d88a  caddy.confd"
sha512sums="a59e6556b6e65d74a7da53d265a47fe052f3e6ef9be68c6d44933040a84ba75ba26e783a71b9e13eeee5e5a0904b700cb4459d6ae802603dbafe811115f3d276  caddy-0.8.2.tar.gz
26297fd26f3f2bb362da73255b122089afe4c3859e1510a789535df52c7621db7ead2ae235c43d5c0b0737b3b621bc4d31d83466b538488b36ec6b940e2b4825  caddy.initd
5b1df94190c5570da0ef4dbc0aa5dc1ede91f440e1b194f5ee949c1a1a0b4e3fd47d6bef66cbc4d73daa00569a7eb7b1813f014af4eb8f239905e8e67f3811f1  caddy.confd"
