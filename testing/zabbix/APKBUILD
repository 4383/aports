# Contributor: Jeff Bilyk <jbilyk at gmail> 
# Maintainer: Natanael Copa <natanael.copa@gmail.com>
pkgname=zabbix
pkgver=1.8.2
pkgrel=2
pkgdesc="Enterprise-class open source distributed monitoring"
url="www.zabbix.com"
license="GPL"
depends="php php-sqlite3 php-gd fping"
makedepends="sqlite-dev libiconv-dev"
install="$pkgname.pre-install"
pkgusers="zabbix"
pkggroups="zabbix"
subpackages="$pkgname-dev $pkgname-doc"
source="http://downloads.sourceforge.net/$pkgname/$pkgname-$pkgver.tar.gz
	zabbix_server.conf
	zabbix_trapper.conf
	zabbix_proxy.conf
	zabbix-dn_skipname.patch
	zabbix-getloadavg.patch
	zabbix-server.initd
	zabbix-agentd.initd
	zabbix-proxy.initd
	"

_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch)
			msg "Applying $i"
			patch -p1 -i "$srcdir"/$i || return 1
			;;
		esac
	done
}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--enable-server \
		--enable-agent \
		--enable-proxy \
		--enable-ipv6 \
		--with-sqlite3
	make || return 1
}

package() {
	local _wwwdir="$pkgdir"/usr/share/webapps/zabbix
	cd "$_builddir"
	make DESTDIR="$pkgdir" install

	mkdir -p "$pkgdir"/usr/share/webapps/zabbix

	install -d -m0750 -o zabbix -g zabbix \
		"$pkgdir"/var/run/zabbix "$pkgdir"/var/log/zabbix

	install -d "$pkgdir"/etc/zabbix 
	install -d "$pkgdir"/usr/share/zabbix/dbms/create/data
	install -d -m0755 "$_wwwdir"
	install -D -m0640 "$srcdir"/zabbix_server.conf "$pkgdir"/etc/zabbix/zabbix_server.conf
	install -D -m0640 "$srcdir"/zabbix_trapper.conf "$pkgdir"/etc/zabbix/zabbix_trapper.conf
	install -D -m0755 "$srcdir"/zabbix-$pkgver/create/data/data.sql "$pkgdir"/usr/share/zabbix/dbms/create/data/data.sql
	install -D -m0755 "$srcdir"/zabbix-$pkgver/create/data/images_mysql.sql "$pkgdir"/usr/share/zabbix/dbms/create/data/images_mysql.sql
	install -D -m0755 "$srcdir"/zabbix-$pkgver/create/schema/mysql.sql "$pkgdir"/usr/share/zabbix/dbms/create/mysql.sql
	cp -r "$srcdir"/zabbix-$pkgver/frontends/php/* "$_wwwdir"
	
	for i in server proxy agentd; do
		install -D -m0755 "$srcdir"/zabbix-$i.initd \
			"$pkgdir"/etc/init.d/zabbix-$i || return 1
	done
  
}

md5sums="fa4be4fa7ac20a33cc0aa5c27b827746  zabbix-1.8.2.tar.gz
26b0401a83bdb1dce29338e5b2786620  zabbix_server.conf
9832a81e134c8e2c11e2a06b7adbf88f  zabbix_trapper.conf
0310b92afb3f35c1075fff53db737212  zabbix_proxy.conf
d13166483792401be2d25b37b0170b82  zabbix-dn_skipname.patch
8d1d2e53479173aac0df0c38a4d6afda  zabbix-getloadavg.patch
e42394e798ab98a8ff4babe68e04633a  zabbix-server.initd
88374bba8a8fdfabfcfe9be6dd12095f  zabbix-agentd.initd
32abde1cc00c2eeccddb7e038117d0ab  zabbix-proxy.initd"
