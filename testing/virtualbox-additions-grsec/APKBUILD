# Maintainer: Natanael Copa <ncopa@alpinelinux.org>

_flavor=grsec
_kpkg=linux-$_flavor
_kver=3.8.8
_kpkgrel=0

# when chaning _ver we *must* bump _mypkgrel
_ver=4.2.8
_mypkgrel=0
_name=virtualbox-additions

# verify the kernel version before entering chroot
_kapkbuild=../../linux-${_flavor}/APKBUILD
if [ -f $_kapkbuild ]; then
	. $_kapkbuild
	pkgname=$_name-$_flavor
	[ "$_kver" != "$pkgver" ] && die "please update _kver to $pkgver"
	[ "$_kpkgrel" != "$pkgrel" ] && die "please update _kpkgrel to $pkgrel"
fi

_kpkgver="$_kver-r$_kpkgrel"
_abi_release=${_kver}-${_kpkgrel}-${_flavor}

pkgname=${_name}-${_flavor}
pkgver=$_kver
pkgrel=$(($_kpkgrel + $_mypkgrel))
pkgdesc="Virtual box addtions kernel modules for $_flavor "
arch="x86"
url='http://virtualbox.org'
license="GPL custom"
makedepends="linux-grsec-dev"
source="http://dev.gentoo.org/~polynomial-c/virtualbox/vbox-kernel-module-src-$_ver.tar.xz
	virtualbox-modules-4.1.4-pax-const.patch
	"

_builddir="$srcdir"/

prepare() {
	cd "$_builddir"
	local i
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"

	export KERN_DIR=/usr/src/linux-headers-${_abi_release}
	export GCC_SPECS=/usr/share/gcc/hardenednopie.specs
	make
}

package() {
	local module=
	cd "$_builddir"
	for module in *.ko; do
		install -D -m644 $module \
			"$pkgdir/lib/modules/${_abi_release}/misc/$module" \
			|| return 1
	done
}

md5sums="49125a6569ee1d204ad4a3f879602035  vbox-kernel-module-src-4.2.8.tar.xz
4bbbce6902722a7439f6fac4d17c6051  virtualbox-modules-4.1.4-pax-const.patch"
sha256sums="47c895d9be08282eaa6d865ed5dafc4b121247a8812ef6ad3907175c26bca911  vbox-kernel-module-src-4.2.8.tar.xz
bd7586074db6dabee3b49cb9152c85e07a316069761df8369479297c592eb240  virtualbox-modules-4.1.4-pax-const.patch"
sha512sums="3651d5f114504245ab0afb89dd3932274a3af5281aa0f3bbd547fd4fe2e4350d3e9df91bcafeb90b2ff9fe001c8cb9a401a662de47351306e1bd0df9913ec64d  vbox-kernel-module-src-4.2.8.tar.xz
9a9a982defed6d4453bc6d9388c3a71169bba85568cfd36d0d2588dda8e213a0d759c983a337a150d17c55bb6206e43738dfd2559fedeb85e132363936a48574  virtualbox-modules-4.1.4-pax-const.patch"
