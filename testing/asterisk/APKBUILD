# Contributor: Timo Teras <timo.teras@iki.fi>
# Maintainer: Timo Teras <timo.teras@iki.fi>
pkgname=asterisk
pkgver=1.6.2.0_beta1
_myver=1.6.2.0-beta1
pkgrel=4
pkgdesc="Asterisk: A Module Open Source PBX System"
url="http://www.asterisk.org/"
license="GPL"
depends="ncurses popt zlib newt dahdi-linux dahdi-tools libltdl libpri freetds"
makedepends="autoconf automake libtool ncurses-dev popt-dev newt-dev zlib-dev
	postgresql-dev unixodbc-dev dahdi-tools-dev libpri-dev g++ tar
	freetds-dev"
install="$pkgname.pre-install $pkgname.post-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-pgsql $pkgname-odbc
	$pkgname-tds"
source="http://downloads.digium.com/pub/asterisk/releases/$pkgname-$_myver.tar.gz
	asterisk-01-1.6.0-gsm-pic.patch
	asterisk-03-1.6.2.0-beta1-to-r186562.patch
	asterisk-04-1.6.0-beta7.1-caps-uclibc.patch
	asterisk-05-1.6.1-glob-uclibc.patch
	asterisk-06-overlapped-enum.patch
	asterisk-07-issue14068.patch
	200-uclibc-daemon.patch
	asterisk.pre-install
	asterisk.post-install
	asterisk.initd
	asterisk.confd"

build() {
	cd "$srcdir/$pkgname-$_myver"
	for i in ../*.patch; do
		msg "Apply $i"
		patch -p1 < $i || return 1
	done

	sed -i -e 's/PBX_ICONV=1/PBX_ICONV=0/g' configure.ac

	./bootstrap.sh
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--libdir=/usr/lib \
		--localstatedir=/var \
		--disable-xmldoc --with-gsm=internal \
		--without-iconv --with-popt --with-z --with-newt \
		--with-odbc --with-postgres --with-tds \
		--with-dahdi --with-pri --with-tonezone \
		|| return 1

	# and figure out which modules to build
	rm menuselect.makeopts
	make menuselect.makeopts
	make -j1 || return 1
	make -j1 DESTDIR="$pkgdir" install

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

_find_and_move() {
	local pattern="$1"
	cd "$pkgdir" || return 1
	find -name "$pattern" -type f | while read f; do
		local dest="$subpkgdir/${f%/*}"
		mkdir -p "$dest"
		mv "$f" "$dest"
	done
}

pgsql() {
	depends="uclibc asterisk libpq zlib"
	install=
	_find_and_move '*_pgsql*'
}

odbc() {
	depends="uclibc asterisk unixodbc"
	install=
	_find_and_move '*odbc*'
}

tds() {
	depends="uclibc asterisk freetds"
	install=
	_find_and_move '*_tds*'
}

md5sums="1a44f295fc9e72d19da7f42d095e6c60  asterisk-1.6.2.0-beta1.tar.gz
97b39fd9777a2521d4f9f095482b7ac2  asterisk-01-1.6.0-gsm-pic.patch
9f5d2412feea58ed49e2dff5cfd1fb8f  asterisk-03-1.6.2.0-beta1-to-r186562.patch
929f740db7043b4553544ebcc7315c91  asterisk-04-1.6.0-beta7.1-caps-uclibc.patch
c37928e95ebef36aad097accfdbbfcb8  asterisk-05-1.6.1-glob-uclibc.patch
1b49f980e56dc7ce493a046eadff3545  asterisk-06-overlapped-enum.patch
95bdc48553cc18c9d3807ac96956fc8a  asterisk-07-issue14068.patch
b00c9d98ce2ad445501248a197c6e436  200-uclibc-daemon.patch
b4a97cb1ec3cc3f71a10ce8c067ab430  asterisk.pre-install
62ecffc90b6714b85f377d1fac73c58b  asterisk.post-install
bbcd152417bb7c838b25cb6007db91da  asterisk.initd
ed31d7ba37bcf8b0346dcf8593c395f0  asterisk.confd"
