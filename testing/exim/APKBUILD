# Contributor: Jesse Young <jlyo@jlyo.org>
# Maintainer: Jesse Young <jlyo@jlyo.org>
pkgname=exim
pkgver=4.84
pkgrel=0
pkgdesc="A Message Transfer Agent"
url="http://www.exim.org/"
arch="all"
license="GPL2"
depends="openssl libspf2"
depends_dev="db-dev pcre-dev openssl-dev libspf2-dev"
makedepends="$depends_dev"
install=
subpackages="$pkgname-doc"
source="ftp://exim.inode.at/exim/exim4/$pkgname-$pkgver.tar.bz2
	exim.Makefile
	exim.confd
	exim.initd
	exim.logrotate
	aliases"

_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"
	# apply patches here
	cp "$srcdir/$pkgname.Makefile" Local/Makefile
	sed -e 's/^LIBS = -lnsl/LIBS =/g' \
		-e 's/^HAVE_ICONV=yes/#HAVE_ICONV=yes/' \
		-i OS/Makefile-Linux
}

build() {
	cd "$_builddir"
	# do not build parallel
	export MAKEFLAGS=-j1
	make makefile
	make || {
		cd build-Linux-*
		sh ../scripts/Configure-config.h "make"
	} && make || return 1
}

package() {
	cd "$_builddir"

	install -D -m644 ../${pkgname}.logrotate ${pkgdir}/etc/logrotate.d/${pkgname}
	install -D -m644 doc/exim.8 ${pkgdir}/usr/share/man/man8/exim.8
	mkdir -p ${pkgdir}/var/spool/exim/db ${pkgdir}/etc/mail \
		${pkgdir}/var/log/exim ${pkgdir}/usr/lib \
		${pkgdir}/var/log/exim ${pkgdir}/usr/sbin \
		${pkgdir}/var/spool/mail
	chmod 770 ${pkgdir}/var/spool/exim ${pkgdir}/var/spool/exim/db
	chmod 750 ${pkgdir}/var/log/exim ${pkgdir}/etc/mail
	chmod 03775 ${pkgdir}/var/spool/mail
	chown root:mail ${pkgdir}/var/spool/mail ${pkgdir}/etc/mail
	chown mail:mail ${pkgdir}/var/log/exim
	install -D -m644 src/configure.default ${pkgdir}/etc/mail/exim.conf
	cd build-Linux-*
	for i in exicyclog exim_checkaccess exim_dumpdb exim_lock\
		exim_tidydb exipick exiqsumm exigrep exim_dbmbuild exim\
		exim_fixdb eximstats exinext exiqgrep exiwhat; do
		install -m 0755 "$i" "$pkgdir/usr/sbin"
	done

	cd "$srcdir/exim-$pkgver/src"
	sed -e "s|/etc/aliases|/etc/mail/aliases|g" \
		-e "s|SYSTEM_ALIASES_FILE|/etc/mail/aliases|g" configure.default \
		>"$pkgdir/etc/mail/exim.conf"

	cp "$srcdir/aliases" "$pkgdir/etc/mail"
	cd "$pkgdir/usr/sbin"
	for i in mailq rmail rsmtp runq sendmail; do
		ln -s exim "$i"
	done
	# fhs compliancy
	ln -s ../sbin/exim ../lib/sendmail

	# remove the 2 lines below (and this) if there is no init.d script
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

md5sums="3d14522e604b687b9e515f5aa739b2c0  exim-4.84.tar.bz2
90e01a407bfb32c406f5265d06c26ad7  exim.Makefile
f442b68d435598831bab8536ade071b8  exim.confd
6ba3c29545484c152df7ac8656943891  exim.initd
8e8003542b9b8cd6300e46c24c302802  exim.logrotate
eaec7a2a5f49b768fa168415ef0105fb  aliases"
sha256sums="78ea22be87fb6df880e7fd482f3bec9ef6ceca0c9dedd50f8a26cae0b38b9e9c  exim-4.84.tar.bz2
0b6f24deea28bd236139dadef9632deb5255ac082bb9988dfac705d67034c92d  exim.Makefile
668f912565a59926957090c6143f669f0e9de2cf441507d3c05fcd046865b401  exim.confd
46869c47ff928c5628113e4a76ea469e8202339305b781ada0e37dcf6cd5bf76  exim.initd
49b4d81d6823057c89f7734b2d76de389d427af56164faad32ec883f8ca9e804  exim.logrotate
f2943990feb2ddfb93e8b0816ef914e7057cb5d48a093901881e970b1002ab8a  aliases"
sha512sums="3cd41af6d57e5f0377fc93367753eae6cb6bf835803e8608c44e1da5acefce1ed8886f4fe7536950de072bfed6e927afe1536c1e6466cf3121dd352b69a68039  exim-4.84.tar.bz2
e6936db8316fbbd32ea9828137eaeeb2e84053252ce1c180015b99d70a9f8ad5a4dcbad565595e19c06a48498ee2df8e86b22efb6ca2bca64af13a4395a89f23  exim.Makefile
24bae5bba1b41e59247cd7089c3f9ffcc5f4b26c3da1b21f755724a7ee5c99a05e324437c965ae86170056cc63b9bcdc41f624a747ab31b887d69cff620f2155  exim.confd
aeec8762d1dce4b09049e08d0c275ae475e639c4a3ad667c4208df36eba71c544311f5c175d7f481ea84213cf130da0a77a0e32d3ff7e933a7356deab8c4e850  exim.initd
665bfa5ced8829f8f199bbcd040c1c667193643c6d902e5412679cf138e4c8cda7ffd0eefc8ff3b76d95202ee52d0c372b7c319746ff590dd6b61b93c1a2fedf  exim.logrotate
9cc0fe81b2110aecdd3d494650d051f773c2c83611692c4e5d365b89dcddd08b16af5b8f5f4ac3e3f553c36198846a05793d8fd01113f62d2ab761f555409201  aliases"
