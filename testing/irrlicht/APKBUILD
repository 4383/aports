# Maintainer: Jeff Bilyk <jbilyk@alpinelinux.org>
pkgname=irrlicht
pkgver=1.8.1
case $pkgver in
*.*.*) _pkgmajver=${pkgver%.*};;
*.*) _pkgmajver=${pkgver};;
esac
pkgrel=0
pkgdesc="3D graphics engine"
url="http://irrlicht.sourceforge.net"
arch="all"
license="ZLIB"
depends=
depends_dev="musl-dev mesa-dev jpeg-dev bzip2 libpng-dev zlib-dev"
makedepends="$depends_dev"
install=""
subpackages="$pkgname-dev $pkgname-doc"
source="http://downloads.sourceforge.net/irrlicht/irrlicht-$pkgver.zip
	irrlicht-1.8.1-mesa-10.x.patch
	irrlicht-1.8.1-config.patch
	irrlicht-1.8.1-sysctl.patch
"

_builddir="$srcdir"/$pkgname-$pkgver/source/Irrlicht
prepare() {
       local i
       cd "$srcdir"/$pkgname-$pkgver/
       for i in $source; do
               case $i in
               *.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
               esac
       done
}

build() {
       cd "$_builddir"
       make sharedlib || return 1
       make || return 1

       #from arch pkgbuild: example build helper
       ln -s libIrrlicht.so.$pkgver "$srcdir"/$pkgname-$pkgver/lib/Linux/libIrrlicht.so

       cd ../../examples
       # Fix examples building
       sed -i '/define USE_IRRKLANG/s:.*://&:' ./Demo/CDemo.h
       make || return 1
}

package() {
       cd "$_builddir"

       mkdir -p "$pkgdir"/usr/lib
       mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
       mkdir -p "$pkgdir"/usr/share/$pkgname/examples/bin
       mkdir -p "$pkgdir"/usr/share/doc/$pkgname
       mkdir -p "$pkgdir"/usr/include/$pkgname/include

       make INSTALL_DIR="$pkgdir" install || return 1

       cd ../..
       install -m644 readme.txt "$pkgdir"/usr/share/licenses/$pkgname

       #from arch pkgbuild: install static library and fix perms
       install -m644 lib/Linux/libIrrlicht.a "$pkgdir"/usr/lib

       #from arch pkgbuild: install media file examples
       cp -r media "$pkgdir"/usr/share/$pkgname

       #from arch pkgbuild: install docs
       cp -r doc/* "$pkgdir"/usr/share/doc/$pkgname
       rm -f "$pkgdir"/usr/share/doc/$pkgname/*.txt

       cd "$pkgdir"/usr/lib
       mv ../../libIrrlicht* ./
       ln -s libIrrlicht.so.$pkgver libIrrlicht.so.1
       ln -s libIrrlicht.so.$pkgver libIrrlicht.so.$_pkgmajver

       mv "$pkgdir"/../include/* "$pkgdir"/usr/include/$pkgname/include/
       mv "$pkgdir"/usr/include/$pkgname/include/irrlicht/* "$pkgdir"/usr/include/$pkgname/include/
       rm -rf "$pkgdir"/../include/

       install -m755 "$srcdir"/$pkgname-$pkgver/bin/Linux/* "$pkgdir"/usr/share/$pkgname/examples/bin/
}

md5sums="f4f7fa33bd1060eb0dd51dcd66b0f6e3  irrlicht-1.8.1.zip
6c35d64a6ca262bca59b93203f1fb802  irrlicht-1.8.1-mesa-10.x.patch
f7a8e6a075f0e2c9fd585f23afd5bc86  irrlicht-1.8.1-config.patch
a84ec80127fdb4bd672413576395db77  irrlicht-1.8.1-sysctl.patch"
sha256sums="814bb90116d5429449ba1d169e2cbff881c473b7eada4c2447132bc4f4a6e97b  irrlicht-1.8.1.zip
42798617c00c6026da70735714dde5088991b6e0bf43509f3ad42714862e40ba  irrlicht-1.8.1-mesa-10.x.patch
1aeec60ed987e789e36b71a2761ceaf7b59b9f9a9c35e287cbd72f3d18777c87  irrlicht-1.8.1-config.patch
c1f887abe9e2e40f3a502cad10f1000d34065df473db1dcf3caa6860761361b5  irrlicht-1.8.1-sysctl.patch"
sha512sums="93390c162e5a8edb231588d47dc421c24d21a34e833df1f3b92c85a9e8ef4a96a61d854e05eedb37f88f7f02821059e78a40a52cbc8e39356c4d36b17775dfbb  irrlicht-1.8.1.zip
bb767ffd288efc2e7b88ad92d9844ab71064ab114c4b83234da3de07968a286e60e3e63db8050d4bff7c55a02bdecd1a858061b06dd8c4699431a9450c503504  irrlicht-1.8.1-mesa-10.x.patch
d8b5995924808a78f242bd6cbad7a2d81673f3d7fed24f620805c006506ff677cdc7790552568788f84ec518df569b3d1d1d96291fd3bc7eef9f3ebbdc94a8c2  irrlicht-1.8.1-config.patch
3f1dac1f5cbee54d3c6f3f0c4b694611104dff6d57ec5b118d3d2f3f8946029ac040793dd3965d880ecb08c9fcdfe56e22bb68948712b95e7b9a9b2b0cfad950  irrlicht-1.8.1-sysctl.patch"
