# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=yadifa
pkgver=2.0.0
_buildnr=4192
pkgrel=0
pkgdesc="Lightweight authoritative Name Server with DNSSEC capabilities"
url="http://www.yadifa.eu"
arch="all"
license="BSD-3"
depends="openssl"
depends_dev="openssl-dev"
makedepends="$depends_dev"
install="$pkgname.pre-install $pkgname.post-install"
options="libtool"
pkgusers="yadifa"
pkggroups="yadifa"
subpackages="$pkgname-dev $pkgname-doc"
source="http://cdn.yadifa.eu/sites/default/files/releases/$pkgname-$pkgver-$_buildnr.tgz
	poll-h.patch
	$pkgname.initd
	$pkgname.confd"

_builddir="$srcdir"/$pkgname-$pkgver-$_buildnr
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	sed -i -e "s/__linux__/__GLIBC__/g" lib/dnscore/src/tcp_io_stream.c
	sed -i -e "s/__linux__/__GLIBC__/g" lib/dnscore/src/debug.c
	sed -i -e "s/__linux__/__GLIBC__/g" lib/dnscore/src/format.c
	sed -i -e "s/__linux__/__GLIBC__/g" sbin/yadifad/signals.c
}

build() {
	cd "$_builddir"
	automake
	./configure --prefix=/usr \
		--build=$CBUILD \
		--host=$CHOST \
		--sysconfdir=/etc/$pkgname \
		--localstatedir=/var \
		--enable-dynamic-provisioning \
		--enable-rrl

	make
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install
	install -D -m 0755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m 0755 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -D -m 0755 etc/*.example "$pkgdir"/etc/$pkgname
	cp etc/yadifad.conf "$pkgdir"/etc/$pkgname
	mkdir -p  "$pkgdir"/var/$pkgname
	mkdir -p  "$pkgdir"/var/log/$pkgname
	chown $pkgusers:$pkggroups "$pkgdir"/var/$pkgname
	chown $pkgusers:$pkggroups "$pkgdir"/var/log/$pkgname
	rm -f "$pkgdir"/usr/lib/*.la
}

md5sums="8bb0cd24c3bea7ea7f503ca523b8a13b  yadifa-2.0.0-4192.tgz
bb9b9e01e8781949381bc1d6e24076ea  poll-h.patch
a368b39c128dfea18d16b61df8b0f069  yadifa.initd
054dc6c7d4e5c8d81610825c0875efd2  yadifa.confd"
sha256sums="ef98afcfa544474c6634a3177af402fc37453dd3244c084bc9e4b323997ef61c  yadifa-2.0.0-4192.tgz
250910b256cf0193ffa74fdae3a22d6cfc6834bd6f751ad9dcf331c43d5a6c0a  poll-h.patch
0e3a165692bd4ff2ea1104a3565c0cbd8ec8896b10e3aa6d6acd7c6a7b357ac1  yadifa.initd
c1a1b5535858ce569197196f94c5a2f13ed2f003d68be06475c765ff82e74c22  yadifa.confd"
sha512sums="a476ab13d25763bd5c53e140243eb6b1524c31ea6b6361196fd68d08d07683b009d9b76c579149815a9d7e887edc6e1edef90436330b37cad301ab3249728aba  yadifa-2.0.0-4192.tgz
a72c0a296de2a0a8ab4b6836cbf364be0c2b2854d1f7c2a151d015902b55b0766c61466a18f4e904e82e40776ba88b8ce0b61f218799ad9d8d779f63aa9610d6  poll-h.patch
905e3f9efc07864c6aa4ca09c41f253b87094d06cc98942f3cab2c3fd34de2795d8f358359a194e8f2913201387c5d8e6f1ceebf2f4ef98b043868c002e65ec3  yadifa.initd
10c8e6e9cfcf8671de541fc2a8f56ea6756d8da1e96262efc26daa4be22aec5f51037d6cbbfa90b826521145f0b41dcc9e515e343ef1ff72a9bf213dc2f90f58  yadifa.confd"
