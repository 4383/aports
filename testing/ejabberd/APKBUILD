# Contributor: Leonardo Arena <rnarld@alpinelinux.org>
# Maintainer: Francesco Colista <francesco.colista@gmail.com>
pkgname=ejabberd
pkgver=2.1.12
pkgrel=1
pkgdesc="An erlang jabber server"
url="http://www.ejabberd.im"
arch="all"
license="GPL"
depends="erlang util-linux"
depends_dev="erlang-dev expat-dev libiconv-dev openssl-dev zlib-dev heimdal-dev"
makedepends="$depends_dev"
pkgusers="ejabberd"
pkggroups="ejabberd"
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc"
source="http://www.process-one.net/downloads/$pkgname/$pkgver/$pkgname-$pkgver.tgz
	gssapi-2.1.0.diff"
_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p2 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"/src
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info
	make || return 1
}

package() {
	cd "$_builddir"/src
	make DESTDIR="$pkgdir" install

	install -d ${pkgdir}/var/spool/$pkgname
	install -d ${pkgdir}/var/lib/$pkgname
	install -D -m0644 ../../../$pkgname.logrotate ${pkgdir}/etc/logrotate.d/$pkgname
	install -m755 -D ../../../$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D ../../../$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	chown -R ejabberd.ejabberd "$pkgdir"/var/log/ejabberd
	chown -R ejabberd.ejabberd "$pkgdir"/var/spool/ejabberd
	chown -R ejabberd.ejabberd "$pkgdir"/var/lib/ejabberd
	chgrp ejabberd "$pkgdir"/etc/ejabberd/ejabberd.cfg "$pkgdir"/etc/ejabberd/ejabberdctl.cfg "$pkgdir"/etc/ejabberd
}

md5sums="7d49242cf04282f3c4cebfafa2cc2f46  ejabberd-2.1.12.tgz
e68959e95b5bf8974d1eee03bd3397a7  gssapi-2.1.0.diff"
sha256sums="38f0825346773c00c85a66b33586c75f2d191d1eb0ed8ae09fa17368d6ddfd19  ejabberd-2.1.12.tgz
3cb3d3a8dcd7a5369a36c674fd26f3b60d976a76fc55ca3da329db851d3ff48d  gssapi-2.1.0.diff"
sha512sums="725ab9563a6c73e85b5115f66bac157cf9b1170913c1bfed7cf066408c6b3ac5b4bdba22c6c3ed1505391a7048a86ce3b59484f78264ab023612c539422278db  ejabberd-2.1.12.tgz
031f8ff688c947988ac6de56757f35b7d5d9dead3d5c8ed1b6fffada7b358616ce56ad92cfe65e004fd665908277c0609c5223cdcb0e366dd2965d19d25b944f  gssapi-2.1.0.diff"
