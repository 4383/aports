# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Maintainer:
pkgname=milter-greylist
pkgver=4.5.16
pkgrel=0
pkgdesc="Stand-alone milter written in C that implements the greylist filtering method"
url="http://hcpnet.free.fr/milter-greylist"
arch="all"
license="GPL"
depends=
depends_dev=
makedepends="$depends_dev bison flex libmilter-dev libspf2-dev opendkim-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-doc"
pkgusers="smmsp"
pkggroups="smmsp"
source="ftp://ftp.espci.fr/pub/milter-greylist/$pkgname-$pkgver.tgz
	milter-greylist-conf.patch
	milter-greylist-no-sockaddr-length.patch
	"

builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$builddir"
        for i in $source; do
                case $i in
                *.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
	#autoreconf -vif
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var/lib \
		--with-libspf2 \
		--with-libopendkim=/usr \
		--with-user=smmsp \
		--with-conffile=/etc/$pkgname/greylist.conf \
		--with-dumpfile=/var/lib/$pkgname/greylist.db \
		--with-thread-safe-resolver \
		--enable-postfix \
		--enable-spamassassin \
		--enable-dnsrbl \
		--disable-rpath
	make -j1 || return 1
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -m755 -D ../../$pkgname.initd "$pkgdir"/etc/init.d/$pkgname || return 1
	install -m644 -D greylist2.conf "$pkgdir"/etc/$pkgname/greylist2.conf
	mkdir -p "$pkgdir"/var/lib/$pkgname
	chown -R smmsp:smmsp "$pkgdir"/var/lib/$pkgname
}

md5sums="dead8ceb27b0b471025bedabd742ce14  milter-greylist-4.5.16.tgz
bbecf43a626a81f3383e7b9d21042290  milter-greylist-conf.patch
811a2d1328cef175c6f71ed82e29e17f  milter-greylist-no-sockaddr-length.patch"
sha256sums="a820616fc6052a74c646bf55b1f44c5931fc87758df8cdbd5b61af6032cc6eb1  milter-greylist-4.5.16.tgz
c0abf2a935f58f7aa8e2f49c272a9fd7c99b6464c2ff00706d1c475b5917db1a  milter-greylist-conf.patch
09c979e88f09f5014b382ec9c4a3dd0a7c5a918fd04210a20a13334b35f9c69a  milter-greylist-no-sockaddr-length.patch"
sha512sums="0627ac09f74fd9fde7d990afd055f12e9f82c1e1edfc38aaa03b56328c6eeaf091c3e80258d75929fa114a33ee5a418baf0c8ad9f6c76be77aeba1942f0d6cbc  milter-greylist-4.5.16.tgz
e48bab52eb6fe8a8123ddc56753fb0fa5243bd07272cf2440269cd348f96f6f6a33163e49d9b009a5ff6181a212f9d5d25354d7ddd787603bcde84eda29e4d9c  milter-greylist-conf.patch
0dbd7c02630dbf2ae36a7a55db7c10cc1b10b36fb390c51d33be4478c751c747cbb710323429fe9834a2ae2710ea02a104cc1f87ac37d23e83771bc5b6303522  milter-greylist-no-sockaddr-length.patch"
