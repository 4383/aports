# Contributor: Francesco Colista <francesco.colista@gmail.com>
# Maintainer: Francesco Colista <francesco.colista@gmail.com>
pkgname=tvheadend-git
_date=20121122
pkgver=$_date
pkgrel=0
pkgdesc="TV Streaming server for linux"
url="http://www.lonelycoder.com/hts/tvheadend_overview.html"
arch="all"
license="GPL3"
depends=""
depends_dev="openssl-dev bash findutils"
makedepends="$depends_dev python"
pkgusers="$pkgname"
pkggroups="$pkgname"
install="$pkgname.pre-install"
subpackages="$pkgname-doc"
source="http://dev.alpinelinux.org/archive/$pkgname/$pkgname-$_date.tar.gz
	$pkgname.initd
	$pkgname.confd"
_giturl="git://github.com/tvheadend/tvheadend.git"
_upload=dev.alpinelinux.org:/archive/$pkgname/
_builddir="$srcdir/$pkgname-$_date"

snapshot() {
	_date=$(date +%Y%m%d)
	local _pkg=$pkgname-$_date.tar.gz
	mkdir -p "$srcdir"
	cd "$srcdir"
	rm -rf "$pkgname"
	git clone --depth=1 --bare $_giturl || return 1
	git --git-dir ${_giturl##*/} archive -o $_pkg \
		--prefix=$pkgname-$_date/ HEAD \
		|| return 1
	msg "New snapshot: $_pkg"
	msg "Uploading to $_upload"
	#scp -r $_pkg $_upload/$_pkg || return 1
	rsync -ave ssh $_pkg $_upload || return 1
	cd ..
	sed -i -e "s/^_date=.*/_date=$_date/" \
		APKBUILD || return 1
	_dir=${PWD%/APKBUILD}
	_dir=${_dir%/*}
	abuild checksum && abuild -r && git add APKBUILD \
		&& git commit -m"${_dir##*/}/$pkgname: snapshot $_date"
}

prepare() {
        local i
        cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

build() {
        cd "$_builddir"
        ./configure --prefix=/usr \
                --sysconfdir=/etc \
                --mandir=/usr/share/man \
                --infodir=/usr/share/info \
                --localstatedir=/var \
		--release \
                --disable-avahi \
                || return 1
        make || return 1
}

package() {
        cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	install -m755 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1
	install -d -o $pkgname -g $pkgname \
		"$pkgdir/etc/$pkgname" || return 1
}

md5sums="9048b0d2a5dda4436bce2ec76c9d859d  tvheadend-git-20121122.tar.gz
8b7da39441150596bdeb2456f7cf73ed  tvheadend-git.initd
17cf7dfaf27706409a004c246c1a2c3c  tvheadend-git.confd"
