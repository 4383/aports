# Contributor: Francesco Colista <francesco.colista@gmail.com>
# Maintainer: Francesco Colista <francesco.colista@gmail.com>
pkgname=tvheadend-git
pkgver=20121204
pkgrel=0
pkgdesc="TV Streaming server for linux"
url="http://www.lonelycoder.com/hts/tvheadend_overview.html"
arch="all"
license="GPL3"
depends=""
depends_dev="openssl-dev libdvbcsa-dev"
makedepends="$depends_dev python findutils bash"
pkgusers="$pkgname"
pkggroups="$pkgname"
install="$pkgname.pre-install"
subpackages="$pkgname-doc"
source="http://dev.alpinelinux.org/archive/$pkgname/$pkgname-$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd"
_giturl="git://github.com/tvheadend/tvheadend.git"
_upload="dev.alpinelinux.org:/archive/$pkgname/"
_builddir="$srcdir/$pkgname-$pkgver"

snapshot() {
        local _date=$(date +%Y%m%d)
        local _pkg=$pkgname-$_date.tar.gz
        mkdir -p "$srcdir"
        cd "$srcdir"
        msg "Creating snapshot: $_pkg"
        rm -rf ${_giturl##*/}
        git clone --depth=1 --bare $_giturl || return 1
        git --git-dir ${_giturl##*/} archive -o $_pkg \
                --prefix=$pkgname-$_date/ HEAD \
                || return 1
        msg "Uploading to $_upload"
        rsync -Lave ssh $_pkg $_upload || return 1
        cd "$startdir"
        sed -i -e "s/^pkgver=.*/pkgver=$_date/" \
                APKBUILD || return 1
        abuild checksum
}

prepare() {
        local i
        cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

build() {
        cd "$_builddir"
        ./configure --prefix=/usr \
                --sysconfdir=/etc \
                --mandir=/usr/share/man \
                --infodir=/usr/share/info \
                --localstatedir=/var \
		--release \
                --disable-avahi \
		--enable-dvbcsa \
                || return 1
        make || return 1
}

package() {
        cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	install -m755 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1
	install -d -o $pkgname -g $pkgname \
		"$pkgdir/etc/$pkgname" || return 1
}

md5sums="abfa68adafb04964263a928934cee2f1  tvheadend-git-20121204.tar.gz
8b7da39441150596bdeb2456f7cf73ed  tvheadend-git.initd
17cf7dfaf27706409a004c246c1a2c3c  tvheadend-git.confd"
