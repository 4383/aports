# Contributor: Olivier Mauras <olivier@mauras.ch>
# Maintainer:
pkgname=consul
pkgver=0.5.2
pkgrel=0
pkgdesc="A tool for service discovery, monitoring and configuration"
url="https://www.consul.io/"
arch="all"
license="MPL 2.0"
depends=""
depends_dev=""
makedepends="go godep perl bash mercurial $depends_dev"
install="$pkgname.pre-install $pkgname.pre-deinstall $pkgname.post-deinstall"
pkgusers="consul"
pkggroups="consul"
subpackages=""
options="!strip"
source="http://dev.alpinelinux.org/archive/$pkgname/$pkgname-$pkgver.tar.gz
	consul.initd
	consul.confd
	acl.json.sample
	encrypt.json.sample
	server.json
	tls.json.sample"

_disturl="dev.alpinelinux.org:/archive/$pkgname/"
_gourl="github.com/hashicorp/consul"
_builddir="$srcdir"/src/github.com/hashicorp

snapshot() {
	abuild clean
	abuild deps
	abuild fetch
	export GOPATH="$srcdir"
	mkdir -p $_builddir
	cd $_builddir
	msg "Checking out v${pkgver} tag"
	git clone -q --branch v${pkgver} https://$_gourl || return 1
	cd $pkgname
	# use custom godeps file
	install -D "${_builddir}"/$pkgname/deps/v${pkgver//./-}.json \
		$_builddir/$pkgname/Godeps/Godeps.json || return 1
	go get -v -d || return 1
	godep restore
	cd "$srcdir"
	tar zcf $pkgname-$pkgver.tar.gz src || return 1
	rsync --progress -La $pkgname-$pkgver.tar.gz \
		$_disturl || return 1
	cd $startdir && abuild undeps
}

prepare() {
	cd "$srcdir"/${pkgname}-${pkgver}
	local i
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"/$pkgname || return 1
	export GOPATH="$srcdir"
	go build -v -o bin/consul \
		-ldflags "-X main.GitDescribe $pkgver" || return 1
}

package() {
	cd "$_builddir"
	# Consul init script
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	# Consul init conf
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1
	# Main binary
	install -m750 -o root -g consul \
		-D ${pkgname}/bin/${pkgname} \
		"$pkgdir"/usr/sbin/${pkgname} || return 1
	# Consul datadir
	install -m750 -o consul -g consul -d "$pkgdir"/var/${pkgname} || return 1
	# Consul configdir
	install -m750 -o root -g consul -d "$pkgdir"/etc/${pkgname} || return 1
	# Consul sample config files
	for cf in acl.json.sample encrypt.json.sample server.json tls.json.sample; do
		install -m640 -o root -g consul "$srcdir"/$cf "$pkgdir"/etc/${pkgname} || return 1
	done
}
