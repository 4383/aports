# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
_flavor=${FLAVOR:-grsec}
_kpkg=linux-$_flavor
_realname=flashcache
_name=$_realname-$_flavor

_kver=3.10.14
_kpkgrel=1

_realver=2.1
_mypkgrel=0

# source the kernel version
if [ -f ../linux-$_flavor/APKBUILD ]; then
	. ../linux-$_flavor/APKBUILD
	[ "$_kver" != "$pkgver" ] && die "$_name: Please update _kver to $pkgver"
	[ "$_kpkgrel" != "$pkgrel" ] && die "$_name: Please update _kpkgrel to $pkgrel"
fi

_kernelver=$_kver-r$_kpkgrel
_abi_release=${_kver}-${_kpkgrel}-${_flavor}

pkgname=$_name
pkgver=$_kver
pkgrel=$(($_kpkgrel + $_mypkgrel))
pkgdesc="a general purpose writeback block cache for Linux"
url="https://github.com/facebook/flashcache/"
arch="all"
license="GPL"
depends="linux-${_flavor}=${_kernelver}"
makedepends="linux-${_flavor}-dev=${_kernelver}"
install=
install_if="linux-$_flavor=$_kernelver $_realname"
subpackages=
source="$_realname-$_realver.tar.gz::https://github.com/facebook/flashcache/archive/$_realver.tar.gz
	depmod.patch"

# override kernel's prepare()
prepare() {
	cd "$srcdir/$_realname-$_realver"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$srcdir/$_realname-$_realver"/src
	export GCC_SPECS=hardenednopie.specs
	make CC="${CC:-gcc}" KERNEL_SOURCE_VERSION=$_abi_release modules \
		|| return 1
}

package() {
	cd "$srcdir/$_realname-$_realver"/src

	make DESTDIR="$pkgdir" CC="${CC:-gcc}" \
		KERNEL_SOURCE_VERSION=$_abi_release \
		DEPMOD=: modules_install || return 1
}

md5sums="b05b48124e4a542122a9e7874c54fafe  flashcache-2.1.tar.gz
ef9bd511f2b964bf22863814679bfba3  depmod.patch"
sha256sums="e8d251411fd703383d46e10a80a0ad8b8b52cdf1b172e58001779085c25fb798  flashcache-2.1.tar.gz
05c0fefaaaea624c12b9ff3e66e0029b8dcc0c0d3246e10683bf217e10b3c450  depmod.patch"
sha512sums="b65f2f0a2170b312ca5e7720d2206574f25d2f6bac3ae3531ba171b0e979a1f42045dad24ee8c8eb8c9d884982d0e6708b3d9dd5cba1fa40247d2adb5c8d89a0  flashcache-2.1.tar.gz
55543347d76171352199294a29bcf19ba6b511f57e63c2a4254c4ebad8829912c65cdbef95bc7485d079dd66c56c1624b9570e7faf038cc5cb80e81079fcadc6  depmod.patch"
