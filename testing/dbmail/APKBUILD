# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer:
pkgname=dbmail
pkgver=3.0.0_rc2
_realpkgver=3.0.0-rc2
pkgrel=0
pkgdesc="Fast and scalable sql based mail services"
url="http://dbmail.org"
arch="all"
license="GPL"
depends=
depends_dev="sqlite-dev mysql-dev postgresql-dev openldap-dev
	libsieve-dev glib-dev gmime-dev mhash-dev libevent-dev
	libzdb-dev"
makedepends="$depends_dev asciidoc xmlto"
install=""
subpackages="$pkgname-dev $pkgname-doc"
source="http://www.dbmail.org/download/3.0/dbmail-3.0.0-rc2.tar.gz
	code-cleanups.patch"

_builddir="$srcdir/${pkgname}_${_realpkgver}"

prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
        ./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/inf \
		--with-mysql \
		--with-pgsql \
		--with-sqlite \
		--with-sieve \
		--with-ldap
	make || return 1
	#make man pages
	cd "$_builddir/man"
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -Dm644 dbmail.conf $pkgdir/etc/dbmail.conf.sample
	mkdir -p "$pkgdir/usr/share/dbmail"
	mv sql/* "$pkgdir/usr/share/dbmail/"
	mv dbmail.schema "$pkgdir/usr/share/dbmail/"
	#install man pages
	cd "$_builddir/man"
	make DESTDIR="$pkgdir" install || return 1
}

md5sums="c4fda2da173ddeda25bcf9e2e57abd1e  dbmail-3.0.0-rc2.tar.gz
b482ba661bb4b1b6fe50e303f37b2336  code-cleanups.patch"
