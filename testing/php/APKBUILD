# Contributor: Carlo Landmeter <clandmeter at gmail>
# Maintainer: Carlo Landmeter <clandmeter at gmail>
pkgname=php
pkgver=5.2.8
pkgrel=0
pkgdesc="The PHP language runtime engine"
url="http://www.php.net/"
license="PHP-3"
depends="uclibc pcre"
makedepends="pcre-dev libxml2-dev libiconv-dev openssl-dev zlib-dev bzip2-dev
curl-dev libpng-dev libjpeg-dev freetype-dev libmcrypt-dev mysql-dev sqlite-dev
libtool libltdl"
subpackages="$pkgname-doc $pkgname-dev $pkgname-bcmath $pkgname-bz2
$pkgname-calendar $pkgname-curl $pkgname-exif
$pkgname-ftp $pkgname-gd $pkgname-iconv $pkgname-json $pkgname-mcrypt 
$pkgname-mime_magic $pkgname-mysql $pkgname-mysqli
$pkgname-openssl $pkgname-pdo $pkgname-pdo_mysql $pkgname-pdo_sqlite
$pkgname-posix $pkgname-session $pkgname-shmop 
$pkgname-soap $pkgname-sockets $pkgname-sqlite $pkgname-sysvmsg $pkgname-sysvsem
$pkgname-sysvshm $pkgname-xmlrpc $pkgname-zip $pkgname-zlib"
source="http://www.php.net/distributions/${pkgname}-${pkgver}.tar.bz2"

build() {
        cd "$srcdir/$pkgname-$pkgver"

        ./configure \
        --prefix=/usr --sysconfdir=/etc/php --with-layout=GNU \
        --with-config-file-path=/etc/php \
	--with-config-file-scan-dir=/etc/php/conf.d \
        --enable-inline-optimization --disable-debug --disable-rpath \
        --disable-static --enable-shared --mandir=/usr/share/man \
        --with-openssl=shared --with-zlib=shared --enable-bcmath=shared \
        --with-bz2=shared --enable-calendar=shared --with-curl=shared \
        --enable-exif=shared --enable-ftp=shared --with-gd=shared \
        --with-jpeg-dir=shared,/usr --with-png-dir=shared,/usr \
	--enable-gd-native-ttf --enable-mbstring=shared --with-mcrypt=shared \
	--with-mysql=shared --with-mysql-sock=/tmp/mysql.sock \
	--with-mysql=shared --with-mysqli=shared --with-pear=/usr/share/pear \
        --enable-pdo=shared --with-pdo-mysql=shared \
	--with-pdo-sqlite=shared,/usr --enable-fastcgi \
        --with-sqlite=shared --enable-sqlite-utf8 --enable-shmop=shared \
        --enable-soap=shared --enable-sysvmsg=shared --enable-sysvsem=shared \
        --enable-sysvshm=shared --enable-zip=shared --enable-posix=shared \
        --enable-sockets=shared --enable-xml --with-ttf=shared \
        --enable-session=shared --with-regex=php --with-pcre-regex=/usr \
        --enable-mbstring=all --enable-mbregex --enable-json=shared \
        --with-iconv=shared --with-xmlrpc=shared --enable-cgi \
	--with-freetype-dir=shared,/usr --with-mime-magic=shared \
        --enable-discard-path --enable-force-cgi-redirect --disable-cli

        make || return 1
        make -j1 INSTALL_ROOT="$pkgdir" install || return 1
        install -D -m644 php.ini-recommended "$pkgdir"/etc/php/php.ini
}

_mv_mod() {
	local d=usr/lib/php/20060613
	mkdir -p "$subpkgdir/$d"
	mv "$pkgdir/$d/${1}.so" "$subpkgdir/$d/" || return 1
	# last one removed the dir
	rmdir "$pkgdir/$d" 2>/dev/null
	return 0
}
	
	
bcmath() {
	depends="uclibc $pkgname"
	_mv_mod bcmath
}

bz2() {
	depends="uclibc $pkgname"
	_mv_mod bz2
}

calendar() {
	depends="uclibc $pkgname"
	_mv_mod calendar
}

curl() {
	depends="uclibc $pkgname curl"
	_mv_mod curl
}

exif() {
	depends="uclibc $pkgname"
	_mv_mod exif
}

ftp() {
	depends="uclibc $pkgname openssl"
	_mv_mod ftp
}

gd() {
	depends="uclibc $pkgname freetype libpng libjpeg zlib"
	_mv_mod gd
}

iconv() {
	depends="uclibc $pkgname libiconv"
	_mv_mod iconv
}

json() {
	depends="uclibc $pkgname"
	_mv_mod json
}

mcrypt() {
	depends="uclibc $pkgname libmcrypt"
	_mv_mod mcrypt
}

mime_magic() {
	depends="uclibc $pkgname"
	_mv_mod mime_magic
}


mysql() {
	depends="uclibc $pkgname libmysqlclient"
	_mv_mod mysql
}

mysqli() {
	depends="uclibc $pkgname libmysqlclient zlib openssl"
	_mv_mod mysqli
}

openssl() {
	depends="uclibc $pkgname openssl"
	_mv_mod openssl
}

pdo() {
	depends="uclibc $pkgname"
	_mv_mod pdo
}

pdo_mysql() {
	depends="uclibc $pkgname libmysqlclient zlib openssl"
	_mv_mod pdo_mysql
}

pdo_sqlite() {
	depends="uclibc $pkgname sqlite"
	_mv_mod pdo_sqlite
}

posix() {
	depends="uclibc $pkgname"
	_mv_mod posix
}

session() {
	depends="uclibc $pkgname"
	_mv_mod session
}

shmop() {
	depends="uclibc $pkgname"
	_mv_mod shmop
}

soap() {
	depends="uclibc $pkgname libxml2 zlib"
	_mv_mod soap
}

sockets() {
	depends="uclibc $pkgname"
	_mv_mod sockets
}

sqlite() {
	depends="uclibc $pkgname"
	_mv_mod sqlite
}

sysvmsg() {
	depends="uclibc $pkgname"
	_mv_mod sysvmsg
}

sysvsem() {
	depends="uclibc $pkgname"
	_mv_mod sysvsem
}

sysvshm() {
	depends="uclibc $pkgname"
	_mv_mod sysvshm
}

xmlrpc() {
	depends="uclibc $pkgname libiconv libxml2 zlib"
	_mv_mod xmlrpc
}

zip() {
	depends="uclibc $pkgname zlib"
	_mv_mod zip
}

zlib() {
	depends="uclibc $pkgname zlib"
	_mv_mod zlib
}

# devleoper package
dev() {
	default_dev
	mkdir -p "$subpkgdir"/usr/lib/php/
	mv "$pkgdir"/usr/lib/php/build "$subpkgdir"/usr/lib/php/
}

md5sums="8760a833cf10433d3e72271ab0d0eccf  php-5.2.8.tar.bz2"
