# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=qt5-qtbase
pkgver=5.2.1
pkgrel=0
pkgdesc="Qt5 - QtBase components"
url="http://qt-project.org/"
arch="all"
license="LGPLv2 with exceptions or GPLv3 with exceptions"
depends=""
depends_dev="mesa-dev libice-dev libsm-dev libx11-dev libxext-dev
	openssl-dev fontconfig-dev freetype-dev glib-dev libpng-dev zlib-dev
	sqlite-dev dbus-dev"
makedepends="$depends_dev
	bison
	cups-dev
	flex
	freetds-dev
	gawk
	gperf
	gtk+2.0-dev
	hicolor-icon-theme
	icu-dev
	libjpeg-turbo-dev
	libxkbcommon-dev
	libxi-dev
	libxrandr-dev
	libxrender-dev
	libxslt-dev
	libxv-dev
	mysql-dev
	pcre-dev
	postgresql-dev
	udev-dev
	unixodbc-dev
	xcb-util-dev
	xcb-util-image-dev
	xcb-util-keysyms-dev
	xcb-util-wm-dev
	"
install=""
subpackages="$pkgname-dev $pkgname-doc
	$pkgname-sqlite $pkgname-odbc $pkgname-postgresql $pkgname-mysql
	$pkgname-tds $pkgname-x11"
source="http://download.qt-project.org/official_releases/qt/${pkgver%.*}/$pkgver/submodules/qtbase-opensource-src-$pkgver.tar.xz
	qt-musl-iconv-no-bom.patch
	qt-musl-socklen.patch
	qt-uclibc-lib-names.patch
	"

_builddir="$srcdir"/qtbase-opensource-src-$pkgver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch)
			msg "Applying $i"
			patch -p1 -i "$srcdir"/$i || return 1
			;;
		esac
	done
	sed -i -e "s|-O2|$CXXFLAGS|" \
		-e "/^QMAKE_RPATH/s| -Wl,-rpath,||g" \
		-e "/^QMAKE_LFLAGS\s/s|+=|+= $LDFLAGS|g" \
		mkspecs/common/*.conf || return 1
}

build() {
	cd "$_builddir"
	./configure -confirm-license -opensource \
		-archdatadir /usr/lib/qt5 \
		-datadir /usr/share/qt5 \
		-dbus-linked \
		-docdir /usr/share/doc/qt5 \
		-examplesdir /usr/share/doc/qt5/examples \
		-glib \
		-gtkstyle \
		-icu \
		-importdir /usr/lib/qt5/imports \
		-largefile \
		-no-openvg \
		-no-rpath \
		-no-separate-debug-info \
		-no-javascript-jit \
		-nomake examples \
		-opengl \
		-openssl-linked \
		-optimized-qmake \
		-plugin-sql-mysql \
		-plugin-sql-odbc \
		-plugin-sql-psql \
		-plugin-sql-sqlite \
		-plugin-sql-tds \
		-plugindir /usr/lib/qt5/plugins \
		-prefix /usr \
		-reduce-relocations \
		-silent \
		-sysconfdir /etc \
		-system-libjpeg \
		-system-libpng \
		-system-pcre \
		-system-sqlite \
		-system-xcb \
		-system-zlib \
		-translationdir /usr/share/qt5/translations \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make INSTALL_ROOT="$pkgdir" install || return 1
	rm -f "$pkgdir"/usr/lib/*.la
}

_mv_files() {
	local i
	for i; do
		mkdir -p "$subpkgdir"/${i%/*}
		mv "$pkgdir"/$i "$subpkgdir"/$i || return 1
	done
}

dev() {
	cd "$pkgdir"
	_mv_files usr/lib/qt5/mkspecs \
		usr/lib/cmake \
		usr/bin \
		$(find usr/ -name '*.prl') \
		|| return 1
	default_dev
}

sqlite() {
	pkgdesc="SQLite driver for Qt5's SQL classes"
	cd "$pkgdir"
	_mv_files usr/lib/qt5/plugins/sqldrivers/libqsqlite*
}

odbc() {
	pkgdesc="ODBC driver for Qt5's SQL classes"
	cd "$pkgdir"
	_mv_files usr/lib/qt5/plugins/sqldrivers/libqsqlodbc*
}

postgresql() {
	pkgdesc="PostgreSQL driver for Qt5's SQL classes"
	cd "$pkgdir"
	_mv_files usr/lib/qt5/plugins/sqldrivers/libqsqlpsql*
}

mysql() {
	pkgdesc="MySQL driver for Qt5's SQL classes"
	cd "$pkgdir"
	_mv_files usr/lib/qt5/plugins/sqldrivers/libqsqlmysql*
}

tds() {
	pkgdesc="TDS driver for Qt5's SQL classes"
	cd "$pkgdir"
	_mv_files usr/lib/qt5/plugins/sqldrivers/libqsqltds*
}

x11() {
	pkgdesc="Qt5 GUI-related libraries"
	depends="hicolor-icon-theme"
	cd "$pkgdir"
	_mv_files \
		usr/lib/libQt5Gui.so.* \
		usr/lib/libQt5Widgets.so.* \
		usr/lib/libQt5OpenGL.so.* \
		usr/lib/libQt5PrintSupport.so.* \
		usr/lib/qt5/plugins/accessible \
		usr/lib/qt5/plugins/generic \
		usr/lib/qt5/plugins/image* \
		usr/lib/qt5/plugins/platform* \
		usr/lib/qt5/plugins/printsupport* \
		|| return 1

	scanelf -Rn usr/ | egrep '(libX|libQt5Gui|libGL)' && return 1
	return 0
}

md5sums="fa005301a2000b92b61b63edc042567b  qtbase-opensource-src-5.2.1.tar.xz
077e31e0cb0d25637a3b3638fffbef3c  qt-musl-iconv-no-bom.patch
bc83dc99f866423b4803453a0e2949d2  qt-musl-socklen.patch
9d26980d72160bed9b5d7da6f6f7d3d4  qt-uclibc-lib-names.patch"
sha256sums="acdfd1aa2548ebea1d922e8e24e5c59f5fc3b2beae7c8003ba47d773bfcc94c0  qtbase-opensource-src-5.2.1.tar.xz
40b337c16bbb1d259f315fe5a1b110f9917223aee53b82809934efa4fa5e62a3  qt-musl-iconv-no-bom.patch
e70bdddf67c358c02099bebee460e3c5456666562bff9ef9ebaacf9f4ea7a6df  qt-musl-socklen.patch
8562bd3307009c1e06f0ca1bfc9dc380f6ce93459f81d70815ffa0aa1543de0c  qt-uclibc-lib-names.patch"
sha512sums="72ef00e9828bf19b2a3daca1c0fa6b0f458c4847da79d4066c818526b8dac504fa4c54496b5d6c67dbea4e786bd811ee8f87614146e684a117d9b86df580e07d  qtbase-opensource-src-5.2.1.tar.xz
a185ea5e984d2636e3f9f6c4ed8fad66a17575da0679724da60a3dc519468ab45aa9369f43ce5c64f07cb730910e36623164aefafca3aabe0359c62becca870e  qt-musl-iconv-no-bom.patch
fb621e9e5a60bb5bd4ad86fa41772fd8db7e8ad3a6e8d36a3d720d493d462db618e4bf3187e3eb66d123fceca64bbbd2df2afba506cc4c79bafa456cd67e82aa  qt-musl-socklen.patch
7297d17f365335ac21292ad44a96e5653cb9072e69c7fe402128531a5c48c0b7581cc630670b2f375dfa0f8f60e2f0048b68869ad5c8f9943d4617e0158ac4b9  qt-uclibc-lib-names.patch"
