# Maintainer: Eivind Uggedal <eivind@uggedal.com>
pkgname=nimrod
pkgver=0.9.4
pkgrel=1
pkgdesc="Statically typed, imperative programming language"
url="http://nimrod-lang.org"
arch="all"
license="MIT"
depends="readline"
depends_dev=""
makedepends="zlib-dev"
install=""
subpackages="$pkgname-doc"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/Araq/Nimrod/archive/v$pkgver.tar.gz
	$pkgname-csources-$pkgver.tar.gz::https://github.com/nimrod-code/csources/archive/v$pkgver.tar.gz
	no-posix-spawn-usevfork.patch
	no-fmtmsg.patch
	prefix-install.patch
	"

_builddir="$srcdir/Nimrod-$pkgver"
_csources="$srcdir/csources-$pkgver"
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	find $_csources -name \*_posix.c | xargs sed -i '/fmtmsg.h/d'
	sed -i '$i#define POSIX_SPAWN_USEVFORK 0' $_csources/c_code/nimbase.h
}

build() {
	cd "$_builddir"

	( cd $_csources && sh build.sh ) || return 1
	mv $_csources/bin/nimrod bin/nimrod || return 1

	./bin/nimrod c koch || return 1
	./koch boot -d:release -d:useGnuReadline
}

package() {
	cd "$_builddir"

	./koch install "$pkgdir"
}

md5sums="3093b7c52ccbc1f1da30b016c17f3daa  nimrod-0.9.4.tar.gz
55c98a8ad0a0d3bf99b39ba6f51311fb  nimrod-csources-0.9.4.tar.gz
db4b13d5b1ba80187792255e9655f2b4  no-posix-spawn-usevfork.patch
4cee2a023d1af4dbf62c19863855ee10  no-fmtmsg.patch
dc7532c75b502e4416f0d4a5ff45462d  prefix-install.patch"
sha256sums="5439aed82272ce8247929c34f806306f2f6d747805cb3754c39e688533ecea28  nimrod-0.9.4.tar.gz
e0b1a2d36e05dfea29948a76bdb052de183dd9bd99a8fecf0fce9ddad00476c4  nimrod-csources-0.9.4.tar.gz
2b2b6912be7950825eedf860d9461b84d19fdcf0ed2dc84ca138c5053cf5520e  no-posix-spawn-usevfork.patch
51ac658f3ceff0526680b0325d77d3da87728f28eebb412c8de5b1235e408112  no-fmtmsg.patch
b9cc03e794765b5fefc4733e3b1b5c3e9df3324f4656a3fef3215180a609bde4  prefix-install.patch"
sha512sums="2834fbb1452da6b31a8f86e9af5c12bec877f47d5f01626975c1b849b350021c838bcd86132307c1159c7e285172e85b7d670fb5b4ce6fdc5d0e8f2499d6e4e6  nimrod-0.9.4.tar.gz
6b9da8df83069ac778ba94ce14ab4b72e66ae7b5afe077f40ed71923b5af2c5121490d70cf6a3a7975f1249f4e0db748d3cd86aead71afde96a4619fadc3aea4  nimrod-csources-0.9.4.tar.gz
0a10e77fc224b791455929310bb2746c760b90daaec00a8fb6f0f65ec65b53a37b4297f669370c7f6155218f5ba686138e52e2d408518a55eae8afa0db5eab8c  no-posix-spawn-usevfork.patch
47b1d98a1f6a962fd6aa9a3d5d978ca5cd60462bcafb97dc449238c5fab665957bfa64819b7402f707f0497f64d0f1e223f8f6402fe9448c6193b1ab26873118  no-fmtmsg.patch
d3f478218edb38d664d3e035b4595f4a4e2b384bf085aac891f9438ee133039f26e4ef5f00ee54e48a583c35b265b97b3ebc759cefdab1ec79eb92e364441aa6  prefix-install.patch"
