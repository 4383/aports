# Maintainer: William Pitcock <nenolod@dereferenced.org>
pkgname=mozjs-38
pkgver=38.8.0
pkgrel=1
pkgdesc="standalone mozilla javascript engine"
url="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Releases/38"
arch="all"
license="LGPL"
depends=""
depends_dev="icu-dev nspr-dev libffi-dev readline-dev"
makedepends="$depends_dev python2 perl"
install=""
subpackages="$pkgname-dev"
source="https://ftp.mozilla.org/pub/firefox/releases/${pkgver}esr/source/firefox-${pkgver}esr.source.tar.bz2
	fix-fortify-system-wrappers.patch"
builddir="$srcdir/mozilla-esr38"
_builddir="$builddir/js/src"
options="!check"

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--with-system-icu \
		--with-system-nspr \
		--enable-system-ffi \
		--with-system-zlib \
		--with-intl-api \
		--enable-ctypes \
		--enable-threadsafe \
		--enable-shared-js \
		--enable-gcgenerational \
		--disable-optimize \
		--enable-pie
	make
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install
	rm -f "$pkgdir"/usr/lib/*.ajs
	mv "$pkgdir"/usr/lib/pkgconfig/js.pc "$pkgdir"/usr/lib/pkgconfig/mozjs-38.pc
}

sha512sums="fcd2497a60176b8403a1793d1ad0a1c96a0a60217c2d4d7acd0506abf6810892bd51fd113d8f952f92b20032efc539a6b1233d8d124c2eb72d726b0935c04d65  firefox-38.8.0esr.source.tar.bz2
a4f613ba4e977796fa024824940bbc1d3df549138612bfcdbb643753d54d4d5bfbf601a12f76312a87ecc7ec595ff34ddefb47c2cd1a6e31252c1fa3a263bdae  fix-fortify-system-wrappers.patch"
