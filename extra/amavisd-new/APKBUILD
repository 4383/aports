# Contributor: Leonardo Arena <rnalrd@gmail.com>
# Maintainer: Leonardo Arena <rnalrd@gmail.com>
pkgname=amavisd-new
pkgver=2.6.3
pkgrel=0
pkgdesc="High-performance interface between mailer (MTA) and content checkers"
url="http://www.ijs.si/software/amavisd"
license="GPL-2"
depends="uclibc sed file perl perl-archive-zip perl-convert-tnef
perl-convert-uulib perl-mime-tools perl-mail-tools perl-net-server
perl-io-stringy perl-unix-syslog perl-db perl-mail-dkim"
makedepends=""
install="$pkgname.post-install"
subpackages=""
source="http://www.ijs.si/software/amavisd/$pkgname-$pkgver.tar.gz
$pkgname.post-install"

build() {
	cd "$srcdir/$pkgname-$pkgver"

	HOME=/var/amavis
	QUARANTINE=$HOME/quarantine
	USER=amavis
	GROUP=amavis
	DIRS="$HOME $HOME/tmp $HOME/var $HOME/db $HOME/home $QUARANTINE"
	CONFIG=/etc/amavisd.conf

	for dir in $DIRS
	do
		if [ ! -d "${pkgdir}$dir" ]; then
			mkdir -p ${pkgdir}$dir
		fi
		chown -R amavis.amavis $HOME
	done

	install -m 755 -o root -D amavisd $pkgdir/usr/sbin/amavisd
	install -m 755 -o root -D amavisd-nanny $pkgdir/usr/bin/amavisd-nanny
	install -m 755 -o root -D amavisd-release $pkgdir/usr/bin/amavisd-release
	sed -e "s:^.*\$MYHOME = .*$:\$MYHOME = '$HOME';:" \
	 -e 's:^.*\$TEMPBASE = .*$:\$TEMPBASE = "\$MYHOME/tmp";:' \
	 -e 's:^.*\$db_home  = .*$:\$db_home = "$MYHOME/db";:' \
	 -e "s:^.*\$QUARANTINEDIR = .*$:\$QUARANTINEDIR = '$QUARANTINE';:" \
	 -e "s:^.*\$daemon_user  = 'vscan';\(.*\)$:\$daemon_user  = 'amavis';\1:" \
	 -e "s:^.*\$daemon_group = 'vscan';\(.*\)$:\$daemon_group  = 'amavis';\1:" < amavisd.conf > amavisd.conf.alpine
	install -m 640 -o root -g amavis -D amavisd.conf.alpine ${pkgdir}${CONFIG}
	install -m 755 -D ../../amavisd.init $pkgdir/etc/init.d/amavisd
}

md5sums="02b0bd38b40258841c60479603dc6842  amavisd-new-2.6.3.tar.gz
4b5cb0c750ab11d9d211a4e389545d6d  amavisd-new.post-install"
