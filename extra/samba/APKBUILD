# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=samba
pkgver=3.2.10
pkgrel=0
pkgdesc="Tools to access a server's filespace and printers via SMB"
url="http://www.samba.org"
license="GPL3"
subpackages="$pkgname-dev $pkgname-doc winbind $pkgname-common 
	$pkgname-initscript tdb"
depends="db popt ncurses uclibc samba-initscript samba-common tdb"
makedepends="db-dev popt-dev ncurses-dev"
source="http://us1.$pkgname.org/$pkgname/ftp/stable/$pkgname-$pkgver.tar.gz
	samba.initd
	samba.confd
	"

build() { 
	cd "$srcdir"/$pkgname-$pkgver/source
	./configure --prefix=/usr \
		--sysconfdir=/etc/samba \
		--with-configdir=/etc/samba \
		--localstatedir=/var \
		--with-fhs \
		--with-lockdir=/var/cache/samba \
		--with-piddir=/var/run/samba \
		--with-logfilebase=/var/log/samba \
		--with-libdir=/usr/lib/samba \
		--without-pam \
		--without-ads \
		--with-libsmbclient \
		--disable-nss-wrapper \
		--disable-dnssd \
		--disable-swat
	make proto || return 1
	make everything || return 1
	make DESTDIR="$pkgdir" install

	install -d "$pkgdir"/var/log/samba \
		"$pkgdir"/usr/share/doc/samba
	cd "$srcdir"/$pkgname-$pkgver
	cp -r examples "$pkgdir"/usr/share/doc/samba/
	install -D packaging/RHEL/setup/smbusers "$pkgdir"/etc/samba/smbusers

	# move the shared libs to /usr/lib
	mv "$pkgdir"/usr/lib/samba/lib*.so* "$pkgdir"/usr/lib/
}

initscript() {
	pkgdesc="Init script for Samba"
	depends=""
	install -Dm755 $srcdir/samba.initd "$subpkgdir"/etc/init.d/samba 
	install -Dm644 $srcdir/samba.confd "$subpkgdir"/etc/conf.d/samba 
}

_mv_files() {
	local i
	for i in "$@"; do
		mkdir -p "$subpkgdir"/${i%/*}
		mv "$pkgdir"/$i "$subpkgdir"/$i || return 1
	done
}

winbind() {
	pkgdesc="Samba user and group resolver"
	depends="uclibc samba-common popt samba-initscript"
	cd "$pkgdir"
	_mv_files \
		usr/bin/wbinfo \
		usr/bin/ntlm_auth \
		usr/sbin/winbindd \
		usr/lib/samba/idmap \
		usr/lib/libwbclient* 
}

common() {
	pkgdesc="Samba common files for both client an servers"
	depends="uclibc popt tdb"
	cd "$pkgdir"
	_mv_files \
		usr/bin/net \
		usr/bin/nmblookup \
		usr/bin/smbpasswd \
		usr/bin/testparm \
		usr/lib/samba/*.dat \
		usr/lib/libtalloc* \
		var/run/samba \
		var/cache/samba \
		var/log/samba
}

tdb() {
	pkgdesc="Trivial database"
	depends="uclibc"
	cd "$pkgdir"
	_mv_files \
		usr/lib/libtdb* \
		usr/bin/tdb*
}

md5sums="7a83207fb05200e9c2114d995f11396e  samba-3.2.10.tar.gz
587c1c4824ef5b0ac593fcf8ec8fec78  samba.initd
c150433426e18261e6e3eed3930e1a76  samba.confd"
