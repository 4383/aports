# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Contributor: Dennis Przytarski <dennis@przytarski.com>
# Contributor: Francesco Zanini <francesco@zanini.me>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=knot
pkgver=2.3.0
pkgrel=0
pkgdesc="An high-performance authoritative-only DNS server"
url="https://www.knot-dns.cz"
arch="all"
license="GPL3"
depends=""
depends_dev="gnutls-dev libedit-dev jansson-dev libcap-ng-dev 
	libidn-dev openssl-dev userspace-rcu-dev zlib-dev"
makedepends="$depends_dev m4 bison flex perl libtool"
install="$pkgname.pre-install $pkgname.post-install"
pkgusers="knot"
pkggroups="knot"
subpackages="$pkgname-dev $pkgname-doc"
source="https://secure.nic.cz/files/knot-dns/${pkgname}-${pkgver}.tar.xz
	knotd.confd
	knotd.initd
	"
builddir="$srcdir/$pkgname-$pkgver"

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--libexecdir=/usr/lib/knot \
		--with-rundir=/var/run/knot \
		--with-storage=/var/lib/knot \
		--disable-silent-rules \
		|| return 1
	make || return 1
	make check || return 1
}

package() {
	cd "$builddir"

	make DESTDIR="$pkgdir" install || return 1

	chown $pkgusers:$pkggroups "$pkgdir"/var/lib/$pkgname || return 1
	chmod 750 "$pkgdir"/var/lib/$pkgname || return 1
	chown $pkgusers:$pkggroups "$pkgdir"/var/run/$pkgname || return 1
	chmod 750 "$pkgdir"/var/run/$pkgname || return 1

	install -Dm 644 "$srcdir"/knotd.confd \
		"$pkgdir"/etc/conf.d/knotd || return 1
	install -Dm 755 "$srcdir"/knotd.initd \
		"$pkgdir"/etc/init.d/knotd || return 1
}

md5sums="7ca754f972fb07faa4f30e50d8a4385b  knot-2.3.0.tar.xz
66f3111080662280d95bc928d6ca92d5  knotd.confd
e243f6266fa6c84ea664678630896fa1  knotd.initd"
sha256sums="8abf9a6562ecf2f7f4222d16ca6c75463399870db360eda7caa40530b469533c  knot-2.3.0.tar.xz
ff384d428c9e67139ed21b0c78eabf6a26d96f31775f6143ce0c4f9c4f6beaf3  knotd.confd
bb2b3815c180086cfd566250c4ba529efe9650dfec3297ddf923dffa2b15d56c  knotd.initd"
sha512sums="28f0f6a00af3feb95ebd9af0c324ffeff1093f8e74136ce81f5a6e7f4434f22b9e371715b4b116de9b8faf39776be4d943c2ae09fb786e6061cc0394a767e8b6  knot-2.3.0.tar.xz
471d3c639a8235ba09491c99d36c0a4f1074d6055ccfd3807be02a30d3ed5bbe69a84f0414ea7810db6bbc1e38f5837108e5744fc59f949ed78a262a7de4597e  knotd.confd
c7ca9ec5dcbf9cf99a3805c7ca040fb43f65945a9ec689d2ee8ead1314f17ecb51147ca2c496ca9289c48a78b71dd2e3d8066c855c42ba8c2fe6d425518f2203  knotd.initd"
