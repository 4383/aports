# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=mesa
pkgver=7.5
pkgrel=1
pkgdesc="Mesa DRI OpenGL library"
url="http://www.mesa3d.org"
license="LGPL"
depends=
subpackages="$pkgname-dev 
	$pkgname-dri-ati:ati $pkgname-dri-ffb:ffb $pkgname-dri-intel:intel
	$pkgname-dri-trident:trident $pkgname-dri-mach64:mach64
	$pkgname-dri-mga:mga $pkgname-dri-r128:r128 $pkgname-dri-s3v:s3v
	$pkgname-dri-savage:savage $pkgname-dri-sis:sis
	$pkgname-dri-tdfx:tdfx $pkgname-dri-unichrome:unichrome
	"

makedepends="pkgconfig libdrm-dev libxxf86vm-dev libxdamage-dev expat-dev
	dri2proto xextproto libx11-dev glproto"
source="http://downloads.sourceforge.net/mesa3d/MesaLib-$pkgver.tar.bz2
	mesa-7.1-link-shared.patch
	intel-revert-vbl.patch
	mesa-7.4-parallel.patch"

depends_dev="libdrm-dev dri2proto libx11-dev libxext-dev libxxf86vm-dev
	libxdamage-dev libxfixes-dev libxcb-dev"

_dri_driverdir=/usr/lib/xorg/modules/dri

build () 
{ 
	cd "$srcdir"/Mesa-$pkgver
	for i in ../*.patch; do
		msg "Applying $i..."
		patch -p1 -i $i || return 1
	done
	${CC:-gcc} -dumpspecs | sed 's/%(link_now)//g' > "$srcdir"/gcc-specs
	export GCC_SPECS="$srcdir"/gcc-specs

#		--with-dri-drivers=swrast \
	./configure --prefix=/usr \
		--with-dri-driverdir=$_dri_driverdir \
		--disable-asm \
		--disable-glx-tls \
		--with-driver=dri \
		--enable-xcb \
		--enable-glu \
		--disable-glut \
		--disable-glw || return 1
	make || return 1
	make -j1 DESTDIR="$pkgdir" install || return 1
	install -m755 -d "$pkgdir"/usr/lib/xorg/modules/extensions
	ln -sf libglx.xorg "$pkgdir"/usr/lib/xorg/modules/extensions/libglx.so || return 1
}


_mv_dri() {
	pkgdesc="Mesa DRI driver for $@"
	install -d "$subpkgdir"/$_dri_driverdir
	
	while [ $# -gt 0 ]; do
		mv "$pkgdir"/$_dri_driverdir/${1}.so \
			"$subpkgdir"/$_dri_driverdir/ || return 1
		shift
	done
}

ati() {		_mv_dri radeon_dri r200_dri r300_dri; }
ffb() {		_mv_dri ffb_dri; }
intel() {	_mv_dri i810_dri i915_dri i965_dri EGL_i915; }
mach64() {	_mv_dri mach64_dri; }
mga() {		_mv_dri mga_dri; }
r128() {	_mv_dri r128_dri; }
s3v() {		_mv_dri s3v_dri; }
savage() {	_mv_dri savage_dri; }
sis() {		_mv_dri sis_dri; }
tdfx() {	_mv_dri tdfx_dri; }
trident() {	_mv_dri trident_dri; }
unichrome() {	_mv_dri unichrome_dri; }

md5sums="459f332551f6ebb86f384d21dd15e1f0  MesaLib-7.5.tar.bz2
9eddc02e23ec08295822911e726ae89a  mesa-7.1-link-shared.patch
a111f4dc82e894f8801bc3fa129af7af  intel-revert-vbl.patch
75e1bb69f384e9d60544fa03c15cc0ec  mesa-7.4-parallel.patch"
