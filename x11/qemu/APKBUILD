# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=qemu
pkgver=0.10.6
pkgrel=0
pkgdesc="QEMU is a generic machine emulator and virtualizer"
url="http://www.nongnu.org/qemu/"
license="GPL-2 LGPL-2"
makedepends="zlib-dev sdl-dev alsa-lib-dev gnutls-dev"
depends=
install="qemu.pre-install"
source="http://savannah.nongnu.org/download/$pkgname/$pkgname-$pkgver.tar.gz
	qemu-0.10.3-nopl-fix.patch"

build()
{
	cd "$srcdir"/$pkgname-$pkgver
	# avoid fdt till an updated release appears
	sed -i -e 's:fdt="yes":fdt="no":' configure
	# prevent docs to get automatically installed
	sed -i '/$(DESTDIR)$(docdir)/d' Makefile
	# Alter target makefiles to accept CFLAGS
	sed -i 's/^\(C\|OP_C\|HELPER_C\)FLAGS=/\1FLAGS+=/' \
		Makefile Makefile.target tests/Makefile
	sed -i 's/^VL_LDFLAGS=$/VL_LDFLAGS=-Wl,-z,execheap/' \
		Makefile.target
	patch -p0 -i ../qemu-0.10.3-nopl-fix.patch || return 1
	export CFLAGS="$CFLAGS -fno-pie -fno-stack-protector"

	./configure --prefix=/usr \
		--audio-drv-list=oss,alsa,sdl \
		--audio-card-list=ac97,sb16,es1370,adlib \
		--disable-darwin-user \
		--disable-bsd-user \
		--disable-kqemu \
		--cc="$CC"

	make || return 1
	make DESTDIR="$pkgdir" install || return 1
}

md5sums="e28f4b2d6faef178da44c03224feecb6  qemu-0.10.6.tar.gz
aef31109b7cde6e31b9dac37c3f8a033  qemu-0.10.3-nopl-fix.patch"
