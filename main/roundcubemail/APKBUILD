# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=roundcubemail
pkgver=0.5.2
pkgrel=1
pkgdesc="A PHP web-based mail client"
url="http://www.roundcube.net"
arch="noarch"
license="GPL"
install="$pkgname.post-upgrade"
depends="php php-imap php-xml php-json"
makedepends=""
subpackages="$pkgname-installer"
source="http://downloads.sourceforge.net/sourceforge/$pkgname/$pkgname-$pkgver.tar.gz"

_src="$srcdir"/roundcubemail-$pkgver

prepare() {
	cd "$_src"

	# fix permissions
	find . -type f -print | xargs chmod a-x
	# remove .htaccess
	find . -name \.htaccess -print | xargs rm -f

	# fixup paths to use the right paths
	sed -i -e 's|temp/|/tmp/|' \
		-e 's|config/|/etc/roundcube/|' \
		-e 's|logs/|/var/log/roundcube/|' \
		config/main.inc.php.dist || return 1

	sed -i -e 's|logs/|/var/log/roundcube/|' \
		-e 's|config/|/etc/roundcube/|' \
		program/include/main.inc || return 1

	# cleanup 
	sed -i 's/\r//' SQL/mssql.initial.sql
	rm -rf logs temp
}

build() {
	return 0
}

package() {
	_instdir="$pkgdir"/usr/share/webapps/roundcube
	mkdir -p "${_instdir}"
	cd "${_instdir}"
	cp -rp "$srcdir"/roundcubemail-$pkgver/* .
	# install config in /etc/roundcube so config files are not overwritten
	# on upgrades
	mkdir -p "$pkgdir"/etc/
	mv config "$pkgdir"/etc/roundcube

	install -d "$pkgdir"/var/log/roundcube
}

installer() {
	pkgdesc="Roundcubemail installer script"
	mkdir -p "$subpkgdir"/usr/share/webapps/roundcube
	mv "$pkgdir"/usr/share/webapps/roundcube/installer \
		"$subpkgdir"/usr/share/webapps/roundcube
}

md5sums="7451ee4b3fdc89300e37c6fa9cd0f7b7  roundcubemail-0.5.2.tar.gz"
