# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=iproute2
pkgver=2.6.35
_realver=$pkgver
pkgrel=3
pkgdesc="IP Routing Utilities"
url="http://www.linux-foundation.org/en/Net:Iproute2"
license="GPL2"
depends=
install="$pkgname.post-install $pkgname.post-deinstall"
makedepends="bison flex bash"
subpackages="$pkgname-doc"
source="http://devresources.linux-foundation.org/dev/iproute2/download/$pkgname-$_realver.tar.bz2
	0001-iproute2-Fix-filtering-related-to-flushing-IP-addres.patch
	0002-iproute2-dont-filter-cached-routes-on-iproute_get.patch
	0003-Snapshot-for-2.6.35.1.patch
	1-2-iproute2-treat-gre-key-as-number-1.patch
	2-2-iproute2-support-xfrm-upper-protocol-gre-key-1.patch
	"

prepare() {
	cd "$srcdir"/$pkgname-$_realver

	for i in ../*.patch; do
		msg "Applying $i..."
		patch -p1 -i $i || return 1
	done

	sed -i '/^TARGETS=/s: arpd : :' misc/Makefile
	sed -i 's:/usr/local:/usr:' tc/m_ipt.c include/iptables.h || return 1
	sed -i 's:=/share:=/usr/share:' Makefile || return 1
}

build() {
	cd "$srcdir"/$pkgname-$_realver
	./configure || return 1
	make CCOPTS="-D_GNU_SOURCE $CFLAGS" LIBDIR=/lib || return 1
}

package() {
	cd "$srcdir"/$pkgname-$_realver
	make -j1 DESTDIR="$pkgdir" install
}

md5sums="b0f281b3124bf04669e18f5fe16d4934  iproute2-2.6.35.tar.bz2
50992f46dd2a75ececdc5e54309e6b25  0001-iproute2-Fix-filtering-related-to-flushing-IP-addres.patch
dbe155ebdb22fb2b30635c0bd2431c5b  0002-iproute2-dont-filter-cached-routes-on-iproute_get.patch
084c0ee27a955d448705bbe51b70dc11  0003-Snapshot-for-2.6.35.1.patch
a9ea5a0c50d8dbeafaff802318fcfac9  1-2-iproute2-treat-gre-key-as-number-1.patch
ae6a91f9633a810f37854b8a2f5e19df  2-2-iproute2-support-xfrm-upper-protocol-gre-key-1.patch"
