# Contributor: Sergei Lukin <sergej.lukin@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=vim
pkgver=7.4.712
_srcver=${pkgver%.*}
_patchver=${pkgver##*.}
pkgrel=2
pkgdesc="advanced text editor"
url="http://www.vim.org"
arch="all"
license='GPL'
depends=
makedepends="ncurses-dev lua5.2-dev"
subpackages="$pkgname-doc ${pkgname}diff"
# hg clone https://vim.googlecode.com/archive/v${pkgver//./-}.tar.gz
#source="vim-$pkgver.tar.gz::https://vim.googlecode.com/archive/v${pkgver//./-}.tar.gz
source="http://dev.alpinelinux.org/archive/vim/vim-$pkgver.tar.gz
	vimrc
	CVE-2016-1248.patch
	CVE-2017-5953.patch
	"
_builddir="$srcdir"/vim-v${pkgver//./-}

# secfixes:
#   7.4.712-r2:
#   - CVE-2017-5953
#   7.4.712-r1:
#   - CVE-2016-1248

prepare() {
	cd "$_builddir"
	# Read vimrc from /etc/vim
	echo '#define SYS_VIMRC_FILE "/etc/vim/vimrc"' >> src/feature.h
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--enable-luainterp \
		--without-x \
		--disable-nls \
		--enable-multibyte \
		--enable-gui=no \
		--with-lua-prefix=/usr/lua5.2 \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make -j1 DESTDIR="$pkgdir/" install
	install -D "$srcdir"/vimrc "$pkgdir"/etc/vim/vimrc
}

vimdiff() {
	pkgdesc="view file diffs in vim"
	arch="noarch"
	depends="diffutils"

	install -d "$subpkgdir"/usr/bin || return 1
	mv "$pkgdir"/usr/bin/vimdiff "$subpkgdir"/usr/bin
}

md5sums="ad8543cadbadb7f3a71d35296ce3612f  vim-7.4.712.tar.gz
97aecde2ab504e543a96bec84b3b5638  vimrc
65cd79792f8150130c4aafb7842b80cf  CVE-2016-1248.patch
9ef01e90bbb56924265c7306ae9f58c3  CVE-2017-5953.patch"
sha256sums="7fe2a9cb24b258a725c5a95f052b62f341aac122aab1243a9a270eff722a37e3  vim-7.4.712.tar.gz
7ac7e5fd75fe315fd8b3ca4172056ebb9f06df0b5985d3ff88133dfcdd87076b  vimrc
b8d1227a41d6f7f596f3bf45dfaf9d0dbbbcf091c5f145c95d464986031446e5  CVE-2016-1248.patch
79dfa7c82565efe85f5cbcc889aa45cc46f2c6a83c58b35b834e05b54367c44d  CVE-2017-5953.patch"
sha512sums="db0e20b3b43ec4033aa057a2676d2a294d12139ecfa7be2403a54e2b0d869e5ba6a606f7dd964752c802129c6e95afee7da2e48f5605c7f64041aa8fb2354aa7  vim-7.4.712.tar.gz
d9586b777881973cb5e48e18750336a522ed72c3127b2d6b6991e2b943468ca5b694476e7fa39ab469178c1375fc8f52627484e0fe377aea5811a513e35a7b02  vimrc
e773f8c497364930dea10585af5888f12ea7be1effb23461df9f92c10c2c0e9e55e127b9465f62a20c03e08ab77f9c9f140f50277d7c9cc5c318e84725434d18  CVE-2016-1248.patch
e9f2bef38bf5257857f2936d6e3e7d7564d97701bf2f89ad1fd56ff7d0f7f8d722801b4c6ace859101e7611e74d48bf052f6cca9e2b6b4720d9adc1a1d38e2cf  CVE-2017-5953.patch"
