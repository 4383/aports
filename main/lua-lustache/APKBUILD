# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
_luaversions="5.1 5.2 5.3"
_name=lustache
pkgname=lua-$_name
pkgver=1.3.1
_pkgver=$pkgver-0
pkgrel=0
pkgdesc="Logic-less {{mustache}} templates with Lua"
url="http://olivinelabs.com/lustache/"
arch="noarch"
license="MIT"
depends=""
depends_dev=""
makedepends="$depends_dev"
install=""
subpackages="$pkgname-common"
for _i in $_luaversions; do
	makedepends="$makedepends lua$_i-dev"
	subpackages="$subpackages lua$_i-$_name:split_${_i/./_}"
done
source="lua-lustache-$pkgver.tar.gz::https://github.com/Olivine-Labs/lustache/archive/v$_pkgver.tar.gz"

_builddir="$srcdir"/lustache-$_pkgver
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"/usr/share/lua/common/lustache

	install -m644 src/lustache/*.lua \
		"$pkgdir"/usr/share/lua/common/lustache/ || return 1
	install -m644 src/lustache.lua \
		"$pkgdir"/usr/share/lua/common/

	for _v in $_luaversions; do
		mkdir -p "$pkgdir"/usr/share/lua/$_v
		for i in lustache lustache.lua; do
			ln -s ../common/$i "$pkgdir"/usr/share/lua/$_v/$i \
				|| return 1
		done
	done
}


common() {
	pkgdesc="Logic-less {{mustache}} templates with Lua $1"
	mkdir -p "$subpkgdir"/usr/share/lua/
	mv "$pkgdir"/usr/share/lua/common "$subpkgdir"/usr/share/lua/
}

_split() {
	pkgdesc="Logic-less {{mustache}} templates with Lua $1"
	install_if="lua$1 $pkgname=$pkgver-r$pkgrel"
	depends="$pkgname-common"
	mkdir -p "$subpkgdir"/usr/share/lua/
	mv "$pkgdir"/usr/share/lua/$1 "$subpkgdir"/usr/share/lua/ || return 1
}

for _v in $_luaversions; do
	eval "split_${_v/./_}() { _split $_v; }"
done

md5sums="e4416abe1a822c1b2d4b3a9e702d5795  lua-lustache-1.3.1.tar.gz"
sha256sums="540bd5e1f6d32aa44d5be946d1772910fb73b62fa909ca5a026c115ece4170f0  lua-lustache-1.3.1.tar.gz"
sha512sums="f1ba0bdd38e60957df1995f32a73a16d1b430072af4e14cce530345c74d542021223c0ef41b0f997f88d762bb194fff7119701cd289e16e3e38dfe3f10d0d9d8  lua-lustache-1.3.1.tar.gz"
