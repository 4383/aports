# Contributor: Kaarle Ritvanen <kaarle.ritvanen@datakunkku.fi>
# Maintainer: Kaarle Ritvanen <kaarle.ritvanen@datakunkku.fi>
pkgname=awall
pkgver=0.3.1
pkgrel=2
pkgdesc="Alpine Wall"
url=http://git.alpinelinux.org/cgit/awall/
arch=noarch
license=GPL-2
replaces="awall-nat"
depends="bind-tools ip6tables ipset iptables lua lua-alt-getopt lua-filesystem lua-json4 lua-pc lua-signal lua-sleep lua-stringy xtables-addons"
subpackages=$pkgname-masquerade
source="http://dev.alpinelinux.org/archive/awall/awall-${pkgver}.tar.bz2
	0001-limit-packet-connection-rate-per-source-IP.patch
	0002-fix-ratelimiting-to-work-with-bursts-properly.patch"

_builddir=$srcdir/awall-${pkgver}

prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	:
}

package() {
	cd "$_builddir"
	make "ROOT_DIR=$pkgdir" install
}

masquerade() {
	depends=awall
	cd "$_builddir"
	for file in lua/5.1/awall/modules/masquerade.lua awall/mandatory/masquerade.json; do	    	
		local path=usr/share/$file
		install -d "$subpkgdir/$(dirname $path)"
		mv "$pkgdir/$path" "$subpkgdir/$path"
	done
}

md5sums="b0547d6c2a90515b0fd66b3b9cf80ad6  awall-0.3.1.tar.bz2
57f9e9816be3fb679581d4c8db664989  0001-limit-packet-connection-rate-per-source-IP.patch
97a2f33572504e62b4d2d9d1d7f22bc8  0002-fix-ratelimiting-to-work-with-bursts-properly.patch"
sha256sums="7780a298b2f09ec959974e5f6fc5c64c196aa8c33b2bc0135a15dcfcb315cacb  awall-0.3.1.tar.bz2
dcfb077003977bbe68c5587ed379c288ca9ea8d64d69b8edd46425d9feccde02  0001-limit-packet-connection-rate-per-source-IP.patch
433b0e227e8966845314f8285c4856591776e310cd8ecba40e6d8076f4195890  0002-fix-ratelimiting-to-work-with-bursts-properly.patch"
sha512sums="5e4e150812899dd47ff607e5701e59fa17b4889c4dd2f60df864d3f831d28f89ac277789e7de6bb70a1578723f7e8782a3fccb3a645aeec35a013b8e62c01880  awall-0.3.1.tar.bz2
48fe9549aa70d37a0b63dc61a47ef4540666aa6616d01b6db9bc48657b3d9cdcb7ee7421cde7fce3a7945687bd6e621aa9cac228d2cf93161b368fd356b2c9fc  0001-limit-packet-connection-rate-per-source-IP.patch
702f8ecf5260de9491bf606d929f31f0c7ba23c4a93513411e519907b1694a948ce1118098a5eafaeec856a4cd6a1f95173c4b5172355146b1999795337bf711  0002-fix-ratelimiting-to-work-with-bursts-properly.patch"
