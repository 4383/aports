# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=busybox
pkgver=1.16.0
pkgrel=7
pkgdesc="Size optimized toolbox of many common UNIX utilities"
url=http://busybox.net
license="GPL-2"
depends=
install="$pkgname.post-install $pkgname.post-upgrade"
triggers="busybox.trigger:/bin /usr/bin /sbin /usr/sbin /lib/modules/*"
source="http://busybox.net/downloads/$pkgname-$pkgver.tar.bz2
	$pkgname-1.11.1-bb.patch
	busybox-1.16.0-POLLHUP.patch
	busybox-1.16.0-ash.patch
	busybox-1.16.0-compat.patch
	busybox-1.16.0-defconfig.patch
	busybox-1.16.0-linux_swap.patch
	busybox-1.16.0-md5_sha_compat.patch
	busybox-1.16.0-syslogd.patch
	busybox-1.16.0-tftp.patch
	busybox-1.16.0-usage.patch
	busybox-1.16.0-wc.patch
	busybox-1.16.0-wget.patch
	0001-beep-the-d-option-takes-milliseconds-not-microsecond.patch
	flock-bb.patch
	busyboxconfig"

_builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	cd "$_builddir"
	#patches
	for i in ../*.patch; do
		msg "Applying $i"
		if ! patch -p1 -i $i; then
			error "$i failed"
			return 1
		fi
	done

	sed -i	-e 's/(ip, _BB_DIR_BIN/(ip, _BB_DIR_SBIN/' \
		-e 's/(vi, _BB_DIR_BIN/(vi, _BB_DIR_USR_BIN/' \
		include/applets.h || return 1

	# we set the install prefix with sed since it might differ depending
	# on abuild version
	sed -e "s:^CONFIG_PREFIX=.*:CONFIG_PREFIX=\"$pkgdir\":" \
		../busyboxconfig > .config
}

build() {
	cd "$_builddir"
	make silentoldconfig || return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make install DESTDIR="$pkgdir"
	mkdir -p "$pkgdir"/usr/sbin "$pkgdir"/usr/bin "$pkgdir"/tmp \
		"$pkgdir"/var/cache/misc
	chmod 1777 "$pkgdir"/tmp
	# we need /bin/sh to be able to execute post-install
	ln -s /bin/busybox "$pkgdir"/bin/sh
}

md5sums="2130884e71a1648bfb63c3250c1d288c  busybox-1.16.0.tar.bz2
4c0f3b486eaa0674961b7ddcd0c60a9b  busybox-1.11.1-bb.patch
6d2d837cace2e681392fa1d1d430ed78  busybox-1.16.0-POLLHUP.patch
b788742e46a848c02913c9bd070025b7  busybox-1.16.0-ash.patch
940aff0065f875b165dac59cc7006c6a  busybox-1.16.0-compat.patch
118e94315a262a23af66c0d3ad83235e  busybox-1.16.0-defconfig.patch
1a406fb181aab8d9667498ea64116d50  busybox-1.16.0-linux_swap.patch
f4758daa8023f000228e9509cceb02d1  busybox-1.16.0-md5_sha_compat.patch
86a27167971333a0ddad4f0e8bc0acc6  busybox-1.16.0-syslogd.patch
e24dc9e56b5de4fff706cfbe5c75d9b2  busybox-1.16.0-tftp.patch
289c8ee19cc43fe175bbd7933c6b5cdf  busybox-1.16.0-usage.patch
6520ca5ad3b2a13d100065c4f07e610a  busybox-1.16.0-wc.patch
928ca5a26599cd1dbb80e08132140832  busybox-1.16.0-wget.patch
00b2aca448952eeb3b579792070712fd  0001-beep-the-d-option-takes-milliseconds-not-microsecond.patch
20d9beea7d0c0aaca14553a8f98fee12  flock-bb.patch
4bc85af9dd659cbb83c9a819b3481a47  busyboxconfig"
