# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=busybox
pkgver=1.14.3
pkgrel=6
pkgdesc="Size optimized toolbox of many common UNIX utilities"
url=http://busybox.net
license="GPL-2"
depends=
install="$pkgname.post-install $pkgname.post-upgrade"
triggers="busybox.trigger:/bin /usr/bin /sbin /usr/sbin /lib/modules/*"
source="http://busybox.net/downloads/$pkgname-$pkgver.tar.bz2
	$pkgname-1.11.1-bb.patch
	0001-install-compat-fix-for-mode-of-created-files.patch
	0001-add-simple-beep-applet-second-version.patch
	bb-tar-numeric-owner.patch
	busybox-sed-3.patch
	busyboxconfig"

build() {
	cd "$srcdir"/$pkgname-$pkgver

	#patches
	for i in ../*.patch; do
		msg "Applying $i"
		if ! patch -p1 -i $i; then
			error "$i failed"
			return 1
		fi
	done

	sed -i	-e 's/(ip, _BB_DIR_BIN/(ip, _BB_DIR_SBIN/' \
		-e 's/(vi, _BB_DIR_BIN/(vi, _BB_DIR_USR_BIN/' \
		include/applets.h || return 1

	# we set the install prefix with sed since it might differ depending
	# on abuild version
	sed -e "s:^CONFIG_PREFIX=.*:CONFIG_PREFIX=\"$pkgdir\":" \
		../busyboxconfig > .config

	make silentoldconfig || return 1
	make || return 1
	make install DESTDIR="$pkgdir"
	mkdir -p "$pkgdir"/usr/sbin "$pkgdir"/usr/bin "$pkgdir"/tmp
	chmod 1777 "$pkgdir"/tmp
	# we need /bin/sh to be able to execute post-install
	ln -s /bin/busybox "$pkgdir"/bin/sh
}

md5sums="d170bf5f97a41aec3a505eab690d5699  busybox-1.14.3.tar.bz2
4c0f3b486eaa0674961b7ddcd0c60a9b  busybox-1.11.1-bb.patch
73d39c57483084298c7e46bdbbbea8d1  0001-install-compat-fix-for-mode-of-created-files.patch
3ba0529f64aadae6ce95c683e6182988  0001-add-simple-beep-applet-second-version.patch
0b5b2d7db201f90cd08f4a3164ee29a1  bb-tar-numeric-owner.patch
b75c3f419f8392dfdadd92aa24fdba8c  busybox-sed-3.patch
3ece68eb92d97f3362dab7d838074d10  busyboxconfig"
