# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=syslinux
pkgver=6.03_pre19
pkgrel=0
_ver=${pkgver/_/-}
pkgdesc="Boot loader for the Linux operating system"
url="http://syslinux.org"
arch="x86 x86_64"
license="GPL"
makedepends="nasm perl util-linux-dev gnu-efi-dev"
depends="mtools blkid mkinitfs"
triggers="syslinux.trigger=/boot"
install="syslinux.post-upgrade"
options="textrels"
ldpath="/usr/share/syslinux"
source="https://www.kernel.org/pub/linux/utils/boot/syslinux/Testing/6.03/syslinux-$_ver.tar.xz
	update-extlinux.conf
	update-extlinux
	"
subpackages="$pkgname-doc $pkgname-dev"

_loaderarch=
case "$CARCH" in
x86)	_loaderarch=efi32;;
x86_64)	_loaderarch=efi64;;
esac

_builddir="$srcdir"/$pkgname-$_ver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case "$i" in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	unset LDFLAGS
	make $_loaderarch installer || return 1
}

package() {
	cd "$_builddir"
	make -j1 INSTALLROOT="$pkgdir" MANDIR=/usr/share/man \
		bios $_loaderarch install || return 1

	mkdir -p "$pkgdir"/etc/update-extlinux.d
	cp "$srcdir"/update-extlinux.conf "$pkgdir"/etc/
	sed "/^version=/s/=.*/=$pkgver-r$pkgrel/" "$srcdir"/update-extlinux \
		> "$pkgdir"/sbin/update-extlinux
	chmod 755 "$pkgdir"/sbin/update-extlinux
}

md5sums="b9f168806ef4cbcb196494818de80e09  syslinux-6.03-pre19.tar.xz
38d206b75b1096ba5df6cfabf455ab06  update-extlinux.conf
35b78e9ed4b7a4feb79f4fc04102acd2  update-extlinux"
sha256sums="ed31aa34026af19f74e0164f6cb0cf0545498f2477110c38c5d2db802127ae1c  syslinux-6.03-pre19.tar.xz
d0b7b869489d0ac1529dd742d8d88844ea4e0a5d893de5218b250b97f68e55f2  update-extlinux.conf
9f7925bedb1611f5c3b6456fa13d21992743b5a92d2f1f8699cd63a0f207ca93  update-extlinux"
sha512sums="08c67e90b3a31791efc9af2a545e81fd1cdecaf579a171e460ef87e563379ab721cec28eba7cf2635ef76e6edea070bfbf1689233b6f6246c4dbf9df45b7e8e0  syslinux-6.03-pre19.tar.xz
f304068ee174e531890fed20b05d962e6c076160c470ed9cf0d822ff56917793ecabec8c0495b045a740f1f63412a55fbb1fa4b4231b18f76c8584b55f51306d  update-extlinux.conf
73ba856bff89d5f23790819c8aeaca95ec336aba96fe6591a2e65345caace658b93627e0f42621d3bd2d70303107d27a9db36cb17648eef110576749e5194f04  update-extlinux"
