# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=uclibc
pkgver=0.9.30.1
pkgrel=19
pkgdesc="C library for developing embedded Linux systems"
url=http://uclibc.org
license="LGPL-2"
_mynamever=uClibc-$pkgver

subpackages="$pkgname-dev"
depends_dev="linux-headers=>2.6.32"

source="http://uclibc.org/downloads/$_mynamever.tar.bz2
	$pkgname-0.9.30.1-resolv.patch
	uclibc-0.9.30.1-pthread_getattr_np.patch
	0001-Add-dn_skipname-from-OpenBSD.patch
	0001-ldd-segfault-fix.patch
	0001-linuxthreads-fixes-from-Will-Newton-will.newton-AT-g.patch
	0001-include-sys-mount.h-define-MNT_DETATCH-and-MNT_EXPIR.patch
	fstatat-fix-32bit.patch
	pthread-new-aliasing-fix.diff
	uclibc-resolv-cname-fix.diff
	uclibc-i386-floating-stacks.diff
	ppoll.patch
	uclibc-fork-hidden.diff
	uclibc-fork-hook.diff
	uclibc-getaddrinfo-netlink.diff
	uclibcconfig.x86
	"
# backport openat funcs
source="$source
	0001-first-pass-at-implementing-at-funcs.patch
	0002-add-hidden-aliases-for-openat-funcs.patch
	0003-remove-libc_hidden_def-mknodat.patch
	"

_config="$srcdir"/uclibcconfig.${ARCH:-x86}


prepare() {
	local i gcc_major
	cd "$srcdir/$_mynamever/"
	# patches goes here
	for i in ../*.patch ../*.diff; do
		msg "Applying $i..."
		patch -p1 < $i || return 1
	done
}

build() {
	cd "$srcdir/$_mynamever/"
	cp "$_config" .config
	make silentoldconfig
	# this is a hack to get uclibc-i386-floating-stacks.diff working
	touch libc/sysdeps/linux/i386/sysdep.h
	make || return 1
}

package() {
	cd "$srcdir/$_mynamever/"
	make install DESTDIR="$pkgdir" install_utils
	install -Dm755 extra/scripts/getent "$pkgdir"/usr/bin/getent
	# provided by linux-headers
	rm -f "$pkgdir"/usr/include/scsi/scsi.h
}

md5sums="1a4b84e5536ad8170563ffa88c34679c  uClibc-0.9.30.1.tar.bz2
ea91460617601b6e084ead66bc3948f5  uclibc-0.9.30.1-resolv.patch
cf80c0d44a41e02f389be427ee615d61  uclibc-0.9.30.1-pthread_getattr_np.patch
c9e3df01e854db4b1118266acd9bcfbd  0001-Add-dn_skipname-from-OpenBSD.patch
4079b20c763727863bc53408e4988434  0001-ldd-segfault-fix.patch
bcd1c4c9c87f092fb4631559e6ec13ba  0001-linuxthreads-fixes-from-Will-Newton-will.newton-AT-g.patch
7ac347d2921e12c4acdfedc4eb4e5d9c  0001-include-sys-mount.h-define-MNT_DETATCH-and-MNT_EXPIR.patch
14d9fa172f67fee0257f0441b3b3bc13  fstatat-fix-32bit.patch
969187e1da84d0a0a5957b392a3d5a2b  pthread-new-aliasing-fix.diff
bbb8475963e791f596c34c81ef5583d7  uclibc-resolv-cname-fix.diff
0b3966ab7774ac42ecf34a7b596c661b  uclibc-i386-floating-stacks.diff
60738298e377295d359768a09adac0bb  ppoll.patch
220260c979eca4558827d0e7ec8aa8b6  uclibc-fork-hidden.diff
55bb709f5efd937df323f0d39a202cfd  uclibc-fork-hook.diff
a7310494a8073ebd43e1d437657532ef  uclibc-getaddrinfo-netlink.diff
36b28777f4c49af39268920fbade41b1  uclibcconfig.x86
329b92fec717c8808c3fa9ffd68f2dfb  0001-first-pass-at-implementing-at-funcs.patch
7ffa41082d9de2bc512b4bed9577bdf9  0002-add-hidden-aliases-for-openat-funcs.patch
e12c647716eef19dd4ad08602dcc435b  0003-remove-libc_hidden_def-mknodat.patch"
