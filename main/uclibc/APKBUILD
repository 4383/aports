# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=uclibc
pkgver=0.9.30.1
pkgrel=13
pkgdesc="C library for developing embedded Linux systems"
url=http://uclibc.org
license="LGPL-2"
_mynamever=uClibc-$pkgver

subpackages="$pkgname-dev"
depends_dev="linux-headers"

source="http://uclibc.org/downloads/$_mynamever.tar.bz2
	$pkgname-0.9.30.1-resolv.patch
	uclibc-0.9.30.1-pthread_getattr_np.patch
	0001-ldd-segfault-fix.patch
	0001-linuxthreads-fixes-from-Will-Newton-will.newton-AT-g.patch
	pthread-new-aliasing-fix.diff
	uclibc-resolv-cname-fix.diff
	uclibc-i386-floating-stacks.diff
	ppoll.patch
	uclibc-fork-hook.diff
	uclibc-getaddrinfo-netlink.diff
	uclibcconfig
	"
# backport openat funcs
source="$source
	0001-first-pass-at-implementing-at-funcs.patch
	0002-add-hidden-aliases-for-openat-funcs.patch
	0003-remove-libc_hidden_def-mknodat.patch
	"

_prepare() {
	local i gcc_major
	cd "$srcdir/$_mynamever/"
	# patches goes here
	for i in ../*.patch ../*.diff; do
		msg "Applying $i..."
		patch -p1 < $i || return 1
	done
}

_compile() {
	cd "$srcdir/$_mynamever/"
	cp ../uclibcconfig .config
	make silentoldconfig
	# this is a hack to get uclibc-i386-floating-stacks.diff working
	touch libc/sysdeps/linux/i386/sysdep.h
	make || return 1
}

_install() {
	cd "$srcdir/$_mynamever/"
	make install DESTDIR="$pkgdir" install_utils
	install -Dm755 extra/scripts/getent "$pkgdir"/usr/bin/getent
}

build() {
	_prepare && _compile && _install
}

md5sums="1a4b84e5536ad8170563ffa88c34679c  uClibc-0.9.30.1.tar.bz2
ea91460617601b6e084ead66bc3948f5  uclibc-0.9.30.1-resolv.patch
cf80c0d44a41e02f389be427ee615d61  uclibc-0.9.30.1-pthread_getattr_np.patch
4079b20c763727863bc53408e4988434  0001-ldd-segfault-fix.patch
bcd1c4c9c87f092fb4631559e6ec13ba  0001-linuxthreads-fixes-from-Will-Newton-will.newton-AT-g.patch
969187e1da84d0a0a5957b392a3d5a2b  pthread-new-aliasing-fix.diff
bbb8475963e791f596c34c81ef5583d7  uclibc-resolv-cname-fix.diff
0b3966ab7774ac42ecf34a7b596c661b  uclibc-i386-floating-stacks.diff
60738298e377295d359768a09adac0bb  ppoll.patch
55bb709f5efd937df323f0d39a202cfd  uclibc-fork-hook.diff
a7310494a8073ebd43e1d437657532ef  uclibc-getaddrinfo-netlink.diff
0a87f57d3e5001027f43b7c959d96319  uclibcconfig
329b92fec717c8808c3fa9ffd68f2dfb  0001-first-pass-at-implementing-at-funcs.patch
7ffa41082d9de2bc512b4bed9577bdf9  0002-add-hidden-aliases-for-openat-funcs.patch
e12c647716eef19dd4ad08602dcc435b  0003-remove-libc_hidden_def-mknodat.patch"
