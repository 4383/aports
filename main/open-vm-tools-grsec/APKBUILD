# Maintainer: Natanael Copa <ncopa@alpinelinux.org>

_flavor=grsec
_kpkg=linux-$_flavor
_realname=open-vm-tools
_kver=3.8.2
_kpkgrel=0

_realver=9.2.2_p893683
_ver=${_realver/_p/-}
_mypkgrel=0

# source open-vm-tools version
if [ -f ../main/$_realname/APKBUILD ]; then
	. ../main/$_realname/APKBUILD
	[ "${_realver}" != "$pkgver" ] && pkgname=$_realname-$_flavor \
		&& die "please set _realver to $pkgver"
fi

# source the kernel version
if [ -f ../main/linux-${_flavor}/APKBUILD ]; then
        . ../main/linux-${_flavor}/APKBUILD
	[ "$_kver" != "$pkgver" ] && die "please set _kver to $pkgver"
	[ "$_kpkgrel" != "$pkgrel" ] && die "please set _kpkgrel to $pkgrel"
fi

_abi_release=${_kver}-${_kpkgrel}-${_flavor}
_kernelver="$_kver-r$_kpkgrel"

pkgname="$_realname-$_flavor"
pkgver=$_kver
pkgrel=$(($_kpkgrel + $_mypkgrel))

pkgdesc="The Open Virtual Machine Tools are the open source implementation of VMware Tools."
url="http://open-vm-tools.sourceforge.net/"
arch="all"
license="LGPL"
subpackages=""
depends="linux-${_flavor}=${_kernelver}"
depends_dev="bash glib-dev gettext-dev linux-${_flavor}-dev=${_kernelver}"
makedepends="$depends_dev"
source="http://downloads.sourceforge.net/project/open-vm-tools/open-vm-tools/stable-${_realver%.*}.x/open-vm-tools-${_ver}.tar.gz
	linux-3.8.patch
	vmci_driver_c.patch
	vmware-modules.initd
	"
#	constify.patch
install_if="linux-${_flavor}=${_kernelver} open-vm-tools"

_builddir="$srcdir/$_realname-$_ver"

prepare() {
	cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

build() {
	export GCC_SPECS=/usr/share/gcc/hardenednopie.specs
	cd "$_builddir"
	./configure --without-pam \
		--without-x \
		--without-dnet \
		--without-icu \
		--without-procps \
		--with-kernel-release="${_abi_release}" \
		|| return 1
	cd "$_builddir"/modules
	make -j1 modules || return 1
}

package() {
	cd "$_builddir"
 	install -D -m755 "$srcdir"/vmware-modules.initd \
		"$pkgdir"/etc/init.d/vmware-modules-${_flavor} || return 1
	mkdir -p $pkgdir/lib/modules/${_abi_release}/misc/
	cd "$_builddir"/modules
	for module in `find -type f -name '*.ko'`; do
		install -D -m644 $module "$pkgdir/lib/modules/${_abi_release}/misc/"
	done
}

md5sums="7af505681d736d4c9ee6493b1166689f  open-vm-tools-9.2.2-893683.tar.gz
fa306331d54af2b9acad5d5693dc05cf  linux-3.8.patch
16e060275e028d1edf1c5fd1a10b6a96  vmci_driver_c.patch
afba2c3487d0b12cee80eb2f04b05ba1  vmware-modules.initd"
sha256sums="1ae795e75bf4b38185f39083b8075686d3bab4c1222f4e39c863aeccb2f5f387  open-vm-tools-9.2.2-893683.tar.gz
98de7879598f229e99ef408776a3ed5fbc7f7fe937c8b925f4fbe3907df50f89  linux-3.8.patch
0c7e24a78784e2e74421b119f996eb74fd346d5634e7f58172860e2c5f5d5bf4  vmci_driver_c.patch
6ceb5c75b002991c511d9dadb6cf91720771e76b701e5f2d91ac9ede4b168265  vmware-modules.initd"
sha512sums="13490bdff2b8b316b1cd09e06c76293f21b83ede025ded5ddc71251e4f64279296f7dd0f248335f7e3d0714759be13f07263f154683878870a062c9ba55644fc  open-vm-tools-9.2.2-893683.tar.gz
2182873330d80d37dfaaccb0b91c4fd25c938ed54979e8a5f9f04f332542c784084b0a10a83e9679f5bfbca4d2e8727b03dc3a23b473692212cc3f7a9894f413  linux-3.8.patch
a2fb52dd5bb323e7bba62ace64e655536c5d103f66bde17266762ecd6327de1ffc629acaa9e22814b23e09239cb7685c4bb0748362d6b2f0d6c34260cb09edc6  vmci_driver_c.patch
639098221975cadaed0ae0f32454a6718ceaa5f43f17d949a84a85dee56fbf5f9e6248899c10a46b12c9c9cf28b837d83a37c25aba62b11cb7849a1cf8d32e1e  vmware-modules.initd"
