# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=ncurses
pkgver=6.0
pkgrel=1
pkgdesc="Console display library"
url="http://www.gnu.org/software/ncurses/"
arch="all"
license=MIT
depends=
source="http://ftp.gnu.org/pub/gnu/ncurses/ncurses-${pkgver}.tar.gz
	"
subpackages="$pkgname-dev $pkgname-doc $pkgname-terminfo-base:base
	$pkgname-terminfo $pkgname-widec-libs:widec $pkgname-libs $pkgname-dbg"

_builddir="$srcdir"/ncurses-$pkgver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	local _confopts="
		--build=$CBUILD
		--host=$CHOST
		--mandir=/usr/share/man
		--without-ada
		--disable-termcap
		--disable-rpath-hack
		--without-cxx-binding
		--with-terminfo-dirs="/etc/terminfo:/usr/share/terminfo"
		--enable-pc-files \
		--with-shared"
	cd "$_builddir"

	mkdir ncurses-build ncursesw-build
	cd ncurses-build
	../configure $_confopts \
		|| return 1
	make libs || return 1
	make -C progs || return 1

	cd ../ncursesw-build
	../configure $_confopts \
		--enable-widec \
		--without-progs \
		|| return 1
	make libs || return 1
	cd ..
}

package() {
	cd "$_builddir"
	make -j1 -C ncurses-build DESTDIR="$pkgdir" install.libs \
		install.progs install.data || return 1

	make -j1 -C ncursesw-build DESTDIR="$pkgdir" install.libs \
		install.includes install.man || return 1

	# Install basic terms in /etc/terminfo
	for i in ansi console dumb linux rxvt screen sun vt52 vt100 vt102 \
			vt200 vt220 xterm xterm-color xterm-xfree86; do
		local termfile=$(find "$pkgdir"/usr/share/terminfo/ -name "$i" 2>/dev/null)
		local basedir=$(basename $(dirname "$termfile"))

		[ -z "$termfile" ] && continue

		install -d "$pkgdir"/etc/terminfo/$basedir
		mv ${termfile} "$pkgdir"/etc/terminfo/$basedir/
		ln -s ../../../../etc/terminfo/$basedir/$i \
			"$pkgdir"/usr/share/terminfo/$basedir/$i
	done
}

terminfo() {
	depends="$pkgname-terminfo-base"
	rm -rf $subpkgdir
	mkdir -p $subpkgdir/usr/share
	mv $pkgdir/usr/share/terminfo $subpkgdir/usr/share
}

widec() {
	pkgdesc="Ncurses wide character libraries"
	depends="$pkgname-terminfo-base"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/lib*w.so.* "$subpkgdir"/usr/lib/
}

libs() {
	pkgdesc="Ncurses libraries"
	depends="$pkgname-terminfo-base"
	mkdir -p "$subpkgdir"/usr/
	mv "$pkgdir"/usr/lib "$subpkgdir"/usr/
}

base() {
	pkgdesc="Descriptions of common terminals"
	mkdir -p "$subpkgdir"/etc
	mv "$pkgdir"/etc/terminfo "$subpkgdir"/etc/
}

md5sums="ee13d052e1ead260d7c28071f46eefb1  ncurses-6.0.tar.gz"
sha256sums="f551c24b30ce8bfb6e96d9f59b42fbea30fa3a6123384172f9e7284bcf647260  ncurses-6.0.tar.gz"
sha512sums="9ec194f4783dae6de8c529cac31b5cfbfcfea212c5d47b1f87cd49df013e38f8580a9e7aa1384918df0921b4ba999d5e73eb6d6362cce2d7287e64308b673963  ncurses-6.0.tar.gz"
