# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
_railsver=4.2
pkgname=redmine
pkgver=3.0.1
pkgrel=3
pkgdesc="Project management web application written in Ruby"
url="http://redmine.org"
arch="noarch"
license="GPL2"
depends="ruby
	ruby-actionpack-action_caching${_railsver}
	ruby-actionpack-xml_parser${_railsver}
	ruby-bigdecimal
	ruby-coderay
	ruby-fastercsv
	ruby-i18n
	ruby-jquery-rails${_railsver}
	ruby-json
	ruby-mocha
	ruby-net-ldap<0.4
	ruby-openid<2.4
	ruby-rack
	ruby-rack-openid
	ruby-rails${_railsver}
	ruby-rbpdf
	ruby-rdoc
	ruby-redcarpet<3.2
	ruby-request_store
	ruby-rmagick
	ruby-protected_attributes${_railsver}
	"
depends_dev=
makedepends="$depends_dev
	ruby-yard
	"
install="$pkgname.pre-install"
subpackages=""
pkgusers="$pkgname"
pkggroups="$pkgname www-data"
source="http://www.redmine.org/releases/redmine-$pkgver.tar.gz
	gemfile.patch
	database.yml.patch
	"
_webapps="usr/share/webapps"

_builddir="$srcdir"/redmine-$pkgver

prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	# verify that all deps are installed
	if ! bundler check; then
		bundler list
		return 1
	fi
}

package() {
	cd "$_builddir"
	# create dirs
	mkdir -p "$pkgdir/$_webapps/$pkgname" "$pkgdir"/etc/redmine \
		|| return 1
	install -o redmine -g www-data -m775 -d \
		"$pkgdir"/var/lib/redmine "$pkgdir"/var/log/redmine \
		|| return 1

	# move config files
	for i in database.yml.example configuration.yml.example \
			additional_environment.rb.example routes.rb; do
		mv config/${i} "$pkgdir"/etc/redmine/${i%.example} || return 1
		ln -s /etc/redmine/${i%.example} config/$i || return 1
	done

	# writeable data dirs
	for i in files tmp public/plugin_assets; do
		chown redmine:www-data $i || return 1
		chmod 775 $i || return 1
		mv $i "$pkgdir"/var/lib/redmine/ || return 1
		ln -s /var/lib/redmine/${i#*/} $i || return 1
	done

	# log dir
	rm -r log && ln -s /var/log/redmine log || return 1

	mv * "$pkgdir/$_webapps/$pkgname" || return 1
}

md5sums="bf63ceef4fde0d38d17d94969478d422  redmine-3.0.1.tar.gz
6115e9c82b7af28cb6849a1f8ad55c0d  gemfile.patch
d834bef9b5f01484f1e0ee82676f4109  database.yml.patch"
sha256sums="9b701ff471bf1d9c9fd671e6a3d3c426850df5411a73f891f49c2cd79d489d5a  redmine-3.0.1.tar.gz
3dce0dccce0931e26d81546ba2c87b776da92a1e532e560f18b2355e378c92a0  gemfile.patch
28b1ec099ae87c43d00d7e997edabaece01d6fc2e67b46c50735e9a1bb72f130  database.yml.patch"
sha512sums="689e8625197b4668bc06c68b0502a23e50675ad13d17a67a25cb51d68b1ac15ff4395783003ce696994bd15191139adde6bc21add0b81b4a40e9979e95753e18  redmine-3.0.1.tar.gz
5cd897dd296c4f89500bb607f2e0898e0af8ec10292f23d16dbb9ea686d10a6bd2b1a9bfdec2aa722461a02ae73ba5160115e5d9ec78031387c7c337eba56ede  gemfile.patch
1b5880979f050a71d726c844369cc5340a8d4aa0b59b2301e1d32dea28f70ca2a85e619c8b845c37de08772154eef13fa63716c1beaaa50d97b80fd65c297bf9  database.yml.patch"
