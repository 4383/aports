# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
_railsver=4.2
pkgname=redmine
pkgver=3.0.1
pkgrel=2
pkgdesc="Project management web application written in Ruby"
url="http://redmine.org"
arch="noarch"
license="GPL2"
depends="ruby
	ruby-actionpack-action_caching${_railsver}
	ruby-actionpack-xml_parser${_railsver}
	ruby-bigdecimal
	ruby-coderay
	ruby-fastercsv
	ruby-i18n
	ruby-jquery-rails${_railsver}
	ruby-json
	ruby-mocha
	ruby-net-ldap<0.4
	ruby-openid<2.4
	ruby-rack
	ruby-rack-openid
	ruby-rails${_railsver}
	ruby-rbpdf
	ruby-rdoc
	ruby-redcarpet<3.2
	ruby-request_store
	ruby-rmagick
	ruby-protected_attributes${_railsver}
	"
depends_dev=
makedepends="$depends_dev
	ruby-yard
	"
install="$pkgname.pre-install"
subpackages=""
pkgusers="$pkgname"
pkggroups="$pkgname"
source="http://www.redmine.org/releases/redmine-$pkgver.tar.gz
	gemfile.patch
	additional_environment.rb
	configuration.yml
	database.yml"
_webapps="usr/share/webapps"

_builddir="$srcdir"/redmine-$pkgver

prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	# verify that all deps are installed
	if ! bundler check; then
		bundler list
		return 1
	fi
}

package() {
	cd "$_builddir"
	# move app to webapps dir
	mkdir -p "$pkgdir/$_webapps/$pkgname"
	mv * "$pkgdir/$_webapps/$pkgname"
	# install default config to /etc/redmine
	install -g $pkggroups -m640 -D "$srcdir"/database.yml \
		"$pkgdir"/etc/redmine/database.yml
	install -g $pkggroups -m644 -D "$srcdir"/configuration.yml \
		"$pkgdir"/etc/redmine/configuration.yml
	install -g $pkggroups -m644 -D "$srcdir"/additional_environment.rb \
		"$pkgdir"/etc/redmine/additional_environment.rb
	cd "$pkgdir/$_webapps/$pkgname"/config
	# link config to webapps dir
	ln -s /etc/redmine/database.yml
	ln -s /etc/redmine/configuration.yml
	ln -s /etc/redmine/additional_environment.rb
	cd "$pkgdir/$_webapps/$pkgname"
	mkdir -p tmp tmp/pdf public/plugin_assets \
		"$pkgdir"/var/log
	chmod -R 755 files log tmp public/plugin_assets
	# move redmine log to /var/log
	mv log "$pkgdir"/var/log/$pkgname
	# symlink logs to var log
	ln -s /var/log/redmine log
	# set correct permissions
	chown -R $pkgusers:$pkggroups \
		"$pkgdir/$_webapps/$pkgname" \
		"$pkgdir"/var/log/"$pkgname"
}

md5sums="bf63ceef4fde0d38d17d94969478d422  redmine-3.0.1.tar.gz
6115e9c82b7af28cb6849a1f8ad55c0d  gemfile.patch
06fa866e699a6f867603f886be3a5eea  additional_environment.rb
7347eb8fa89144c8a0ca292702203803  configuration.yml
05e17d7ca4a268b7ab7d3b6a9f5f3fcb  database.yml"
sha256sums="9b701ff471bf1d9c9fd671e6a3d3c426850df5411a73f891f49c2cd79d489d5a  redmine-3.0.1.tar.gz
3dce0dccce0931e26d81546ba2c87b776da92a1e532e560f18b2355e378c92a0  gemfile.patch
fc151100cad99bec40cd57eefcf05917b760cd1d189609b0da3c2454916363e0  additional_environment.rb
5f17d5f2e37b4487c44154b2f212811d3a52fa1b7a0bcc9664e3caac80aa887c  configuration.yml
243bf7ec026af6d158706f9275d40fd046a6038200664b9329fba25b4697816f  database.yml"
sha512sums="689e8625197b4668bc06c68b0502a23e50675ad13d17a67a25cb51d68b1ac15ff4395783003ce696994bd15191139adde6bc21add0b81b4a40e9979e95753e18  redmine-3.0.1.tar.gz
5cd897dd296c4f89500bb607f2e0898e0af8ec10292f23d16dbb9ea686d10a6bd2b1a9bfdec2aa722461a02ae73ba5160115e5d9ec78031387c7c337eba56ede  gemfile.patch
0ac637c140ace5760067917db755a65add5362a8fbda87bdbe17c1f39c46861ecfbe096fe5d4e9ff2525d325ebd46ca995049f9cb326e376cc9074843bd0051a  additional_environment.rb
a62ac016fc3e58db7db453bdb779cd0d542a610cf7d1be2fdb07d39a1531c558d81af3d91adafffee28311387b65079faf3ee3bc9c14dd12ceb5bac83254fdbd  configuration.yml
a6a52d469ce390331124908bad650c190236b86439f7e38bfc2ff738c82182915ad4c35365533f6eed1216a47ef0f3fe7185e5a4107f6e7c8646222804743112  database.yml"
