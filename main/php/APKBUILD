# Contributor: Carlo Landmeter <clandmeter at gmail>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=php
pkgver=5.3.3
_suhosinver=${pkgver}-0.9.10
pkgrel=5
pkgdesc="The PHP language runtime engine"
url="http://www.php.net/"
license="PHP-3"
depends=
install="$pkgname.post-upgrade"
makedepends="pcre-dev libxml2-dev libiconv-dev openssl-dev zlib-dev bzip2-dev
	curl-dev libpng-dev jpeg-dev freetype-dev libmcrypt-dev mysql-dev
	sqlite-dev libtool libltdl postgresql-dev db-dev unixodbc-dev icu-dev
	gd-dev gmp-dev gettext-dev imap-dev aspell-dev
	net-snmp-dev libxslt-dev cyrus-sasl-dev openldap-dev pkgconfig
	libgcrypt-dev apache2-dev apr-dev apr-util-dev libevent-dev"
subpackages="$pkgname-dev $pkgname-doc $pkgname-cli $pkgname-fpm $pkgname-pear
	$pkgname-apache2
	$pkgname-bcmath
	$pkgname-bz2
	$pkgname-calendar
	$pkgname-curl
	$pkgname-dba
	$pkgname-exif
	$pkgname-ftp
	$pkgname-gd
	$pkgname-gettext
	$pkgname-gmp
	$pkgname-iconv
	$pkgname-imap
	$pkgname-intl
	$pkgname-json
	$pkgname-ldap
	$pkgname-mcrypt
	$pkgname-mysql
	$pkgname-mysqli
	$pkgname-odbc
	$pkgname-openssl
	$pkgname-pdo
	$pkgname-pdo_mysql
	$pkgname-pdo_odbc
	$pkgname-pdo_pgsql
	$pkgname-pdo_sqlite
	$pkgname-pgsql
	$pkgname-phar
	$pkgname-posix
	$pkgname-pspell
	$pkgname-shmop
	$pkgname-snmp
	$pkgname-soap
	$pkgname-sockets
	$pkgname-sqlite
	$pkgname-sqlite3
	$pkgname-sysvmsg
	$pkgname-sysvsem
	$pkgname-sysvshm
	$pkgname-xml
	$pkgname-xmlrpc
	$pkgname-xsl
	$pkgname-zip
	$pkgname-zlib
	"

source="http://www.php.net/distributions/${pkgname}-${pkgver}.tar.bz2
        http://download.suhosin.org/suhosin-patch-${_suhosinver}.patch.gz
	php-install-pear-xml.patch
	php-uclibc.patch
	php-fpm.init
	"

_extdir="/usr/lib/php/20090626"

prepare() {
        cd "$srcdir/$pkgname-$pkgver"
	# beat the pear installer into using xml.so
	patch -p1 -i "$srcdir"/php-install-pear-xml.patch || return 1
	patch -p1 -i "$srcdir"/php-uclibc.patch || return 1
}

build() {
        cd "$srcdir/$pkgname-$pkgver"

	# apply suhosin patch
	gunzip -c ${srcdir}/suhosin-patch-${_suhosinver}.patch.gz \
		| patch -p1 || return 1

	phpextensions="--enable-bcmath=shared \
		--enable-calendar=shared \
		--enable-dba=shared \
		--enable-exif=shared \
		--enable-ftp=shared \
		--enable-gd-native-ttf \
		--enable-intl=shared \
		--enable-json=shared \
		--enable-mbregex \
		--enable-mbstring \
		--enable-pdo=shared \
		--enable-phar=shared \
		--enable-posix=shared \
		--enable-session \
		--enable-shmop=shared \
		--enable-soap=shared \
		--enable-sockets=shared \
		--enable-sqlite-utf8 \
		--enable-sysvmsg=shared \
		--enable-sysvsem=shared \
		--enable-sysvshm=shared \
		--enable-xml=shared \
		--enable-zip=shared \
		--with-bz2=shared \
		--with-curl=shared \
		--with-db4=shared \
		--with-freetype-dir=shared,/usr \
		--with-gd=shared,/usr \
		--with-gettext=shared \
		--with-gmp=shared \
		--with-iconv=shared \
		--with-icu-dir=/usr \
		--with-imap-ssl=shared \
		--with-imap=shared \
		--with-jpeg-dir=shared,/usr \
		--with-ldap=shared \
		--with-mcrypt=shared \
		--with-mysql-sock=/var/run/mysqld/mysqld.sock \
		--with-mysql=shared,mysqlnd \
		--with-mysqli=shared,mysqlnd \
		--with-openssl=shared \
		--with-pcre-regex=/usr \
		--with-pdo-mysql=shared,mysqlnd \
		--with-pdo-odbc=shared,unixODBC,/usr \
		--with-pdo-pgsql=shared \
		--with-pdo-sqlite=shared,/usr \
		--with-pgsql=shared \
		--with-png-dir=shared,/usr \
		--with-pspell=shared \
		--with-regex=php \
		--with-snmp=shared \
		--with-sqlite3=shared,/usr \
		--with-sqlite=shared \
		--with-unixODBC=shared,/usr \
		--with-xmlrpc=shared \
		--with-xsl=shared \
		--with-zlib=shared \
		--without-db1 \
		--without-db2 \
		--without-db3 \
		--without-qdbm \
		"
#		--with-enchant=shared,/usr \
#		--with-tidy=shared \


	phpextensionsapache2="--enable-bcmath=shared \
		--enable-calendar=shared \
		--enable-dba=shared \
		--enable-exif=shared \
		--enable-ftp=shared \
		--enable-gd-native-ttf \
		--enable-intl=shared \
		--enable-json=shared \
		--enable-mbregex \
		--enable-mbstring \
		--enable-pdo=shared \
		--enable-phar=shared \
		--enable-posix=shared \
		--enable-session \
		--enable-shmop=shared \
		--enable-soap=shared \
		--enable-sockets=shared \
		--disable-sqlite \
		--enable-sysvmsg=shared \
		--enable-sysvsem=shared \
		--enable-sysvshm=shared \
		--enable-xml=shared \
		--enable-zip=shared \
		--with-bz2=shared \
		--with-curl=shared \
		--with-db4=shared \
		--with-freetype-dir=shared,/usr \
		--with-gd=shared,/usr \
		--with-gettext=shared \
		--with-gmp=shared \
		--with-iconv=shared \
		--with-icu-dir=/usr \
		--with-imap-ssl=shared \
		--with-imap=shared \
		--with-jpeg-dir=shared,/usr \
		--with-ldap=shared \
		--with-mcrypt=shared \
		--with-mysql-sock=/var/run/mysqld/mysqld.sock \
		--with-mysql=shared,mysqlnd \
		--with-mysqli=shared,mysqlnd \
		--with-openssl=shared \
		--with-pcre-regex=/usr \
		--with-pdo-mysql=shared,mysqlnd \
		--with-pdo-odbc=shared,unixODBC,/usr \
		--with-pdo-pgsql=shared \
		--without-pdo-sqlite \
		--with-pgsql=shared \
		--with-png-dir=shared,/usr \
		--with-pspell=shared \
		--with-regex=php \
		--with-snmp=shared \
		--without-sqlite3 \
		--without-sqlite \
		--with-unixODBC=shared,/usr \
		--with-xmlrpc=shared \
		--with-xsl=shared \
		--with-zlib=shared \
		--without-db1 \
		--without-db2 \
		--without-db3 \
		--without-qdbm \
		"

        ./configure --build=${CHOST:-i486-alpine-linux-uclibc} \
		--prefix=/usr \
		--sysconfdir=/etc/php \
		--with-layout=GNU \
		--with-config-file-path=/etc/php \
		--with-config-file-scan-dir=/etc/php/conf.d \
		--enable-inline-optimization \
		--disable-debug \
		--disable-rpath \
		--disable-static \
		--enable-shared \
		--mandir=/usr/share/man \
		--enable-fastcgi \
		--enable-cgi \
		--enable-cli \
		--enable-fpm \
		--enable-discard-path \
		--enable-force-cgi-redirect \
		--with-pic \
		$phpextensions

	# see #183
	sed -i -e '/^BUILD_CGI/s/$(LDFLAGS)/-lpthread $(LDFLAGS)/' Makefile

        make || return 1

	# Need seperate configure string for apache subpkg
	mkdir -p "$srcdir"/php-apache2
	cp -R "$srcdir"/$pkgname-$pkgver/* "$srcdir"/php-apache2
	cd "$srcdir"/php-apache2
	make clean
        ./configure --build=${CHOST:-i486-alpine-linux-uclibc} \
                    --prefix=/usr \
                    --sysconfdir=/etc/php \
                    --with-layout=GNU \
                    --with-config-file-path=/etc/php \
                    --with-config-file-scan-dir=/etc/php/conf.d \
                    --enable-inline-optimization \
                    --disable-debug \
                    --disable-rpath \
                    --disable-static \
                    --enable-shared \
                    --mandir=/usr/share/man \
                    --enable-fastcgi \
                    --enable-cgi \
                    --disable-cli \
                    --enable-discard-path \
                    --enable-force-cgi-redirect \
                    --with-pic \
		    --with-apxs2 \
                    ${phpextensionsapache2}


        make || return 1
}

package() {
        cd "$srcdir/$pkgname-$pkgver"
        make -j1 INSTALL_ROOT="$pkgdir" install || return 1
        install -D -m644 php.ini-production "$pkgdir"/etc/php/php.ini
	sed -i -e "s:^; extension_dir = \"./\":extension_dir = \"$_extdir\":" "$pkgdir"/etc/php/php.ini
}

apache2() {
       cd "$srcdir"/php-apache2
       mkdir -p "$subpkgdir"/usr/lib/apache2/  
       mkdir -p "$subpkgdir"/etc/apache2/conf.d/
       install -D -m755 libs/libphp5.so "$subpkgdir"/usr/lib/apache2/libphp5.so
       install -D -m644 ../../php5-module.conf "$subpkgdir"/etc/apache2/conf.d/php5-module.conf
}

cli() {
	pkgdesc="PHP command line interface"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/php "$subpkgdir"/usr/bin/
}

fpm() {
	pkgdesc="PHP Fast Process Manager (FPM) interface"
	mkdir -p "$subpkgdir"/usr/bin
	mkdir -p "$subpkgdir"/etc/php
	mv "$pkgdir"/usr/sbin/php-fpm "$subpkgdir"/usr/bin/php-fpm
	mv "$pkgdir"/etc/php/php-fpm.conf.default "$subpkgdir"/etc/php/php-fpm.conf
	install -D -m755 "$srcdir"/php-fpm.init "$subpkgdir"/etc/init.d/php-fpm
}

pear() {
	depends="php php-cli"
	mkdir -p "$subpkgdir"/usr/bin
	mkdir -p "$subpkgdir"/usr/share
	mkdir -p "$subpkgdir"/etc/php
	mv "$pkgdir"/usr/share/pear "$subpkgdir"/usr/share/
	mv "$pkgdir"/usr/bin/pear* "$subpkgdir"/usr/bin/
	mv "$pkgdir"/usr/bin/pecl "$subpkgdir"/usr/bin/
	mv "$pkgdir"/etc/php/pear.conf "$subpkgdir"/etc/php/
}

_mv_mod() {
	pkgdesc="$1 php extension"
	mkdir -p "$subpkgdir/$_extdir"
	mv "$pkgdir/$_extdir/${1}.so" "$subpkgdir/$_extdir/" || return 1
	install -d "$subpkgdir"/etc/php/conf.d
	echo "extension=${1}.so" > "$subpkgdir"/etc/php/conf.d/${1}.ini
	return 0
}

bcmath()	{ _mv_mod bcmath; }
bz2()		{ _mv_mod bz2; }
calendar()	{ _mv_mod calendar; }
curl()		{ _mv_mod curl; }
dba()		{ _mv_mod dba; }
#enchant()	{ _mv_mod enchant; }
exif()		{ _mv_mod exif; }
ftp()		{ _mv_mod ftp; }
gd()		{ _mv_mod gd; }
gettext()	{ _mv_mod gettext; }
gmp()		{ _mv_mod gmp; }
iconv()		{ _mv_mod iconv; }
imap()		{ _mv_mod imap; }
intl()		{ _mv_mod intl; }
json()		{ _mv_mod json; }
ldap()		{ _mv_mod ldap; }
mcrypt()	{ _mv_mod mcrypt; }
mysql()		{ _mv_mod mysql; }
mysqli()	{ _mv_mod mysqli; }
odbc()		{ _mv_mod odbc; }
openssl()	{ _mv_mod openssl; }
pdo()		{ _mv_mod pdo; }
pdo_mysql()	{ _mv_mod pdo_mysql; }
pdo_odbc()	{ _mv_mod pdo_odbc; }
pdo_pgsql()	{ _mv_mod pdo_pgsql; }
pdo_sqlite()	{ _mv_mod pdo_sqlite; }
phar()		{ _mv_mod phar; }
posix()		{ _mv_mod posix; }
pgsql()		{ _mv_mod pgsql; }
pspell()	{ _mv_mod pspell; }
#session()	{ _mv_mod session; }
shmop()		{ _mv_mod shmop; }
snmp()		{ _mv_mod snmp; }
soap()		{ _mv_mod soap; }
sockets()	{ _mv_mod sockets; }
sqlite()	{ _mv_mod sqlite; }
sqlite3()	{ _mv_mod sqlite3; }
sysvmsg()	{ _mv_mod sysvmsg; }
sysvsem()	{ _mv_mod sysvsem; }
sysvshm()	{ _mv_mod sysvshm; }
xml()		{ _mv_mod xml; }
xmlrpc()	{ _mv_mod xmlrpc; }
xsl()		{ _mv_mod xsl; }
zip()		{ _mv_mod zip; }
zlib()		{ _mv_mod zlib; }

# devleoper package
dev() {
	default_dev
	mkdir -p "$subpkgdir"/usr/lib/php/ "$subpkgdir"/usr/bin/
	mv "$pkgdir"/usr/lib/php/build "$subpkgdir"/usr/lib/php/
	mv "$pkgdir"/usr/bin/phpize "$subpkgdir"/usr/bin/
}

md5sums="21ceeeb232813c10283a5ca1b4c87b48  php-5.3.3.tar.bz2
b66b27c43b1332400ef8982944c3b95b  suhosin-patch-5.3.3-0.9.10.patch.gz
5111e3be06d391f8772587c675240fab  php-install-pear-xml.patch
26adfe0e744ec05fa9e368bbdee83176  php-uclibc.patch
8f2bb2b744a2de50025842cb51fb6a3a  php-fpm.init"
