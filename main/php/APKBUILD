# Contributor: Carlo Landmeter <clandmeter at gmail>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=php
pkgver=5.3.0
pkgrel=0
pkgdesc="The PHP language runtime engine"
url="http://www.php.net/"
license="PHP-3"
depends=
install="$pkgname.post-upgrade"
makedepends="pcre-dev libxml2-dev libiconv-dev openssl-dev zlib-dev bzip2-dev
	curl-dev libpng-dev jpeg-dev freetype-dev libmcrypt-dev mysql-dev
	sqlite-dev libtool libltdl postgresql-dev"
subpackages="$pkgname-doc $pkgname-dev $pkgname-bcmath $pkgname-bz2
	$pkgname-calendar $pkgname-curl $pkgname-exif $pkgname-ftp $pkgname-gd
	$pkgname-iconv $pkgname-json $pkgname-mcrypt
	$pkgname-mysql $pkgname-mysqli $pkgname-openssl $pkgname-pdo
	$pkgname-pdo_mysql $pkgname-pdo_sqlite $pkgname-posix $pkgname-session
	$pkgname-shmop $pkgname-soap $pkgname-sockets $pkgname-sqlite
	$pkgname-sysvmsg $pkgname-sysvsem $pkgname-sysvshm $pkgname-xmlrpc
	$pkgname-zip $pkgname-zlib $pkgname-postgresql $pkgname-pdo_pgsql"
source="http://www.php.net/distributions/${pkgname}-${pkgver}.tar.bz2"

build() {
        cd "$srcdir/$pkgname-$pkgver"

        ./configure --build=${CHOST:-i486-alpine-linux-uclibc} \
		--prefix=/usr \
		--sysconfdir=/etc/php \
		--with-layout=GNU \
		--with-config-file-path=/etc/php \
		--with-config-file-scan-dir=/etc/php/conf.d \
		--enable-inline-optimization \
		--disable-debug \
		--disable-rpath \
		--disable-static \
		--enable-shared \
		--mandir=/usr/share/man \
		--with-openssl=shared \
		--with-zlib=shared \
		--enable-bcmath=shared \
		--with-bz2=shared \
		--enable-calendar=shared \
		--with-curl=shared \
		--enable-exif=shared \
		--enable-ftp=shared \
		--with-gd=shared \
		--with-jpeg-dir=shared,/usr \
		--with-png-dir=shared,/usr \
		--enable-gd-native-ttf \
		--enable-mbstring=shared \
		--with-mcrypt=shared \
		--with-mysql=shared \
		--with-mysql-sock=/tmp/mysql.sock \
		--with-mysql=shared \
		--with-mysqli=shared \
		--with-pear=/usr/share/pear \
		--enable-pdo=shared \
		--with-pdo-mysql=shared \
		--with-pdo-sqlite=shared,/usr \
		--enable-fastcgi \
		--with-sqlite=shared \
		--enable-sqlite-utf8 \
		--enable-shmop=shared \
		--enable-soap=shared \
		--enable-sysvmsg=shared \
		--enable-sysvsem=shared \
		--enable-sysvshm=shared \
		--enable-zip=shared \
		--enable-posix=shared \
		--enable-sockets=shared \
		--enable-xml \
		--with-ttf=shared \
		--enable-session=shared \
		--with-regex=php \
		--with-pcre-regex=/usr \
		--enable-mbstring=all \
		--enable-mbregex \
		--enable-json=shared \
		--with-iconv=shared \
		--with-xmlrpc=shared \
		--enable-cgi \
		--with-freetype-dir=shared,/usr \
		--with-fileinfo=shared \
		--enable-discard-path \
		--enable-force-cgi-redirect \
		--disable-cli \
		--with-pgsql=shared \
		--with-pdo-pgsql=shared \
		--with-pic

        make || return 1
        make -j1 INSTALL_ROOT="$pkgdir" install || return 1
        install -D -m644 php.ini-production "$pkgdir"/etc/php/php.ini
}

_mv_mod() {
	local d=usr/lib/php/20090626
	mkdir -p "$subpkgdir/$d"
	mv "$pkgdir/$d/${1}.so" "$subpkgdir/$d/" || return 1
	# last one removed the dir
	rmdir "$pkgdir/$d" 2>/dev/null
	return 0
}

bcmath()	{ _mv_mod bcmath; }
bz2()		{ _mv_mod bz2; }
calendar()	{ _mv_mod calendar; }
curl()		{ _mv_mod curl; }
exif()		{ _mv_mod exif; }
ftp()		{ _mv_mod ftp; }
gd()		{ _mv_mod gd; }
iconv()		{ _mv_mod iconv; }
json()		{ _mv_mod json; }
mcrypt()	{ _mv_mod mcrypt; }
# mime_magic()	{ _mv_mod mime_magic; }
mysql()		{ _mv_mod mysql; }
mysqli()	{ _mv_mod mysqli; }
openssl()	{ _mv_mod openssl; }
pdo()		{ _mv_mod pdo; }
pdo_mysql()	{ _mv_mod pdo_mysql; }
pdo_sqlite()	{ _mv_mod pdo_sqlite; }
posix()		{ _mv_mod posix; }
session()	{ _mv_mod session; }
shmop()		{ _mv_mod shmop; }
soap()		{ _mv_mod soap; }
sockets()	{ _mv_mod sockets; }
sqlite()	{ _mv_mod sqlite; }
sysvmsg()	{ _mv_mod sysvmsg; }
sysvsem()	{ _mv_mod sysvsem; }
sysvshm()	{ _mv_mod sysvshm; }
xmlrpc()	{ _mv_mod xmlrpc; }
zip()		{ _mv_mod zip; }
zlib()		{ _mv_mod zlib; }
postgresql()	{ _mv_mod pgsql; }
pdo_pgsql()	{ _mv_mod pdo_pgsql; }

# devleoper package
dev() {
	default_dev
	mkdir -p "$subpkgdir"/usr/lib/php/
	mv "$pkgdir"/usr/lib/php/build "$subpkgdir"/usr/lib/php/
}

md5sums="846760cd655c98dfd86d6d97c3d964b0  php-5.3.0.tar.bz2"
