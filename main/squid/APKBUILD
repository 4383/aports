# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=squid
pkgver=3.3.12
pkgrel=0
pkgdesc="A full-featured Web proxy cache server."
url="http://www.squid-cache.org"
install="squid.pre-install squid.pre-upgrade"
pkgusers="squid"
pkggroups="squid"
arch="all"
license="GPL-2"
depends="logrotate"
makedepends="openssl-dev perl-dev autoconf automake heimdal-dev libtool
	libcap-dev"
subpackages="$pkgname-doc"
linguas="af ar az bg ca cs da de el es et fa fi fr he hu hy id it ja ko lt
	lv ms nl oc pl pt ro ru sk sl sr sv th tr uk uz vi zh"
langdir="/usr/share/squid/errors"

source="http://www.squid-cache.org/Versions/v3/3.3/squid-$pkgver.tar.bz2
	squid-3.3.9-loggable-urlgroup.patch
	cf_gen-pthread.patch
	bug-3679.patch
	squid.initd
	squid.confd
	$pkgname.logrotate
	"

pkgusers="squid"
pkggroups="squid"

_builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
#	./bootstrap.sh
}

build() {
	cd "$_builddir"

	./configure --prefix=/usr \
		--datadir=/usr/share/squid \
		--sysconfdir=/etc/squid \
		--libexecdir=/usr/lib/squid \
		--localstatedir=/var \
		--with-logdir=/var/log/squid \
		--disable-strict-error-checking \
		--enable-removal-policies="lru,heap" \
		--enable-digest-auth-helpers="password" \
		--enable-basic-auth-helpers="getpwnam,NCSA,SMB,MSNT,multi-domain-NTLM,squid_radius_auth" \
		--enable-epoll \
		--enable-external-acl-helpers="ip_user,unix_group,wbinfo_group" \
		--enable-ntlm-auth-helpers="fakeauth,no_check,smb_lm" \
		--enable-negotiate-auth-helpers="squid_kerb_auth" \
		--disable-mit \
		--enable-heimdal \
		--enable-delay-pools \
		--enable-arp-acl \
		--enable-ssl \
		--enable-linux-netfilter \
		--enable-ident-lookups \
		--enable-useragent-log \
		--enable-cache-digests \
		--enable-referer-log \
		--enable-async-io \
		--enable-truncate \
		--enable-arp-acl \
		--enable-htcp \
		--enable-carp \
		--enable-poll \
		--with-filedescriptors=16384 \
		--enable-follow-x-forwarded-for \
		--with-large-files \
		--with-default-user=squid \
		|| return 1

	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/squid

	install -d -o squid -g squid \
		"$pkgdir"/var/cache/squid \
		"$pkgdir"/var/log/squid \
		"$pkgdir"/var/run/squid
	chmod +x "$pkgdir"/usr/lib/squid/*
}

squid_kerb_auth() {
	pkgdesc="Squid kerberos authetication helper"
	install -d "$subpkgdir"/usr/lib/squid
	mv "$pkgdir"/usr/lib/squid/squid_kerb_auth "$subpkgdir"/usr/lib/squid/
}

md5sums="08c22a6b85b1c3f85ad92152ed1bd385  squid-3.3.12.tar.bz2
31b771f75d155f3d0bee76a246040894  squid-3.3.9-loggable-urlgroup.patch
473f8f6dabaec2bd73134d8288deea3d  cf_gen-pthread.patch
9e71076799d334faba6f4954594e7b4a  bug-3679.patch
905e57c6d41414f54a75a5c0f9f7fac7  squid.initd
2897c725c201be53d3c9a7db0101bdf0  squid.confd
58823e0b86bc2dc71d270208b7b284b4  squid.logrotate"
sha256sums="18781e700b950f58a1b669a8be4c60d5ca218131f6a2fc1263c2a453befa05a0  squid-3.3.12.tar.bz2
0a4192ab1df22db309f35d4dcd80414bede84a591776ba7ef775e9e443663c1e  squid-3.3.9-loggable-urlgroup.patch
3b05ebd2d4baeb0e01437de768c8fbe76ff446f126d107b73fad6bd0d1968f0c  cf_gen-pthread.patch
6b08cd129ea5fef019c78f1818c628e1070fe767e362da14844396b671f5a18d  bug-3679.patch
3e5786304f218aecd5c01fa4b81aa05092ee3c7652d914b01112222fb5b2796e  squid.initd
ec2a9f3308129354783c5088fb37148eda102fe9397fb7bbe90243d9223ee2e1  squid.confd
b6efdb3261c2e4b5074ef49160af8b96e65f934c7fd64b8954df48aa41cd9b67  squid.logrotate"
sha512sums="ffbf8c13a7f124cd3bf6ec29b90c9f7f60228a928dafc406f912ae0437c1ea948b5ebe66d1524dddd294c1a47e0bccc1a05d8ce08d11c785fe2a99c704f42d95  squid-3.3.12.tar.bz2
80360600275cb1b9c484c41c169dedc841c92fa519e9f146bb66fdb947b2dc897a72d49509180f88c4d9fb373457c9117838599ad41e272ecb2972738e905b7f  squid-3.3.9-loggable-urlgroup.patch
c5a230fe1f4dda8a3ab064f07c2b93a6f6e3ebdf290cb45da262300d06ac28aa4470a80c8f14db5c9ff4dcc478933d9882bef638a566fe8ad66aec1f96f80be3  cf_gen-pthread.patch
b477397f205ba207502a42aae674c85cad85eec831158ea0834361d98ef09a0f103d7a847e101bdd0ece73bbdda9b545960edd5385042bd593733810977e292a  bug-3679.patch
d16178aef007bafa976b89def4371fdd05f26c5ab558f6619bf6f6ca915fc783d2314d7d8e96032abfaf7b3f8c8b746031f78a6be1f66245d9303ff3a9feb605  squid.initd
f13b3ab159fdc7cdcccfe10e494a84fa2d67c999820e166a8ad67523094088c147d3712b00e9cfd0d6b7e3c0cc9a4ad3ee7d7f7d42e11f5b5c4b5e4bf5016b31  squid.confd
89a703fa4f21b6c7c26e64a46fd52407e20f00c34146ade0bea0c4b63d050117c0f8e218f2256a1fbf6abb84f4ec9b0472c9a4092ff6e78f07c4f5a25d0892a5  squid.logrotate"
