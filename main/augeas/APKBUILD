# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=augeas
pkgver=1.0.0
pkgrel=2
pkgdesc="A configuration editing tool"
url="http://augeas.net"
arch="all"
license="LGPL2+"
depends=""
depends_dev="libxml2-dev"
makedepends="$depends_dev readline-dev"
install=""
subpackages="$pkgname-dev $pkgname-doc $pkgname-tests $pkgname-libs"
source="http://download.augeas.net/augeas-$pkgver.tar.gz
	CVE-2013-6412.patch"

_builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	# fix eglibc-2.16+ build issue
	sed -i -e '/gets is a/d' \
		gnulib/lib/stdio.in.h \
		|| return 1
}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info
	make || return 1
	make tests || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	rm "$pkgdir"/usr/lib/*.la || return 1
}

tests() {
	pkgdesc="Tests for Augeas lenses"
	arch="noarch"
	mkdir -p "$subpkgdir"/usr/share/augeas/lenses/dist/
	mv "$pkgdir"/usr/share/augeas/lenses/dist/tests \
		"$subpkgdir"/usr/share/augeas/lenses/dist/
}

libs() {
	pkgdesc="Libraries for augeas"
	replaces="augeas"
	mkdir -p "$subpkgdir"/usr/ "$subpkgdir"/usr/share/augeas/
	mv "$pkgdir"/usr/lib "$subpkgdir"/usr/ || return 1
	mv "$pkgdir"/usr/share/augeas/lenses \
		"$subpkgdir"/usr/share/augeas/ || return 1
}

md5sums="82131019432ecf8102e1491610ad2dd1  augeas-1.0.0.tar.gz
90f48a055dfda363eb518902358d857c  CVE-2013-6412.patch"
sha256sums="31bf757c5b8197765946b3805f3793c32b03cd92a7a77ec95d37e71a1f131912  augeas-1.0.0.tar.gz
c323c75dc12d41d5b79e9825dcee496791830068b69dcd7b08b69694752a3db4  CVE-2013-6412.patch"
sha512sums="63744d9021e5965d61416beb8193506468e9c79c154e40f3ad46c487d5a26d93f6a31d5b0946d4c5d87e1682e29ee386124a30f9dd6d60621542de456975793a  augeas-1.0.0.tar.gz
a9f570c12f0212b37574b26f566e3c43f2ed7267c5db9672673f08a5f1037d5d7ea3b7aadb3c00cdb3dd3163b420ae3144d3bcb0a78ea01dfc14c80f435d062d  CVE-2013-6412.patch"
