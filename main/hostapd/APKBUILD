# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=hostapd
pkgver=2.3
pkgrel=2
pkgdesc="daemon for wireless software access points"
url="http://hostap.epitest.fi/hostapd/"
arch="all"
license="custom"
depends=
makedepends="openssl-dev libnl-dev"
install=
subpackages="$pkgname-doc"
patches="
	musl-fix-types.patch
	CVE-2012-4445.patch
	0001-EAP-pwd-peer-Fix-payload-length-validation-for-Commi.patch
	0002-EAP-pwd-server-Fix-payload-length-validation-for-Com.patch
	0003-EAP-pwd-peer-Fix-Total-Length-parsing-for-fragment-r.patch
	0004-EAP-pwd-server-Fix-Total-Length-parsing-for-fragment.patch
	0005-EAP-pwd-peer-Fix-asymmetric-fragmentation-behavior.patch
	CVE-2015-1863.patch
	CVE-2015-4141.patch
	CVE-2015-4142.patch
	0001-WPS-Reject-a-Credential-with-invalid-passphrase.patch
	"



source="http://hostap.epitest.fi/releases/$pkgname-$pkgver.tar.gz
	$patches
	$pkgname.initd
	$pkgname.confd"


_builddir="$srcdir"/$pkgname-$pkgver/hostapd

prepare() {
	local conf="$_builddir/.config"

	cd "$_builddir"/..
	for i in $patches; do
		msg $i
		patch -p1 -i "$srcdir"/$i || return 1
	done

	cd "$_builddir"
	sed -i -e "s:/etc/hostapd:/etc/hostapd/hostapd:g" \
		hostapd.conf

	# toolchain setup
	echo "CC = ${CC:-gcc}" > $conf

	# EAP authentication methods
	echo "CONFIG_EAP=y" >> $conf
	echo "CONFIG_EAP_MD5=y" >> $conf

	# SSL authentication methods
	echo "CONFIG_EAP_TLS=y" >> $conf
	echo "CONFIG_EAP_TTLS=y" >> $conf
	echo "CONFIG_EAP_MSCHAPV2=y" >> $conf
	echo "CONFIG_EAP_PEAP=y" >> $conf

	# Enable Wi-Fi Protected Setup
	echo "CONFIG_WPS=y" >> $conf
	echo "CONFIG_WPS_UPNP=y" >> $conf

	echo "CONFIG_EAP_GTC=y" >> $conf
	echo "CONFIG_EAP_SIM=y" >> $conf
	echo "CONFIG_EAP_AKA=y" >> $conf
	echo "CONFIG_EAP_PAX=y" >> $conf
	echo "CONFIG_EAP_PSK=y" >> $conf
	echo "CONFIG_EAP_SAKE=y" >> $conf
	echo "CONFIG_EAP_GPSK=y" >> $conf
	echo "CONFIG_EAP_GPSK_SHA256=y" >> $conf

	# drivers
	echo "CONFIG_DRIVER_HOSTAP=y" >> $conf
	echo "CONFIG_DRIVER_WIRED=y" >> $conf
	echo "CONFIG_DRIVER_PRISM54=y" >> $conf

	# Add include path for madwifi-driver headers
#	echo "CFLAGS += -I/usr/include/madwifi" >> $conf
#	echo "CONFIG_DRIVER_MADWIFI=y" >> $conf

	# enable nl80211 driver"
	echo "CONFIG_DRIVER_NL80211=y" >> $conf
	echo "CFLAGS += -I/usr/include/netlink" >> $conf
	echo "LIBS += -L/usr/lib" >> $conf

	# misc
	echo "CONFIG_PKCS12=y" >> $conf
	echo "CONFIG_RADIUS_SERVER=y" >> $conf
	echo "CONFIG_IAPP=y" >> $conf
	echo "CONFIG_IEEE80211R=y" >> $conf
	echo "CONFIG_IEEE80211W=y" >> $conf
	echo "CONFIG_IEEE80211N=y" >> $conf
	echo "CONFIG_PEERKEY=y" >> $conf
	echo "CONFIG_RSN_PREAUTH=y" >> $conf

	# IPv6 support
	echo "CONFIG_IPV6=y" >> $conf
}

build() {
	cd "$_builddir"
	make || return 1

	make nt_password_hash || return 1 
	make hlr_auc_gw || return 1
}

package() {
	cd "$_builddir"
	install -d "$pkgdir"/etc/hostapd
	install hostapd.conf hostapd.accept hostapd.deny hostapd.eap_user \
		hostapd.radius_clients hostapd.sim_db hostapd.wpa_psk \
		"$pkgdir"/etc/hostapd/ || return 1

	install -Dm755 hostapd "$pkgdir"/usr/sbin/hostapd \
		&& install -Dm755 hostapd_cli "$pkgdir"/usr/bin/hostapd_cli \
		&& install -Dm755 nt_password_hash \
			"$pkgdir"/usr/bin/nt_password_hash \
		&& install -Dm755 hlr_auc_gw "$pkgdir"/usr/bin/hlr_auc_gw \
		&& install -Dm755 "$srcdir"/hostapd.initd \
			"$pkgdir"/etc/init.d/hostapd \
		&& install -Dm644 "$srcdir"/hostapd.confd \
			"$pkgdir"/etc/conf.d/hostapd \
		&& install -Dm644 hostapd.8 \
			"$pkgdir"/usr/share/man/man8/hostapd.8 \
		&& install -Dm644 hostapd_cli.1 \
			"$pkgdir"/usr/share/man/man1/hostapd_cli \
		|| return 1
}

md5sums="40b89c61036add0c2dd1fc10767d3b5f  hostapd-2.3.tar.gz
1ed73d28faae5d004bd8e34891df6eea  musl-fix-types.patch
0d01d4641e0c33f79c1f4372613655bf  CVE-2012-4445.patch
87d611a9b704402f66fa59ba1458928d  0001-EAP-pwd-peer-Fix-payload-length-validation-for-Commi.patch
bafcec421e4f5c6a8383893d029a79e5  0002-EAP-pwd-server-Fix-payload-length-validation-for-Com.patch
fa2aed3cf49f7e6c7b17bf9db9a001f5  0003-EAP-pwd-peer-Fix-Total-Length-parsing-for-fragment-r.patch
de0fca4d74a1883d15ef5754f13a5226  0004-EAP-pwd-server-Fix-Total-Length-parsing-for-fragment.patch
9d854969af23b207f9f3dff38ef78770  0005-EAP-pwd-peer-Fix-asymmetric-fragmentation-behavior.patch
8e8c34267fefcc4142ee142e5515b5df  CVE-2015-1863.patch
222ec96a8dc73c41608cc463beac3966  CVE-2015-4141.patch
d3688697f81ca1e684a79dfa3682a111  CVE-2015-4142.patch
5337a17c7df35648f5d544953b4966cd  0001-WPS-Reject-a-Credential-with-invalid-passphrase.patch
de734b22c3ad1e85309b5634d29c6225  hostapd.initd
c91382209042defa04e79d0ae841a29e  hostapd.confd"
sha256sums="c94c2b76876fad4c80a1063a06f958a2189ba5003475016fa7658a1ca49bb4df  hostapd-2.3.tar.gz
35ec232335ccd8329d267bd75b972936e11cc4b487e47a1b73b390bb7551389e  musl-fix-types.patch
06dc7df2159fb0604191f66d35164caa5927963eebe77b5f2c389bd7590e2a49  CVE-2012-4445.patch
a204bc37f52e5346780a306c01706689eb46263dedcdcb1eb2f4c0b291a0db93  0001-EAP-pwd-peer-Fix-payload-length-validation-for-Commi.patch
298fc3b89f987922fb2600d0c95e8c868d6da30d24643748afd47bcd30da7b44  0002-EAP-pwd-server-Fix-payload-length-validation-for-Com.patch
2fd42fb53be793c54343aa18a84afebe4603aa6ce8b6969ad6b3a8d327c6b142  0003-EAP-pwd-peer-Fix-Total-Length-parsing-for-fragment-r.patch
c28ca6303a562809dfd1812f9b918808b3b0f0c52cc43070fd1777e1cfc88f18  0004-EAP-pwd-server-Fix-Total-Length-parsing-for-fragment.patch
04ef66fbd5b2167274cd7123d7f7252963b9a9c1ec2f5edf6558a6ad92d47689  0005-EAP-pwd-peer-Fix-asymmetric-fragmentation-behavior.patch
a3abf75801f02199ff48c316a7b6598860e6ca20ce2fe79b0bec873905e5c8a4  CVE-2015-1863.patch
eb63d845fdc38b6310c527ad1705b6fe3b74f90e263188da2aca97468cc55142  CVE-2015-4141.patch
cc6c488afab4ccfdaedd9e224989b5fe713d6b0415ea94579190bd8ba60c9be5  CVE-2015-4142.patch
d8ab806c9e090867de273df988f38a3a5a91129e5027981cadcfd96577d36029  0001-WPS-Reject-a-Credential-with-invalid-passphrase.patch
4bb2e7bfe8149353bb17ae74c3e6cf3c833af0b00303f7eb1eb4efe9867458e6  hostapd.initd
6c14e88b14bb9a93d2dca69239d829f435e93180e621319aeed0f3987290dfba  hostapd.confd"
sha512sums="e54a3117a86393fc6374c3284f1ec52530d09c33e24f9ff943fd6f277f6140b666f0e5e4ac3a972916ed5c1fe2c7d88b59a416bb5fc451608dae1b33dd3cdffb  hostapd-2.3.tar.gz
9386de2aec75d5aa1da72c37a4fd0607d1666e9d3f0233a33a66a3ca4408cbb4efca1172a5b9b5d78dc88cf7ffab3366f38578a46f07d8aacc56c66b4a8e2cde  musl-fix-types.patch
619acce84516dead1e03e5da71657ea4c4b6f3ca8271574409773aeb316cbddc88095b50320804f457f001f4f3fe83053e660c008d8409f59bb4d3bfe058b601  CVE-2012-4445.patch
9440f8d9d18d20b95d236c1a4467d86dfbbc17d8f26b0caa48d6737c6231d1ff14793c6fc8a1e4508f3ad38c9a5d710fd49b85c7de16634dbe6685af05f44f7c  0001-EAP-pwd-peer-Fix-payload-length-validation-for-Commi.patch
0887017bfdb4632baa49bb849b732eed7eec9a498247fdd5ef8448e4a6df10380c06d68fa706e0b2624c04eb6f5a327cdb71c5c71c3476dc383f889ee7372702  0002-EAP-pwd-server-Fix-payload-length-validation-for-Com.patch
341901aa94c44ae725b6d4dddac2a52b6457234189554fc282c9cf5fa0254125d7323553a7b8118f9a3e2020f039267ed4c912f84ac6f2cb12670b40c28ac652  0003-EAP-pwd-peer-Fix-Total-Length-parsing-for-fragment-r.patch
b752f91c3d6dcf0784d9cb20a0c7f8de6c837c38ff62cf77b136d9b818890b13f55eeed1d6097f244181b480be953e1bdfb5651116dc5d62a2d02c018e19042a  0004-EAP-pwd-server-Fix-Total-Length-parsing-for-fragment.patch
07a21f0cc7d00e17bed8ef5ced36159020a410a4606aa0ca24e47223835ab0cc5fbeed3075c4f17d2ce1aee437eedf9fea8f4b95252b2fa255d54a195637cb6f  0005-EAP-pwd-peer-Fix-asymmetric-fragmentation-behavior.patch
61f90d06bd42fb7ea17ba147db861303f5b1fdce2cda35492cec578214da5ea5d654a1df99dee4d4a0c07ef3e8b3bfb65ab4b98eff21c2013adf536766136ce1  CVE-2015-1863.patch
4633a96a91e151407e4c62b74b4e78d37e4fba586278c6ae4340ce149bee0c644a4d62675256839c3130374a4dc7531beaeed8282946e7dcd3faf1ed74bf99be  CVE-2015-4141.patch
dc561d90f3f329ebb201abbb53eea161603fb2abba6b2fc5c79298d97c84f2d65d401608cd7bb2fb82abf909661c56699bf4bcbf902f6f8c7d5b1853b0277353  CVE-2015-4142.patch
3e596edadc8a44efff1347184c6f4ad160e3a045052e97ea20905cde4ba8b9c4252e319e69ffab1f548328563b623e4e3319a2d5a6780157325a748f5c114a20  0001-WPS-Reject-a-Credential-with-invalid-passphrase.patch
d840249b8f537875948e192665b980884bfc977681e577b27e3c5ae4c9724b0c2123cfee72eebbd0d5a33bf0979d7837fc48f8053e66dd06854cca1e8689b798  hostapd.initd
0882263bbd7c0b05bf51f51d66e11a23a0b8ca7da2a3b8a30166d2c5f044c0c134e6bccb1d02c9e81819ca8fb0c0fb55c7121a08fe7233ccaa73ff8ab9a238fe  hostapd.confd"
