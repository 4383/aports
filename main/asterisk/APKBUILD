# Contributor: Timo Teras <timo.teras@iki.fi>
# Maintainer: Timo Teras <timo.teras@iki.fi>
pkgname=asterisk
pkgver=10.12.4
pkgrel=0
pkgdesc="Asterisk: A Module Open Source PBX System"
pkgusers="asterisk"
pkggroups="asterisk"
url="http://www.asterisk.org/"
arch="all"
license="GPL"
depends=
makedepends="autoconf automake libtool ncurses-dev popt-dev newt-dev zlib-dev
	postgresql-dev unixodbc-dev dahdi-tools-dev libpri-dev tar
	freetds-dev openssl-dev lua-dev alsa-lib-dev spandsp-dev tiff-dev
	libresample sqlite-dev wget speex-dev libogg-dev"
install="$pkgname.pre-install $pkgname.pre-upgrade"
subpackages="$pkgname-dev $pkgname-doc $pkgname-pgsql $pkgname-odbc
	$pkgname-tds $pkgname-fax $pkgname-sample-config:sample
	$pkgname-sounds-moh:sound_moh $pkgname-sounds-en:sound_en"
source="http://downloads.asterisk.org/pub/telephony/asterisk/releases/asterisk-${pkgver/_/-}.tar.gz
	100-uclibc-daemon.patch
	101-caps-uclibc.patch
	900-tryinclude.patch
	ASTERISK-13456.patch
	ASTERISK-18977.patch
	ASTERISK-18995.patch
	ASTERISK-19109.patch
	ASTERISK-20527.patch
	asterisk.initd
	asterisk.confd
	asterisk.logrotate"

_builddir="$srcdir/$pkgname-${pkgver/_/-}"

prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg "$i"; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	sed -i -e 's:lua5.1/::' pbx/pbx_lua.c
	sed -i -e 's/PBX_ICONV=1/PBX_ICONV=0/g' configure.ac
	sed -i -e 's/int foo = res_ninit(NULL);/res_ninit_is_not_really_here();/g' configure.ac

	./bootstrap.sh
}

build() {
	cd "$_builddir"
	SHA1SUM="$PWD"/build_tools/sha1sum-sh ./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--libdir=/usr/lib \
		--localstatedir=/var \
		--disable-xmldoc --with-gsm=internal \
		--without-iconv --with-popt --with-z --with-newt \
		--with-unixodbc --with-postgres --with-tds \
		--with-dahdi --with-pri --with-tonezone \
		--with-resample \
		--with-sqlite3 \
		--with-speex \
		--with-asound \
		--without-x11 \
		--with-spandsp \
		|| return 1

	# and figure out which modules to build
	rm menuselect.makeopts
	make menuselect.makeopts
	make ASTCFLAGS="$CFLAGS" ASTLDFLAGS="$LDFLAGS" || return 1
}

package() {
	cd "$_builddir"
	make -j1 DESTDIR="$pkgdir" install

	install -d "$pkgdir"/var/run/asterisk
	install -d "$pkgdir"/var/lib/asterisk

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$pkgname

	chown -R asterisk:asterisk "$pkgdir"/var/*/asterisk
	chown -R asterisk:asterisk "$pkgdir"/etc/asterisk
	chmod -R u=rwX,g=rX,o= "$pkgdir"/etc/asterisk
}

_move_dir() {
	for DIR in "$@"; do
		local dest=`dirname "$subpkgdir/$DIR"`
		echo mkdir -p $dest
		mkdir -p "$dest"
		echo mv "$pkgdir"/$DIR $dest
		mv "$pkgdir"/"$DIR" "$dest"
	done
}

_find_and_move() {
	local pattern="$1"
	cd "$pkgdir" || return 1
	find -name "$pattern" -type f | while read f; do
		local dest="$subpkgdir/${f%/*}"
		mkdir -p "$dest"
		mv "$f" "$dest"
	done
}

doc() {
	default_doc
}

dev() {
	default_dev
	depends="asterisk"
}

pgsql() {
	depends=
	install=
	_find_and_move '*_pgsql*'
}

odbc() {
	depends=
	install=
	_find_and_move '*odbc*'
}

tds() {
	depends=
	install=
	_find_and_move '*_tds*'
}

fax() {
        depends=
        install=
        _find_and_move '*_fax*'
}

sample() {
	arch="noarch"
	pkgdesc="Sample configuration files for asterisk"
	cd "$_builddir"
	mkdir -p "$subpkgdir"/var/lib/asterisk/phoneprov
	make -j1 samples DESTDIR="$subpkgdir"

	chown -R asterisk:asterisk "$subpkgdir"/var/*/asterisk
	chown -R asterisk:asterisk "$subpkgdir"/etc/asterisk
	chmod -R u=rwX,g=rX,o= "$subpkgdir"/etc/asterisk
}

sound_moh() {
	arch="noarch"
	pkgdesc="Default on-hold music files for asterisk"
	depends=
	install=
	_move_dir var/lib/asterisk/moh
	chown -R asterisk:asterisk "$subpkgdir"/var/*/asterisk
}

sound_en() {
	arch="noarch"
	pkgdesc="English sound files for asterisk"
	depends=
	install=
	_move_dir var/lib/asterisk/sounds/en
	chown -R asterisk:asterisk "$subpkgdir"/var/*/asterisk
}

md5sums="f8c924a5a12dc8af7f75bc15e3e18c52  asterisk-10.12.4.tar.gz
837fc3bc835699462a8d2a7a16b9b6a3  100-uclibc-daemon.patch
6e1129e30c4fd2c25c86c81685a485a9  101-caps-uclibc.patch
b794636266cc573f0dda730fba634567  900-tryinclude.patch
8dea1081693fb5bf63b380ad6d56e316  ASTERISK-13456.patch
1ddadef41aa7120e168738b6f3ed8917  ASTERISK-18977.patch
bc6713f5434e07b79d3afdd155461d72  ASTERISK-18995.patch
a22bb1d513d026564cb40ec213b1ae7f  ASTERISK-19109.patch
676ca42ee1859d8a7bae4345ede5eb89  ASTERISK-20527.patch
74cd25a5638a94ef51e9f4ede2fd28f2  asterisk.initd
ed31d7ba37bcf8b0346dcf8593c395f0  asterisk.confd
3e65172275684373e1a25c8a11224411  asterisk.logrotate"
sha256sums="d719e09677e2aa7866f506a8b3f83016aa27a3c652b975b7d2beebe5891e2ee9  asterisk-10.12.4.tar.gz
6f56ea997513c10fa39835e8dd11fbfb4ec0bb23f4b771963e56691b15a5c003  100-uclibc-daemon.patch
c2ef786e9a8082fe8ba7b4eb2f130925cb823d100ec567909ad465c279e335bf  101-caps-uclibc.patch
0f1c7fd5e1a103cc79ee1c00ac3369d0089399b1c888e1319245d40a1c0b98a1  900-tryinclude.patch
8f97d590ce45d5a0afec44267007be4692d0fa21aacab8d52b2f7ffdd3dea73d  ASTERISK-13456.patch
e3aff74332cd434f336bc114a427bb6a57f2f101a014a5745925fc8ddb88ee4e  ASTERISK-18977.patch
7a7140156ae7fc7e833035db1e428db8d90159579cd2678c4b5cc829ded47485  ASTERISK-18995.patch
fa3a1a714b4d0931f106e03d4e8b596d4ea2dabc90f26a234f55f45674845b53  ASTERISK-19109.patch
1f822e618554e9962fe4599975bdcc24413e087dbd7ea4ce0305ecb7ea9bef94  ASTERISK-20527.patch
13bcc98f2a78d4dd41e810232979eb83044e9166302bfb5b971315f2a82af36f  asterisk.initd
d221148583b57f9c37d7160f2493f0d204ad11f7abb17e3a3534e108ad5452d7  asterisk.confd
77b253b6db71460acf9a51e87ad4c8582027a46db01a4c50fb048bada58c19d1  asterisk.logrotate"
sha512sums="198fde82180e4c4826aac677bba11a2801442c80b60d3b8171b5803e075145095cb05ec8dcafa184f38f1464aae34e2e3561e92f35f29cb0abfa7b43db5deaa4  asterisk-10.12.4.tar.gz
24a0d3c0ae86117ead8d2e35fc9a5945e04b9f80f3baf122337c8361c015e5ad904c206579962aefe3eb35a1fbf269515228ae5f34a801d7725d73dc235cf831  100-uclibc-daemon.patch
601681b9a33e77b33a0393a494c4140aa6c1f174c514093242a4081661bb7f78b6af867100996c97f3bf12e8dd10873dd3e116b61e2a0e04832f4ee470664368  101-caps-uclibc.patch
8926aac757ca5c4cf1b8e1235301762b10afaef66d67d0b989780f725539bb6473f9aef138f8cc86602282def5dab940aa592e604aa3b5591d2083a35be515bf  900-tryinclude.patch
284c7645ac7219fb5bfa2c0e0178791b1eb0f3c27593b5686f2c1029c47ef3dc4fe038a7a80ac53b3979282f30e951c0ad58f17966f29f17ceefbd376d2200df  ASTERISK-13456.patch
30608f649009a2dcee3559606afbfa687fb87e3a62effcc8748f0de2c0f3f0e037172519e1b4c01695ad64ec801c3d46a6b19716969f6194ba33ca4ed31c0316  ASTERISK-18977.patch
42b2385d88e72473fe34c63e1be8cdf7f37688649fe5bf033b5ba17627008b771aec8f0a583e9ad483a20f9e1f7c33922cb42bf5b73adc68aa43fd46c5da1daa  ASTERISK-18995.patch
194247b51b8a80d2cd23b87cdad13b8f5cb98a07f0ef9f660d9513707539eedc36df4c89400884f335512ece3641350ec08ae7818caa415c6f71e2a1e2e11141  ASTERISK-19109.patch
6edd8e0a1dce326aadf659c8bf8ed34083e8247b6c0f032d097c77df25feb93107375ba505e9076c084fe80676336d6c863e04c3c6808a850e24257fd7a7702d  ASTERISK-20527.patch
e29477aa57d88fedc96d13751f68f302d3892c70b5ea5b5a8cc85d0439335fc1a6847648447b443a074c0877718f23295e3752056a108301d340d1e2919465b1  asterisk.initd
ab6b6f08ff43268cbb1abb7ed7d678949991ba495682a644bbaeb017d6adbff0a43297905fd73ae8db1786a28d5b5904f1bc253209a0e388c8a27f26c6ce14ed  asterisk.confd
7591d2faf539d05d9ee4e431c78a5e20686721fd79221ad94dffeeaff9282220b09cb9aec214bd7a8d12affaec0276c9c91e6e21af8b6712c0a9502b60b02f2b  asterisk.logrotate"
