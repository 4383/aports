# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=ipsec-tools
pkgver=0.8.1
pkgrel=2
pkgdesc="User-space IPsec tools for various IPsec implementations"
url="http://ipsec-tools.sourceforge.net/"
arch="all"
license="BSD"
depends=""
makedepends="openssl-dev bison flex"
subpackages="$pkgname-doc $pkgname-dev"
source="http://downloads.sourceforge.net/$pkgname/$pkgname-$pkgver.tar.gz
	racoon.initd
	racoon.confd
	01-fix-deletion-notification.patch
	02-fix-xauth-double-free-on-reload.patch
	03-fix-sport-selection.patch
	20-grekey-support.patch
	50-reverse-connect.patch
	70-defer-isakmp-ident-handling.patch
	75-racoonctl-rcvbuf.patch
	90-dead-on-initial-contact.patch
	"

_builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	cd "$_builddir"
	update_config_sub || return 1
	for i in ../*.patch; do
		msg "Applying $i..."
		patch -p1 -i $i || return 1
	done

	sed -i 's:-Werror::g' configure
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var/lib \
		--with-kernel-headers=/usr/include \
		--disable-security-context \
		--enable-adminport \
		--enable-dpd \
		--enable-frag \
		--enable-hybrid \
		--enable-ipv6 \
		--enable-natt \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install
	rm "$pkgdir"/usr/lib/*.la

	install -D -m755 ../racoon.initd "$pkgdir"/etc/init.d/racoon
	install -D -m644 ../racoon.confd "$pkgdir"/etc/conf.d/racoon
}

md5sums="4d5d5ccc402c9c6bec0e87217e451fe5  ipsec-tools-0.8.1.tar.gz
74f12ed04ed273a738229c0bfbf829cc  racoon.initd
2d00250cf72da7f2f559c91b65a48747  racoon.confd
c8b141e2c705c31af1c35d481e695ee6  01-fix-deletion-notification.patch
5f30dfa6997b32e89c0e86826a70f777  02-fix-xauth-double-free-on-reload.patch
2dd6bc764a5464b811edd6b4847880eb  03-fix-sport-selection.patch
a6efed1359bde30ea3652fdbe76d89c0  20-grekey-support.patch
f97205eea3dc68d2437a2ad8720f4520  50-reverse-connect.patch
94773c94233e14cdce0fa02ff780a43e  70-defer-isakmp-ident-handling.patch
2d5d24c4a3684a38584f88720f71c7d6  75-racoonctl-rcvbuf.patch
1d0d8ef21c65138d40f902502412da9c  90-dead-on-initial-contact.patch"
