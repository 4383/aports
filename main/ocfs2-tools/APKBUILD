# Contributor:
# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname=ocfs2-tools
pkgver=1.4.4
pkgrel=4
pkgdesc="Oracle Cluster File System 2 utilities"
url="http://oss.oracle.com/projects/ocfs2-tools"
arch="all"
license="GPL2"
depends=
depends_dev="e2fsprogs-dev glib-dev readline-dev"
makedepends="$depends_dev"
install=
subpackages="$pkgname-dev $pkgname-doc"
source="http://oss.oracle.com/projects/ocfs2-tools/dist/files/source/v1.4/$pkgname-$pkgver.tar.gz
	gcc45-ftbfs.patch
	build.patch
	$pkgname.initd
	$pkgname.confd
	$pkgname.cluster-conf"

_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"

	for i in ../*.patch
	do
		msg "Applying patch $i"
		patch -p1 -i $i || return 1
	done

	sed -i 's%sys/raw.h%linux/raw.h%' fswreck/include/main.h || return 1
	sed -i 's%sys/raw.h%linux/raw.h%' debugfs.ocfs2/include/main.h || return 1
}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--enable-ocfs2console=no \
		--enable-dynamic-fsck=yes \
		--disable-glibtest || return 1
	make -j1 || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install

	# remove the 2 lines below (and this) if there is no init.d script
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/o2cb
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/o2cb
	install -m644 -D "$srcdir"/$pkgname.cluster-conf "$pkgdir"/etc/ocfs2/cluster.conf
}

md5sums="f7ae245e8baa499aa56d7af25a7885d5  ocfs2-tools-1.4.4.tar.gz
5dba18ca5596b1de0f2eeb30f5ed1656  gcc45-ftbfs.patch
c938040f0e77a4bb23e952c8f99b6cc5  build.patch
601fbd79acdc52a9046293aa977b1547  ocfs2-tools.initd
d81b6ab068ec92a137b58c9ad56c4637  ocfs2-tools.confd
189e433cf001465f1565faae2e6e10ac  ocfs2-tools.cluster-conf"
