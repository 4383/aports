# Contributor: William Pitcock <nenolod@dereferenced.org>
# Maintainer: William Pitcock <nenolod@dereferenced.org>
pkgname=xen
pkgver=4.1.3
pkgrel=1
pkgdesc="Xen hypervisor"
url="http://www.xen.org/"
arch="x86 x86_64"
license="GPL"
depends="udev syslinux bash python"
depends_dev="openssl-dev python-dev e2fsprogs-dev gettext zlib-dev ncurses-dev
	libiconv-dev dev86 texinfo perl iasl pciutils-dev"
makedepends="$depends_dev"
install=""
subpackages="$pkgname-doc"
source="http://bits.xensource.com/oss-xen/release/$pkgver/$pkgname-$pkgver.tar.gz
	blktap2_libvhd_add_iconv.patch
	detect_libiconv.patch
	fix_bswap_blktap.patch
	fix_bswap_blktap2.patch
	define_fsimage_dir.patch
	librt.patch
	busybox-sed.patch
	xsa-12.patch
	xsa-13.patch
	xsa-14.patch
	xsa-15-1.patch
	xsa-15-2.patch
	xsa-15-3.patch
	xsa-15-4.patch
	xsa-15-5.patch
	xsa-16.patch
	xsa-17.patch
	xsa-20.patch
	xsa-21.patch
	xsa-22.patch
	xsa-23.patch
	xsa-24.patch
	xsa-25.patch
	xsa26-4.1.patch
	xsa27-4.1.patch
	xsa28-4.1.patch
	xsa29-4.1.patch
	xsa30-4.1.patch
	xsa31-4.1.patch

	xencommons.initd
	xend.initd
	xendomains.initd"

_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"

	msg "Patching sources..."
	for i in $source; do
		case $i in
		*.patch)
			msg "Applying $i..."
			patch -s -p1 -N -i "$srcdir"/$i || return 1
			;;
		esac
	done
	msg "Sources have been patched successfully."

	# remove all -Werror
	msg "Eradicating -Werror..."
	find -name '*.mk' -o -name 'Make*' | xargs sed -i -e 's/-Werror//g'
}

build() {
	cd "$_builddir"

	# We unset $CFLAGS and $LDFLAGS because Xen's buildsystem does not
	# like these values being set.  Arguably this is a bug but I can't be
	# bothered to track it down.  --nenolod
	unset CFLAGS
	unset LDFLAGS

	# If we provide no parameters it tries to build a kernel image.  We
	# definitely don't want that.
	msg "Running preflight check..."
	(cd tools/check; ./chk build) || return 1

	msg "Building hypervisor..."
	make -j1 xen || return 1

	msg "Building tools..."
	make -j1 tools || return 1

	msg "Building stub domains..."
	make -j1 stubdom || return 1
}

package() {
	cd "$_builddir"

	# We unset $CFLAGS and $LDFLAGS because Xen's buildsystem does not
	# like these values being set.  Arguably this is a bug but I can't be
	# bothered to track it down.  --nenolod
	unset CFLAGS
	unset LDFLAGS

	make -j1 DESTDIR="$pkgdir" install-xen install-tools install-stubdom \
		|| return 1

	install -m755 -D "$srcdir"/xencommons.initd "$pkgdir"/etc/init.d/xencommons
	install -m755 -D "$srcdir"/xend.initd "$pkgdir"/etc/init.d/xend
	install -m755 -D "$srcdir"/xendomains.initd "$pkgdir"/etc/init.d/xendomains
}

md5sums="bed929d5c5e5135cab40e2a6aab73fa0  xen-4.1.3.tar.gz
6d4b045ae56be6288733d0e078f591ea  blktap2_libvhd_add_iconv.patch
ed3283697cb1ddff066f4087eabf68c6  detect_libiconv.patch
503f0883f4a0b50fe4e37e09ed9a6177  fix_bswap_blktap.patch
b973dc1ffcc6872e222b36f3b7b4836b  fix_bswap_blktap2.patch
0bb8a435020a5a49b38b1a447fb69977  define_fsimage_dir.patch
fa06495a175571f4aa3b6cb88937953e  librt.patch
1bea3543ddc712330527b62fd9ff6520  busybox-sed.patch
8a7bf334786c3fcafa9f9ae407c56a86  xsa-12.patch
73ba610d9098022f4fc3fb8b10111836  xsa-13.patch
e7b2e777128fb45386642be324fbd85e  xsa-14.patch
e38a8799c358c5959bc0146f7fb7bd2f  xsa-15-1.patch
8097d6451ab6d33f8374df316562a961  xsa-15-2.patch
75a12e9f62188677e5be6b33990b8b3c  xsa-15-3.patch
060667428ae4f12ab93a218238d3ff14  xsa-15-4.patch
ff8c8c952808a5d1c8258013608b8f19  xsa-15-5.patch
bbd0801bd2f8b501b366368be1520090  xsa-16.patch
a9d0b6ea849e40be80bed23b93138bba  xsa-17.patch
c7ba117dba1ee05c8944cc62c4dd1ce1  xsa-20.patch
1324c3a8999ca113ca0b60daad361bb0  xsa-21.patch
24e3db4c01c2ad8d17539b7a20d057d2  xsa-22.patch
4d16a72c8c5e28ab439227e7e96d5650  xsa-23.patch
8d58e94aa0d3ed43178fdcbd1af7d9fc  xsa-24.patch
e5f0a25cc5cb7245be0be5c9d19adef2  xsa-25.patch
0ef1933756429c5204d4cb59e20a609a  xsa26-4.1.patch
075932924d01e4fc231bf37a14241ccb  xsa27-4.1.patch
0d59195f99e5f871cd4606cfb9c2ffdf  xsa28-4.1.patch
8e69a2b2819a26504ca12353dc6ce829  xsa29-4.1.patch
4acab55051e542761d9ac5f782964dcb  xsa30-4.1.patch
2b9c5737b2910dc077c6e654b973947f  xsa31-4.1.patch
0b62c1fbe2699a32e745724fd301db5b  xencommons.initd
5ee6a16ec70dfbcd4944ded71b393fa2  xend.initd
a2b5234483f1b5892d22e9315d9c307f  xendomains.initd"
