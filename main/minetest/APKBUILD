# Contributor: <xmingske@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=minetest
pkgver=0.4.10
pkgrel=2
pkgdesc="An infinite-world block sandbox game and a game engine"
url="http://minetest.net/"
arch="all"
install="$pkgname.pre-install"
license="LGPL2.1 CCBY-SA3.0"
depends="$pkgname-common"
makedepends="sqlite-dev bzip2-dev openssl-dev irrlicht-dev cmake libvorbis-dev
	libjpeg-turbo-dev libpng-dev openal-soft-dev libogg-dev mesa-dev sqlite-dev
	luajit-dev hiredis-dev"
source="$pkgname-$pkgver.tar.gz::https://codeload.github.com/minetest/${pkgname}/tar.gz/${pkgver}
	$pkgname.confd
	$pkgname.initd
	"
subpackages="$pkgname-doc $pkgname-common $pkgname-server"

_builddir="${srcdir}"/${pkgname}-${pkgver}

prepare() {
	local pf
	cd "${_builddir}"
	for pf in $source; do
		case $pf in
		*.patch) msg $pf; patch -p1 -i "$srcdir"/${pf} || return 1;;
		esac
	done
}

build() {
	mkdir "${_builddir}"/.build_client
	cd "${_builddir}"/.build_client
	cmake -DCUSTOM_BINDIR=/usr/bin \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCUSTOM_DOCDIR="/usr/share/doc/${pkgname}" \
		-DCUSTOM_SHAREDIR="/usr/share/${pkgname}" \
		-DBUILD_CLIENT=1 \
		-DBUILD_SERVER=0 \
		-DENABLE_REDIS=0 \
		-DRUN_IN_PLACE=0 \
		..
	make || return 1
	mkdir "${_builddir}"/.build_server
	cd "${_builddir}"/.build_server
	cmake -DCUSTOM_BINDIR=/usr/bin \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCUSTOM_DOCDIR="/usr/share/doc/minetest" \
		-DCUSTOM_SHAREDIR="/usr/share/minetest" \
		-DBUILD_CLIENT=0 \
		-DBUILD_SERVER=1 \
		-DENABLE_REDIS=1 \
		-DRUN_IN_PLACE=0 \
		..
	make || return 1
}

common() {
	arch="noarch"
	mkdir -p "${subpkgdir}/usr/share/minetest"
	mv "${pkgdir}/usr/share/minetest/builtin" "${subpkgdir}/usr/share/minetest" || return 1
	mv "${pkgdir}/usr/share/minetest/games" "${subpkgdir}/usr/share/minetest" || return 1
}

package() {
	cd "${_builddir}"/.build_client
	make DESTDIR="${pkgdir}" install || return 1
}

server(){
	mkdir -p "${subpkgdir}/usr/bin"
	cd "${_builddir}"
	install -m644 -D $pkgname.conf.example "$subpkgdir"/etc/$pkgname/$pkgname.conf
	install -D -m755 "$srcdir"/$pkgname.initd \
		"$subpkgdir"/etc/init.d/$pkgname || return 1
	install -D -m644 "$srcdir"/$pkgname.confd \
		"$subpkgdir"/etc/conf.d/$pkgname || return 1
	cp bin/minetestserver ${subpkgdir}/usr/bin
}

md5sums="61bb35c9d5521f1b072bc3c3e634c863  minetest-0.4.10.tar.gz
89529d4af9bddc6504979404d609bb96  minetest.confd
3da0c6a91862cdbfe70665a6ed300085  minetest.initd"
sha256sums="620a2f3c279d337a2ac405ea65a559cc9c87f3d58bb565f9935fe338d003bbf7  minetest-0.4.10.tar.gz
f1d54fc223b5330d7b6cf20e2a0b96cfb4f56ee236072d9379c63b0b11452178  minetest.confd
7489226264d91452e6048d8ff99e0c9451f3b9976c22c502722d6b280a489bd5  minetest.initd"
sha512sums="882723996b4904b4b9e3653476c2b4a988967600fc2b0897f755dd28d5da2ae5cab45a14fcdf8827c3f2838e952399e1e7d7e264cd26070fef2dbcd33cd1c59a  minetest-0.4.10.tar.gz
98c4cf9b9957f69a0ceae771b7c2173fb4c7e4ad636081b6cb52168cb7a26f7f7f61c885718a2241c6f6d652d8d43bc5989b5fab95e3bf9dce4dd423c6ca3ab0  minetest.confd
5fe9de23f90cecbe74a6d096de3c6bb2bacc376cdcd412ce36586e2bdac31906a97804d3c59a5f1cc9942b4305ac2ba77caad74a78c4ccd03d1fba00244ca6b1  minetest.initd"
