# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=bash
pkgver=4.3
#_patchlevel=${pkgver##*.}
#_myver=${pkgver%.*}
#_patchbase=${_myver%.*}${_myver#*.}
_myver=$pkgver
pkgrel=1
pkgdesc="The GNU Bourne Again shell"
url="http://www.gnu.org/software/bash/bash.html"
arch="all"
license="GPL3+"
makedepends="readline-dev ncurses-dev bison flex"
depends=""
subpackages="$pkgname-doc"
source="http://ftp.gnu.org/gnu/bash/bash-${_myver}.tar.gz
	bash-noinfo.patch
	"
# generate url's to patches. note: no forks allowed!
#_i=1
#_pad="00"
#while [ $_i -le $_patchlevel ]; do
	#[ $_i -ge 10 ] && _pad="0"
	#[ $_i -ge 100 ] && _pad=
	#source="$source http://ftp.gnu.org/gnu/bash/bash-$_myver-patches/bash$_patchbase-$_pad$_i"
	#_i=$(( $_i + 1))
#done

# run 'abuild _gensrc >> APKBUILD' to generate the patch list
#_gensrc() {
#	for _i in $(seq 1 $_patchlevel); do
#		# seq -w unsupported by busybox
#		_p=$(printf "%0.3i" $_i)
#		echo -e "\thttp://ftp.gnu.org/gnu/bash/bash-${_myver}-patches/bash${_patchbase}-$_p"
#	done
#}

_builddir="$srcdir"/$pkgname-$_myver
prepare() {
	local p
	cd "$_builddir"
	update_config_sub || return 1
	#for p in ../bash${_patchbase}-??? ../*.patch; do
	for p in ../*.patch; do
		msg "applying patch ${p##*/}"
		patch -p0 -i $p || return 1
	done
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--bindir=/bin \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--with-curses \
		--disable-nls \
		--enable-readline \
		--without-bash-malloc \
		--with-installed-readline \
		|| return 1
	# parallel build workarounds
	make y.tab.c && make builtins/libbuiltins.a && make || return 1
}

package() {
	cd ${startdir}/src/${pkgname}-${_myver}
	make DESTDIR=${pkgdir} install || return 1

	rm -rf "$pkgdir"/usr/share/locale
}
md5sums="81348932d5da294953e15d4814c74dd1  bash-4.3.tar.gz
80fec5f3d60a63756a4999c877e31a8e  bash-noinfo.patch"
sha256sums="afc687a28e0e24dc21b988fa159ff9dbcf6b7caa92ade8645cc6d5605cd024d4  bash-4.3.tar.gz
363bc919d98cadbfca27660be0d1d4bb6cfe1c5f86a7830966e456df36e46792  bash-noinfo.patch"
sha512sums="a852b8e46ee55568dce9d23a30a9dbd1c770c2d2a4bc91e1c3177d723b31b32c5d69d19704a93f165891b409b9dd2cc65723372044e2bd0ee49ed59a11512651  bash-4.3.tar.gz
74d51550cc03410f22ffea13f6452350d1e5564bff619fb07a5bbef14ca565fbe03770a2c0041292732cda16e8944b33ccbd0dfe29a606a068fedabe277cd6ae  bash-noinfo.patch"
