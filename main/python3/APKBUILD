# Maintainer:
# Contributor: Kiyoshi Aman <kiyoshi.aman@gmail.com>
# Contributor: Bart≈Çomiej Piotrowski <bpiotrowski@alpinelinux.org>

pkgname=python3
pkgver=3.5.2
pkgrel=2
pkgdesc="A high-level scripting language"
url="http://www.python.org"
arch="all"
license="custom"
subpackages="$pkgname-dev $pkgname-doc $pkgname-tests"
depends=""
makedepends="expat-dev openssl-dev zlib-dev ncurses-dev bzip2-dev xz-dev
	sqlite-dev libffi-dev tcl-dev linux-headers gdbm-dev readline-dev"
source="http://www.python.org/ftp/python/$pkgver/Python-$pkgver.tar.xz
	musl-find_library.patch
	issue-27955.patch
	"

_builddir="$srcdir"/Python-$pkgver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	# force system libs
	rm -r Modules/expat \
		Modules/zlib \
		Modules/_ctypes/darwin* \
		Modules/_ctypes/libffi* \
		|| return 1
}

build() {
	cd "$_builddir"
	./configure \
		--prefix=/usr \
		--enable-shared \
		--enable-ipv6 \
		--with-computed-gotos \
		--with-threads \
		--with-system-ffi \
		--with-system-expat \
		--with-dbmliborder=gdbm:ndbm \
		--enable-loadable-sqlite-extensions \
	        --disable-rpath \
		|| return 1
	make EXTRA_CFLAGS="$CFLAGS" || return 1
}

package() {
	cd "$_builddir"
	make -j1 DESTDIR="$pkgdir" EXTRA_CFLAGS="$CFLAGS" install maninstall \
		|| return 1
	mv "$pkgdir"/usr/bin/2to3 "$pkgdir"/usr/bin/2to3-3.3
	install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

_mv_files() {
	cd "$pkgdir"/usr/lib/python${pkgver%.*}
	for i in */test */tests; do
		mkdir -p "$subpkgdir"/usr/lib/python${pkgver%.*}/"$i"
		mv "$i"/* "$subpkgdir"/usr/lib/python${pkgver%.*}/"$i"
		rm -rf "$i"
	done
	mv "$pkgdir"/usr/lib/python${pkgver%.*}/test \
		"$subpkgdir"/usr/lib/python${pkgver%.*}
}

dev() {
	# pyconfig.h is needed runtime so we move it back
	default_dev
	mkdir -p "$pkgdir"/usr/include/python${pkgver%.*}m
	mv "$subpkgdir"/usr/include/python${pkgver%.*}m/pyconfig.h \
		"$pkgdir"/usr/include/python${pkgver%.*}m/
}

tests() {
	pkgdesc="The test modules from the main python package"
	arch="noarch"
	cd "$pkgdir"
	_mv_files
}

md5sums="8906efbacfcdc7c3c9198aeefafd159e  Python-3.5.2.tar.xz
3810fc5ba451204525698ef80cce675e  musl-find_library.patch
b63a796d0662515d7abe1e94576ced1d  issue-27955.patch"
sha256sums="0010f56100b9b74259ebcd5d4b295a32324b58b517403a10d1a2aa7cb22bca40  Python-3.5.2.tar.xz
611b8915611e6e04d17eb322d3feef6f14e7d97e2072bca0dfdc3bcb29ad7b38  musl-find_library.patch
61ea7a484332c245f0fccdbe93597efd91e3613a495d7172627a47b85dd8d088  issue-27955.patch"
sha512sums="c07c3366f1c81e214241444bb9da6db9d11da32ad66bfa29cdad5a3b2e34e4d870bda6d4ce3c3910b582942e91f1d8c8a1c1a7b9464cc147b83c9e0007012742  Python-3.5.2.tar.xz
ff55054b563e154a84d408a5875dac8381decd2bdfb4bb3147bf313e1e9e36162cce0ce74d6e607348a8fe9e01f0b3fe4c8c60c2de81a2055f0f6518408de59b  musl-find_library.patch
388a0f49e98daf953bf859c15cc43f71dc7d77e82e65cb14a51999e8dd78cf93636ab5c116148c6310a8ea93a7c6d03fcd35e1b8f023d8e94fcff637b6c47c54  issue-27955.patch"
