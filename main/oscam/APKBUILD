# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer:
pkgname=oscam
pkgver=0_svn20140304
pkgrel=1
pkgdesc="An Open Source Conditional Access Module software"
url="http://www.streamboard.tv/oscam/"
arch="all"
license="GPL"
depends=""
depends_dev="openssl-dev libusbx-dev pcsc-lite-dev"
makedepends="$depends_dev bash subversion"
install="$pkgname.pre-install"
pkgusers="$pkgname"
subpackages="$pkgname-doc $pkgname-list-smargo:list_smargo $pkgname-dbg"
svnurl="http://www.streamboard.tv/svn/oscam/trunk"
disturl="dev.alpinelinux.org:/archive/$pkgname/"
source="http://dev.alpinelinux.org/archive/$pkgname/$pkgname-$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	$pkgname.conf"

_builddir="$srcdir"/oscam-$pkgver

prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	make allyesconfig
	./config.sh --disable IPV6SUPPORT
	make OSCAM_BIN=oscam \
		LIST_SMARGO_BIN=list_smargo \
		CONF_DIR=/etc/oscam \
		USE_LIBUSB=1 \
		USE_PCSC=1 || return 1
}

package() {
	cd "$_builddir"
	install -d "$pkgdir"/var/log/$pkgname/cw \
		"$pkgdir"/usr/share/doc/oscam/example \
		"$pkgdir"/usr/share/doc/oscam/monitor \
		"$pkgdir"/usr/share/man/man1 \
		"$pkgdir"/usr/share/man/man5 || return 1
	install -m644 "$_builddir"/Distribution/doc/txt/* \
		"$pkgdir"/usr/share/doc/oscam/ || return 1
	install -m644 "$_builddir"/Distribution/doc/example/* \
		"$pkgdir"/usr/share/doc/oscam/example/ || return 1
	install -m644 "$_builddir"/Distribution/monitor/* \
		"$pkgdir"/usr/share/doc/oscam/monitor/ || return 1
	install -m644 "$_builddir"/Distribution/doc/man/*.1 \
		"$pkgdir"/usr/share/man/man1/ || return 1
	install -m644 "$_builddir"/Distribution/doc/man/*.5 \
		"$pkgdir"/usr/share/man/man5/ || return 1
	install -D -m755 "$_builddir/oscam" \
		"$pkgdir/usr/bin/oscam" || return 1
	install -D -m644 "$srcdir"/$pkgname.conf \
		"$pkgdir"/etc/$pkgname/$pkgname.conf || return 1
	chown -R $pkgname "$pkgdir"/var/log/$pkgname \
		"$pkgdir"/etc/$pkgname || return 1
	install -D -m755 "$srcdir"/$pkgname.initd \
                "$pkgdir"/etc/init.d/$pkgname || return 1
        install -D -m644 "$srcdir"/$pkgname.confd \
                "$pkgdir"/etc/conf.d/$pkgname || return 1
	rm -f "$pkgdir"/usr/lib/*.la
}

list_smargo() {
	pkgdesc="Tool to identify your smargo card reader"
	install -m755 -D "$_builddir"/list_smargo \
		"$subpkgdir"/usr/bin/list_smargo || return 1
}

md5sums="8a0cc31c1b8fa7aa34dc0100babe3ae5  oscam-0_svn20140304.tar.gz
56f8a71e018973b6fb8f2efa2873b6cb  oscam.initd
209c3747e235def3ba374b4aab237a15  oscam.confd
90939047384482ba8d4428b127b53785  oscam.conf"
sha256sums="e35c3f37a0b4fa738c5548c0888b83c24c6c6cc4e06ba584c734fac02d5c9d7c  oscam-0_svn20140304.tar.gz
3b925940d39eff9dd98733b777214e4503cef7e845fb24ef29cdd2ecc2e6fbc7  oscam.initd
71464c3c2f8a25899fe064d9a99938ca7fc9871e1b99e15e9a6babcd266b68d9  oscam.confd
7a2e4cb5da504027b858086966eee57fcc1cc14115a7978997857e631e459b6e  oscam.conf"
sha512sums="fc7d71f69d084b93ab1ad9e9d9462252ce5484b2da43411e8893294af6063b8b7066c516c5c0a3d772dba09f9e5e6cdd6cf0b616016f3074f097bcedb1d71ad9  oscam-0_svn20140304.tar.gz
f33821de7441fb59a2339d0323b18199d326c7f47a139128f02bf0661bc43c36dfa9dc2a9d6b4d9415da576d829d50123173537037008be93adb4a0458e6613a  oscam.initd
c5567457763eb01f6287215f29547c867ae3f5b224691ff690616bb7598ea831299f73784064a571284b88d34c6504a2594b46e8275d5db2e1fb1394c11945eb  oscam.confd
0f3c4b9940bd27169dfe934599525558bc712d43f07959f19dce6ccfbf0e4d35d345272500fba2bff30e4ecf23f11f72b75321f8a45df908373620349d7f8808  oscam.conf"
