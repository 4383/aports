# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=qemu
pkgver=1.0.1
pkgrel=4
pkgdesc="QEMU is a generic machine emulator and virtualizer"
url="http://www.nongnu.org/qemu/"
arch="all"
license="GPL-2 LGPL-2"
makedepends="zlib-dev sdl-dev alsa-lib-dev gnutls-dev ncurses-dev glib-dev
	jpeg-dev libpng-dev vde2-dev spice-dev paxctl"
depends=
install="qemu.pre-install"
subpackages="
$pkgname-alpha
$pkgname-arm
$pkgname-cris
$pkgname-i386
$pkgname-lm32
$pkgname-m68k
$pkgname-microblaze
$pkgname-microblazeel
$pkgname-mips
$pkgname-mips64
$pkgname-mips64el
$pkgname-mipsel
$pkgname-ppc
$pkgname-ppc64
$pkgname-ppcemb
$pkgname-sh4
$pkgname-s390x
$pkgname-sh4eb
$pkgname-sparc
$pkgname-sparc64
$pkgname-x86_64
$pkgname-xtensa
$pkgname-xtensaeb
$pkgname-img
"
source="http://wiki.qemu.org/download/qemu-$pkgver.tar.gz
	80-kvm.rules
	configure-libm.patch
	CVE-2012-2652.patch
	librt.patch
	CVE-2012-6075.patch
	"

prepare() {
	cd "$srcdir"/$pkgname-$pkgver
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	# avoid fdt till an updated release appears
	sed -i -e 's:fdt="yes":fdt="no":' configure
	# prevent docs to get automatically installed
	sed -i '/$(DESTDIR)$(docdir)/d' Makefile
	# Alter target makefiles to accept CFLAGS
	sed -i 's/^\(C\|OP_C\|HELPER_C\)FLAGS=/\1FLAGS+=/' \
		Makefile Makefile.target tests/Makefile
	sed -i 's/^VL_LDFLAGS=$/VL_LDFLAGS=-Wl,-z,execheap/' \
		Makefile.target
}

build() {
	cd "$srcdir"/$pkgname-$pkgver
	./configure --prefix=/usr \
		--audio-drv-list=oss,alsa,sdl \
		--audio-card-list=ac97,sb16,es1370,adlib \
		--enable-vde \
		--enable-spice \
		--disable-darwin-user \
		--disable-bsd-user \
		--disable-linux-user \
		--disable-werror \
		--cc="${CC:-gcc}" \
		|| return 1

	make V=1 || return 1
}

package() {
	cd "$srcdir"/$pkgname-$pkgver
	make DESTDIR="$pkgdir" install || return 1
	install -Dm644 "$srcdir"/80-kvm.rules \
		"$pkgdir"/lib/udev/rules.d/80-kvm.rules || return 1
	paxctl -c -m "$pkgdir"/usr/bin/qemu-system-* || return 1
}

_subsys() {
	pkgdesc="Qemu $1 system emulator"
	depends="qemu"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/qemu-system-$1 "$subpkgdir"/usr/bin/
}

alpha() { _subsys alpha; }
arm() { _subsys arm; }
cris() { _subsys cris; }
i386() { _subsys i386; }
lm32() { _subsys lm32; }
m68k() { _subsys m68k; }
microblaze() { _subsys microblaze; }
microblazeel() { _subsys microblazeel; }
mips() { _subsys mips; }
mips64() { _subsys mips64; }
mips64el() { _subsys mips64el; }
mipsel() { _subsys mipsel; }
ppc() { _subsys ppc; }
ppc64() { _subsys ppc64; }
ppcemb() { _subsys ppcemb; }
s390x() { _subsys s390x; }
sh4() { _subsys sh4; }
sh4eb() { _subsys sh4eb; }
sparc() { _subsys sparc; }
sparc64() { _subsys sparc64; }
x86_64() { _subsys x86_64; }
xtensa() { _subsys xtensa; }
xtensaeb() { _subsys xtensaeb; }

img() {
	pkgdesc="QEMU command line tool for manipulating disk images"
	replaces="qemu"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/qemu-img \
		"$pkgdir"/usr/bin/qemu-io \
		"$subpkgdir"/usr/bin/

	# we exploit the fact that -img subpackage are craeted last
	# and check that we done have new systems that belongs in
	# subpackage
	local _bins= _ret=0
	for i in "$pkgdir"/usr/bin/qemu-system-*; do
		if [ -r "$i" ]; then
			error "Please create a subpackage for ${i##*/}"
			_ret=1
		fi
	done
	return $_err
}

md5sums="5efd1091f01e3bc31bfdec27b8edeb00  qemu-1.0.1.tar.gz
66660f143235201249dc0648b39b86ee  80-kvm.rules
a69fe6ff552b61606c5550cac4294abc  configure-libm.patch
319652a41e46e4920b30c84b93241e93  CVE-2012-2652.patch
9f6c3143d61748eedc8cf8d0e53aee2c  librt.patch
abf8919e668120c44b4d1570c8a1e6c4  CVE-2012-6075.patch"
sha256sums="198902e10782517f607c9ed9e629b5e7708ea39eb373ed3ec3f1c8a169d98378  qemu-1.0.1.tar.gz
37f666f1cdb7d8a62171de69b531681dcb0fba74236729dac8b6c019232eba84  80-kvm.rules
36dcd4c2540d0d74f94dfae9a24d92f8895d24a2030250b88a2534e4f1355df1  configure-libm.patch
ac05d15dcd3f5f4d8ccc4333f91ad5c8068f891b210e207b0ce682bd790bbb94  CVE-2012-2652.patch
5e4e34229aa31b83e3fa762a7af7d4cdbadaf82125cddb8e8caff62b2466c6f7  librt.patch
33e9ee7b646aa40b58e7ffd6bff36c8d897d84cca03800f243c2737e55ee163d  CVE-2012-6075.patch"
sha512sums="c3c311288bd9e843c3e9dae9ad36e370ffa6a379878fae1067e656e9a1f38e002314e59f0fc46c84df98bdd4d6b7acc6b99907b3cf04a2b100a752b837da0178  qemu-1.0.1.tar.gz
9b7a89b20fcf737832cb7b4d5dc7d8301dd88169cbe5339eda69fbb51c2e537d8cb9ec7cf37600899e734209e63410d50d0821bce97e401421db39c294d97be2  80-kvm.rules
93c969bc4d077690f60f199f5628c7ae0ecbaa87bfc903770b0a0914eddfc7f694028281dbb2fb7086055ce341a723c9ad9aa0238ad08f91c9e9c2b21f04e6af  configure-libm.patch
e7e0b49efe9ea67515665daa08927ed161197c8654d8eaf3d56d2084abcb8509ea8d748d65a2c2a021a5e7b95442ed6dba333f3ceb4b7d3a6ec03dbf13786a57  CVE-2012-2652.patch
66787fc829e09223eab05f8ea57dcf7bc3a2d5a231fa5276b5b5dd20f3852282c2e09f4890ed247150bbebabe88bc3dc6ab7a0af69b6e5f0f8e175d950d04ddf  librt.patch
248720594d216390e9b2df47cc095442c9257a740a2cd6622b941a681f84a3e672494e23b8bdd4213aec263ed8ecf86e1ce49ef9227ea8ba54a96a65ee28f4d2  CVE-2012-6075.patch"
