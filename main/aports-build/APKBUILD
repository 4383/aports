# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=aports-build
pkgver=0.8
pkgrel=0
pkgdesc="MQTT based build-on-git-push scripts for Alpine Linux"
url="http://alpinelinux.org"
arch="noarch"
license="GPL2"
depends="abuild>2.20.0 mosquitto-clients alpine-sdk mqtt-exec rsync lua-aports"
depends_dev=""
makedepends="$depends_dev mosquitto-dev"
install="$pkgname.pre-install"
subpackages=""

source="aports-build
	aports-build.initd
	mqtt-exec.aports-build.confd
	"

_builddir=
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	install -Dm755 "$srcdir"/aports-build \
		"$pkgdir"/usr/bin/aports-build || return 1
	install -d "$pkgdir"/etc/init.d || return 1

	ln -s mqtt-exec "$pkgdir"/etc/init.d/mqtt-exec.aports-build || return 1
	install -Dm644 "$srcdir"/mqtt-exec.aports-build.confd \
		"$pkgdir"/etc/conf.d/mqtt-exec.aports-build || return 1

	# keep this for a migration period
	install -Dm755 "$srcdir"/aports-build.initd \
		"$pkgdir"/etc/init.d/aports-build || return 1
}

md5sums="700592623bf5be9dd6b49a175be51dcd  aports-build
4ca3699a6df13cc937b267a28207b572  aports-build.initd
10c96b7b22707e87a5732137d31daf74  mqtt-exec.aports-build.confd"
sha256sums="ddbd154cd987cbb0d4c9b96676360a3c08abf6d976dd594f8eeec9a51b53bc2f  aports-build
a4a8756bc10d27219f5d569b2ea12450c864be439dac1fccb2b79dd374dd525a  aports-build.initd
a558a14951c05740483a52c58c5c5cff38a36ea89854c5502531cabffef6a49e  mqtt-exec.aports-build.confd"
sha512sums="ed7180d6565d65ae120da53869f56f92e609cc788ab5d3b4e8c90acbd7c078e9c8987357a8c54b424b75bba6f8f0ee59a3be9c4a7bd0a040b054f406f3d00a4b  aports-build
e5bb9b219a5e03cc594bd1ffe064d9c531f2dc2f50b4cdf66014c49e9dc42b04133968dda0da0b3d572663523ba47a1d77a945f220a85e699930590bf163739c  aports-build.initd
fdd80a1cd22342f20f2027a13f028f8046a065955b15b25660ad1c0be47fdc602b28d0ac9a104b843c119eea082b5d5c8dd39a3e07a93d832ae85f006bedb87f  mqtt-exec.aports-build.confd"
