# Maintainer: Natanael Copa <ncopa@alpinelinux.org>

_flavor=grsec
_realname=iscsitarget
# source the kernel version
if [ -f ../linux-$_flavor/APKBUILD ]; then
	. ../linux-$_flavor/APKBUILD
fi
_kernelver=$pkgver-r$pkgrel
_abi_release=$pkgver-${_flavor}

# get pkgver from iscsitarget
if [ -f ../iscsitarget/APKBUILD ]; then
	. ../iscsitarget/APKBUILD
fi
pkgname=${_realname}-${_flavor}
pkgver=${pkgver:-0.4.17}
pkgrel=12
pkgdesc="$_flavor kernel modules for iscsitarget"
url="http://iscsitarget.sourceforge.net/"
license="GPL-2"
depends="linux-${_flavor}=${_kernelver}"
install=
makedepends="linux-${_flavor}-dev=${_kernelver}"
subpackages=
source="http://downloads.sourceforge.net/$_realname/$_realname-$pkgver.tar.gz
	iscsitarget-0.4.17+linux-2.6.28.patch
	iscsitarget-0.4.17+linux-2.6.29.patch
	iscsitarget-0.4.17+linux-2.6.30.patch
	"

build() {
	cd "$srcdir"/$_realname-$pkgver
	for i in ../*.patch; do
		msg "Applying $i"
		patch -p1 < $i || return 1
	done

	unset ARCH
	local ksrc=/usr/src/linux-headers-${_abi_release}
	make KSRC="$ksrc" kernel || return 1
	make KSRC="$ksrc" DISTDIR="$pkgdir" install-kernel || return 1
}
md5sums="e79b437695fc50e7d054631855a16b1b  iscsitarget-0.4.17.tar.gz
f58dde50f72b04b7737b33e517e56208  iscsitarget-0.4.17+linux-2.6.28.patch
a7be10bb04c9014807e39db75c9cd468  iscsitarget-0.4.17+linux-2.6.29.patch
2f65d30d1766828fc87cac55a84e0b07  iscsitarget-0.4.17+linux-2.6.30.patch"
