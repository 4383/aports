# Contributor: Michael Mason <ms13sp@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=dansguardian
pkgver=2.10.1.1
pkgrel=10
pkgdesc="Web content filter"
url="http://dansguardian.org"
arch="all"
license="GPL"
depends="logrotate"
makedepends="zlib-dev pcre-dev pkgconfig libiconv-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-doc"
pkgusers="dansguar"
pkggroups="dansguar"
source="http://dansguardian.org/downloads/2/Stable/$pkgname-$pkgver.tar.gz
	dansguardian.initd
	dansguardian.logrotate
	ftp-credential.patch
	dansguardian-2.10.1.1-gcc44.patch
	dansguardian-2.10.1.1-pcre830.patch
	"

_builddir="$srcdir"/dansguardian-$pkgver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	# do not block "microsoft...clustimg=..." and similar
	sed -i -e 's:\.\*:.{1,10}:g' configs/lists/bannedregexpurllist 

}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--with-proxyuser=dansguar \
		--with-proxygroup=dansguar \
		--with-logdir=/var/log/dansguardian \
		--with-piddir=/var/run/ \
		--enable-ntlm
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -D -m 755 "$srcdir"/dansguardian.initd \
		"$pkgdir"/etc/init.d/dansguardian || return 1
	install -D -m 644 "$srcdir"/dansguardian.logrotate \
		"$pkgdir"/etc/logrotate.d/dansguardian || return 1
	install -d -o dansguar -g dansguar "$pkgdir"/var/log/dansguardian
}

md5sums="0987a1c9bfbdf398118386f10279611a  dansguardian-2.10.1.1.tar.gz
feaa8582f8c0251a4bff76b5e05c9369  dansguardian.initd
85b6de01c9508e8ceff5ebb55752f8d3  dansguardian.logrotate
475c46026e8553181d293d5a4feaf6d9  ftp-credential.patch
2c78b5c7346b8fcb3dee352e0c53cb5a  dansguardian-2.10.1.1-gcc44.patch
594ca48a3753684151c2012ee371d15b  dansguardian-2.10.1.1-pcre830.patch"
