# Maintainer: Timo Teras <timo.teras@iki.fi>
pkgname=openssl
pkgver=1.0.1g
pkgrel=0
pkgdesc="Toolkit for SSL v2/v3 and TLS v1"
url="http://openssl.org"
depends=
makedepends="perl zlib-dev"
depends_dev="zlib-dev"
arch="all"
license="openssl"

subpackages="$pkgname-dev $pkgname-doc libcrypto1.0:libcrypto libssl1.0:libssl"

source="http://www.openssl.org/source/${pkgname}-${pkgver}.tar.gz
	fix-manpages.patch
	openssl-bb-basename.patch
	0001-crypto-hmac-support-EVP_MD_CTX_FLAG_ONESHOT-and-set-.patch
	0003-engines-e_padlock-backport-cvs-head-changes.patch
	0004-engines-e_padlock-implement-sha1-sha224-sha256-accel.patch
	0005-crypto-engine-autoload-padlock-dynamic-engine.patch
	"

_builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	cd "$_builddir"
	for i in ../*.patch; do
		msg "Applying $i..."
		patch -p1 -N < $i || return 1
	done
}

build() {
	cd "$_builddir"
	./config --prefix=/usr \
		--libdir=lib \
		--openssldir=/etc/ssl \
		shared zlib enable-montasm enable-md2 \
		-Wa,--noexecstack \
		|| return 1

	make -j1 || return 1
}

package() {
	cd "$_builddir"
	make -j1 INSTALL_PREFIX="$pkgdir" MANDIR=/usr/share/man install
}

libcrypto() {
	pkgdesc="Crypto library from openssl"
	replaces="openssl libcrypto"
	mkdir -p "$subpkgdir"/lib "$subpkgdir"/usr/lib
	for i in "$pkgdir"/usr/lib/libcrypto*; do
		mv $i "$subpkgdir"/lib/
		ln -s ../../lib/${i##*/} "$subpkgdir"/usr/lib/${i##*/}
	done
	mv "$pkgdir"/usr/lib/engines "$subpkgdir"/usr/lib/
}

libssl() {
	pkgdesc="SSL shared libraries"
	replaces="openssl"
	mkdir -p "$subpkgdir"/lib "$subpkgdir"/usr/lib
	for i in "$pkgdir"/usr/lib/libssl*; do
		mv $i "$subpkgdir"/lib/
		ln -s ../../lib/${i##*/} "$subpkgdir"/usr/lib/${i##*/}
	done
}

md5sums="de62b43dfcd858e66a74bee1c834e959  openssl-1.0.1g.tar.gz
115c481cd59b3dba631364e8fb1778f5  fix-manpages.patch
c6a9857a5dbd30cead0404aa7dd73977  openssl-bb-basename.patch
1f607b8e11347e56a0906756f3d6928a  0001-crypto-hmac-support-EVP_MD_CTX_FLAG_ONESHOT-and-set-.patch
53fbd01733b488717575e04a5aaf6664  0003-engines-e_padlock-backport-cvs-head-changes.patch
c0dae72e29e8fdfb753906411b1722bc  0004-engines-e_padlock-implement-sha1-sha224-sha256-accel.patch
7820941f69acf58f05cccb33faf4ee70  0005-crypto-engine-autoload-padlock-dynamic-engine.patch"
sha256sums="53cb818c3b90e507a8348f4f5eaedb05d8bfe5358aabb508b7263cc670c3e028  openssl-1.0.1g.tar.gz
fe844e21b2c42da2d8e9c89350211d70c0829f45532b89b7e492bfde589ee7ed  fix-manpages.patch
82863c2fed659a7186c7f3905a1853b8bd8060350ad101ce159fa7e7d2ba27e8  openssl-bb-basename.patch
7f40edec04115e97ae2c64e77d3324f6083963200add148f9a4dec090c60550b  0001-crypto-hmac-support-EVP_MD_CTX_FLAG_ONESHOT-and-set-.patch
cc5e464d7bf8e181bb454de65772366ed90ee91716ecbadaaf2dfda2e080fdc2  0003-engines-e_padlock-backport-cvs-head-changes.patch
38b84dd0382fdb3d48e27772d40cde866217a5bace8aa1282288a724b5ea1609  0004-engines-e_padlock-implement-sha1-sha224-sha256-accel.patch
f2d6bffae2fe5fcf76c7b9f6299893846a7730cadf70ab91bc94ee0578d0ba8d  0005-crypto-engine-autoload-padlock-dynamic-engine.patch"
sha512sums="66ebbad3c8ad98a07b486d39d0c3ae62b00133f8f2877cf8b97c461e7c7f40b29cf9c3cae82cf73a92dcf1daa63d33aa76c910fbcbe60158589fc7cb48f41e6d  openssl-1.0.1g.tar.gz
880411d56da49946d24328445728367e0bf13b0fd47954971514bee8cd5613a038ad8aeaf68da2c92f4634deb022febd7b3e37f9bbfc5d2c9c8b3b5ffd971407  fix-manpages.patch
6c4f4b0c1b606b3e5a8175618c4398923392f9c25ad8d3f5b65b0424fe51e104c4f456d2da590d9f572382225ab320278e88db1585790092450cad60a02819a5  openssl-bb-basename.patch
beab0d972037acef0da28cb2729fb7f88d4a1eb816d69a7f7285171a115829c0e371eb2c0f77a608c158ce7a1ee5f3ef42e615450426fa5900913708dac284a3  0001-crypto-hmac-support-EVP_MD_CTX_FLAG_ONESHOT-and-set-.patch
3b1379cee6eef5f524a5763aedcf37561a4cae0c8dcf6822177e981f80215bb98b8849db122dd0cfae15b82c3221ebb50c4d854ee1f475ce1510e031c1e06b6a  0003-engines-e_padlock-backport-cvs-head-changes.patch
87df036263307ee1f84e1e44f9bef432170f793f83b55d68c255f72c99faecdb634bb1b5a4ef751609484f89dd554990fbc48de5eac55caf69009d124b7007c2  0004-engines-e_padlock-implement-sha1-sha224-sha256-accel.patch
10527394de1f8c8530c8599261f08e4bc8c670d4f1bb278d107f7c47d9a7d093c79e9e6019629378066d739725688b4e896600b56a62400c401903aa5d666432  0005-crypto-engine-autoload-padlock-dynamic-engine.patch"
