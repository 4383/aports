# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=openrc
pkgver=0.14
_ver=${pkgver/_git*/}
pkgrel=1
pkgdesc="OpenRC manages the services, startup and shutdown of a host"
url="http://git.overlays.gentoo.org/gitweb/?p=proj/openrc.git"
arch="all"
license='BSD-2'
depends=""
makedepends="bsd-compat-headers"
subpackages="$pkgname-doc $pkgname-dev"
install="$pkgname.post-install $pkgname.post-upgrade"
source="openrc-$pkgver.tar.gz::https://github.com/OpenRC/openrc/archive/$pkgver.tar.gz
	openrc-0.4.3-mkmntdirs.patch

	0001-Force-root-be-rw-before-localmount.patch
	0001-sysctl.Linux.in-fix-for-busybox-sysctl.patch
	swap-umount-tmpfs.patch
	swap-ifexists.patch
	hide-migrate-to-run-error.patch

	hostname.initd
	hwdrivers.initd
	keymaps.initd
	modules.initd
	modloop.initd
	networking.initd
	modloop.confd
	"

_builddir="$srcdir/$pkgname-$_ver"
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1
		esac
	done
	sed -i -e '/^sed/d' pkgconfig/Makefile
}

build() {
	cd "$_builddir"
	make LIBEXECDIR=/lib/rc || return 1
}

package() {
	cd "$_builddir"
	make LIBEXECDIR=/lib/rc DESTDIR="$pkgdir/" install

	# we cannot have anything turned on by default
	rm -f "$pkgdir"/etc/runlevels/*/*

	# we still use our ifup/ifdown based net config
	rm -f "$pkgdir"/etc/conf.d/network "$pkgdir"/etc/init.d/network

	# we override some of the scripts
	for i in "$srcdir"/*.initd; do
		j=${i##*/}
		install -Dm755 $i "$pkgdir"/etc/init.d/${j%.initd}
	done
	
	install -D -m644 "$srcdir"/modloop.confd "$pkgdir"/etc/conf.d/modloop
	install -d "$pkgdir"/etc/local.d "$pkgdir"/run
}

md5sums="9cf465c6013bf95ae003bc4a9d11aed4  openrc-0.14.tar.gz
8c2c1c2ee0509b63966b7187a2079f4b  openrc-0.4.3-mkmntdirs.patch
4fd036ff07ed9ad7fb76af6a3ffc0695  0001-Force-root-be-rw-before-localmount.patch
09df9c2a6fbf3e18586c3737cd481e67  0001-sysctl.Linux.in-fix-for-busybox-sysctl.patch
c2af5e52da614a6cef02d1e4d537e360  swap-umount-tmpfs.patch
1c426b84d13a725ad493647b5253f239  swap-ifexists.patch
679c559aa54f9e855cd735866eeaaad6  hide-migrate-to-run-error.patch
bcdd9cde07728cc7a4159a05236689f0  hostname.initd
ce3832d8ed5906367ef0f4776b38f3bd  hwdrivers.initd
33ca3e558c42cdd17adccbc7807298f7  keymaps.initd
098a1f16812f56fcb56eb6b6f0fa31f6  modules.initd
673667abbca920c3cb203e621e761f30  modloop.initd
55aeca82475cb5a146abff8333bfdf85  networking.initd
c1ec888202d868710b5749f7b217d1e3  modloop.confd"
sha256sums="fbc1a88ac53e01681a8945dccc16a71c86550a741e8f32fd3e75ba46512653f3  openrc-0.14.tar.gz
c807aed11d7eb42de5c421a6d117532f6215697f159f40cb3404bdc80270bee1  openrc-0.4.3-mkmntdirs.patch
e869e2076c10a7134f5d9e4ae4a5d09ca35c6333d400556f1e329170d2e58066  0001-Force-root-be-rw-before-localmount.patch
8125caab3798d97acfae678ab81085ac247d570e471238c0cfc5b08a84cb61bd  0001-sysctl.Linux.in-fix-for-busybox-sysctl.patch
84d67ed2cf050e20f52d4ea048e7452e78356ba02b396d8c064a4458c0811ea4  swap-umount-tmpfs.patch
8978b00492d90b573f5254cc394582e8f1a5cd8b4d6c928fa0a9a022dd17fe9c  swap-ifexists.patch
786580df90a5a75087e5adfd395d160dee2df4b994e0938e8524198aeaf2d774  hide-migrate-to-run-error.patch
46e0453cd31deb4c07029e20bd954d9b6e48d86e8d803824c624af14323638f0  hostname.initd
a71a38309beb6f4718a2ece863659735a5e157a7c927518265e562cd90fc71ff  hwdrivers.initd
a6f013c02ca3efb4e29b4844e4d27710cfd319e66157c4fd88a8169e06e7151f  keymaps.initd
42f7add323ee77d1ee04d96ed4b52897dd1d2a32ab361fd755d4eb707d67e5be  modules.initd
407f4830fd11ff187b97edfdea5b81dcd2747545fe2dbf28ec7dfba48cc91cda  modloop.initd
dc30c4e0cac37597dda3f97f68aa2f8a5e87a9856de8b2fd08579916117de8ed  networking.initd
a5a0316cd59f5401b1d789bb466c98186201277ba6f014017b14965fcc10c254  modloop.confd"
sha512sums="5d2eb8a81fa243b0d1fc6c6a3026461752bf491ba5aa2155b182d3249d98fb3729630ccaaa811402d7f5eaaf08399304357c4011d6523cac0cf69e1d10a02274  openrc-0.14.tar.gz
eee27fbf72776fb70d3aa6c6464180731d522191e5755aa431ab09ea11dd11bf001a95618adcaa5ccc08455268003ca2917b2bff31adc9894214221c469a97db  openrc-0.4.3-mkmntdirs.patch
51c77be5ab726d50ef1d0b9dab644edef1ff739e855e3a12ab27beada8911998e0c6a7491eb92df621dcdb633b672d933a4edc00115ec43bdf1271105239ebb7  0001-Force-root-be-rw-before-localmount.patch
ce9c2cc211a391f20702dbc51fe0cf3c979cb25f5d6d3bdf2ebbaf1c5fd6d39d102a7a37effa751c02a865f91e316672819e0a4c1cd76e0524a7a2a7e2b9a1f6  0001-sysctl.Linux.in-fix-for-busybox-sysctl.patch
8fd442d372401740b1c523367c928f49efa8179604aac2b517cdc4264daf303056d5a5e0a2c996db5e6ef9b7cdd0619a16cfabc15c3399e322384844e2a36542  swap-umount-tmpfs.patch
c5b8806c693b0ea48ff87e0e3669304f5c2f95954ad54814889047a933f367081a8c8d3bb771dd1ed6c3bc845df894232bd6b662066d09eba3abf3964187d1d1  swap-ifexists.patch
750e3305913d3f6fa6baa0b34b851fe17aacb922e864b95ec9b4b451e8e3c16d0c10686a12f4c7cb9b5d05894e1d89b0dac3beed19b1223d3fbc672f25769145  hide-migrate-to-run-error.patch
4734b7acdfe3f830a7e7a3b75de2f4085e4e606f545bf7984add8754dce8ac32e4ed1ecc8aa1047b82a4840138327bb5efacd20c81ec3f5e10ac4e1ff9d85aa0  hostname.initd
932669915d0e4c8b7d23823c6d057d5d3bbc7f2f67532547201fea986c7e3208607d69cfdd41b0b0b1828f33c4e87efb8d65f7a715c33a8c9cdc846b7ec7439b  hwdrivers.initd
ee58de9b8608d3f3aa6111b9b43977b91bd2c39bcc3471711812fe740dbc49eee8a7ddd6f2878b90c8eb9bcc5a2f543cb2d82c04f16c263ffad58de7955d8db5  keymaps.initd
103889e4e183105b87052ead50747358c5cb17627f93c83b84434f9e615f8cad3ae554fb78e1f9f4c634265313d7ae11fe3760a5c97a5d8b4ddf48aa2b489be7  modules.initd
a35748ec6824d6d966e2e3829e57ea296ea87bd0c52f037210c680c5c2039788b42575480e69efc1aaa1242319635b5798e6dce04978cb8c4f47dfde87e5088f  modloop.initd
b46b34d96ba01aa7d19cae12560fbb2724762223fb5717b9d8d8c46c09dbc35829b9626c96cc08b9388614baa990e2fb526aab12c44667851731cae949bded1a  networking.initd
aa702a7da8e6c0e5d8738febaf6b4e4cb021b30ce5c1809b530abf2b36739079446b16fc054740da8d86ed099942cf5deed6597cedb64c058f3def587a8b4689  modloop.confd"
