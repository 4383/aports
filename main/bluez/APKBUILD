# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=bluez
pkgver=5.16
pkgrel=0
pkgdesc="Tools for the Bluetooth protocol stack"
url="http://www.bluez.org/"
arch="all"
license="GPL2+"
depends="consolekit dbus"
replaces="udev"
makedepends="dbus-dev libusb-compat-dev udev-dev
	libical-dev readline-dev glib-dev
	autoconf automake libtool
	"
subpackages="$pkgname-dev $pkgname-doc $pkgname-libs $pkgname-cups
	$pkgname-hid2hci"
source="http://www.kernel.org/pub/linux/bluetooth/bluez-$pkgver.tar.xz
	0001-shared-include-endian.h-for-be32toh-htobe32-and-htob.patch
	0002-unit-prevent-unintended-use-of-glibc-s-error-3.patch
	0003-bnep-avoid-use-of-caddr_t.patch
	bluetooth.initd
	rfcomm.initd
	rfcomm.confd
	"

_builddir="$srcdir"/bluez-$pkgver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	libtoolize --force && aclocal && autoconf && automake --add-missing
}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--libexecdir=/usr/lib \
		--mandir=/usr/share/man \
		--disable-systemd \
		--enable-library \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make install DESTDIR="$pkgdir" || return 1
	rm "$pkgdir"/usr/lib/*.la || return 1
	install -Dm755 "$srcdir"/bluetooth.initd "$pkgdir"/etc/init.d/bluetooth
	install -Dm755 "$srcdir"/rfcomm.initd "$pkgdir"/etc/init.d/rfcomm
	install -Dm644 "$srcdir"/rfcomm.confd "$pkgdir"/etc/conf.d/rfcomm
	install -Dm755 test/simple-agent "$pkgdir"/usr/bin/bluez-simple-agent
}

libs() {
	pkgdesc="Libraries for Bluetooth protocol stack"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libbluetooth.so.* "$subpkgdir"/usr/lib/
}

cups() {
	pkgdesc="Bluez backend for CUPS"
	mkdir -p "$subpkgdir"/usr/lib/
	mv "$pkgdir"/usr/lib/cups "$subpkgdir"/usr/lib/
}

hid2hci() {
	pkgdesc="Put HID proxying bluetooth HCI's into HCI mode"
	replaces="bluez"
	mkdir -p "$subpkgdir"
	mv "$pkgdir"/lib "$subpkgdir"/
}

md5sums="4cf4e60e5eaed8eaf42caa816d356ca1  bluez-5.16.tar.xz
983fa9455a969e0df38ddbe9ab460917  0001-shared-include-endian.h-for-be32toh-htobe32-and-htob.patch
1d87b1ed2603eb37ae96d4368192737a  0002-unit-prevent-unintended-use-of-glibc-s-error-3.patch
e320ccd2ec08d81018ed4f92f198bf66  0003-bnep-avoid-use-of-caddr_t.patch
7a5611fa2cf42da2e844f96b2efa9f3b  bluetooth.initd
7672edb8e33c4495ee9febb9864feb10  rfcomm.initd
7f4bb093adb0f519c621f2ea68712f35  rfcomm.confd"
sha256sums="c8d5094a21a799dca9cdcd99651dc19d521af514b22b8178fc787c454cdbb163  bluez-5.16.tar.xz
3ec238c343466e5f835365c2d9fa7d3039fc22b9a40bc98aa3f8dda4a2bccf50  0001-shared-include-endian.h-for-be32toh-htobe32-and-htob.patch
d1a7018c0971ad52d31b6eb6231deb86de5f913d0a6661992716c6a797c2c1bc  0002-unit-prevent-unintended-use-of-glibc-s-error-3.patch
6d3c08dd9ddd2c16b74a0e4039c336a2b78dbb2e5b7a54e040ebfb76009a065e  0003-bnep-avoid-use-of-caddr_t.patch
d4aef203e184bef4284b3719268c91e07a1e3f84cbdea2ac8ab40a2617ac9186  bluetooth.initd
4430703a9bec9a9482416b2d24aa47492264768a0b61356b361bbc8b1229a83e  rfcomm.initd
672498957049fd301f9c9c1dc9fa49430e5e6d3c3f1f3cdce80df3af7d425d08  rfcomm.confd"
sha512sums="27ac9aa98107b234696885ce3f40736dc25b9e4b34baa6b4d9dd3f0b81d4ca364a819f42801bddc8c1a247be1db37ac3c7e7802188ad943b996c07b640db65b1  bluez-5.16.tar.xz
b7c946cac036a639eeb31e34437ed8e84b6613bc8da7b564b585b30bd02323843545b932ee49c2f53176315075f57e471ba397a725e052f7a3bfdc68c2e4ec32  0001-shared-include-endian.h-for-be32toh-htobe32-and-htob.patch
e1cd0675c037ab1cfdbda0cbb8e1ea493ee1ad9fb447c4836b9fd97df35ee63a6535f903ea6260c3fa40a36b48fdc8bff490a98f659edb8717adb3bc854d6c0e  0002-unit-prevent-unintended-use-of-glibc-s-error-3.patch
90b8270e3101f1e8e2bbde1f31b27cedaac40ebbd91e754ce5150829667cfb15b9ba71bd39bfb6fff6d4d72a905b1cdf0eba84931adecc1236902bfe37b9020e  0003-bnep-avoid-use-of-caddr_t.patch
2c13cde6561c5aa8b2f27306851458966c67853f6ac2358d09019fda14d3d8e3ff6d9f1c90512c67063d1e1954ec05bf117c5fafc7716446cc5786e9cc12c49f  bluetooth.initd
8f14b4e05c9ecaf4586ed2fdc2d2519de6b613de62ae5c95508baa682630f3112c5b6db6850f76679afc49e06f2ad035d148fa30b9b980747b6fb423f7bebe88  rfcomm.initd
a70aa0dbbabe7e29ee81540a6f98bf191a850da55a28f678975635caf34b363cf4d461a801b3484120ee28fdd21240bd456a4f5d706262700924bd2e9a0972fb  rfcomm.confd"
