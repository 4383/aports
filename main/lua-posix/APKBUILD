# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=lua-posix
_name=luaposix
pkgver=5.1.26
pkgrel=1
pkgdesc="POSIX library for Lua"
url="https://github.com/luaposix/luaposix"
arch="all"
license="MIT"
depends="lua lua-bitlib"
makedepends="lua lua-dev perl ncurses-dev"
source="luaposix-$pkgver.tar.gz::https://github.com/luaposix/luaposix/archive/release-v$pkgver.tar.gz
	0001-Removed-Lua-5.2-functions-lua_len-and-lua_tointegerx.patch"

replaces="luaposix"
subpackages="lua-curses $pkgname-doc"

_builddir="$srcdir"/$_name-release-v$pkgver
_lualib=/usr/lib/lua/5.1
_luashare=/usr/share/lua/5.1

prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}
build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--libdir=$_lualib \
		--datadir=$_luashare \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	rm "$pkgdir"/$_lualib/*.la || return 1
}

curses() {
	pkgdesc="ncurses binding for Lua"
	replaces="curses"
	mkdir -p "$subpkgdir"/$_lualib "$subpkgdir"/$_luashare
	mv "$pkgdir"/$_lualib/curses* "$subpkgdir"/$_lualib/ || return 1
	mv "$pkgdir"/$_luashare/curses* "$subpkgdir"/$_luashare/ || return 1
}
md5sums="26018f1e581e24d2875e848a77d03139  luaposix-5.1.26.tar.gz
2af13134ae7e936e74f6f1f2f011a3ba  0001-Removed-Lua-5.2-functions-lua_len-and-lua_tointegerx.patch"
sha256sums="8de25b0013cc97ccf5ccd8b23012a548fb8ed682d8d95c849c3798bdfbda9866  luaposix-5.1.26.tar.gz
256504f015850b3126a53d40d6210b8d6f473bc3c180b74621c62709d3db594d  0001-Removed-Lua-5.2-functions-lua_len-and-lua_tointegerx.patch"
sha512sums="48e8a7ab8752d0a87326226813c1feb4f76596c568eb657777c8861837fd036835107c1ef7125d9512d42326ce560249057a791e99c36e29228fae665443fb59  luaposix-5.1.26.tar.gz
b460d42e39c790ca4dd44b16923a9a44267a2b2088995eed9cdbfc9b852d9beb30f96a30cceddd6bbe32e2ed2cc806515e8d9e9fb7a3d877043a65f1f1f2394e  0001-Removed-Lua-5.2-functions-lua_len-and-lua_tointegerx.patch"
