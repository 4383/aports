# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=webkitgtk
pkgver=2.0.0
pkgrel=0
pkgdesc="portable web rendering engine WebKit for GTK+"
url="http://webkitgtk.org/"
arch="all"
license="LGPL BSD"
depends=
depends_dev="gtk+3.0-dev libsoup-dev gstreamer1-dev gst-plugins-base1-dev"
makedepends="$depends_dev
	autoconf automake libtool
	bison
	enchant-dev
	expat-dev
	flex
	gnutls-dev
	gobject-introspection-dev
	gperf
	gtk+2.0-dev
	gtk-doc
	icu-dev
	libgcrypt-dev
	libgpg-error-dev
	libjpeg-turbo-dev
	libpng-dev
	libsecret-dev
	libsoup-dev
	libwebp-dev
	libxcomposite-dev
	libxcursor-dev
	libxdamage-dev
	libxi-dev
	libxml2-dev
	libxrandr-dev
	libxslt-dev
	libxt-dev
	mesa-dev
	pango-dev
	perl-switch
	ruby-gems
	sqlite-dev
	zlib-dev
	"
install=
replaces="webkit"
subpackages="$pkgname-dev $pkgname-lang"
source="http://webkitgtk.org/releases/webkitgtk-$pkgver.tar.xz
	webkit-gtk-1.7.90-parallel-make-hack.patch
	webkitgtk-1.10-textrels.patch
	"

_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"
	for i in $source; do
		case "$i" in
		*.patch)
			msg "Applying $i"
			patch -p1 -i "$srcdir"/$i || return 1
			;;
		esac
	done
	libtoolize --force && aclocal -I Source/autotools && autoconf && automake || return 1
}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--disable-geolocation \
		--disable-webkit2 \
		--with-gtk=3.0 \
		|| return 1
	# hack to work around parallel make problems,
	# see https://bugs.webkit.org/show_bug.cgi?id=79498
	make -j1 all-built-sources-local \
		&& make all-ltlibraries-local \
		&& make all-programs-local \
		&& make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	rm -f "$pkgdir"/usr/lib/*.la
	# verify so we don't have textrels
	if scanelf -qRt "$pkgdir" | grep TEXTREL; then
		error "found textrels"
		return 1
	fi
}

md5sums="fa231ba8c9cd33575b9692614324be21  webkitgtk-2.0.0.tar.xz
de77a3e7e61753e7f1cce3f4bd00a3f6  webkit-gtk-1.7.90-parallel-make-hack.patch
9ace721086b25f0f32d7f76b29789f67  webkitgtk-1.10-textrels.patch"
sha256sums="454cdc4beffc2010f83661059178e33b6d9a07bcd60d09eabdf5d7cda17b88e4  webkitgtk-2.0.0.tar.xz
e20d7d45e6230308f7d4a7aac1095cb1fe8d9c7eb0f3e65b061acf8bc4bbaf73  webkit-gtk-1.7.90-parallel-make-hack.patch
754bbf13c7a6c9bd745f642367ff884156020dd2ea7611c3d20a509c6685c836  webkitgtk-1.10-textrels.patch"
sha512sums="bd1dbe51b49462c2e138d8d8779ff2b568de9beb6ae5da86da720e3fba668399118d9f47f3440fa7e9ab90beb28852c757b787651c8200de3cbcec5e6e1dbeb5  webkitgtk-2.0.0.tar.xz
907356faab08ebf65da8760ad11ee8ecd4e97274b1c00c1e207fd52e479d64a0545ba66859b1a79bd150a95da4a9e8724b3c461a24f803fb341b8242566b5cc0  webkit-gtk-1.7.90-parallel-make-hack.patch
c3502a11ce4777abc164209c0087ec7cb6c28b376056bee52651b4e4bd2d49f2d6e4a74422f21d9bce848479a4a1b02052935b3c9397f1d43a59b3de22ef2758  webkitgtk-1.10-textrels.patch"
