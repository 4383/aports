From d43136f093e2893457c4e0d944925c97ba86effc Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Mon, 22 Nov 2010 14:42:36 +0000
Subject: [PATCH] lbu: fix lbu status for encrypted apkovls

http://redmine.alpinelinux.org/issues/480
---
 lbu.in |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/lbu.in b/lbu.in
index 527b9e7..309a8ab 100644
--- a/lbu.in
+++ b/lbu.in
@@ -140,6 +140,9 @@ unpack_apkovl() {
 	local count=0
 	mkdir -p "$dest"
 	mount_once "$mnt"
+	if [ -n "$ENCRYPTION" ]; then
+		f="$f.$ENCRYPTION"
+	fi	
 	if [ ! -f "$mnt/$f" ]; then
 		return 1
 	fi
@@ -147,7 +150,6 @@ unpack_apkovl() {
 		tar -C "$dest" -zxf "$mnt/$f"
 		return
 	fi
-	f="$f.$ENCRYPTION"
 	check_openssl
         while [ $count -lt 3 ]; do
 		$OPENSSL enc -d -$ENCRYPTION -in "$mnt/$f" | tar \
@@ -564,7 +566,10 @@ cmd_status() {
 	unpack_apkovl "$tmp/a"
 
 	# generate new apkovl and extract to tmpdir/b
+	local save_encryption="$ENCRYPTION"
+	ENCRYPTION=
 	cmd_package - | tar -C "$tmp/b" -zx
+	ENCRYPTION="$save_encryption"
 
 	# show files that exists in a but not in b as deleted
 	local f
-- 
1.7.3.2

