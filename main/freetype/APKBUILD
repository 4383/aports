# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Carlo Landmeter <clandmeter@gmail.com>
pkgname=freetype
pkgver=2.6.3
pkgrel=0
pkgdesc="TrueType font rendering library"
url="http://freetype.sourceforge.net"
arch="all"
license="GPL"
depends=""
depends_dev="libpng-dev"
makedepends="$depends_dev zlib-dev"
subpackages="$pkgname-dev $pkgname-doc"
# fontconfig-ultimate https://github.com/bohoomil/fontconfig-ultimate
_ultver="2016-02-12"
source="http://download.savannah.gnu.org/releases/freetype/freetype-$pkgver.tar.bz2
	fontconfig-ultimate-$_ultver.tar.gz::https://github.com/renatoaguiar/fontconfig-ultimate/archive/$_ultver.tar.gz
	40-memcpy-fix.patch
	CVE-2016-10244.patch
	CVE-2017-8105.patch
	CVE-2017-8287.patch
	"

# secfixes:
#   2.6.3-r0:
#     - CVE-2016-10244
#     - CVE-2017-8105
#     - CVE-2017-8287

_builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	cd "$_builddir"
	for i in "$srcdir"/*.patch; do
		msg "Applying ${i}"
		patch -p0 -i $i || return 1
	done
	# apply infinality
	for j in "$srcdir"/fontconfig-ultimate-$_ultver/$pkgname/*.patch; do
               case $j in
                        */gperf-for-infinality.patch)
                                msg "Skipping ${j}"
                        ;;
                        *)
                                msg "Applying ${j}"
                                patch -p1 -i $j || return 1
                        ;;
                esac
	done
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--disable-static \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make -j1 DESTDIR="$pkgdir" install || return 1

	# for compat. This should be removed once all apps are properly using
	# pkg-config
	ln -s freetype2 "$pkgdir"/usr/include/freetype

	# install infinality profile settings
	install -Dm755 "$srcdir"/fontconfig-ultimate-$_ultver/$pkgname/infinality-settings.sh \
		"$pkgdir"/etc/X11/xinit/xinitrc.d/infinality-settings.sh || return 1
	sed -i "1i #!/bin/sh" \
		"$pkgdir"/etc/X11/xinit/xinitrc.d/infinality-settings.sh || return 1
}

md5sums="0037b25a8c090bc8a1218e867b32beb1  freetype-2.6.3.tar.bz2
d5d9467394b73baf4e830b3f6fc944cd  fontconfig-ultimate-2016-02-12.tar.gz
bd2d808a0c00dcf9f1d1c0a9a8227ad9  40-memcpy-fix.patch
0bb752550d20a3bee72f737ad479991a  CVE-2016-10244.patch
478ff673ef99f69bcc4fa0957b606cf3  CVE-2017-8105.patch
a45568a4c33ed3768e73ab7951ef2bf8  CVE-2017-8287.patch"
sha256sums="371e707aa522acf5b15ce93f11183c725b8ed1ee8546d7b3af549863045863a2  freetype-2.6.3.tar.bz2
c67e3a8c5cdb19636e936a822df862e59f84b468e3d70d0991b23bb37099d356  fontconfig-ultimate-2016-02-12.tar.gz
574c265c7a7032c5afb32a9807e5d04354ad0def656194cfcfff1ccca6a5540e  40-memcpy-fix.patch
9ad660d70077c167a41da007056eada3fd9dab3ba802e14d5b46426e5ded6692  CVE-2016-10244.patch
173689b597571f05a1187bc92a400d6bc838a693301011544be982952dc80904  CVE-2017-8105.patch
235c3946ad3bbd11685cb6511be46e84adeaf52c23511863e9aa715a5369a8a2  CVE-2017-8287.patch"
sha512sums="e1f9018835fc88beeb4479537b59f866c52393ae18d24a1e0710a464cf948ab02b35c2c6043bc20c1db3a04871ee4eb0bb1d210550c0ea2780c8b1aea98fbf0d  freetype-2.6.3.tar.bz2
b6d7a59c4a26b3b99a817e27eead2ca58538770b48af935100262223d5422c835c48590736cedb59ad220be3d7af6a7933e3137da99fdc8603f8fc8d81b8e4b9  fontconfig-ultimate-2016-02-12.tar.gz
1553f7f0514238012e300bc8d0b1e260145db17fb56f13e4aa667435e98c3749c00e150caa0e318289b84bca33b9a06a68b8342575e10ac3bf5af3d5cc861537  40-memcpy-fix.patch
64f7ca7b84d8ddf881beed097911f52f704539f872c67c2490d42ab44c879d973a8d7bd290fe841248998d2fade5ab4a71a725148f91deb624135552437a1162  CVE-2016-10244.patch
8992af56a71329f67f0bd445ef2b1d5e10f2ac5281c449ccbf0dbc826027ba8c828c05dbe5aee2e5a7d6b8cd8443192268a4177759c9158c0008d546c6dd9093  CVE-2017-8105.patch
703e345868d0a391645227918fa49ba1e2e1f0009c5f80e8177b9c0468b8c9ae8d47da1bb65a103133e221946556aa49fa24ea0cb1cc270331f7c4954c8b95bd  CVE-2017-8287.patch"
