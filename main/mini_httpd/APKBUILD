# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=mini_httpd
pkgver=1.23
pkgrel=1
pkgdesc="Small forking webserver with ssl and ipv6 support"
url="http://www.acme.com/software/mini_httpd/"
arch="all"
license="BSD"
depends="logrotate"
makedepends="openssl-dev"
subpackages="$pkgname-doc"
install="$pkgname.pre-install $pkgname.pre-upgrade"
source="http://www.acme.com/software/mini_httpd/$pkgname-$pkgver.tar.gz
	fix-cgi.patch
	$pkgname.conf.sample
	$pkgname.initd
	$pkgname.logrotate
	"

_builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	cd "$_builddir"

	local i
	for i in $source; do
		case $i in
			*.patch)
				msg "$i"
				patch "${patch_args:--p1}" -i "$srcdir/$i" || return 1
				;;
		esac
	done

	sed -i s:getline:htgetline:g \
		htpasswd.c || return 1
}

build() {
	cd "$_builddir"
	make CFLAGS="${CFLAGS} -DUSE_SSL" \
		LDFLAGS="${LDFLAGS}" \
		SSL_LIBS="-lssl -lcrypto" \
		|| return 1
}

package() {
	cd "$_builddir"
	# does not respect DESTDIR
	make install \
		BINDIR="$pkgdir"/usr/sbin \
		MANDIR="$pkgdir"/usr/share/man

	# rename htpasswd to mini_htpasswd
	mv "$pkgdir"/usr/sbin/htpasswd "$pkgdir"/usr/sbin/mini_htpasswd
	mv "$pkgdir"/usr/share/man/man1/htpasswd.1 \
		"$pkgdir"/usr/share/man/man1/mini_htpasswd.1

	mkdir -p "$pkgdir"/var/www/localhost/htdocs
	install -D -m644 ../mini_httpd.conf.sample \
		"$pkgdir"/etc/mini_httpd/mini_httpd.conf
	install -D -m755 ../mini_httpd.initd "$pkgdir"/etc/init.d/mini_httpd
	install -D -m644 ../mini_httpd.logrotate \
		"$pkgdir"/etc/logrotate.d/mini_httpd
	install -d "$pkgdir"/var/run/mini_httpd "$pkgdir"/var/log/mini_httpd
}

md5sums="fb8ba6d826a8b28d1885a9fca473c120  mini_httpd-1.23.tar.gz
ad4d92f99a2d37ffb55d7aac29eca777  fix-cgi.patch
9254094233d05a69b2953dd9e8c9ce1c  mini_httpd.conf.sample
1679e25f17788a8c9be752ff059bbd9b  mini_httpd.initd
915683e9c7e1cef7ce9b1bbaa31ab680  mini_httpd.logrotate"
sha256sums="bcc8c88392a4baeba5fa3ca8b924e9558c3dcb3018989b228d4f621acc8fffca  mini_httpd-1.23.tar.gz
51f0a907a39a4d0f590da9b9f65b4e766254df214e7064a45826540f61c9f092  fix-cgi.patch
bc6fb1d7a1ac42549b469be5dd4368a5afca502562f9488a7061f16d0434d353  mini_httpd.conf.sample
cae12348aa748a24d52ca51c7846e5af28e3bf3c57c08b5f436b1fb82f4aa0cd  mini_httpd.initd
e7b4388fc574916b0b4948c60655f55c51a481fe1b2c2f34c55775f0c454bcb5  mini_httpd.logrotate"
sha512sums="a3895830d0a3d2f649ef46948eb7dbf7319402c7e610859fec5e7bc04acafa10c22a170baf70582a392b5758696cf4fdebe3718de9c7f40cfaa3ea80b957238a  mini_httpd-1.23.tar.gz
48fd5d9395654fee76b0b09340b34d5afba4c0bbcb816cde0d75e24dced384ea237e50689fcdd7881ddf227750eada589595d24f3405e3861d591c3b478a2a25  fix-cgi.patch
4ecb6a2686cebfa97ff5f7ab99f6903d43468a01eea9d3e5852f2bcc48f280b538a17acaa30aff05ea4645df8bfa6544082a494452e1eff9745f86460e378411  mini_httpd.conf.sample
821e775318d7fff1f77dc3bd08ac2095233a9224be424eb796c1d6eae6cea5b1ed99a6b18d367bb120ceff5f5a2026f88c6bc3d54a754120bc68b27ea7c46a49  mini_httpd.initd
ebaae32d151de8d8f923b0bbfd7a3524d47ee96fce46b46e8f44f5495459828508bb98b3c0250c76bf76e205f61ef4dfc273835731e3edf8e3d51761dd638e3c  mini_httpd.logrotate"
