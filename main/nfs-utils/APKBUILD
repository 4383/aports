# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=nfs-utils
pkgver=1.3.1_rc3
_basever=1.3.0
pkgrel=0
pkgdesc="kernel-mode NFS"
url="http://nfs.sourceforge.net/"
arch="all"
license="GPL"
depends="rpcbind"
makedepends="util-linux-dev libtirpc-dev libcap-dev libevent-dev
	libnfsidmap-dev keyutils-dev lvm2-dev krb5-dev sqlite-dev
	autoconf automake libtool !rpcgen"
subpackages="$pkgname-doc $pkgname-dbg"
[ "$ALPINE_LIBC" != "eglibc" ] && subpackages="$subpackages rpcgen"

source="http://downloads.sourceforge.net/nfs/$pkgname-$_basever.tar.bz2
	nfs-utils-1.3.1-rc3.patch
	0001-conffile-use-standard-uint-_t-and-unsigned-char.patch
	0002-Fix-header-include-for-definition-of-NULL.patch
	0003-configure.ac-enable-GNU_SOURCE-for-stat64-statfs64.patch
	0004-replace-__attribute_malloc__-with-the-more-portable-.patch
	0005-mountd-use-standard-dev_t-instead-of-glibc-internals.patch
	0006-nfsstat-replace-the-legacy-SA_ONESHOT-with-standard-.patch
	0007-Allow-usage-of-getrpcbynumber-when-getrpcbynumber_r-.patch
	0008-Only-work-around-glibc-bugs-on-glibc.patch
	0009-include-libgen.h-for-basename.patch
	0010-exportfs-fix-test-of-NULL-pointer-in-host_pton.patch
	0011-exportfs-only-do-glibc-specific-hackery-on-glibc.patch
	0012-rework-access-to-proc-net-rpc.patch

	nfs-utils-mtab-sym.patch
	uclibc-getaddrinfo-canonname.patch
	musl-getservbyport.patch

	nfs.initd
	nfsmount.initd
	rpc.gssd.initd
	rpc.idmapd.initd
	rpc.pipefs.initd
	rpc.statd.initd
	rpc.svcgssd.initd
	nfs.confd
	nfs.exports
	"

prepare() {
	cd "$srcdir/$pkgname-$_basever"
	for i in $source; do
		case $i in
		*.patch) msg "Applying $i"
			patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	# fix build on eglibc
	if [ "$ALPINE_LIBC" != "eglibc" ]; then
		sed -i -e '/^#include <libio.h>/d' \
			support/include/sockaddr.h || return 1
	fi
	# busybox install fix
	sed -i 's/--mode 755/-m755/g' \
		tools/nfs-iostat/Makefile.am \
		tools/nfs-iostat/Makefile.in \
		tools/mountstats/Makefile.am \
		tools/mountstats/Makefile.in || return 1

	./autogen.sh || return 1
}

build() {
	cd "$srcdir/$pkgname-$_basever"

	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--without-tcp-wrappers \
		--enable-ipv6 \
		--enable-nfsv4 \
		--enable-uuid \
		--enable-gss \
		--enable-libmount-mount \
		|| return 1

	make || return 1
}

package() {
	cd "$srcdir/$pkgname-$_basever"
	make -j1 DESTDIR="$pkgdir" install

	for i in nfs rpc.pipefs rpc.svcgssd nfsmount rpc.idmapd rpc.gssd \
			rpc.statd; do
		install -m755 -D "$srcdir"/$i.initd "$pkgdir"/etc/init.d/$i \
			|| return 1
	done


	install -m644 -D "$srcdir"/nfs.confd "$pkgdir"/etc/conf.d/nfs
	install -m644 -D "$srcdir"/nfs.exports "$pkgdir"/etc/exports
}

rpcgen() {
	pkgdesc="Remote Procedure Call (RPC) protocol compiler"
	cd "$srcdir/$pkgname-$_basever"
	install -m755 -D tools/rpcgen/rpcgen "$subpkgdir"/usr/bin/rpcgen
}

md5sums="3ac3726eda563946d1f44ac3e5b61d56  nfs-utils-1.3.0.tar.bz2
4f6b75806437b08742f95eeb8abc640e  nfs-utils-1.3.1-rc3.patch
714afe3a88d6a584d15e167c96c57925  0001-conffile-use-standard-uint-_t-and-unsigned-char.patch
42df50df2888a3384550d4f5667fb515  0002-Fix-header-include-for-definition-of-NULL.patch
0ee94b77a48b6b364e6b14bb75b992a2  0003-configure.ac-enable-GNU_SOURCE-for-stat64-statfs64.patch
2e67ee958bbdcc11d1888c1b8c4329f0  0004-replace-__attribute_malloc__-with-the-more-portable-.patch
d10a5b570dbbb20accfb4117f605914a  0005-mountd-use-standard-dev_t-instead-of-glibc-internals.patch
4b5e2ed10351eb8d6ab4aa99e65d72aa  0006-nfsstat-replace-the-legacy-SA_ONESHOT-with-standard-.patch
93588b3c68825eadf758832a0045f9e2  0007-Allow-usage-of-getrpcbynumber-when-getrpcbynumber_r-.patch
3b733a0bb274ecdf80bbc09b2a11aa4f  0008-Only-work-around-glibc-bugs-on-glibc.patch
6424e1113a838ab35eb8623ed82a2352  0009-include-libgen.h-for-basename.patch
232a07d7d923435a12e51ee74e05cea2  0010-exportfs-fix-test-of-NULL-pointer-in-host_pton.patch
5994a46367486129e2892c73dcdc82c2  0011-exportfs-only-do-glibc-specific-hackery-on-glibc.patch
1f6ba2d021b5fa7f7ea4e66b393bd268  0012-rework-access-to-proc-net-rpc.patch
2b2d228f9947581c924a691a84664fa1  nfs-utils-mtab-sym.patch
37a82a3a81410b483790ca30d564f4ba  uclibc-getaddrinfo-canonname.patch
b2a716619a34194afbf0dc1c2371b478  musl-getservbyport.patch
9e402e75f23b886fce2f53bec2c1d415  nfs.initd
d514fb87ce5de9909f43d99012352f09  nfsmount.initd
144b0e1f7d32265abe4c499a47af6154  rpc.gssd.initd
650f68e51a02ba84c272960fc302c445  rpc.idmapd.initd
80772890099fafdb8af3d6dd3db242c2  rpc.pipefs.initd
37fdb069a5fcabea507012497bb95c53  rpc.statd.initd
20e71ab412555b2dc9b50f346f68e5c8  rpc.svcgssd.initd
09135438d6df50b868bbe5a2260f973c  nfs.confd
4f1bb7b2412ce5952ecb5ec22d8ed99d  nfs.exports"
sha256sums="25f1c974018c944347d74eebe89643e1004c822a6145153136b192d1acfaf60d  nfs-utils-1.3.0.tar.bz2
d138a10d4d97e185f1563574019919881a742f2908ef432055b64c4e1a249e2c  nfs-utils-1.3.1-rc3.patch
3ea08ea31560eef7315953d691862174bb1a814ef7d5a0c7d695e922d8723b67  0001-conffile-use-standard-uint-_t-and-unsigned-char.patch
562647aeb295c612889744a4ca7770409ac60ff5953210e5765cac6689d9b0c4  0002-Fix-header-include-for-definition-of-NULL.patch
bf0af038c1f73a15abaca0242652b9f6666bdff9eae0ac6d4188291abe742769  0003-configure.ac-enable-GNU_SOURCE-for-stat64-statfs64.patch
5f95083f65eb4b8f7e2687a1070c0a7a8eee1ec2fb10a56a47e4d69ddd3b9188  0004-replace-__attribute_malloc__-with-the-more-portable-.patch
993b944d25f03fe7282e1be1d1a294e72d2f879365f08d5c59ea377e51736204  0005-mountd-use-standard-dev_t-instead-of-glibc-internals.patch
5f9ef2978c6cf2c7883984d2ef6bbcb79d88e2155e0b183bfbb8748d1696ba81  0006-nfsstat-replace-the-legacy-SA_ONESHOT-with-standard-.patch
cae35793e7548be84fdb4719d92156b7ff167304952fd15d9023e051ec176a82  0007-Allow-usage-of-getrpcbynumber-when-getrpcbynumber_r-.patch
1de98cbae3b03ea3fba14f1a125bf88b01581e7a9e155377b9d9d98963ced365  0008-Only-work-around-glibc-bugs-on-glibc.patch
e0eca027b68c191dc96ca89ebe628df18e487b7cbdfb3629231526ef35953de6  0009-include-libgen.h-for-basename.patch
280ab8bb989c555d880c0aa9b75a6fa83d3bf912ffde75588d914eb9d4cdf54d  0010-exportfs-fix-test-of-NULL-pointer-in-host_pton.patch
0bd62ea53c980369990f04b620db725259fa919a351b8ed44e081a8b7a1c221e  0011-exportfs-only-do-glibc-specific-hackery-on-glibc.patch
2d5cc55a6047ef576d6795442b3926f7f686122be26be8566606e0a2d5695b56  0012-rework-access-to-proc-net-rpc.patch
5a1c6875f43ecc93d5db7bcf84b4ceda16c09b6109c28696eb55d05247511706  nfs-utils-mtab-sym.patch
7c7451365001f1672abd6fd6dd53da03617a9baa4758ec515b3adf8b7bb7ad93  uclibc-getaddrinfo-canonname.patch
ae46423ef3383f4a134f578c29a7100d58cde8d8853e88f3ffd66a261d436421  musl-getservbyport.patch
81b546cb98be4678cd22f4da39927d2c79532717d927bfba055af447dbff26a5  nfs.initd
f2f5b54fef59f24a1fc6a8b814dfe2cfdeeb02fd0d5041cff31650e626fe4b75  nfsmount.initd
00d9c29280a83e8458c33139d04a9b38c6fdba9d7cb9b420ca83bf6b10e6435d  rpc.gssd.initd
3ce65326859c43983dad25ad2d4731488c488037796e39b6b5eda336e8bf81ef  rpc.idmapd.initd
d651ad9099ea443282476fcedf52c00f0a274eb6a9e4b58a5838780369206973  rpc.pipefs.initd
a727948ccf665b6bb1977ac3014b7086ff654173d1a2be1e2b38a43e97f84ca8  rpc.statd.initd
f1c460d8b0e91e54a551397d755135d05a3728d81de596535bf8bda074455677  rpc.svcgssd.initd
9ca3b7dfbac5bedd818a3637805380f4e873ef8e809c21c26f410c86ac16e03e  nfs.confd
f2aaf1c92e07172adeb65f7f2bc0140c533ae453a3477e99be677ef2e05f2d4b  nfs.exports"
sha512sums="9cb9efa26d2b1bd6ae3e0c516ac50b17b4c7993366ae36c7786da734dc8ea4dd7a05f0d6fabb6fba6df36ead8642341a095f1972cb46b400840705356d410a6a  nfs-utils-1.3.0.tar.bz2
a19bea1792e2034e713c49f407512ed6a5d0bfc9c99a8ef96b656b183f90d44554d2f007f28d2ba66e07c9756c9c50d6b5fab3a200fb6ce573e2d7755ec2cf0b  nfs-utils-1.3.1-rc3.patch
4f215d3824142dcf911e57e5772c8d8df4671703c46ba1a28afeca84c94c566034fbaa11214998ae8e636666b32afac6fcfd7b7ee7ba3f4ce469a5952e3aea18  0001-conffile-use-standard-uint-_t-and-unsigned-char.patch
7e6367904135465a06561ab3053362992380eaaa012277697d6f3ae7bbdf022d20cb1e36099ecfb646f414892eb1c32142073561f48ab82f09589473115fb889  0002-Fix-header-include-for-definition-of-NULL.patch
30161e256160ba258e588412e6dbe5a7b112c19963c489eb01b4b93af329c5f034a6466e44031c4b63f9df9577d30ba8b50102013abdde7bcb40b08d1d222a35  0003-configure.ac-enable-GNU_SOURCE-for-stat64-statfs64.patch
fea39cdc904cf58c0ddf848c941e8bfda12f30e3a723b9be051042682876d7fbe3bf42b464e1f38993230cb63a7a55d93c08cb26dd6b79b482e10cf4f119515b  0004-replace-__attribute_malloc__-with-the-more-portable-.patch
8372f6f5b71e9f5e262396c7d319188998e46e91ad763d0acc5e8931d1a12f2240f49dfcab20a71048ec2445e8dbb0d15d8f798978308fd492e146beda4a589e  0005-mountd-use-standard-dev_t-instead-of-glibc-internals.patch
0d8030816a19ababbc2c3e59960240fe3ed84a058082f7f5bee28129cb9969d14be6d6ebb96d0992928ef76610c94dc5937510db05b4853ef93489ea7134af4b  0006-nfsstat-replace-the-legacy-SA_ONESHOT-with-standard-.patch
c665989dfb7d050f87f998373d1b26e816beb87063df625596aca6bf372a65a919d6cf8c8b1664f9aa3422a95e276a0ad5b11b883a40a65c0769fd5f37ea08f9  0007-Allow-usage-of-getrpcbynumber-when-getrpcbynumber_r-.patch
fe8191a231cd53dd5e44abeb46dbe34bf33df8f8071375c7f80468c12a6de47d16e6eba1342dbd889b16a821491b80f191691fae29f5e4a46f262e3d8beca5ab  0008-Only-work-around-glibc-bugs-on-glibc.patch
b5042e36f46701ef1163f54e3ef537a07590dec71e39f4fc64ba7a9d0e27a2d7c65af0e639a17867704f212774a375d47bf9bba74ec4c5afffe59c8cee74c588  0009-include-libgen.h-for-basename.patch
703f1cd9f72faad84fbf60f631acb8e1927a1915addcc64840f6f690e6577837b7a3cefd493fc3b553e724c31352053558395a7a813c90c4186666cd5fd433e1  0010-exportfs-fix-test-of-NULL-pointer-in-host_pton.patch
9561a979a2313f00c0bbb2ffb3193ca089e5de2f15cf5b6c142e65e04a9401bbc962e490e5b1de026750262a05e5258b286a79781444e7f2ac6bd581b426211a  0011-exportfs-only-do-glibc-specific-hackery-on-glibc.patch
babaf804265cdd768a2dc8ec798e0a31e8cd8c65c6d8f57f4d254b9b56f336c1c3ec2e8a34ed7765a32720b5d75eb9490ad6269daba51aded8fe29136b3b715e  0012-rework-access-to-proc-net-rpc.patch
5fd9039a61a0cdaeb57b5332ea545034101e6f15be200b7cf8fc7d0a3d22836a6fc778e0560656c1825808a4dc09046d9923d81b4d1324a6e526b226c657d064  nfs-utils-mtab-sym.patch
b9f0820773d3ab82cfa9ba603c83f98a71ad2e7205418c1223344b5b3e1bdfbb6aa183ab830df25ded660a4950d0e54098485fa08a4f6b6363a62c0f6c713489  uclibc-getaddrinfo-canonname.patch
a14fc747cc75f65bb206b28eb4f838ae85687c917893531318d3991adc3ed9914316b97fc507bf34881855c9978ad9d4617f33e464d1a0d746a65b31177687c1  musl-getservbyport.patch
98eeae4b30fe13d6fdeb62d47e05fd5bc577946d84a3fe84703dcc90c58768f0d1886a0aa9262ead3aac5c4bd6d7b1cc2b703fb9603baffad4ac2ead635294f3  nfs.initd
8e720417d7443c6bd4e3bda9e7bf4a61b073009fc1750ec0c7378fb01d726ee827a759c6bc10629606b4f2dbd7884807a9e0b8377382e4968f06ef8e938537ae  nfsmount.initd
cd4f763c7cced0eecb03e2d4c8fb1d5fbbddd119a014dee4e9cb881d3750fb01a50daa4475700914785cb1313ceef638b7de4d8dddac90cbab63888cc81938f6  rpc.gssd.initd
624ac8c5a381a0ccc1bb7dfd06c080a9de85a9e94e1d4071a6ef401e1b20f0d05d767be5e85eea374c3a4c29218b3db6013383afa0bdd1a7f61b77260675bfdb  rpc.idmapd.initd
46a423a58ba67b02f0075e2e06d4fe9aee9b05662f6f7e4ddfd5ac5763eb562a3402ab8427f351bfb3ac0c2feeefc5475ecf4e41be5f690f10c63b2ee3146398  rpc.pipefs.initd
cf0272e42310b1ff8d40ff37dc839df2dd4fba4cb408f8fa67ce445e2975b37cafbb35e6d41af2bb462fd05bdd444ba297a156daadcf50e1d73b322d6abeea17  rpc.statd.initd
844e8d41a6a8b632d98585724aca2e9ae596f72c67e17e4e8fb9eb81e6c58eed9e10cf8b2a96896dba8fd1efaa95d846954e712bdf3402a847ae17742dae2157  rpc.svcgssd.initd
1711803f848f73fef9fa74bd572fa7643c586f06eeedf62ed91bd2aa06ad59c7b1f1c585b6f7b7a8ce67ff7fd6b601d88dc99ca1000dd1d3f5991f420da9761b  nfs.confd
70f96bb3a465ee0fa857a6e511051ca3ced9f5a5d1e6b8b32eec843a2067f2475d8979c724a3661de0a2b078eef143f55d75ed184d823841d9de5038da91fb91  nfs.exports"
