# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=nfs-utils
pkgver=2.1.1
_basever=$pkgver
pkgrel=0
pkgdesc="kernel-mode NFS"
url="http://nfs.sourceforge.net/"
arch="all"
license="GPL"
depends="rpcbind"
options="suid"
makedepends="util-linux-dev libtirpc-dev libcap-dev libevent-dev
	libnfsidmap-dev keyutils-dev lvm2-dev krb5-dev sqlite-dev
	autoconf automake libtool bsd-compat-headers"
subpackages="$pkgname-doc $pkgname-dbg rpcgen"

source="http://downloads.sourceforge.net/nfs/$pkgname-$_basever.tar.bz2
	0011-exportfs-only-do-glibc-specific-hackery-on-glibc.patch

	nfs-utils-mtab-sym.patch
	musl-getservbyport.patch

	nfs.initd
	nfsmount.initd
	rpc.gssd.initd
	rpc.idmapd.initd
	rpc.pipefs.initd
	rpc.statd.initd
	rpc.svcgssd.initd
	nfs.confd
	nfs.exports
	"

builddir="$srcdir/$pkgname-$_basever"

prepare() {
	default_prepare
	cd $builddir
	./autogen.sh
}

build() {
	cd $builddir
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--without-tcp-wrappers \
		--enable-ipv6 \
		--enable-nfsv4 \
		--enable-uuid \
		--enable-gss \
		--enable-libmount-mount
	make
}

package() {
	cd $builddir
	make -j1 DESTDIR="$pkgdir" install

	local i=
	for i in nfs rpc.pipefs rpc.svcgssd nfsmount rpc.idmapd rpc.gssd \
			rpc.statd; do
		install -m755 -D "$srcdir"/$i.initd "$pkgdir"/etc/init.d/$i
	done

	install -m644 -D "$srcdir"/nfs.confd "$pkgdir"/etc/conf.d/nfs
	install -m644 -D "$srcdir"/nfs.exports "$pkgdir"/etc/exports
}

rpcgen() {
	pkgdesc="Remote Procedure Call (RPC) protocol compiler"
	cd $builddir
	install -m755 -D tools/rpcgen/rpcgen "$subpkgdir"/usr/bin/rpcgen
}

sha512sums="ed358280b7e124154632040bf747f6e4c3c6e4156bf90e82ff6915b1488f1c0dd65251a3a0f9b7ca96b9664d64e24b379828da9b524e64a3c769a44f4c930448  nfs-utils-2.1.1.tar.bz2
9561a979a2313f00c0bbb2ffb3193ca089e5de2f15cf5b6c142e65e04a9401bbc962e490e5b1de026750262a05e5258b286a79781444e7f2ac6bd581b426211a  0011-exportfs-only-do-glibc-specific-hackery-on-glibc.patch
5fd9039a61a0cdaeb57b5332ea545034101e6f15be200b7cf8fc7d0a3d22836a6fc778e0560656c1825808a4dc09046d9923d81b4d1324a6e526b226c657d064  nfs-utils-mtab-sym.patch
a14fc747cc75f65bb206b28eb4f838ae85687c917893531318d3991adc3ed9914316b97fc507bf34881855c9978ad9d4617f33e464d1a0d746a65b31177687c1  musl-getservbyport.patch
d29003bb45207bc2c5074a394f7b7431e3aca97364f9c4da946d09b8755df356ce1a446d14d64fc8847c5f275a2b96cb03ec99de4e0fad81973a4a614360331d  nfs.initd
8301a8981b6103398ec6e6aa234bdaab27762c96d3e3023e3ee7663b2f8dffab27338f4bd1b16f6584eba5ecb52e6b46aa5619fa4d5d7916f5e015881149cfaa  nfsmount.initd
8bb94bf583a44b77ee7c3fe2d9302dfa026388534ba0d60803b4ade789180c6fcc5bb801c268dad2a2ae5ea3df015f06504e1adf606f5264b30293cae682a5fd  rpc.gssd.initd
a9f00a6713a359a7c3bad5af660b1f99850b8c8c747371285a8b5f298578a72f3fbfd131119b6e74c7e4e5f5942f8376caa44c1475cc52c078e3cd96b1b51ce4  rpc.idmapd.initd
19ec69635cbbadae1a13f691d4a10778876c4218682b00794cc6cec88a90b016b92c32023c386536cdc1d9b9ae6a7c22817555b435a0e231c244d70d5ee8be59  rpc.pipefs.initd
519affb7ecd8ebd454058dcd4a4163ae53751bf53e105b9914c88b51c91dccb552863c6b68885361d8f4474b4881d36f64003abc6bd192e8f361fa1c1a3ac128  rpc.statd.initd
da07974bd7f191de683a0f83f8d87a5cfd116e233a1e70985820e7c2a0f8d39ec17d312f01f65ffccbc4f5b9180add2bbe171df2de3780a8dcf4df0bbfe9e31c  rpc.svcgssd.initd
1711803f848f73fef9fa74bd572fa7643c586f06eeedf62ed91bd2aa06ad59c7b1f1c585b6f7b7a8ce67ff7fd6b601d88dc99ca1000dd1d3f5991f420da9761b  nfs.confd
70f96bb3a465ee0fa857a6e511051ca3ced9f5a5d1e6b8b32eec843a2067f2475d8979c724a3661de0a2b078eef143f55d75ed184d823841d9de5038da91fb91  nfs.exports"
