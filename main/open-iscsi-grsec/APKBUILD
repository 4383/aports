# Maintainer: Leonardo Arena <rnalrd@gmail.com>

_flavor=grsec
_realname=open-iscsi
_realver=2.0-872
_kver=3.0.8
_kpkgrel=3

# verify the kernel version before entering chroot
if [ -f ../linux-${_flavor}/APKBUILD ]; then
	. ../linux-${_flavor}/APKBUILD
	[ "$_kver" != "$pkgver" ] && die "please update _kver to $pkgver"
	[ "$_kpkgrel" != "$pkgrel" ] && die "please update _kpkgrel to $pkgrel"
fi

_kernelver="$_kver-r$_kpkgrel"
_abi_release=$_kver-${_flavor}
_ksrc=/usr/src/linux-headers-${_abi_release}

_iscsiver=$_realver

pkgname=${_realname}-${_flavor}
pkgver=$_kver
_mypkgrel=0
pkgrel=$(($_kpkgrel + $_mypkgrel))
pkgdesc="$_flavor kernel modules for open-iscsi $_iscsiver"
url="http://www.open-iscsi.org"
arch="all"
license="GPL-2"
depends="linux-${_flavor}=${_kernelver}"
install=
makedepends="linux-${_flavor}-dev=${_kernelver}"
subpackages=
source="http://www.open-iscsi.org/bits/$_realname-$_realver.tar.gz
	Makefile-Alpine-kernels-support.patch"

_builddir="$srcdir/$_realname-$_realver"

prepare() {
	cd "$_builddir"
	patch -p1 < "$srcdir"/Makefile-Alpine-kernels-support.patch || return 1
}

build() {
	cd "$_builddir"
	unset ARCH
	export GCC_SPECS=/usr/share/gcc/hardenednopie.specs
	make KSRC="$_ksrc" kernel || return 1
}

package() {
	cd "$_builddir"
	make KSRC="$_ksrc" DESTDIR="$pkgdir" \
	 INSTALL_MOD_DIR="extra/drivers/scsi" \
	 install_kernel
}

md5sums="b4df94f08c241352bb964043b3e44779  open-iscsi-2.0-872.tar.gz
3d0806dc1c3c61b40a1e10eef63a1007  Makefile-Alpine-kernels-support.patch"
