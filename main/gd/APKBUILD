# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Carlo Landmeter <clandmeter@gmail.com>
pkgname=gd
pkgver=2.1.1
_myver=${pkgver/_rc/RC}
pkgrel=1
pkgdesc="Library for the dynamic creation of images by programmers"
url="http://www.libgd.org/"
arch="all"
license="custom"
depends=
makedepends="libpng-dev libjpeg-turbo-dev freetype-dev zlib-dev"
subpackages="$pkgname-dev $pkgname-doc"
source="http://bitbucket.org/libgd/gd-libgd/downloads/libgd-$pkgver.tar.xz
	CVE-2016-3074.patch
	invalid_neg_size.gd2
	"

_builddir="$srcdir"/lib$pkgname-$_myver

prepare() {
	cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
	update_config_sub || return 1
	# Binary file included in CVE
	cp "$srcdir"/invalid_neg_size.gd2 "$_builddir"/tests/gd2/ || return 1
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--with-png \
		--with-freetype \
		--with-jpeg \
		--without-xpm \
		--without-fontconfig \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -D -m644 COPYING "$pkgdir"/usr/share/licenses/$pkgname/COPYING
	rm -r "$pkgdir"/usr/lib/libgd.la
}

md5sums="9076f3abd1f9815d106da36467ea15bc  libgd-2.1.1.tar.xz
1302aaf334899f086c707ebff7b27c96  CVE-2016-3074.patch
5d47f93d43e04fd29e758a1cda35fd4a  invalid_neg_size.gd2"
sha256sums="9ada1ed45594abc998ebc942cef12b032fbad672e73efc22bc9ff54f5df2b285  libgd-2.1.1.tar.xz
98908d8dda9b82c28c5903e1d42ba0f4c4604742b3648cfa224267e0a56cebfd  CVE-2016-3074.patch
a90b3a76ca00e6766a600feeecf3c3fb1a6c71b256b44fe0d6e7268e54e758f3  invalid_neg_size.gd2"
sha512sums="48f444402a4b89e412870f9091b92eb26136c5c0d795722262ad973c7d4103476204a2de36133a2634b8f410d6bccdcf60afb829a74ac2fddfb96aff2cd2567b  libgd-2.1.1.tar.xz
91e13a5f9d2009707258613fec0549021c397b9f0b92a0e63dca9874a8f4041de1a2e04693da5e34668b154069d952735c5a4c8de9e3b6ab57b97297f8eab832  CVE-2016-3074.patch
c2402dd19525468b41f5424d42237ead46f108d8ef7f70fc8f11afa715972b474c53d792f92dd27f044f1be9b2e6a9c33eeb9434249f63055f52ac4a68b970b4  invalid_neg_size.gd2"
