# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=cgit
pkgver=0.10.2
pkgrel=0
_gitver=2.0.1
pkgdesc="A fast webinterface for git"
url="http://git.zx2c4.com/cgit/"
arch="all"
license="GPL2"
makedepends="openssl-dev zlib-dev lua5.2-dev"
depends=
subpackages=
source="http://git.zx2c4.com/cgit/snapshot/cgit-$pkgver.tar.xz
	https://www.kernel.org/pub/software/scm/git/git-$_gitver.tar.gz
	CVE-2016-1899.patch
	ui-blob-set-csp-just-in-case.patch
	CVE-2016-1900.patch
	CVE-2016-1901.patch
	"

_makeopts="NO_ICONV=YesPlease
	NO_GETTEXT=YesPlease
	NO_TCLTK=YesPlease
	NO_SVN_TESTS=YesPlease
	LUA_PKGCONFIG=lua5.2
	prefix=/usr"

prepare() {
	cd "$srcdir/$pkgname-$pkgver"
	# check that upstream git ver corresponds with our
	local _ver=$(awk -F'[ \t]*=[ \t]*' '/^GIT_VER/ { print $2 }' Makefile)
	if [ "$_ver" != "$_gitver" ]; then
		error "Please set _gitver in APKBUILD to $_ver"
		return 1
	fi
	rm -rf git
	mv ../git-$_gitver git

	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$srcdir/$pkgname-$pkgver"
	make $_makeopts
}

package() {
	cd "$srcdir/$pkgname-$pkgver"
	make $_makeopts DESTDIR="$pkgdir" \
		CGIT_SCRIPT_PATH=/usr/share/webapps/cgit \
		install
	ln -s cgit.cgi "$pkgdir"/usr/share/webapps/cgit/cgit
}

md5sums="6682d597f6e3e76645a254c7be537bd3  cgit-0.10.2.tar.xz
981f5937840716cb563be1cc6292c8d7  git-2.0.1.tar.gz
a97aa769ffcea8eadaa9d07af66cac62  CVE-2016-1899.patch
94781166b8974b178c5e662a97f0819c  ui-blob-set-csp-just-in-case.patch
983434f7d09159024166a275ee9310e3  CVE-2016-1900.patch
348e3ac77fbcf537707a9060b918dc31  CVE-2016-1901.patch"
sha256sums="94598e6582752659598e8086d3e2b2a2081df89ac8397460f507b15e71264c8d  cgit-0.10.2.tar.xz
02609a06fb40db1f6a968867c0e82bcb959b85902747830de0fda53228712daf  git-2.0.1.tar.gz
84185ccd38533541169721517db2e895733c6e320318ae96c6ce0d46c172482d  CVE-2016-1899.patch
b7a55ce0e6907d2e9ca14f15cef91964e81ad05f22f5dbc18fd5d9940f854dc5  ui-blob-set-csp-just-in-case.patch
449fd7a9cf19c35ca5114d7877b2dca78da0a23f1c31984e4d6f4221d8c5bb59  CVE-2016-1900.patch
490eb320304cdebfcaa9e07517b5a0c7c37428babe8d4b5a0fbd0852340299b0  CVE-2016-1901.patch"
sha512sums="5f4a0b65a9a802f5a464224ad4773ce6c926d0e61bb53baa4270f923570d92674b2b1b0669a74eb0e25d2b5e7fc7f637b37037c2371ebd7a3437ce28d78d650f  cgit-0.10.2.tar.xz
61bd1e250a8f01bdfed10d243fb6d95968795d7ebf8452f26ca778f0b99f2e13b35d0963004798b251c9ae300300c22dff79a0de21b5a3f1faebe51f557f33b2  git-2.0.1.tar.gz
bd8a166c516fda2598c4060c478bd25b681960a8db2d8d46fa4cafaa4ede9bcbff84fd25596cef1b4230edc1a1a7a41ea07a94d425180bad14955d184017c048  CVE-2016-1899.patch
c2b41967cdef2e42d611c2fe0721a71c1b33e6a1785d45a2ef53c970e8e71ae9eef0b8eae93ca8a3d9933288fef9777c649430c94ecc930c875f98e35d5ce413  ui-blob-set-csp-just-in-case.patch
36626fed9e9c3bdc8fb6c07c3189023fd5edd7f0251198e5cc8225fb8545ace0aa9852352e2509427c179dd3f6b9e705176925ee9aa833039c6b3b6b529b8c2f  CVE-2016-1900.patch
5e83ddb52bbc317a577ca6669af70f252f30f538724d76177739a741beba3f0a2bd08642f2ae4d4947035b93300e26ea4582cb2091932a267c9046101318c0b5  CVE-2016-1901.patch"
