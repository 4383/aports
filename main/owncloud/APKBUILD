# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname="owncloud"
pkgver="8.2.5"
pkgrel=0
_contactsver="0.5.0.0"
_calendarver="0.8.2"
_tasksver="0.8"
_documentsver="0.11.1"
_pdfviewerver="$pkgver"
_texteditorver="$pkgver"
_mozillasyncver="1.4"
_musicver="0.3.10"
pkgdesc="Your own WebDAV-based cloud service"
url="http://owncloud.org"
arch="noarch"
license="AGPL"
depends="php php-ctype php-curl php-dom php-gd php-iconv php-json php-xml
	php-zlib php-zip"
depends_dev=
makedepends="$depends_dev"
install=
subpackages="$pkgname-pgsql $pkgname-sqlite $pkgname-mysql $pkgname-encryption
	$pkgname-calendar $pkgname-contacts $pkgname-documents $pkgname-external
	$pkgname-mozilla_sync $pkgname-music $pkgname-ldap $pkgname-tasks
	$pkgname-texteditor $pkgname-pdfviewer $pkgname-videoviewer"
replaces="$pkgname-plugins"

source="https://download.owncloud.org/community/$pkgname-$pkgver.tar.bz2
	$pkgname-contacts-$_contactsver.tar.gz::https://github.com/owncloudarchive/contacts/releases/download/v$_contactsver/contacts.tar.gz
	$pkgname-calendar-$_calendarver.zip::https://github.com/owncloudarchive/calendar/releases/download/v$_calendarver/calendar.zip
	$pkgname-documents-$_documentsver.zip::https://github.com/owncloud/documents/releases/download/$_documentsver/documents.zip
	$pkgname-mozilla_sync-$_mozillasyncver.tar.gz::https://github.com/owncloud/mozilla_sync/archive/v$_mozillasyncver.tar.gz
	$pkgname-music-$_musicver.zip::https://github.com/owncloud/music/releases/download/v$_musicver/music.zip
	$pkgname-pdfviewer-$_pdfviewerver.tar.gz::https://github.com/owncloud/files_pdfviewer/archive/v$_pdfviewerver.tar.gz
	$pkgname-tasks-$_tasksver.tar.gz::https://github.com/owncloud/tasks/archive/v$_tasksver.tar.gz
	$pkgname-texteditor-$_texteditorver.tar.gz::https://github.com/owncloud/files_texteditor/archive/v$_texteditorver.tar.gz
	owncloud.config.php
	owncloud-6-always-return-true-isSetLocaleWorking.patch
	"
pkggroups="www-data"


#_builddir="$srcdir"/core-$pkgver
_builddir="$srcdir"/$pkgname

_ocbasedir="/var/lib/owncloud"
_ocdatadir="$_ocbasedir/data"
_ocwwwdir="/usr/share/webapps/owncloud"
_ocappsdir="$_ocwwwdir/apps"
_occonfdir="/etc/owncloud"


prepare() {
	cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg "Applying patch $i"; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"${_occonfdir}
	mkdir -p "$pkgdir"${_ocdatadir}
	mkdir -p "$pkgdir"${_ocwwwdir}
	install -m664  "$_builddir"/resources/config/ca-bundle.crt "$pkgdir"${_occonfdir}/ca-bundle.crt || return 1
	rm -rf config data
	mv * "$pkgdir"${_ocwwwdir} || return 1
	chmod +x "$pkgdir"${_ocwwwdir}/occ || return 1
	ln -s $_occonfdir "$pkgdir"${_ocwwwdir}/config || return 1
	install -m660 ../owncloud.config.php "$pkgdir"${_occonfdir}/config.php
	install -m664 .htaccess "$pkgdir"${_ocwwwdir}/.htaccess
	for dir in \
	 "$pkgdir"${_occonfdir} \
	 "$pkgdir"${_ocdatadir} \
	 "$pkgdir"${_ocappsdir}; do
		chown -R :www-data $dir || return 1
		chmod 770 $dir || return 1
	done
}

pgsql() {
	arch="noarch"
	pkgdesc="ownCloud PostgreSQL support"
	depends="owncloud php-pgsql php-pdo_pgsql php-pear-mdb2-driver-pgsql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

sqlite() {
	arch="noarch"
	pkgdesc="ownCloud SQLite support"
	depends="owncloud php-sqlite3 php-pdo_sqlite"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

mysql() {
	arch="noarch"
	pkgdesc="ownCloud MySQL support"
	depends="owncloud php-mysql php-pdo_mysql php-pear-mdb2-driver-mysql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

plugins() {
	arch="noarch"
	pkgdesc="ownCloud 3rdparty plugins"
	depends="owncloud"
	mkdir -p "$subpkgdir"${_ocwwwdir} || return 1
	mv "$pkgdir"${_ocwwwdir}/3rdparty "$subpkgdir"${_ocwwwdir}
}

_mv_app() {
	mkdir -p "$subpkgdir"${_ocappsdir} || return 1
	if [ "$1" = "pkg" ]; then
		mv "$pkgdir"${_ocappsdir}/$2 "$subpkgdir"${_ocappsdir} || return 1
	elif [ "$1" = "src" ]; then
		local appname="${subpkgname#$pkgname-}"
		mv "$srcdir"/$2 "$subpkgdir"${_ocappsdir}/$appname || return 1
	fi
	chown -R :www-data "$subpkgdir"${_ocappsdir} || return 1
	chmod 770 "$subpkgdir"${_ocappsdir} || return 1
}

contacts() {
	arch="noarch"
	pkgdesc="ownCloud contacts"
	depends="owncloud"
	_mv_app src contacts
}

calendar() {
	arch="noarch"
	pkgdesc="ownCloud calendar"
	depends="owncloud"
	_mv_app src calendar
}

documents() {
	arch="noarch"
	pkgdesc="ownCloud integrated documents editor"
	depends="owncloud"
	_mv_app src documents
}

encryption() {
	arch="noarch"
	pkgdesc="ownCloud integrated encryption support"
	depends="owncloud php-openssl"
	_mv_app pkg encryption
}

external() {
	arch="noarch"
	pkgdesc="ownCloud integrated external storage support"
	depends="owncloud php-curl php-ftp"
	_mv_app pkg files_external
}

ldap() {
	arch="noarch"
        pkgdesc="ownCloud integrated LDAP authentication"
	depends="owncloud php-ldap"
	_mv_app pkg user_ldap
}

mozilla_sync() {
	arch="noarch"
        pkgdesc="ownCloud Mozilla Sync app"
	depends="owncloud"
	_mv_app src mozilla_sync-$_mozillasyncver
}

music() {
	arch="noarch"
        pkgdesc="ownCloud music app"
	depends="owncloud"
	_mv_app src music
	# Correct world-writable directories
	find "${subpkgdir}${_ocappsdir}" -type d -exec chmod 775 {} \;
}

pdfviewer() {
	arch="noarch"
        pkgdesc="ownCloud integrated PDF viewer"
	depends="owncloud"
	_mv_app pkg files_pdfviewer
}

tasks() {
	arch="noarch"
	pkgdesc="ownCloud tasks"
	depends="owncloud"
	_mv_app src tasks-$_tasksver
}

texteditor() {
	arch="noarch"
	pkgdesc="ownCloud integrated text editor"
	depends="owncloud"
	_mv_app pkg files_texteditor
}

videoviewer() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app pkg files_videoviewer
}

md5sums="38ddc70cb0508acaebf07b3d33c17f74  owncloud-8.2.5.tar.bz2
106e5c74e26989b6a3dc9dd4a69df5f1  owncloud-contacts-0.5.0.0.tar.gz
95570ae37e1985678daf3b1f4008d3a9  owncloud-calendar-0.8.2.zip
581c2e0874ff961498845c49efa6f46b  owncloud-documents-0.11.1.zip
e98fdb10ff4139b4259e2a183a88975a  owncloud-mozilla_sync-1.4.tar.gz
9f1d98ba83039e42d53487348ff22df2  owncloud-music-0.3.10.zip
c1129898a5c14f59fec79d7077c5018d  owncloud-pdfviewer-8.2.5.tar.gz
ba3838830c4ce81ebc299d67526cc8d7  owncloud-tasks-0.8.tar.gz
18f915a6a90ec6b59453a3c7d38b006a  owncloud-texteditor-8.2.5.tar.gz
c2d6aedbec4766375cfe51a69fe28e97  owncloud.config.php
f497dbf3a67d14fc9049ca680673c805  owncloud-6-always-return-true-isSetLocaleWorking.patch"
sha256sums="48d19ab92fdb9e0222a8cb0c2ceadf594a1c30ee14a9376f77dfd2146b1c83b4  owncloud-8.2.5.tar.bz2
3ab3d121576c4136c5e5e43af02843d16d2badabe7475efc999e4c1a9fabfff8  owncloud-contacts-0.5.0.0.tar.gz
28cb63f3e4e3086831f87cf467092d7937d18be4ddbcabe31b5ce5e1af61b68f  owncloud-calendar-0.8.2.zip
6b5465a573022a2cd888ca213ed52441a0f53b7ec023cc9a060aa1c8a6805061  owncloud-documents-0.11.1.zip
314621c290daee93429d881e78d8cae13faaca3205b23860f06450633c5c3b6a  owncloud-mozilla_sync-1.4.tar.gz
f71eb59637f2a688e66283abf3a232f9e8cbb9aef189475115271ea64d296ff2  owncloud-music-0.3.10.zip
ab8095fad3ccd4030bacd56589615a15682dc60d13995cf727fa5de0b14f8483  owncloud-pdfviewer-8.2.5.tar.gz
a5ec7d004372721803293e5dce3cff818acdfcfe986bf84ff9de560b3b99fc01  owncloud-tasks-0.8.tar.gz
0a2d1c58802188bbf675e928338e63a1978046a962585fa5eb9c6e6e24650eca  owncloud-texteditor-8.2.5.tar.gz
717daea08063132547a431768e9e4c449397ede2d73d2b70c235b6af11d69a85  owncloud.config.php
3466ffbd22d4a9f04f4df862f3fb2f695fd1ca4bc6fb4b6a56258958064d5762  owncloud-6-always-return-true-isSetLocaleWorking.patch"
sha512sums="3623bbc49b30366275c293922cedddc304a8bbb1bd2403aa28b3979f68e7308841fcdc66c75abca4897174f804265e9a9f0db45286f2adacdd0b5dbf1b7efd85  owncloud-8.2.5.tar.bz2
ac7dbf6f461bd3e20865652cb64a0ff41e4b5fd15a9e415ac741ff60bf5a40ba2bcbe67522ca01fd0933594a50e9f18beb36c783b69661e5ddffbdb60f8a0508  owncloud-contacts-0.5.0.0.tar.gz
724168868452fcd2a4e7c5621267c7a63c97ccb0b58c44efc30999b92b9964c68f2ffb53e9279e092337f1b26568267a86627cd790af01d687047c977477f570  owncloud-calendar-0.8.2.zip
1e2378a862f3015129610fe3fd979f2452e4f97cc880d4854f1f5d825a12a73c013a23bfdd3cd6efc8536be2efa014997e8df74bcb736b80415396843181ffb5  owncloud-documents-0.11.1.zip
a279a6e0109aa3b17442265358284583d846f88afa3746005792b93dffbd3396dc1277ce892b2a226496038ec6e8ec7ef2295b981ef8acf1a3fa3c32886623d0  owncloud-mozilla_sync-1.4.tar.gz
d229b82552b71bf34574c61b6dd2987ac0ece3ed2021530df7cf63170033b9d69703d14fae8b0c66418339756b6e729f5dc3898f5117898f161f0ff76e723f91  owncloud-music-0.3.10.zip
6411576bbae4de8c3877246795d60a36283ea1f43813806925a92a5e2a04e7492f476bb799301a9abe0a6759c5dacd816fb4b20b707e562f97a030a5e0baee5f  owncloud-pdfviewer-8.2.5.tar.gz
f69f9ac50ae7aa10036a35cf20ac3aa89a5c41617f811d04e6026438c0f8ceeda764621ccf5bbe2f086ce29c12260b65ee1db208ff8d74c183d55970d4c9af4a  owncloud-tasks-0.8.tar.gz
738593b76122534ea48cc54a3ac8f63d34b67183af63f0e5a264e149f024d567743503e3dae96e31e7c5fd6f7d75f8719642d320041e30f9d8b9b8f59ee68616  owncloud-texteditor-8.2.5.tar.gz
c4b2c38aca1a71a46b91d23f98e65d2350421697dee119adefda560b3606177f858ea32b36a8f622c03041a2f75a87bf8532e701954237c8b46874f5895e731f  owncloud.config.php
4b2038786571c62129d748bb71262a7cbc966cf4b97482f13bcedaa36fcfa343080a464fc74463a9bd6615c99a10cd590b91cacead62632db36bfd8940173d13  owncloud-6-always-return-true-isSetLocaleWorking.patch"
