# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname="owncloud"
pkgver="6.0.4"
pkgrel=0
pkgdesc="Your own WebDAV-based cloud service"
url="http://owncloud.org"
arch="noarch"
license="AGPL"
depends="php php-ctype php-dom php-gd php-iconv php-json php-zlib
	php-zip"
depends_dev=
makedepends="$depends_dev"
install=
subpackages="$pkgname-pgsql $pkgname-sqlite $pkgname-mysql $pkgname-documents
	$pkgname-external $pkgname-texteditor $pkgname-videoviewer"
replaces="$pkgname-plugins"
source="http://download.owncloud.org/community/$pkgname-$pkgver.tar.bz2
	owncloud.config.php
	owncloud-5.0.13-remove-shares-where-files-do-not-exist-postgres.patch
	owncloud-6-always-return-true-isSetLocaleWorking.patch
	"
pkggroups="www-data"

_builddir="$srcdir"/$pkgname

_ocvardir="/var/lib/owncloud"
_ocdatadir="$_ocbasedir/data"
_ocwwwdir="/usr/share/webapps/owncloud"
_ocappsdir="$_ocwwwdir/apps"
_occonfdir="/etc/owncloud"

prepare() {
	cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg "Applying patch $i"; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"${_occonfdir}
	mkdir -p "$pkgdir"${_ocdatadir}
	mkdir -p "$pkgdir"${_ocwwwdir}
	rm -rf config data
	mv * "$pkgdir"${_ocwwwdir} || exit
	ln -s $_occonfdir "$pkgdir"${_ocwwwdir}/config || return 1
	install -m660 ../owncloud.config.php "$pkgdir"${_occonfdir}/config.php
	for dir in \
	 "$pkgdir"${_occonfdir} \
	 "$pkgdir"${_ocdatadir} \
	 "$pkgdir"${_ocappsdir}; do
		chown -R :www-data $dir || return 1
		chmod 770 $dir || return 1
	done
}

pgsql() {
	arch="noarch"
	pkgdesc="ownCloud PostgreSQL support"
	depends="owncloud php-pgsql php-pdo_pgsql php-pear-mdb2-driver-pgsql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

sqlite() {
	arch="noarch"
	pkgdesc="ownCloud SQLite support"
	depends="owncloud php-sqlite3 php-pdo_sqlite"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

mysql() {
	arch="noarch"
	pkgdesc="ownCloud MySQL support"
	depends="owncloud php-mysql php-pdo_mysql php-pear-mdb2-driver-mysql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

plugins() {
	arch="noarch"
	pkgdesc="ownCloud 3rdparty plugins"
	depends="owncloud"
	mkdir -p "$subpkgdir"${_ocwwwdir} || return 1
	mv "$pkgdir"${_ocwwwdir}/3rdparty "$subpkgdir"${_ocwwwdir}
}

_mv_app() {
	mkdir -p "$subpkgdir"${_ocappsdir} || return 1
	mv "$pkgdir"${_ocappsdir}/$1 "$subpkgdir"${_ocappsdir}
}

texteditor() {
	arch="noarch"
	pkgdesc="ownCloud integrated text editor"
	depends="owncloud"
	_mv_app files_texteditor
}

videoviewer() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app files_videoviewer
}

documents() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app documents
}

external() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app files_external
}

md5sums="0a92cf5971e9c9c58e40219b385bd8f4  owncloud-6.0.4.tar.bz2
f15efb780f109648432132861828417c  owncloud.config.php
e033c3211983429ef811ffea8159bb46  owncloud-5.0.13-remove-shares-where-files-do-not-exist-postgres.patch
f497dbf3a67d14fc9049ca680673c805  owncloud-6-always-return-true-isSetLocaleWorking.patch"
sha256sums="49b576bf9e7131c08f0437bbbaafdcd900b37010eb90b23048b69dbbb6c01532  owncloud-6.0.4.tar.bz2
012e6bf876643f65fdaf2eb9f8b3d0a04d555dd3a40d5a67576c96e59a434516  owncloud.config.php
0dc56930cc725def606aabdb3ba380fc38daa203b4544ddde523a7d1f962ade8  owncloud-5.0.13-remove-shares-where-files-do-not-exist-postgres.patch
3466ffbd22d4a9f04f4df862f3fb2f695fd1ca4bc6fb4b6a56258958064d5762  owncloud-6-always-return-true-isSetLocaleWorking.patch"
sha512sums="ddabb2a14f507833069039ba43555419c6224681d3e5c821d2c9936f50577f1eea07785ca61f14e5bab5da73349ebf6bbb5504c0582351e3826d0e6bd9855f43  owncloud-6.0.4.tar.bz2
6bbc7bd28236549ac5660f1c1ec89fc68c28849a44cfe970cef4efc43891463d83818efd2d335802390c7db1ea2a9f7d15220a09fb567fd7e27b8cee7f1acd02  owncloud.config.php
1c05b9c96c92e74d0b603fe76facb4fc9510dbb18dc210cd0b073ca2776886416303abb28d66266982a60e67aa6c7ba06c2ad45dfd926f3a6260f58f1a90e882  owncloud-5.0.13-remove-shares-where-files-do-not-exist-postgres.patch
4b2038786571c62129d748bb71262a7cbc966cf4b97482f13bcedaa36fcfa343080a464fc74463a9bd6615c99a10cd590b91cacead62632db36bfd8940173d13  owncloud-6-always-return-true-isSetLocaleWorking.patch"
