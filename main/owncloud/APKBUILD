# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname="owncloud"
pkgver="9.0.5"
pkgrel=0
_contactsver="0.0.0.151"
_calendarver="1.3.2"
_tasksver="0.9.3"
_documentsver="$pkgver"
_pdfviewerver="$pkgver"
_texteditorver="$pkgver"
_mozillasyncver="1.4"
_musicver="0.3.12"
_php=php5
pkgdesc="Your own WebDAV-based cloud service"
url="http://owncloud.org"
arch="noarch"
license="AGPL"
depends="$_php ${_php}-ctype ${_php}-curl ${_php}-dom ${_php}-gd ${_php}-iconv ${_php}-json ${_php}-xml
	${_php}-xmlreader ${_php}-zlib ${_php}-zip"
depends_dev=
makedepends="$depends_dev"
install=
subpackages="$pkgname-pgsql $pkgname-sqlite $pkgname-mysql $pkgname-encryption
	$pkgname-calendar $pkgname-contacts $pkgname-documents $pkgname-external
	$pkgname-gallery $pkgname-mozilla_sync $pkgname-music $pkgname-ldap
	$pkgname-tasks $pkgname-texteditor $pkgname-pdfviewer $pkgname-videoplayer"
replaces="$pkgname-plugins"

source="https://download.owncloud.org/community/$pkgname-$pkgver.tar.bz2
	$pkgname-contacts-$_contactsver.tar.gz::https://github.com/owncloud/contacts/releases/download/v$_contactsver/contacts.tar.gz
	$pkgname-calendar-$_calendarver.tar.gz::https://github.com/owncloud/calendar/archive/v$_calendarver.tar.gz
	$pkgname-documents-$_documentsver.tar.gz::https://github.com/owncloud/documents/archive/v$_documentsver.tar.gz
	$pkgname-texteditor-$_texteditorver.tar.gz::https://github.com/owncloud/files_texteditor/archive/v$_texteditorver.tar.gz
	$pkgname-mozilla_sync-$_mozillasyncver.tar.gz::https://github.com/owncloud/mozilla_sync/archive/v$_mozillasyncver.tar.gz
	$pkgname-music-$_musicver.tar.gz::https://github.com/owncloud/music/archive/v$_musicver.tar.gz
	$pkgname-pdfviewer-$_pdfviewerver.tar.gz::https://github.com/owncloud/files_pdfviewer/archive/v$_pdfviewerver.tar.gz
	$pkgname-tasks-$_tasksver.tar.gz::https://github.com/owncloud/tasks/archive/v$_tasksver.tar.gz
	owncloud.config.php

	owncloud-6-always-return-true-isSetLocaleWorking.patch
	owncloud-9-disable-chmod.patch
	"
pkggroups="www-data"

#_builddir="$srcdir"/core-$pkgver
_builddir="$srcdir"/$pkgname

_ocbasedir="/var/lib/owncloud"
_ocdatadir="$_ocbasedir/data"
_ocwwwdir="/usr/share/webapps/owncloud"
_ocappsdir="$_ocwwwdir/apps"
_occonfdir="/etc/owncloud"


prepare() {
	cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg "Applying patch $i"; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"${_occonfdir}
	mkdir -p "$pkgdir"${_ocdatadir}
	mkdir -p "$pkgdir"${_ocwwwdir}
	rm -rf config data
	mv * "$pkgdir"${_ocwwwdir} || return 1
	chmod +x "$pkgdir"${_ocwwwdir}/occ || return 1
	ln -s $_occonfdir "$pkgdir"${_ocwwwdir}/config || return 1
	install -m660 ../owncloud.config.php "$pkgdir"${_occonfdir}/config.php
	install -m664 .htaccess "$pkgdir"${_ocwwwdir}/.htaccess
	for dir in \
	 "$pkgdir"${_occonfdir} \
	 "$pkgdir"${_ocdatadir} \
	 "$pkgdir"${_ocappsdir}; do
		chown -R :www-data $dir || return 1
		chmod 770 $dir || return 1
	done
}

pgsql() {
	arch="noarch"
	pkgdesc="ownCloud PostgreSQL support"
	depends="owncloud ${_php}-pgsql ${_php}-pdo_pgsql ${_php}-pear-mdb2-driver-pgsql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

sqlite() {
	arch="noarch"
	pkgdesc="ownCloud SQLite support"
	depends="owncloud ${_php}-sqlite3 ${_php}-pdo_sqlite"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

mysql() {
	arch="noarch"
	pkgdesc="ownCloud MySQL support"
	depends="owncloud ${_php}-mysql ${_php}-pdo_mysql ${_php}-pear-mdb2-driver-mysql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

plugins() {
	arch="noarch"
	pkgdesc="ownCloud 3rdparty plugins"
	depends="owncloud"
	mkdir -p "$subpkgdir"${_ocwwwdir} || return 1
	mv "$pkgdir"${_ocwwwdir}/3rdparty "$subpkgdir"${_ocwwwdir}
}

_mv_app() {
	mkdir -p "$subpkgdir"${_ocappsdir} || return 1
	if [ "$1" = "pkg" ]; then
		mv "$pkgdir"${_ocappsdir}/$2 "$subpkgdir"${_ocappsdir} || return 1
	elif [ "$1" = "src" ]; then
		local appname="${subpkgname#$pkgname-}"
		mv "$srcdir"/$2 "$subpkgdir"${_ocappsdir}/$appname || return 1
	fi
	chown -R :www-data "$subpkgdir"${_ocappsdir} || return 1
	chmod 770 "$subpkgdir"${_ocappsdir} || return 1
}

contacts() {
	arch="noarch"
	pkgdesc="ownCloud contacts"
	depends="owncloud"
	_mv_app src contacts
}

calendar() {
	arch="noarch"
	pkgdesc="ownCloud calendar"
	depends="owncloud"
	_mv_app src calendar-$_calendarver
}

documents() {
	arch="noarch"
	pkgdesc="ownCloud integrated documents editor"
	depends="owncloud"
	_mv_app src documents-$_documentsver
}

encryption() {
	arch="noarch"
	pkgdesc="ownCloud integrated encryption support"
	depends="owncloud ${_php}-openssl"
	_mv_app pkg encryption
}

external() {
	arch="noarch"
	pkgdesc="ownCloud integrated external storage support"
	depends="owncloud ${_php}-curl ${_php}-ftp"
	_mv_app pkg files_external
}

gallery() {
	arch="noarch"
	pkgdesc="ownCloud integrated gallery application"
	depends="owncloud"
	_mv_app pkg gallery
}

ldap() {
	arch="noarch"
        pkgdesc="ownCloud integrated LDAP authentication"
	depends="owncloud ${_php}-ldap"
	_mv_app pkg user_ldap
}

mozilla_sync() {
	arch="noarch"
        pkgdesc="ownCloud Mozilla Sync app"
	depends="owncloud"
	_mv_app src mozilla_sync-$_mozillasyncver
}

music() {
	arch="noarch"
        pkgdesc="ownCloud music app"
	depends="owncloud"
	_mv_app src music-$_musicver
	# Correct world-writable directories
	find "${subpkgdir}${_ocappsdir}" -type d -exec chmod 775 {} \;
}

pdfviewer() {
	arch="noarch"
        pkgdesc="ownCloud integrated PDF viewer"
	depends="owncloud"
	_mv_app pkg files_pdfviewer
}

tasks() {
	arch="noarch"
	pkgdesc="ownCloud tasks"
	depends="owncloud"
	_mv_app src tasks-$_tasksver
}

texteditor() {
	arch="noarch"
	pkgdesc="ownCloud integrated text editor"
	depends="owncloud"
	_mv_app pkg files_texteditor
}

videoplayer() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	provides="$pkgname-videoviewer"
	_mv_app pkg files_videoplayer
}

md5sums="38c27ab8dbdce00b0a0211e4a1d1d62b  owncloud-9.0.5.tar.bz2
110b4f260ab1e52341f1fcc57b2ee669  owncloud-contacts-0.0.0.151.tar.gz
ec02314ccf68fc19777156c84a27f003  owncloud-calendar-1.3.2.tar.gz
5631e5b752eabeaf05dcdbda987c5fbe  owncloud-documents-9.0.5.tar.gz
826fba7d4b19a18efce84a65d183b4c6  owncloud-texteditor-9.0.5.tar.gz
e98fdb10ff4139b4259e2a183a88975a  owncloud-mozilla_sync-1.4.tar.gz
8b67bb6ad487d3d6766376a38169bc11  owncloud-music-0.3.12.tar.gz
7f7eb6a6ce8af0313aebd4fb8555f511  owncloud-pdfviewer-9.0.5.tar.gz
84e7e522faa5f4a6bd3c75a29e259bcb  owncloud-tasks-0.9.3.tar.gz
2c131b3ed0632bef7c372b6ec09f55cb  owncloud.config.php
f497dbf3a67d14fc9049ca680673c805  owncloud-6-always-return-true-isSetLocaleWorking.patch
5e393c5cbfa0dc9f5d4d35dbdef3b839  owncloud-9-disable-chmod.patch"
sha256sums="c8c2c4f7a06208f006762740ca6bb6a4c4d8362fc8d226dcccb82b970993f7c5  owncloud-9.0.5.tar.bz2
e13e885c11432f92e693c0f1ca2d3a0439cdf9eb242a203a0a751c7de5191384  owncloud-contacts-0.0.0.151.tar.gz
f99bb96a663096a03d6dc5459d8409abd48bcec2139af84e55bff17c90620493  owncloud-calendar-1.3.2.tar.gz
87be7ad76af2efe15c55cab74ce77ce23cc4e46103b6a9396d88fd848597bc5f  owncloud-documents-9.0.5.tar.gz
7a14aa66457c583e40c5d88f51ea4d9a7c4365fbf21e58fd0ac5e05ef4ebd13f  owncloud-texteditor-9.0.5.tar.gz
314621c290daee93429d881e78d8cae13faaca3205b23860f06450633c5c3b6a  owncloud-mozilla_sync-1.4.tar.gz
12997165c52298ba1b8b8d1f643af0628077aa9f14142e5c853d3c85a6ce44d5  owncloud-music-0.3.12.tar.gz
84883064ac6858ad0c5e352245efcf8fbf1aa820c8b380900fd6e56d8fa0264b  owncloud-pdfviewer-9.0.5.tar.gz
0a5ef52ba915e7ec8f124ab7bd2c01f22db27f77343ddfa8d799927711133c55  owncloud-tasks-0.9.3.tar.gz
41b9bcd59604b8150e1a865ab37c2cbbe433d49eb3ef2ba2f55c37b3a8cc41c9  owncloud.config.php
3466ffbd22d4a9f04f4df862f3fb2f695fd1ca4bc6fb4b6a56258958064d5762  owncloud-6-always-return-true-isSetLocaleWorking.patch
9739810a5f040ff1488559fb17360b65aec94a4024b2f74437785420336d4d72  owncloud-9-disable-chmod.patch"
sha512sums="e100f2d84f2aa35669479618528b1d08c33a654378b6feae5b67430342f7ceacc7403e5bcb5447ded592a2a3a7f69fda55697d7b39d6382c9887da46a189b74e  owncloud-9.0.5.tar.bz2
219410025b3020b327ecc779d7d8a25e17eb693ae9c8ca7655ea914e5a73009de14972fc998c2ae0e5e3f5ad7c01db209372965865e3c7ac145e8b42365b356b  owncloud-contacts-0.0.0.151.tar.gz
b87f80984949868b87812637ed707c4cc90bc719dbed77d0a41956b9425116e7b64553125493a8bd48427b26b7311b05402ed61114b925186376756545e02891  owncloud-calendar-1.3.2.tar.gz
644e704903f520f6ee328d9da2ea5003500f475ae665d13f73f7241789634f1b246a2020aeb5d509dc8d73b5ea17f2d6a0e3c74273a5b8f2f063006e34383334  owncloud-documents-9.0.5.tar.gz
3b0001427a8cf1d3fb1130b62afbf76b9b1180c9cdb09b8a2db1bd073284b4eae6c611db5996eaf3c22ba32f29b5640078a10025e3e65f29421a6ebca8e1fada  owncloud-texteditor-9.0.5.tar.gz
a279a6e0109aa3b17442265358284583d846f88afa3746005792b93dffbd3396dc1277ce892b2a226496038ec6e8ec7ef2295b981ef8acf1a3fa3c32886623d0  owncloud-mozilla_sync-1.4.tar.gz
3a4f99b925008191ab6a9107417236fa7626c8884b5dc766deb6b6bcbc663c56ba680d82b3b4c73f6ce81278ca016b2a5db00e41cd16f97e2cf3f451d069ef4e  owncloud-music-0.3.12.tar.gz
e45146b341ef4f1e17c8211f79d3848c8fc42e576cae5e2adc2e0514318de34b0b0bfc303500a39f203b833f15680eaa10e308ee985f64abe3153d55c0a81831  owncloud-pdfviewer-9.0.5.tar.gz
05903caadaab8c7982cb91b1442d617c777a9d97fcd5406d1b404006fa91ef73251852a53a03cb7fcbed097c1120fc920983c1a24a0e8f1f2e95b230153fd26a  owncloud-tasks-0.9.3.tar.gz
b4bd206bff5f4871f023344ea03afd52795876d4563da00ccd026c5d976570dfb0923cd218449395e238a2b23de516f6a655a69539bc5a7d0cb67048c94bb15f  owncloud.config.php
4b2038786571c62129d748bb71262a7cbc966cf4b97482f13bcedaa36fcfa343080a464fc74463a9bd6615c99a10cd590b91cacead62632db36bfd8940173d13  owncloud-6-always-return-true-isSetLocaleWorking.patch
62f4c4e5f0c23aea98a3cefdd5f08773fc34039ef444d167063f7b1f4640aee48bd108776e6f28f12acec3833f7bcf6b76aaa300c41f5f3fc8fc536c9f6b7586  owncloud-9-disable-chmod.patch"
