# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname="owncloud"
pkgver="8.1.6"
pkgrel=1
_contactsver="0.4.0.1"
_calendarver="0.7.4"
_tasksver="0.8"
_documentsver="0.10.2"
_pdfviewerver="$pkgver"
_texteditorver="$pkgver"
_mozillasyncver="1.4"
_musicver="0.3.10"
pkgdesc="Your own WebDAV-based cloud service"
url="http://owncloud.org"
arch="noarch"
license="AGPL"
depends="php php-ctype php-dom php-gd php-iconv php-json php-xml php-zlib
	php-zip"
depends_dev=
makedepends="$depends_dev"
install=
subpackages="$pkgname-pgsql $pkgname-sqlite $pkgname-mysql $pkgname-encryption
	$pkgname-calendar $pkgname-contacts $pkgname-documents $pkgname-external
	$pkgname-mozilla_sync $pkgname-music $pkgname-ldap $pkgname-tasks
	$pkgname-texteditor $pkgname-pdfviewer $pkgname-videoviewer"
replaces="$pkgname-plugins"

source="https://download.owncloud.org/community/$pkgname-$pkgver.tar.bz2
	$pkgname-contacts-$_contactsver.tar.gz::https://github.com/owncloudarchive/contacts/releases/download/v$_contactsver/contacts.tar.gz
	$pkgname-calendar-$_calendarver.zip::https://github.com/owncloudarchive/calendar/releases/download/v$_calendarver/calendar.zip
	$pkgname-documents-$_documentsver.tar.gz::https://github.com/owncloud/documents/releases/download/v$_documentsver/documents.zip
	$pkgname-texteditor-$_texteditorver.tar.gz::https://github.com/owncloud/files_texteditor/archive/v$_texteditorver.tar.gz
	$pkgname-mozilla_sync-$_mozillasyncver.tar.gz::https://github.com/owncloud/mozilla_sync/archive/v$_mozillasyncver.tar.gz
	$pkgname-music-$_musicver.zip::https://github.com/owncloud/music/releases/download/v$_musicver/music.zip
	$pkgname-pdfviewer-$_pdfviewerver.tar.gz::https://github.com/owncloud/files_pdfviewer/archive/v$_pdfviewerver.tar.gz
	$pkgname-tasks-$_tasksver.zip::https://github.com/owncloud/tasks/archive/v$_tasksver.zip
	owncloud.config.php
	owncloud-6-always-return-true-isSetLocaleWorking.patch
	"

pkggroups="www-data"

#_builddir="$srcdir"/core-$pkgver
_builddir="$srcdir"/$pkgname

_ocbasedir="/var/lib/owncloud"
_ocdatadir="$_ocbasedir/data"
_ocwwwdir="/usr/share/webapps/owncloud"
_ocappsdir="$_ocwwwdir/apps"
_occonfdir="/etc/owncloud"


prepare() {
	cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg "Applying patch $i"; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"${_occonfdir}
	mkdir -p "$pkgdir"${_ocdatadir}
	mkdir -p "$pkgdir"${_ocwwwdir}
	rm -rf config data
	mv * "$pkgdir"${_ocwwwdir} || return 1
	chmod +x "$pkgdir"${_ocwwwdir}/occ || return 1
	ln -s $_occonfdir "$pkgdir"${_ocwwwdir}/config || return 1
	install -m660 ../owncloud.config.php "$pkgdir"${_occonfdir}/config.php
	for dir in \
	 "$pkgdir"${_occonfdir} \
	 "$pkgdir"${_ocdatadir} \
	 "$pkgdir"${_ocappsdir}; do
		chown -R :www-data $dir || return 1
		chmod 770 $dir || return 1
	done
}

pgsql() {
	arch="noarch"
	pkgdesc="ownCloud PostgreSQL support"
	depends="owncloud php-pgsql php-pdo_pgsql php-pear-mdb2-driver-pgsql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

sqlite() {
	arch="noarch"
	pkgdesc="ownCloud SQLite support"
	depends="owncloud php-sqlite3 php-pdo_sqlite"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

mysql() {
	arch="noarch"
	pkgdesc="ownCloud MySQL support"
	depends="owncloud php-mysql php-pdo_mysql php-pear-mdb2-driver-mysql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

plugins() {
	arch="noarch"
	pkgdesc="ownCloud 3rdparty plugins"
	depends="owncloud"
	mkdir -p "$subpkgdir"${_ocwwwdir} || return 1
	mv "$pkgdir"${_ocwwwdir}/3rdparty "$subpkgdir"${_ocwwwdir}
}

_mv_app() {
	mkdir -p "$subpkgdir"${_ocappsdir} || return 1
	if [ "$1" = "pkg" ]; then
		mv "$pkgdir"${_ocappsdir}/$2 "$subpkgdir"${_ocappsdir} || return 1
	elif [ "$1" = "src" ]; then
		local appname="${subpkgname#$pkgname-}"
		mv "$srcdir"/$2 "$subpkgdir"${_ocappsdir}/$appname || return 1
	fi
	chown -R :www-data "$subpkgdir"${_ocappsdir} || return 1
	chmod 770 "$subpkgdir"${_ocappsdir} || return 1
}

contacts() {
	arch="noarch"
	pkgdesc="ownCloud contacts"
	depends="owncloud"
	_mv_app src contacts-$_contactsver
}

calendar() {
	arch="noarch"
	pkgdesc="ownCloud calendar"
	depends="owncloud"
	_mv_app src calendar
}

documents() {
	arch="noarch"
	pkgdesc="ownCloud integrated documents editor"
	depends="owncloud"
	_mv_app src documents-$_documentsver
}

encryption() {
	arch="noarch"
	pkgdesc="ownCloud integrated encryption support"
	depends="owncloud php-openssl"
	_mv_app pkg encryption
}

external() {
	arch="noarch"
	pkgdesc="ownCloud integrated external storage support"
	depends="owncloud php-curl php-ftp"
	_mv_app pkg files_external
}

ldap() {
	arch="noarch"
        pkgdesc="ownCloud integrated LDAP authentication"
	depends="owncloud php-ldap"
	_mv_app pkg user_ldap
}

mozilla_sync() {
	arch="noarch"
        pkgdesc="ownCloud Mozilla Sync app"
	depends="owncloud"
	_mv_app src mozilla_sync-$_mozillasyncver
}

music() {
	arch="noarch"
        pkgdesc="ownCloud music app"
	depends="owncloud"
	_mv_app src music
	# Correct world-writable directories
	find "${subpkgdir}${_ocappsdir}" -type d -exec chmod 775 {} \;
}

pdfviewer() {
	arch="noarch"
        pkgdesc="ownCloud integrated PDF viewer"
	depends="owncloud"
	_mv_app pkg files_pdfviewer
}

tasks() {
	arch="noarch"
	pkgdesc="ownCloud tasks"
	depends="owncloud"
	_mv_app src tasks-$_tasksver
}

texteditor() {
	arch="noarch"
	pkgdesc="ownCloud integrated text editor"
	depends="owncloud"
	_mv_app pkg files_texteditor
}

videoviewer() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app pkg files_videoviewer
}

md5sums="7d98fa3d6824911037b1bd8108a72c7e  owncloud-8.1.6.tar.bz2
1f35877e1be5d7bedf59c630c493b62e  owncloud-contacts-0.4.0.1.tar.gz
ea1af42a900e255e9f9c90443b5559f7  owncloud-calendar-0.7.4.zip
7b55feeda24b9b4f36d665a0192c80bb  owncloud-documents-0.10.2.tar.gz
7504a65a52be2b21e063e4561c845dd8  owncloud-texteditor-8.1.6.tar.gz
e98fdb10ff4139b4259e2a183a88975a  owncloud-mozilla_sync-1.4.tar.gz
9f1d98ba83039e42d53487348ff22df2  owncloud-music-0.3.10.zip
2c79499708178dca7c5518ba7a734d21  owncloud-pdfviewer-8.1.6.tar.gz
d7cc2a2d66a0555eb185131bce11d4d8  owncloud-tasks-0.8.zip
815a9144dcc174c2e7c560dd218ff820  owncloud.config.php
f497dbf3a67d14fc9049ca680673c805  owncloud-6-always-return-true-isSetLocaleWorking.patch"
sha256sums="b137b518f2f41d944f722cb0c31b82372663ebffbd4e747369416f7c1565df19  owncloud-8.1.6.tar.bz2
57289bdaf73ce6d3a31a88bfaaf2cbdd2f6ae615d8fb1d3776773444a829a3fb  owncloud-contacts-0.4.0.1.tar.gz
8e5889e9bb5276e205bd326b4b84d121648f262adf82ab3ee1aba0c54eca0ad6  owncloud-calendar-0.7.4.zip
30ab8351fdc87bb4136937304de4ca4b4e367e0329409ae3b27c6bfac21b5699  owncloud-documents-0.10.2.tar.gz
d65986f1f0550187f76513e68c248eab6e42ce796ef69148a960d1b170b392dd  owncloud-texteditor-8.1.6.tar.gz
314621c290daee93429d881e78d8cae13faaca3205b23860f06450633c5c3b6a  owncloud-mozilla_sync-1.4.tar.gz
f71eb59637f2a688e66283abf3a232f9e8cbb9aef189475115271ea64d296ff2  owncloud-music-0.3.10.zip
a8b0ad875b8e894fb82e5286d6453ffaaa8006e369e2484b359e9b4f5a0ad123  owncloud-pdfviewer-8.1.6.tar.gz
029ebcee1105be8cf40c874eb4aa3a3aa812fbde3ecd29cdb9136fc24be36208  owncloud-tasks-0.8.zip
181e19980ccff5b5eb9f9434ef4dd9cfcee722e238bd0b422ece2b4d753cda12  owncloud.config.php
3466ffbd22d4a9f04f4df862f3fb2f695fd1ca4bc6fb4b6a56258958064d5762  owncloud-6-always-return-true-isSetLocaleWorking.patch"
sha512sums="00093d89f6c06f023177644b3800cc1c39a84be0a46dcb42b3485aec84970bee310db024bc7aa67363d2cf497136aa13643fa746185ade6d0213902112005be3  owncloud-8.1.6.tar.bz2
aae00cb54dd8dcb566d6a9dc62f2f54047b0bcdad543af6c01819bfb3cbdd393a7721e96c2effc5842ef79ca665ed8fe5247c5fd72b0c2cac1c257ad50ce3c36  owncloud-contacts-0.4.0.1.tar.gz
4411c1af7a8e90feaddb69a5b3a7aecac733d81ee607cfe93c5ca073c4a92592ec90603fe261944024e8096063c75c3cdcde783460c1bd2d996a040113090cc7  owncloud-calendar-0.7.4.zip
4c35e4baecc1dfd1da9ffb4ab262dfd0069a91675bb3595d433692f8738cc33090d116a73e1d405d22952cc14e5e3706454889edc88b84393e7b0bacdadfee9e  owncloud-documents-0.10.2.tar.gz
6cf6071aac374fbf5e6f3bbea041d2fb3eec0b42870ba6c2322eaccf0d3c5ac188dfc6a375e617b57a0d50a81b6e74c7dba9f0252a58d5445b243c10767efe41  owncloud-texteditor-8.1.6.tar.gz
a279a6e0109aa3b17442265358284583d846f88afa3746005792b93dffbd3396dc1277ce892b2a226496038ec6e8ec7ef2295b981ef8acf1a3fa3c32886623d0  owncloud-mozilla_sync-1.4.tar.gz
d229b82552b71bf34574c61b6dd2987ac0ece3ed2021530df7cf63170033b9d69703d14fae8b0c66418339756b6e729f5dc3898f5117898f161f0ff76e723f91  owncloud-music-0.3.10.zip
f9547f37586179c123c20a6365b928adca71d9c45cf6ed96ad3d1fc4d66f9be6538a6526d82a7d9ac891a0a11be171fe96f52d98985f79ec3d5c8e7978568ebe  owncloud-pdfviewer-8.1.6.tar.gz
c4422d2580784a2751e0b8542b0bd9b769f89c03a0afca4176c90136685bab6f4e1c71c6e6b2ae807748ec01a33892e7038eb38099267c5ceb577d1f6e3e2ae3  owncloud-tasks-0.8.zip
012e5fb889218eb5f6fbb9ad5fd58b72cc28d32b3922a7ddf50b777150c6fa2bf9c806aa7afe4da09a820881b68bdcf2ce04c0faad62f1b9185ba629de4ae3c1  owncloud.config.php
4b2038786571c62129d748bb71262a7cbc966cf4b97482f13bcedaa36fcfa343080a464fc74463a9bd6615c99a10cd590b91cacead62632db36bfd8940173d13  owncloud-6-always-return-true-isSetLocaleWorking.patch"
