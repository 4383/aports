# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname=owncloud
pkgver=5.0.3
pkgrel=1
pkgdesc="Your own WebDAV-based cloud service"
url="http://owncloud.org"
arch="noarch"
license="AGPL"
depends="php php-ctype php-dom php-gd php-iconv php-json php-zlib
	php-zip"
depends_dev=
makedepends="$depends_dev"
install="$pkgname.post-install $pkgname.post-upgrade"
subpackages="$pkgname-pgsql $pkgname-sqlite $pkgname-mysql
	$pkgname-texteditor $pkgname-videoviewer"
replaces="$pkgname-plugins"
source="http://download.owncloud.org/community/$pkgname-$pkgver.tar.bz2
	owncloud.config.php
	owncloud-pgsql-upgrade-5.0.3.patch
	"

_builddir="$srcdir"/$pkgname

prepare() {
	cd "$_builddir"
	patch -p1 < ../owncloud-pgsql-upgrade-5.0.3.patch
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"/etc/owncloud
	mkdir -p "$pkgdir"/var/lib/owncloud/data
	mkdir -p "$pkgdir"/usr/share/webapps/owncloud
	rm -rf config data
	mv * "$pkgdir"/usr/share/webapps/owncloud
	ln -s /etc/owncloud "$pkgdir"/usr/share/webapps/owncloud/config || exit 1
	#ln -s /var/lib/owncloud/data "$pkgdir"/usr/share/webapps/owncloud/data || exit 1
	install -m640 ../owncloud.config.php "$pkgdir"/etc/owncloud/config.php
}

pgsql() {
	pkgdesc="ownCloud PostgreSQL support"
	depends="owncloud php-pgsql php-pdo_pgsql php-pear-mdb2-driver-pgsql postgresql"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
}

sqlite() {
	pkgdesc="ownCloud SQLite support"
	depends="owncloud php-sqlite php-pdo_sqlite sqlite"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
}

mysql() {
	pkgdesc="ownCloud MySQL support"
	depends="owncloud php-mysql php-pdo_mysql php-pear-mdb2-driver-mysql mysql"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
}

plugins() {
	pkgdesc="ownCloud 3rdparty plugins"
	depends="owncloud"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
	mv "$pkgdir"/usr/share/webapps/owncloud/3rdparty \
	 "$subpkgdir"/usr/share/webapps/owncloud
}

_mv_app() {
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud/apps
	mv "$pkgdir"/usr/share/webapps/owncloud/apps/files_$1 \
	 "$subpkgdir"/usr/share/webapps/owncloud/apps
}

texteditor() {
	pkgdesc="ownCloud integrated text editor"
	depends="owncloud"
	_mv_app texteditor
}

videoviewer() {
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app videoviewer
}


md5sums="354e0d6ad98ea544aacada809df4b815  owncloud-5.0.3.tar.bz2
48258b2f750ad85d3e1b1bc6d396a661  owncloud.config.php
a66e0d8e2aa59ee92d985494daba98fc  owncloud-pgsql-upgrade-5.0.3.patch"
sha256sums="edcfad4a82906e53b08f61c91180a1bac81412661d78045d7ec668fb63cc9ffc  owncloud-5.0.3.tar.bz2
14b81dd22cf5ebe2e8c9b9c939adb4246f7967d37510816d0018cb222a6b1c4d  owncloud.config.php
9ab33f7e2ef8d8b0f500c7353fb94e7220979ebe7fee62a8dc86cc92682b1d7a  owncloud-pgsql-upgrade-5.0.3.patch"
sha512sums="f8168b2ba43609bca1f58fa8034396a81de03dc1d3838e4a1ebf79faf605d87a747189e639ca734d0ca89d626ae962c32d3ee853a4ffe0e5a9b195ac7f1a6ed3  owncloud-5.0.3.tar.bz2
37995eb694b1d9aba88b1eafddd8b1d3697ed0cd13a5486684eca27df675f82bf177226833bdcc81f0067843b255598d946dd48e02d134f0e97f774c0c90214b  owncloud.config.php
bb2d9894989f585fe866ef2a6e04d32d4307e29fc2e5b1ca7a4e6781704bb3588486bb8e4b22246b20190020726ed3e4ae64764897cde3880de6228be49105f3  owncloud-pgsql-upgrade-5.0.3.patch"
