# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname="owncloud"
pkgver="6.0.2"
pkgrel=0
pkgdesc="Your own WebDAV-based cloud service"
url="http://owncloud.org"
arch="all"
license="AGPL"
depends="php php-ctype php-dom php-gd php-iconv php-json php-zlib
	php-zip"
depends_dev=
makedepends="$depends_dev"
install="$pkgname.post-install $pkgname.post-upgrade"
subpackages="$pkgname-pgsql $pkgname-sqlite $pkgname-mysql $pkgname-documents
	$pkgname-external $pkgname-texteditor $pkgname-videoviewer"
replaces="$pkgname-plugins"
source="http://download.owncloud.org/community/$pkgname-$pkgver.tar.bz2
	owncloud.config.php
	owncloud-5.0.13-remove-shares-where-files-do-not-exist-postgres.patch
	"

_builddir="$srcdir"/$pkgname

prepare() {
	cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg "Applying patch $i"; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"/etc/owncloud
	mkdir -p "$pkgdir"/var/lib/owncloud/data
	mkdir -p "$pkgdir"/usr/share/webapps/owncloud
	rm -rf config data
	mv * "$pkgdir"/usr/share/webapps/owncloud || exit
	ln -s /etc/owncloud "$pkgdir"/usr/share/webapps/owncloud/config || exit 1
	mv "$pkgdir"/usr/share/webapps/owncloud/apps "$pkgdir"/var/lib/owncloud || exit 1
	ln -s /var/lib/owncloud/apps "$pkgdir"/usr/share/webapps/owncloud/apps || exit 1
	install -m640 ../owncloud.config.php "$pkgdir"/etc/owncloud/config.php
}

pgsql() {
	arch="noarch"
	pkgdesc="ownCloud PostgreSQL support"
	depends="owncloud php-pgsql php-pdo_pgsql php-pear-mdb2-driver-pgsql"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
}

sqlite() {
	arch="noarch"
	pkgdesc="ownCloud SQLite support"
	depends="owncloud php-sqlite3 php-pdo_sqlite"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
}

mysql() {
	arch="noarch"
	pkgdesc="ownCloud MySQL support"
	depends="owncloud php-mysql php-pdo_mysql php-pear-mdb2-driver-mysql"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
}

plugins() {
	arch="noarch"
	pkgdesc="ownCloud 3rdparty plugins"
	depends="owncloud"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
	mv "$pkgdir"/usr/share/webapps/owncloud/3rdparty \
	 "$subpkgdir"/usr/share/webapps/owncloud
}

_mv_app() {
	mkdir -p "$subpkgdir"/var/lib/owncloud/apps
	mv "$pkgdir"/var/lib/owncloud/apps/$1 \
	 "$subpkgdir"/var/lib/owncloud/apps
}

texteditor() {
	arch="noarch"
	pkgdesc="ownCloud integrated text editor"
	depends="owncloud"
	_mv_app files_texteditor
}

videoviewer() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app files_videoviewer
}

documents() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app documents
}

external() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app files_external
}

md5sums="da5286427771c68d14b351cf68f515fd  owncloud-6.0.2.tar.bz2
ff335ac21c1dd21520e7218a7240d713  owncloud.config.php
e033c3211983429ef811ffea8159bb46  owncloud-5.0.13-remove-shares-where-files-do-not-exist-postgres.patch"
sha256sums="a5a194ad07fca7cbf158b660cc098c6364590bdd15d086069221faf4386b713f  owncloud-6.0.2.tar.bz2
2bdcb131bee57aaee8f073db66a199c999b95b4a7bf741ae55ee2e0b7b359a1a  owncloud.config.php
0dc56930cc725def606aabdb3ba380fc38daa203b4544ddde523a7d1f962ade8  owncloud-5.0.13-remove-shares-where-files-do-not-exist-postgres.patch"
sha512sums="8a603e3a7cc16a8e4951f0c9ad8919cea04c9cefe1d90db1ee377a51011c0604bed6c620d59e83650e557f89acba2d86060e6238b1f96023dae473d8e63cfa0f  owncloud-6.0.2.tar.bz2
54b7fcb7fd9bcd2992b71205df3fe51597deda32c2919dfd43dd80a803568fd28c78492024eb8041f04bb23de749ee6225a8029dd8234cc861ce5501f810827a  owncloud.config.php
1c05b9c96c92e74d0b603fe76facb4fc9510dbb18dc210cd0b073ca2776886416303abb28d66266982a60e67aa6c7ba06c2ad45dfd926f3a6260f58f1a90e882  owncloud-5.0.13-remove-shares-where-files-do-not-exist-postgres.patch"
