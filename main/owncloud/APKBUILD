# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname="owncloud"
pkgver="5.0.9"
pkgrel=0
pkgdesc="Your own WebDAV-based cloud service"
url="http://owncloud.org"
arch="noarch"
license="AGPL"
depends="php php-ctype php-dom php-gd php-iconv php-json php-zlib
	php-zip"
depends_dev=
makedepends="$depends_dev"
install="$pkgname.post-install $pkgname.post-upgrade"
subpackages="$pkgname-pgsql $pkgname-sqlite $pkgname-mysql
	$pkgname-texteditor $pkgname-videoviewer"
replaces="$pkgname-plugins"
source="http://download.owncloud.org/community/$pkgname-$pkgver.tar.bz2
	owncloud.config.php
	"

_builddir="$srcdir"/$pkgname

prepare() {
	cd "$_builddir"
	return 0
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"/etc/owncloud
	mkdir -p "$pkgdir"/var/lib/owncloud/data
	mkdir -p "$pkgdir"/usr/share/webapps/owncloud
	rm -rf config data
	mv * "$pkgdir"/usr/share/webapps/owncloud
	ln -s /etc/owncloud "$pkgdir"/usr/share/webapps/owncloud/config || exit 1
	#ln -s /var/lib/owncloud/data "$pkgdir"/usr/share/webapps/owncloud/data || exit 1
	install -m640 ../owncloud.config.php "$pkgdir"/etc/owncloud/config.php
}

pgsql() {
	pkgdesc="ownCloud PostgreSQL support"
	depends="owncloud php-pgsql php-pdo_pgsql php-pear-mdb2-driver-pgsql"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
}

sqlite() {
	pkgdesc="ownCloud SQLite support"
	depends="owncloud php-sqlite3 php-pdo_sqlite"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
}

mysql() {
	pkgdesc="ownCloud MySQL support"
	depends="owncloud php-mysql php-pdo_mysql php-pear-mdb2-driver-mysql"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
}

plugins() {
	pkgdesc="ownCloud 3rdparty plugins"
	depends="owncloud"
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud
	mv "$pkgdir"/usr/share/webapps/owncloud/3rdparty \
	 "$subpkgdir"/usr/share/webapps/owncloud
}

_mv_app() {
	mkdir -p "$subpkgdir"/usr/share/webapps/owncloud/apps
	mv "$pkgdir"/usr/share/webapps/owncloud/apps/files_$1 \
	 "$subpkgdir"/usr/share/webapps/owncloud/apps
}

texteditor() {
	pkgdesc="ownCloud integrated text editor"
	depends="owncloud"
	_mv_app texteditor
}

videoviewer() {
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app videoviewer
}


md5sums="1ad9d51e2b355bc5243c84db97786b01  owncloud-5.0.9.tar.bz2
4df3864a94a7b036ac85960549a4013b  owncloud.config.php"
sha256sums="67949a29644468a7cb51c83ffd620bb2093ba02420fb789135161758ccfbf1ff  owncloud-5.0.9.tar.bz2
4b81fbb8c87d05831d22fd64c08db547bcfec901c0737f7f13cbeaace4c421ab  owncloud.config.php"
sha512sums="5bfe1d835c28e609dd9cb975223de7bc46e94f61bcd860834cb8a1b8abb2807e9992384765a5d3e7cdd3eb5a6139bc1cd089ca4e88399e8e19a844a7baa49e5f  owncloud-5.0.9.tar.bz2
51704e369f02fec1f65dc9fca3c4d4c86396bec87c2fb98c8b48b267fbee23b6125626a7987bae2b383d8d8b48a567b84398499e08b725dc23e82fe2b6885b7c  owncloud.config.php"
