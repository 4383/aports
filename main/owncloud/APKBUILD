# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname="owncloud"
pkgver="8.0.0"
pkgrel=0
pkgdesc="Your own WebDAV-based cloud service"
url="http://owncloud.org"
arch="noarch"
license="AGPL"
depends="php php-ctype php-dom php-gd php-iconv php-json php-xml php-zlib
	php-zip"
depends_dev=
makedepends="$depends_dev"
install=
subpackages="$pkgname-pgsql $pkgname-sqlite $pkgname-mysql $pkgname-encryption
	$pkgname-calendar $pkgname-contacts $pkgname-documents $pkgname-external
	$pkgname-mozilla_sync $pkgname-ldap $pkgname-tasks
	$pkgname-texteditor $pkgname-pdfviewer $pkgname-videoviewer"
replaces="$pkgname-plugins"
source="http://download.owncloud.org/community/$pkgname-$pkgver.tar.bz2
	https://apps.owncloud.com/CONTENT/content-files/168708-contacts.zip
	https://apps.owncloud.com/CONTENT/content-files/168707-calendar.zip
	https://apps.owncloud.com/CONTENT/content-files/168711-documents.zip
	https://apps.owncloud.com/CONTENT/content-files/161793-mozilla_sync-1.4.zip
	https://github.com/Fmstrat/ownnote/archive/ownNote-0.0.2.tar.gz
	https://apps.owncloud.com/CONTENT/content-files/166058-tasks.zip
	owncloud.config.php
	owncloud-6-always-return-true-isSetLocaleWorking.patch
	"
pkggroups="www-data"

_builddir="$srcdir"/$pkgname

_ocbasedir="/var/lib/owncloud"
_ocdatadir="$_ocbasedir/data"
_ocwwwdir="/usr/share/webapps/owncloud"
_ocappsdir="$_ocwwwdir/apps"
_occonfdir="/etc/owncloud"


prepare() {
	cd "$_builddir"
        for i in $source; do
                case $i in
                *.patch) msg "Applying patch $i"; patch -p1 -i "$srcdir"/$i || return 1;;
                esac
        done
}

build() {
	cd "$_builddir"
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"${_occonfdir}
	mkdir -p "$pkgdir"${_ocdatadir}
	mkdir -p "$pkgdir"${_ocwwwdir}
	rm -rf config data
	mv * "$pkgdir"${_ocwwwdir} || return 1
	ln -s $_occonfdir "$pkgdir"${_ocwwwdir}/config || return 1
	install -m660 ../owncloud.config.php "$pkgdir"${_occonfdir}/config.php
	for dir in \
	 "$pkgdir"${_occonfdir} \
	 "$pkgdir"${_ocdatadir} \
	 "$pkgdir"${_ocappsdir}; do
		chown -R :www-data $dir || return 1
		chmod 770 $dir || return 1
	done
}

pgsql() {
	arch="noarch"
	pkgdesc="ownCloud PostgreSQL support"
	depends="owncloud php-pgsql php-pdo_pgsql php-pear-mdb2-driver-pgsql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

sqlite() {
	arch="noarch"
	pkgdesc="ownCloud SQLite support"
	depends="owncloud php-sqlite3 php-pdo_sqlite"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

mysql() {
	arch="noarch"
	pkgdesc="ownCloud MySQL support"
	depends="owncloud php-mysql php-pdo_mysql php-pear-mdb2-driver-mysql"
	mkdir -p "$subpkgdir"${_ocwwwdir}
}

plugins() {
	arch="noarch"
	pkgdesc="ownCloud 3rdparty plugins"
	depends="owncloud"
	mkdir -p "$subpkgdir"${_ocwwwdir} || return 1
	mv "$pkgdir"${_ocwwwdir}/3rdparty "$subpkgdir"${_ocwwwdir}
}

_mv_app() {
	mkdir -p "$subpkgdir"${_ocappsdir} || return 1
	if [ "$1" = "pkg" ]; then
		mv "$pkgdir"${_ocappsdir}/$2 "$subpkgdir"${_ocappsdir}
	elif [ "$1" = "src" ]; then
		mv "$srcdir"/$2 "$subpkgdir"${_ocappsdir}
	fi
}

contacts() {
	arch="noarch"
	pkgdesc="ownCloud contacts"
	depends="owncloud"
	_mv_app src contacts
}

calendar() {
	arch="noarch"
	pkgdesc="ownCloud calendar"
	depends="owncloud"
	_mv_app src calendar
}

documents() {
	arch="noarch"
	pkgdesc="ownCloud integrated documents editor"
	depends="owncloud"
	_mv_app src documents
}

encryption() {
	arch="noarch"
	pkgdesc="ownCloud integrated encryption support"
	depends="owncloud php-openssl"
	_mv_app pkg files_encryption
}

external() {
	arch="noarch"
	pkgdesc="ownCloud integrated external storage support"
	depends="owncloud php-ftp"
	_mv_app pkg files_external
}

ldap() {
	arch="noarch"
        pkgdesc="ownCloud integrated LDAP authentication"
	depends="owncloud php-ldap"
	_mv_app pkg user_ldap
}

mozilla_sync() {
	arch="noarch"
        pkgdesc="ownCloud Mozilla sync app"
	depends="owncloud"
	subpkgver="1.4"
	_mv_app src mozilla_sync
}

#ownnote() {
#	arch="noarch"
#        pkgdesc="ownCloud notes app"
#	depends="owncloud"
#	subpkgver="0.0.2"
#	_mv_app src ownnote-ownNote-$subpkgver
#}

pdfviewer() {
	arch="noarch"
        pkgdesc="ownCloud integrated PDF viewer"
	depends="owncloud"
	_mv_app pkg files_pdfviewer
}

tasks() {
	arch="noarch"
	pkgdesc="ownCloud tasks"
	depends="owncloud"
	_mv_app src tasks
}

texteditor() {
	arch="noarch"
	pkgdesc="ownCloud integrated text editor"
	depends="owncloud"
	_mv_app pkg files_texteditor
}

videoviewer() {
	arch="noarch"
	pkgdesc="ownCloud integrated video viewer"
	depends="owncloud"
	_mv_app pkg files_videoviewer
}

md5sums="d2c1366be0756c24e1f5cfc02f80269f  owncloud-8.0.0.tar.bz2
d706ff102f7d8e097c0c6f9335b4676e  168708-contacts.zip
2e50e7cf83d2c10943caa83119b4d94e  168707-calendar.zip
166f86208cc71a07c9d73e184890cd97  168711-documents.zip
1ce06aac149edfbe0825d251088258b7  161793-mozilla_sync-1.4.zip
b97b0c0c13d0c351f196944e3e5a6706  ownNote-0.0.2.tar.gz
2aee5990ee55476ff6e74b72ee15ae88  166058-tasks.zip
5374a893d97f4cf456760f0a88a9d673  owncloud.config.php
f497dbf3a67d14fc9049ca680673c805  owncloud-6-always-return-true-isSetLocaleWorking.patch"
sha256sums="0c62cb06fe4c3eb107bccc4302f2bb3b9f7e5373cf7c9dd307fea8e823e6342f  owncloud-8.0.0.tar.bz2
8a77d0fb436bd70898c70eca4f98672ecd6759a4b25bb44ffdc95f9b04d41e3d  168708-contacts.zip
5edb9f9258aac1eedf5509d334290c34dc3a493b9176edce516ddd6113bc9301  168707-calendar.zip
8c476f36b5c108e071beef613112583d43a4ed9f3afee2f71d77a6dee86a25d5  168711-documents.zip
fb2e40cd79cd94afa3d0d5841e741d08b25802133856a2e41114b863c1fbb07a  161793-mozilla_sync-1.4.zip
9f00554a91cd80bcc19f75f4fb5d45cb2638e767b69b233fe40b6d27d3eaebed  ownNote-0.0.2.tar.gz
02a6103de7a1fa7169c8c715ab8be67fb8a597eb6bb0bf3ca27c0cecba208043  166058-tasks.zip
06bebe03164b98a69a1b138cc99d1227d50db7a2b4f1e5830631e0db58b2542b  owncloud.config.php
3466ffbd22d4a9f04f4df862f3fb2f695fd1ca4bc6fb4b6a56258958064d5762  owncloud-6-always-return-true-isSetLocaleWorking.patch"
sha512sums="bc92f4341cb4b6b2f7b5f9218d8bb7f4321008d6f2391f237ea07303ffafef5aebc94317c690daea2f81d408b0278198c84cfbfc40192158ef5f08b482efa5a3  owncloud-8.0.0.tar.bz2
31018156a0601c3937c20effe3acbefc6d861fbb40df1d89d6e445f1a5d15dd062b497c139c5d4bad218dc0c418b981c8609c158d0acc0cc8892b0629514714e  168708-contacts.zip
57ffac92d88cba91cb6e999f31f5c0b58cd1cd874a3eb639fe0317a5c11a63d595e533e0c3914095a41e2f60965d8abb70de75f43fed9cff160db3c3d6a400d8  168707-calendar.zip
37319ed46f84f8cb6dba7ae0812dd73084f087fa974b4ae2839ec9035b822df744ee1f432c04deb6e8eb1767027cc7af63001e312241aa7877a6ba8a912be731  168711-documents.zip
c86c6b1302d7ef82e1038b3987eebfb4cfd31d226e76cad75a79e3679405c58095a1fca254156e0688993e916165960aad066188b13ed9a2f4c4312916b54d9f  161793-mozilla_sync-1.4.zip
483eeb6d0e2e6438310e3d4142f8f2419958f6670b50f767b9345d135cc3d222d9e19a83372b46dced093508c9f0086e436a39b2ab10d454c0fae8a136dfd3a6  ownNote-0.0.2.tar.gz
2fbc5be1a635126543f5ff9de128681f18b856f4d561b7e0c2f6b1ca9e0e7d58825fbc656051257fb6b0ff9851510bed395bd3b83c183309f98f3af64ab18993  166058-tasks.zip
3e82a1dea53a33f84ab6986b18e5750a4fdef9bbc0c6e78788e9234f61374f6b135f3bcdd3ad14705f68f5779fce6d992632067023a648c5d7d5a247412a0696  owncloud.config.php
4b2038786571c62129d748bb71262a7cbc966cf4b97482f13bcedaa36fcfa343080a464fc74463a9bd6615c99a10cd590b91cacead62632db36bfd8940173d13  owncloud-6-always-return-true-isSetLocaleWorking.patch"
