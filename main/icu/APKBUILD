# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=icu
pkgver=52.1

# convert x.y.z to x_y_z
_ver=${pkgver//./_}

pkgrel=1
pkgdesc="International Components for Unicode library"
url="http://www.icu-project.org/"
arch="all"
license="custom:icu"
subpackages="$pkgname-dev $pkgname-doc $pkgname-libs"
depends=
makedepends=
source="http://download.icu-project.org/files/icu4c/${pkgver}/${pkgname}4c-$_ver-src.tgz
	icu-timezone.patch
	CVE-2014-8146.patch
	CVE-2014-8147.patch
	"

_builddir="$srcdir"/icu/source

prepare() {
	cd "$_builddir"
	update_config_sub || return 1

	local x
	# https://bugs.icu-project.org/trac/ticket/6102
	for x in ARFLAGS CFLAGS CPPFLAGS CXXFLAGS FFLAGS LDFLAGS; do
		sed -i -e "/^${x} =.*/s:@${x}@::" "config/Makefile.inc.in" \
			|| return 1
	done

	for i in $source; do
		case "$i" in
		*.patch)
			msg "Applying $i"
			patch -p1 -i "$srcdir"/$i || return 1
			;;
		esac
	done
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--with-data-packaging=library \
		--disable-samples \
		--mandir=/usr/share/man \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make -j1 DESTDIR="$pkgdir" install || return 1
	chmod +x "$pkgdir"/usr/bin/icu-config
	install -Dm644 "$srcdir"/icu/license.html \
		"$pkgdir"/usr/share/licenses/icu/license.html
}

libs() {
	default_libs
	replaces="icu"
}

md5sums="9e96ed4c1d99c0d14ac03c140f9f346c  icu4c-52_1-src.tgz
7c5d8b8105c26afa78fa4300bb4bed48  icu-timezone.patch
59b258e7dedf329faa270d7c56efec59  CVE-2014-8146.patch
e3a1beeff61e786176225bfd8883263c  CVE-2014-8147.patch"
sha256sums="2f4d5e68d4698e87759dbdc1a586d053d96935787f79961d192c477b029d8092  icu4c-52_1-src.tgz
b5bff5392e5c6b8bacd8f06fd32bff08688c7884bd33ffc10ef4338f621c6ef5  icu-timezone.patch
ab82594942d372d6ae54c76a687d9388cc8f53b86360d6b11899ade7d8c28a3e  CVE-2014-8146.patch
6c7425c89a3699899420b0b4b81bb2f4dfd982454d2cd730bac6729742c82465  CVE-2014-8147.patch"
sha512sums="5300b1d97340850d3d72af220ff5cbc2ae2820aff4367b60e52f17ead9831011dcda3d4c5af57c899d47b6fc964b23c9c8922954b32d314d669eb1a479a2efb0  icu4c-52_1-src.tgz
fc424cf0b78c9dcdea309e161b4ead3537207dc1b0ef8a2b0d824360a261f7b358cc0261e8c9e74f61244b67db106c92902ff63fcbaabf31d701d38e37a8e658  icu-timezone.patch
fecf44dd06701978014779f791c6b10c3544a3bc8d9f1fda4f7f93adff84f31361b128e61637bace221e733d95063cefcc23bd7e2e86a7d5d68cfad0a52ef736  CVE-2014-8146.patch
0fabe1dd15a3957dcf9ae32e053876e4bdc0348a9f5bfd9549d375a76f38a1691836a2cad26bc26ac26b39487cc5924b2b8e0dbc280cee1141d49d379dfa173b  CVE-2014-8147.patch"
