# Contributor: Sergei Lukin <sergej.lukin@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=libarchive
pkgver=3.2.2
pkgrel=1
pkgdesc="library that can create and read several streaming archive formats"
url="http://libarchive.googlecode.com/"
arch="all"
license="BSD"
depends=""
subpackages="$pkgname-dev $pkgname-doc $pkgname-tools"
makedepends="zlib-dev bzip2-dev xz-dev acl-dev openssl-dev expat-dev"
depends_dev="$makedepends"
source="http://www.libarchive.org/downloads/libarchive-$pkgver.tar.gz
	CVE-2017-5601.patch
	CVE-2017-14166.patch"

_builddir="$srcdir"/$pkgname-$pkgver

# secfixes:
#  3.2.0-r0:
#    - CVE-2016-1541
#  3.2.1-r0:
#    - CVE-2015-8934
#    - CVE-2016-4300
#    - CVE-2016-4302
#    - CVE-2016-4809
#    - CVE-2016-5844
#    - CVE-2016-6250
#  3.2.2-r0:
#    - CVE-2017-5601
#  3.2.2-r1:
#    - CVE-2017-14166

prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build () {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--without-xml2 \
		|| return 1
	make
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
}

tools() {
	pkgdesc="libarchive tools bsdtar and bsdcpio"
	mkdir -p "$subpkgdir"/usr/
	mv "$pkgdir"/usr/bin "$subpkgdir"/usr/
}

md5sums="1ec00b7dcaf969dd2a5712f85f23c764  libarchive-3.2.2.tar.gz
f9bf727dad55bc4c639e4fe12c456d8f  CVE-2017-5601.patch
f5dc039605c8c349da58f396c83816e9  CVE-2017-14166.patch"
sha256sums="691c194ee132d1f0f7a42541f091db811bc2e56f7107e9121be2bc8c04f1060f  libarchive-3.2.2.tar.gz
300c119e85a49615e2ed34521de77fa8202d1db39bb861998b3e71148c1adcdc  CVE-2017-5601.patch
059c894d5a26ebbd7f908e54ecc47429eb6166968c6b900447ac7d8c04b936b8  CVE-2017-14166.patch"
sha512sums="a67920c37d49cf9478032d77fc4fa21827cebb96e9b83d9ecb8466328834052e4ab3d3a9bc4e2edf405d6cb14ffd648c9fa100b578257f6e5842c99bbea558a7  libarchive-3.2.2.tar.gz
a00839e72fa7ccbdbde4b8b5a8e04f96d6eabcaa2d0150393c8273e4855b09d18cbec6fb1e4551d0d1bbc0439e1f41d5341539a0de8a97f821a5281a7bac8494  CVE-2017-5601.patch
7cc9dbafd970c07fb4421b7a72a075cc0a000db77df4432222539c58625c93c45f01a144838b551980bc0c6dc5b4c3ab852eb1433006c3174581ba0897010dbe  CVE-2017-14166.patch"
