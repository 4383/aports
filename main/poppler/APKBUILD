# Maintainer: Natanael Copa <ncopa@alpinelinux.org>

# this aport does not include glib/gtk support in order to break the
# circular make dependency: gtk <- cups <- poppler <- gtk
# So we build gtk support in poppler-gtk
pkgname=poppler
pkgver=0.22.1
pkgrel=1
pkgdesc="PDF rendering library based on xpdf 3.0"
url="http://poppler.freedesktop.org/"
arch="all"
license="GPL"
subpackages="$pkgname-dev $pkgname-doc $pkgname-utils"
makedepends="libjpeg-turbo-dev cairo-dev libxml2-dev fontconfig-dev libiconv-dev
	lcms-dev"
depends=
depends_dev="cairo-dev"
source="http://$pkgname.freedesktop.org/$pkgname-$pkgver.tar.gz
	CVE-2013-4473.patch
	CVE-2013-4474.patch"

_builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-static \
		--enable-cairo-output \
		--enable-xpdf-headers \
		--enable-libjpeg \
		--enable-zlib \
		--disable-poppler-glib \
		--disable-poppler-qt4 \
		|| return 1
	make
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	find "$pkgdir" -name '*.la' -delete
}

utils() {
	pkgdesc="Poppler's xpdf-workalike command line utilities"
	install -d "$subpkgdir"/usr
	mv "$pkgdir"/usr/bin "$subpkgdir"/usr/
}

md5sums="50c259fdda538c1ba94b62aa25f7ec87  poppler-0.22.1.tar.gz
6cbd84d8a52316ca7cf0383e2c437f9e  CVE-2013-4473.patch
112d102b32b6b985f15c88423ecc66eb  CVE-2013-4474.patch"
sha256sums="12b6a6d3c0bfda065653b7507cda49e22773693c913f8e563d55fb33031197c0  poppler-0.22.1.tar.gz
aff72cd21c3eee9c7b342d17ac748120a54026de0b15caa824a80473174b0c99  CVE-2013-4473.patch
1a440e3f9fc8349a7e95f12d772ac19760ea696364a0ff7cc6f24d8b1d3c6d7e  CVE-2013-4474.patch"
sha512sums="038729dbdba8800f4944613fe40c6925cf424ee86e88048ffe50c72c5e86650dfd79fe39296480c837873dbf8f2c0acee8d803721c24203d9e355858a10ef9e2  poppler-0.22.1.tar.gz
2e0e5be091c8939bf7b3efb2de3e11e128e5212c22b8c5073fc12dbefce17b95495a3a5bdcd1b4abea4f8473b0728ebdfb0fd09fcd754d34d58b7f8922eaa1b1  CVE-2013-4473.patch
3885be303ed4d5050e03da947751fd1c85d1847d5260ce2ad1f85e39b63ff0ed28dc3ce7269fd96600bcafb8e76492f5841d2e58ecda69ea22c00b7039e9b10f  CVE-2013-4474.patch"
