# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=slim
pkgver=1.3.6
pkgrel=0
pkgdesc="Desktop-independent graphical login manager for X11"
url="http://slim.berlios.de/"
arch="all"
license="GPL-2"
subpackages="$pkgname-doc"
makedepends="libxmu-dev libpng-dev libjpeg-turbo-dev libxft-dev
	cmake linux-pam-dev"
depends=
install=
source="http://download.berlios.de/$pkgname/$pkgname-$pkgver.tar.gz
	http://dev.alpinelinux.org/~ncopa/alpine/slim-alpinelinux.tar.gz
	pthread.patch
	$pkgname.logrotate
	$pkgname.initd
	"

prepare() {
	cd "$srcdir/slim-$pkgver"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	sed -i -e 's|#xserver_arguments.*|xserver_arguments   -nolisten tcp vt07|'\
		-e 's|/var/run/slim.lock|/var/lock/slim.lock|' \
		-e 's|halt_cmd.*|halt_cmd            /sbin/poweroff|'\
		-e 's|reboot_cmd.*|reboot_cmd          /sbin/reboot|'\
		-e 's|console_cmd.*|console_cmd         /usr/bin/terminal|'\
		-e 's|login_cmd.*|login_cmd           exec /bin/sh -l /etc/X11/xinit/xinitrc|' \
		-e 's|screenshot_cmd.*|screenshot_cmd      scrot /slim.png|' \
		-e 's|imagemagick|scrot|' \
		-e 's|current_theme.*|current_theme       alpinelinux|' \
		slim.conf || return 1
}

build() {
	cd "$srcdir/slim-$pkgver"
	cmake . \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_SKIP_RPATH=ON \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DUSE_PAM=no \
		-DUSE_CONSOLEKIT=no \
		|| return 1


	make CXX="${CXX:-g++}" CC="${CC:-gcc}" || return 1
}

package() {
	cd "$srcdir/slim-$pkgver"
	make DESTDIR="$pkgdir" MANDIR=/usr/share/man install || return 1

	install -D -m755 ../slim.initd "$pkgdir"/etc/init.d/slim || return 1
	install -D -m644 ../slim.logrotate "$pkgdir"/etc/logrotate.d/slim

	# install our default theme
	cd "$srcdir"/slim-alpinelinux
	install -d "$pkgdir"/usr/share/slim/themes/alpinelinux
	cp background.png panel.png slim.theme \
		"$pkgdir"/usr/share/slim/themes/alpinelinux/
	rm -rf "$pkgdir"/usr/share/slim/themes/default
}

md5sums="d40d256394f9ef34cef34d2aa9cb52e6  slim-1.3.6.tar.gz
cd63232c7770b0e67a009a94c2a46b82  slim-alpinelinux.tar.gz
960137d1fd0cd257c889a6212cd8b44e  pthread.patch
43da096480bf72c3ccec8ad8400f34f0  slim.logrotate
6ee3a023e56052528295034be809cfc6  slim.initd"
sha256sums="21defeed175418c46d71af71fd493cd0cbffd693f9d43c2151529125859810df  slim-1.3.6.tar.gz
dfa910e8d8c1cd3b687d7b0b49d1cb36ba4148de8862667c4ca03da194e42e64  slim-alpinelinux.tar.gz
f71de6655c1be6009fee9b75e75d16c7fe9bbf85bc475eebfaf4018a83e9428d  pthread.patch
5bf44748b5003f2332d8b268060c400120b9100d033fa9d35468670d827f6def  slim.logrotate
fcb6b74588b3c9fb4001cdbf0d52a72db3b325118d8112b8186c5cafe0b1c1fa  slim.initd"
sha512sums="345b1dee5d6f0c3716dfa7c5c16274adbf18586bdaaa6af4f310e24c5a61f79a297ffac921a5ba545523317e9fe120916df226c36b9c9b49c2ac9c1ca21dee0c  slim-1.3.6.tar.gz
45e080bd5cc49e5c380d851fee7622ffe6ce9b11fdabe3b3b971618b0d140c39cead5e2a9f6ac5272eed885649b1903c9a4d3c6ce45dcf3026a91198f4d790c5  slim-alpinelinux.tar.gz
312bd54e60451c6105300d5b8bf08788bca009b0af6661c180c357131e3b066f14cf95f6ed8ed186f750fbd9783407dee7bd9d494c594f6c57d2f762a132dcda  pthread.patch
e5f398ea58adbedea7ae40c7a907d2f926148ee6f3c51fc5761b84d1d119c091fa0cf34f908cd49300fcddea71c5c9b6f2ac21731808ce5d73ea65a65b19a55b  slim.logrotate
022348a96e42bcf9454174f470c954b5a25d45250220d26010aa1b62106dc2f27a34c2e767f4f97087424b8122443095623098417a163683c54126878f1721a4  slim.initd"
