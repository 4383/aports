# Contributor: William Pitcock <nenolod@dereferenced.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=lxc
pkgver=0.9.0
_mypkgver=${pkgver/_rc/-rc}
pkgrel=11
pkgdesc="linux containers - tools"
url="http://lxc.sourceforge.net/"
arch="all"
license="GPL"
depends="bash"
depends_dev="libcap-dev"
makedepends="$depends_dev lvm2 util-linux"
install=""
subpackages="$pkgname-dev $pkgname-doc $pkgname-lvm"
source="http://linuxcontainers.org/downloads/lxc-$_mypkgver.tar.gz
	bb-rm.patch
	bb-shutdown.patch
	alpine-template-backport.patch
	0001-lxc-alpine-create-dev-zero.patch
	0002-lxc-alpine-add-arm.patch

	0001-lxc-alpine-add-hwaddr-for-a-single-macvlan-interface.patch
	0001-lxc-alpine-allow-dev-full.patch
	0001-lxc-alpine-enable-4-consoles-by-default.patch
	0001-lxc-alpine-enable-loopback-interface-by-default.patch
	0001-lxc-alpine-run-bootmisc-and-syslog-at-boot-runlevel.patch
	0001-lxc-alpine-copy-etc-TZ-to-container-if-present.patch
	0001-lxc-alpine-mount-tmpfs-on-dev-shm.patch
	0001-Don-t-include-linux-if_bridge.h.patch
	0001-fallback-from-udev-to-mdev.patch

	lxc-fix-headers.patch
	lxc.initd
	"

_builddir="${srcdir}/${pkgname}-${_mypkgver}"
prepare() {
	local i
	cd "$_builddir"
	update_config_sub || return 1
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	[ "$CLIBC" = musl ] && export CFLAGS="$CFLAGS -Dutmpxname=utmpname -D_GNU_SOURCE"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-apparmor \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -d "$pkgdir"/var/lib/lxc
	install -Dm755 "$srcdir"/lxc.initd "$pkgdir"/etc/init.d/lxc
}

lvm() {
	pkgdesc="linux containers lvm support"
	depends="lvm2 util-linux lxc"
	arch="noarch"
	mkdir "$subpkgdir"
}

md5sums="8552a4479090616f4bc04d8473765fc9  lxc-0.9.0.tar.gz
a0894c2ddf9133c3cc33c264e4596a3c  bb-rm.patch
e96514860ee34b62d1b208ab03c569bc  bb-shutdown.patch
25dd200bd158d16a05bb3e7aaef84697  alpine-template-backport.patch
e08b77b3b35adac290b49b9c9e04754c  0001-lxc-alpine-create-dev-zero.patch
181c01649399b2c2dbadab9713381358  0002-lxc-alpine-add-arm.patch
c57d7008ab6e7f652159a5f2856a343d  0001-lxc-alpine-add-hwaddr-for-a-single-macvlan-interface.patch
ee3339a1c5d388b65b24bdea924387a8  0001-lxc-alpine-allow-dev-full.patch
c12ea194274b6c8d3b05bd43ed70c61d  0001-lxc-alpine-enable-4-consoles-by-default.patch
999a89373f5e2c61d1369526de7e5850  0001-lxc-alpine-enable-loopback-interface-by-default.patch
75979789ec45ef865895f5ce5721dd3e  0001-lxc-alpine-run-bootmisc-and-syslog-at-boot-runlevel.patch
6c188f8dd2ba18e895eed2dec79fcab9  0001-lxc-alpine-copy-etc-TZ-to-container-if-present.patch
c172314d12b6bc2ef7b39e891bb74a9c  0001-lxc-alpine-mount-tmpfs-on-dev-shm.patch
83e105a961993d46fb901e49230c69f2  0001-Don-t-include-linux-if_bridge.h.patch
97279f1d46b9f7c07d43b7ca69513bad  0001-fallback-from-udev-to-mdev.patch
24e7ae51da3c8c483d5228b821cc7244  lxc-fix-headers.patch
9f780f761dcaec3ce40d083c6df044d4  lxc.initd"
sha256sums="1e1767eae6cc5fbf892c0e193d25da420ba19f2db203716c38f7cdea3b654120  lxc-0.9.0.tar.gz
c9caea06b87baf5e335821c7e9ce3caca849b33f8176fbd48126c605583e78fc  bb-rm.patch
0e5706cb077f750afdd6a5a4fd2afdf0b9113126c85e130d92680bed4ce9c20e  bb-shutdown.patch
df193c4cf08e171c23b0b472750b7b1e0e7a66971c03201a0523e4039909f33b  alpine-template-backport.patch
8b3b314d99209ae27d78cd4e9469638a945d68d03beefaec499bad373a7cb8cd  0001-lxc-alpine-create-dev-zero.patch
415e28eae4d0611c899509835c70e82a06b2bae0b8f380b40de6eb0b5a039684  0002-lxc-alpine-add-arm.patch
526ed739247422e0d326d0892612bec520508763203136c620c3c1ee4a9329bf  0001-lxc-alpine-add-hwaddr-for-a-single-macvlan-interface.patch
66c10a207380f5c0f1945ed6f6b1254c554b68127bc3729d7bf335137ab0750d  0001-lxc-alpine-allow-dev-full.patch
264cbc4efe6983050b3043fb4df031c4d9b93d35eb3c02463bddf530f8701880  0001-lxc-alpine-enable-4-consoles-by-default.patch
eb5043672ef81cd5b20f25dc847bfad7e9e14b42a794856c3a8c8c1e4e408dfc  0001-lxc-alpine-enable-loopback-interface-by-default.patch
51bd2fc5f166499c8996d1b89f324168b0c1bbb6b2b79260591d442120098a34  0001-lxc-alpine-run-bootmisc-and-syslog-at-boot-runlevel.patch
92d7f479d8d466e03f187076a1187112a116f3a37426ba6d1dfd87ed7999c4c8  0001-lxc-alpine-copy-etc-TZ-to-container-if-present.patch
b85e307faaacfa79854564032e17325bc30efdccf9e8ab3929ab7b44a5a74205  0001-lxc-alpine-mount-tmpfs-on-dev-shm.patch
f0911ff82ef8fc3f1832f3af771fe6d9944f12d7409feb7d4233136e6720ad05  0001-Don-t-include-linux-if_bridge.h.patch
ccc57c12f81f68b6d21688982bebb11f98840ca2288b8e9966d2078cd95bd9f8  0001-fallback-from-udev-to-mdev.patch
82d584e30b1963bd638b5a640b2788d8ac3757b480f61fd2ab55a09b9a6f4ccd  lxc-fix-headers.patch
8bdb64ecf100b648396456f6765230aab8649665bfcf320baede529ce6c5484d  lxc.initd"
sha512sums="a96133660ca6ea45dc4b8d167267120328577339e933ff9510f03e9d368ca5db77031dc1e7e4529b3e506f63f79c2ce3f8f72571a7dfdbeb2a8799777782a606  lxc-0.9.0.tar.gz
b8fe47af6b1341ca472b6337c304f52402c53d400fc1d13895f2f568dd4d81b9ff281efc70bc1ddc221ac457db3bed4a199491059a15f66755deddc93ce91bf1  bb-rm.patch
86df52e380a01d6d3f588ca395925e8f774529c72e5b4c8dcb701d79fad7697ed8800f0ff51fded2896b2d2af49faa7f26960234fc8c1a6b4bc8f42d85078e6d  bb-shutdown.patch
d10e25aeee0aba61a4c3420fe1b2bfd9213e7ef10f399ed5f0ba5d978a97a49fd23044b098f73f6d9651c23b1bb025f30d81deb6aec9edf4d2267afc22a09d60  alpine-template-backport.patch
0304aabfac3280cbc18347f1168b2289a98e03b9f6a3134770e43bb914978a64a108a0b0ec709856db161e98366c06c8a65d5a30e730add4cee2968718cdc93a  0001-lxc-alpine-create-dev-zero.patch
d1860b5a47303762ec82d65c2f2c6feaac0115aeb2ddaaf6c052085e9b8dc1d8f6bd05af1c8596c7c978391af75cbe97b38f98f37dd036d61bd9cea9b81226dd  0002-lxc-alpine-add-arm.patch
55c2a67eff5c90721de5949b21afc5aa77bf28323616f551beb4404cacfd0ba38cbb7d5046ed54d685414b5fdbbd5b5f20df9cb0c8ee2c0c12e48bd35866e033  0001-lxc-alpine-add-hwaddr-for-a-single-macvlan-interface.patch
dd686d8ce9cd73807b744163e6b20e41eca17f3ee618cef66f19488cb2527b56d38c04231d25177de6295f2df224cd567add90e257dfa9d6be7f9a50f5c7bf21  0001-lxc-alpine-allow-dev-full.patch
372490dc5a459778e97b75691ed48b2c070c0a9b16f08c7f5ef3a791ded64fe5f23ca1e145314fea355664a2b055eb572546dd0793560137baae0898184c9e19  0001-lxc-alpine-enable-4-consoles-by-default.patch
47d31ed9d0cdde58b0ee97b3f179db270534b73fe8c77fe72fdef1483a545e608a533d41e8b4041474493016cd445fe02751663ad0cbc7fc9af241b344454dea  0001-lxc-alpine-enable-loopback-interface-by-default.patch
75130578c4103586b973c6e9586833acfa89de8021f4dd320385905c4f9d3d1bf7a1e8d3cfe8704a3add00d41d19c30a371bce232a863e9c837a148e9066a0d6  0001-lxc-alpine-run-bootmisc-and-syslog-at-boot-runlevel.patch
7c5e6656565ed0ec51449baab4d310520cc43805428515d6541d4c4e03cc2f44b6762b3239983ee06596dcdec68d395250f944aabe92afc91ba2432f4847555b  0001-lxc-alpine-copy-etc-TZ-to-container-if-present.patch
850bc35c56e7c7b7e7a3efde504e2ceefbb790a3298d96e195ab610a83a946b3783e409ce14639fb9e8ac03ccc05b973c0c81803c514148c0e1c726249277eaa  0001-lxc-alpine-mount-tmpfs-on-dev-shm.patch
ebdc01504a3e4d48ba96f6e9c6786c02f6803a14ae6754f52aee12c462c7a24e678cf520318662e2f7e4efcd65cd577c2d415ca13fcb7ace323f59bdcfec9f75  0001-Don-t-include-linux-if_bridge.h.patch
fa5d69ced46ecb5994f615f70589fd70eaecd8b9d8873887afff6ce0671efbf0e2518ed3e873c25ca8367d860d0f1ba34b17f57563a9c18b84cf6c20c1bdf52a  0001-fallback-from-udev-to-mdev.patch
2c4138e57021714d66bd4d30cfedd768965a0ec11776363b83db7d4efa8c06901c42ee1ad13dff68fd8e3e6a1c34034c529c1f8995d9d3a57a318bc7023fbc05  lxc-fix-headers.patch
e3aa39c60db6ba73cbe3fcb27170dd83a03a0a175d8a28513f242a81eef5cb0e90b78dc63fc8da5c7160e60bc780111679fd6d0e401a0d6626e574c328c5afb0  lxc.initd"
