# Contributor: William Pitcock <nenolod@dereferenced.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=lxc
pkgver=1.0.6
_mypkgver=${pkgver/_rc/.rc}
pkgrel=2
pkgdesc="linux containers - tools"
url="http://lxc.sourceforge.net/"
arch="all"
license="GPL"
depends="bash"
depends_dev="libcap-dev"
makedepends="$depends_dev lvm2 util-linux automake autoconf libtool lua5.2-dev"
install=""
subpackages="$pkgname-dev $pkgname-doc $pkgname-lvm lua5.2-lxc:_lua52
	$pkgname-templates $pkgname-libs"
source="https://github.com/lxc/lxc/archive/lxc-$_mypkgver.tar.gz
	version.patch
	lxc.initd

	CVE-2014-1334.patch
	CVE-2015-1331.patch
	CVE-2015-1335.patch
	fix-multislash.patch
	"

_builddir="${srcdir}/lxc-lxc-${_mypkgver}"
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	./autogen.sh
}

build() {
	cd "$_builddir"
	LUA_VERSION=5.2 \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-apparmor \
		--enable-lua \
		--with-lua-pc=lua5.2 \
		--with-distro=alpine \
		|| return 1
	make VERSION=$pkgver || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -d "$pkgdir"/var/lib/lxc
	install -Dm755 "$srcdir"/lxc.initd "$pkgdir"/etc/init.d/lxc
}

lvm() {
	pkgdesc="linux containers lvm support"
	depends="lvm2 util-linux lxc"
	arch="noarch"
	mkdir "$subpkgdir"
}

_lua52() {
	pkgdesc="Lua 5.2 module for LXC"
	for i in lib share; do
		mkdir -p "$subpkgdir"/usr/$i || return 1
		mv "$pkgdir"/usr/$i/lua "$subpkgdir"/usr/$i/ || return 1
	done
}

templates() {
	pkgdesc="Templates for LXC"
	arch="noarch"
	mkdir -p "$subpkgdir"/usr/share/lxc
	mv "$pkgdir"/usr/share/lxc/templates "$subpkgdir"/usr/share/lxc/
}

dev() {
	default_dev
	#fix abuild smartness
	mv "$subpkgdir"/usr/bin/lxc-config \
		"$pkgdir"/usr/bin/ || return 1
}

md5sums="3949cd916a120f40c2355c9a5b65cd51  lxc-1.0.6.tar.gz
79e90616b5049a472ccdcb5b1dcdd8b1  version.patch
1268d4b3e6ed004a47216b8714d09bfd  lxc.initd
33444cc34285e2cd6933fef01c0a7ca8  CVE-2014-1334.patch
5d9e5fc3a4d02ea986d84ef7b29f359c  CVE-2015-1331.patch
47df9db0bbb78d9b822edc508885c718  CVE-2015-1335.patch
36a9c325f1c2a40e07b4a90fcdf1f3e0  fix-multislash.patch"
sha256sums="2aea199a89e2cd946f93406af6c3f62844f36954b79a6991b36d2c33022cb11c  lxc-1.0.6.tar.gz
b6d85fb23940d2511b3951de56b2532843c0e03ec1613548366361cc0c1a46b9  version.patch
bc108a722dc359a24c48837ef7012c776b1d20a533ae0e2231f75081dad4e2f5  lxc.initd
9d9f108e174e0a19789107f8ac8f25a7fe6d1732bef1ca62e334745f87d1ee07  CVE-2014-1334.patch
f6974204ad7db4188df16d658ae332fc8a8317ff4ff66363028516f86996a4b1  CVE-2015-1331.patch
ef7a48440a92404b4a799b91e16f10a38463d5031109f0dbdee0cc88826abeca  CVE-2015-1335.patch
cb9d34d58ea051a4c9a266ce2dc137594acdfee3e692a8cbe47a82f53b881f6c  fix-multislash.patch"
sha512sums="fe85ccb57865d86704df6b4b79d60f31892785b07dc9dd2580cc6c384c89c29c23516e906b7a16bc03c6582c1fb2432bb8ff11bd17c09efa8f6a035fb41f46b1  lxc-1.0.6.tar.gz
e2ffcbf55447291a8434a4f37255c3a6a119bc4116c75d205006aa2b070bf6be28535cf6107bead14bbf64bf9fa415346ab544bd1c15e1add7d1c6380e6b2def  version.patch
6618ceb59f1927bb82ad1a0fe0a7d4c452ced7855d8f0953556fce9154f30a4c5afbd7a2ab07fb26e6e793b07d4c8f906f8dc27c1defe0580dcf1545c80d1d60  lxc.initd
0c983c82ef9168a08ab0f1f9e27d4518d8ca08ec50ebe1110398f9145c82855efc3a9841239fe2097e6f333bd7cf4cefa4ee9bcd2e41cd83f81c39750a6a45c7  CVE-2014-1334.patch
6d1884a08586ce6d8c5b297cd44844632b0cf0296defd81dd20e563be24c1711ec46bee97ff81e33d9639c91419f547f294d1abfc6d759ff6b6c415a21c4dca8  CVE-2015-1331.patch
2ab3474d3b1b960d98e3ca12817b3deb829b47d6282c0576acd092103ff7e576fdd189435e0fc67344931eb09c9e18f6d4818b02c5b31d20f6f371658fc13cef  CVE-2015-1335.patch
f32b5c76a68f46b14e7525d577b6a0c45064b3594e6aaa86be5da60fc37825011432491f0b6bc8de32e9b162c13314c7f4f7246c9a79cb95e605114acee80bb0  fix-multislash.patch"
