# Contributor: William Pitcock <nenolod@dereferenced.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=lxc
pkgver=1.0.6
_mypkgver=${pkgver/_rc/.rc}
pkgrel=3
pkgdesc="linux containers - tools"
url="http://lxc.sourceforge.net/"
arch="all"
license="GPL"
depends="bash"
depends_dev="libcap-dev"
makedepends="$depends_dev lvm2 util-linux automake autoconf libtool lua5.2-dev"
install=""
options="suid"
subpackages="$pkgname-dev $pkgname-doc $pkgname-lvm lua5.2-lxc:_lua52
	$pkgname-templates $pkgname-libs"
source="https://github.com/lxc/lxc/archive/lxc-$_mypkgver.tar.gz
	version.patch
	lxc.initd

	0001-Support-openvswitch-bridges.patch
	0002-fix-typo.patch
	0003-Update-the-openvswitch-bridge-attach-code.patch

	0001-lxc-alpine-make-sure-dev-shm-is-world-writeable.patch
	0002-lxc-alpine-create-a-default-tty-for-console.patch
	"

_builddir="${srcdir}/lxc-lxc-${_mypkgver}"
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	./autogen.sh
}

build() {
	cd "$_builddir"
	LUA_VERSION=5.2 \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-apparmor \
		--enable-lua \
		--with-lua-pc=lua5.2 \
		--with-distro=alpine \
		|| return 1
	make VERSION=$pkgver || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -d "$pkgdir"/var/lib/lxc
	install -Dm755 "$srcdir"/lxc.initd "$pkgdir"/etc/init.d/lxc
}

lvm() {
	pkgdesc="linux containers lvm support"
	depends="lvm2 util-linux lxc"
	arch="noarch"
	mkdir "$subpkgdir"
}

_lua52() {
	pkgdesc="Lua 5.2 module for LXC"
	for i in lib share; do
		mkdir -p "$subpkgdir"/usr/$i || return 1
		mv "$pkgdir"/usr/$i/lua "$subpkgdir"/usr/$i/ || return 1
	done
}

templates() {
	pkgdesc="Templates for LXC"
	arch="noarch"
	mkdir -p "$subpkgdir"/usr/share/lxc
	mv "$pkgdir"/usr/share/lxc/templates "$subpkgdir"/usr/share/lxc/
}

dev() {
	default_dev
	#fix abuild smartness
	mv "$subpkgdir"/usr/bin/lxc-config \
		"$pkgdir"/usr/bin/ || return 1
}

md5sums="3949cd916a120f40c2355c9a5b65cd51  lxc-1.0.6.tar.gz
79e90616b5049a472ccdcb5b1dcdd8b1  version.patch
2c21cb054c7f373318e373cfa9e4f78c  lxc.initd
0800600ea0e9a0a4eab5822e8f14d6a2  0001-Support-openvswitch-bridges.patch
82f16afb2cec1dfca66e4057daf02694  0002-fix-typo.patch
fc502befeee596d5a1cf78d4f294a3e9  0003-Update-the-openvswitch-bridge-attach-code.patch
b0bf2ec6a49bd7d5a9db107c0d6bf925  0001-lxc-alpine-make-sure-dev-shm-is-world-writeable.patch
b0eeceaa8a13df9d37f0739961320c25  0002-lxc-alpine-create-a-default-tty-for-console.patch"
sha256sums="2aea199a89e2cd946f93406af6c3f62844f36954b79a6991b36d2c33022cb11c  lxc-1.0.6.tar.gz
b6d85fb23940d2511b3951de56b2532843c0e03ec1613548366361cc0c1a46b9  version.patch
97606cf912818f7ba099d72cb42b25fee44789c1bfd67f1c0150253e86dc6979  lxc.initd
a415aa17655788a49627eb2e06fd06b3f73dfea283a9c67c9bf7029430fcca88  0001-Support-openvswitch-bridges.patch
e6502aa038b18dc4dff7eea6d916215babb8ce775d7c79b2fb7669edcc23ea97  0002-fix-typo.patch
3a63dda403a2fab04fa5d2c9e7762efdcb911cbd913399b8226abdec6643fec9  0003-Update-the-openvswitch-bridge-attach-code.patch
b699d220332a1a004cd7305eed8700f80fc86160299fdbbaa234f6b545a17217  0001-lxc-alpine-make-sure-dev-shm-is-world-writeable.patch
33fb2866dbfc1aabedee65fe2b5f3e8ebce1d081a1ea5d8734a43793308f40c6  0002-lxc-alpine-create-a-default-tty-for-console.patch"
sha512sums="fe85ccb57865d86704df6b4b79d60f31892785b07dc9dd2580cc6c384c89c29c23516e906b7a16bc03c6582c1fb2432bb8ff11bd17c09efa8f6a035fb41f46b1  lxc-1.0.6.tar.gz
e2ffcbf55447291a8434a4f37255c3a6a119bc4116c75d205006aa2b070bf6be28535cf6107bead14bbf64bf9fa415346ab544bd1c15e1add7d1c6380e6b2def  version.patch
bcf73032f2c7d17d457bcd5405071a869dcdeef36ef6b9bf5e13f21d5b4c5e1548a09114dd032863ba91358b74b2a72598bf01e53520185492593c2f4db15ffc  lxc.initd
636dc009496f8648ba10aec6b590c2d1f5db17bf76161fec2b38a7a994198d2ac9c1af7e342f4d3e695d53951b5309447f20155fb79e00489a2f5c0513d08d89  0001-Support-openvswitch-bridges.patch
dc5f5f230df91ea951e231aaedebab8217bcf6a676e2da88f4db3e0b36cdd922fb888c0f6a0eb34d5065add9c002b080c9ac687f9cd16875bd18d4f120f56d6e  0002-fix-typo.patch
c7089b58dc7c4d2fc8cb245c7eb43930bd9e821e136e5461c3f79af063c640076c07d92afd5675cc57bb832e85690d917b87b337d075505a65e154efa7c45bc0  0003-Update-the-openvswitch-bridge-attach-code.patch
fc86573f0b557cd7cb0fc99395d81ed0c78c22298bd36fe5a5581c428b80e7bd242fd5578abb576fb72c37e1cb9aac0e8f7611243d6bc92504d95c662e653eee  0001-lxc-alpine-make-sure-dev-shm-is-world-writeable.patch
f645fa99b4706a45a05005f18a4fad6dbb8568f831cc9780d6b3c49fc045296309e649d754e69b72be2a55af584dd12560b449720e18f9f1627d8eb0e94a01f4  0002-lxc-alpine-create-a-default-tty-for-console.patch"
