# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=git
pkgver=2.4.1
pkgrel=1
pkgdesc="A distributed version control system"
url="http://git.or.cz/"
arch="all"
license="GPL2+"
depends=
replaces="git-perl"

# note that order matters
subpackages="$pkgname-doc
	$pkgname-bash-completion:completion
	perl-$pkgname-svn:_perl_git_svn
	perl-$pkgname:_perl_git
	$pkgname-svn
	$pkgname-email
	$pkgname-cvs
	$pkgname-p4
	$pkgname-daemon
	$pkgname-gitweb
	$pkgname-subtree
	$pkgname-subtree-doc:subtree_doc
	$pkgname-perl:_git_perl
	"

makedepends="zlib-dev openssl-dev curl-dev expat-dev perl-dev python-dev
	pcre-dev asciidoc xmlto perl-error"
source="git-$pkgver.tar.gz::https://github.com/git/git/archive/v$pkgver.tar.gz
	bb-tar.patch
	git-daemon.initd
	git-daemon.confd

	transport-add-protocol-whitelist-env-var.patch
	submodule-allow-only-certain-protocols-for-submodule-fetches.patch
	transport-refactor-protocol-whitelist-code.patch
	http-limit-redirection-to-protocol-whitelist.patch
	http-limit-redirection-depth.patch
	"

_makeopts="
	NO_GETTEXT=YesPlease
	NO_NSEC=YesPlease
	NO_TCLTK=YesPlease
	NO_SVN_TESTS=YesPlease
	USE_LIBPCRE=1"

_gitcoredir=/usr/libexec/git-core

prepare() {
	cd "$srcdir"/$pkgname-$pkgver
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$srcdir"/$pkgname-$pkgver
	make prefix=/usr DESTDIR="$pkgdir" $_makeopts || return 1
}

package() {
	cd "$srcdir"/$pkgname-$pkgver
	make prefix=/usr \
		DESTDIR="$pkgdir" \
		INSTALLDIRS=vendor \
		$_makeopts install || return 1
	mkdir -p "$pkgdir"/var/git
	install -Dm755 "$srcdir"/git-daemon.initd \
		"$pkgdir"/etc/init.d/git-daemon || return 1
	install -Dm644 "$srcdir"/git-daemon.confd \
		"$pkgdir"/etc/conf.d/git-daemon || return 1

	make prefix=/usr DESTDIR="$pkgdir" install-man || return 1
}

_perl_git_svn() {
	pkgdesc="Perl interface to Git::SVN"
	depends="git=$pkgver-r$pkgrel"
	replaces="git-perl"
	eval local `perl -V:vendorlib`
	mkdir -p "$subpkgdir"/$vendorlib/Git
	mv "$pkgdir"/$vendorlib/Git/SVN* "$subpkgdir"/$vendorlib/Git/
}

_perl_git() {
	pkgdesc="Perl interface to Git"
	depends="git=$pkgver-r$pkgrel perl-error"
	replaces="git-perl"
	eval local `perl -V:vendorlib`
	eval local `perl -V:vendorarch`
	for i in $vendorlib $vendorarch; do
		mkdir -p "$subpkgdir"/${i%/*} || return 1
		mv "$pkgdir"/$i "$subpkgdir"/$i || return 1
	done
}

email() {
	depends="perl perl-git=$pkgver-r$pkgrel perl-net-smtp-ssl
		perl-authen-sasl"
	pkgdesc="Git tools for sending email"
	replaces="git"
	mkdir -p "$subpkgdir"/$_gitcoredir
	mv "$pkgdir"/$_gitcoredir/*email* "$subpkgdir"/$_gitcoredir
}


svn() {
        depends="perl perl-git-svn=$pkgver-r$pkgrel perl-subversion
		perl-term-readkey"
        pkgdesc="Subversion support for git"
        arch="noarch"
        replaces=""

        mkdir -p "$subpkgdir"/$_gitcoredir
        mv "$pkgdir"/$_gitcoredir/git-svn "$subpkgdir"/$_gitcoredir/
}

cvs() {
	pkgdesc="Git tools for importing CVS repositories"
	depends="perl perl-git=$pkgver-r$pkgrel cvs perl-dbd-sqlite"
	replaces="git-perl"
	mkdir -p "$subpkgdir"/usr/bin "$subpkgdir"/$_gitcoredir
	mv "$pkgdir"/usr/bin/git-cvs* "$subpkgdir"/usr/bin/ || return 1
	mv "$pkgdir"/$_gitcoredir/*cvs* "$subpkgdir"/$_gitcoredir \
		|| return 1
}

p4() {
	pkgdesc="Git tools for working with Perforce depots"
	depends="git=$pkgver-r$pkgrel"
	replaces="git"
	mkdir -p "$subpkgdir"/$_gitcoredir/mergetools
	mv "$pkgdir"/$_gitcoredir/*p4* "$subpkgdir"/$_gitcoredir/ || return 1
	mv "$pkgdir"/$_gitcoredir/mergetools/*p4* \
		"$subpkgdir"/$_gitcoredir/mergetools/ || return 1
}

daemon() {
	pkgdesc="Git protocol daemon"
	depends="git=$pkgver-r$pkgrel"
        replaces="git"
	mkdir -p "$subpkgdir"/$_gitcoredir
	mv "$pkgdir"/$_gitcoredir/git-daemon "$subpkgdir"/$_gitcoredir \
		|| return 1
	mv "$pkgdir"/etc "$subpkgdir"/ || return 1
}

gitweb() {
	pkgdesc="Simple web interface to git repositories"
	depends="git=$pkgver-r$pkgrel perl"
	replaces="git"
	mkdir -p "$subpkgdir"/usr/share
	mv "$pkgdir"/usr/share/gitweb "$subpkgdir"/usr/share/
}

completion() {
	depends=""
	pkgdesc="Bash completion script for git"
	arch="noarch"
	replaces=""

	install -Dm644 "$srcdir"/git-$pkgver/contrib/completion/git-completion.bash \
		"$subpkgdir"/usr/share/bash-completion/completions/git
}

subtree() {
	depends="git=$pkgver-r$pkgrel"
	pkgdesc="Split git repository into subtrees"
	arch="noarch"
	replaces=""

	cd "$srcdir"/$pkgname-$pkgver/contrib/subtree
	make prefix=/usr DESTDIR="$pkgdir" || return 1
	make install prefix=/usr DESTDIR="$subpkgdir"
}

subtree_doc() {
	depends=""
	pkgdesc="Split git repository into subtrees (documentation)"
	arch="noarch"
	replaces=""

	cd "$srcdir"/$pkgname-$pkgver/contrib/subtree
	make install-man prefix=/usr DESTDIR="$subpkgdir"
}

# catch-the-rest of stuff that needs perl
_git_perl() {
	depends="git=$pkgver-r$pkgrel perl-git=$pkgver-r$pkgrel perl"
	pkgdesc="Additional Git commands that requires perl"
	arch="noarch"
	replaces=""

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/perl* "$subpkgdir"/usr/lib/
	cd "$pkgdir"
	find -type f | xargs file --mime-type | grep perl | cut -d: -f1| while read f; do
		mkdir -p "$subpkgdir"/${f%/*}
		mv "$f" "$subpkgdir"/${f%/*}
	done
	find "$subpkgdir" -name perllocal.pod -delete
}


md5sums="14f0f4f1f904a97b09506ef7b7e60cc8  git-2.4.1.tar.gz
e63a201556c4f089de790805c09a2e5b  bb-tar.patch
75b9d8f33fbec38a8e0e06baf5165b19  git-daemon.initd
2258e95d389ccc6de0b5111d53d9eed6  git-daemon.confd
10390d958548a9bf8291fde68df73f6f  transport-add-protocol-whitelist-env-var.patch
89b2fea6eb092beebc986874a90f7794  submodule-allow-only-certain-protocols-for-submodule-fetches.patch
9d47666f2b8ea580661421c38b154bda  transport-refactor-protocol-whitelist-code.patch
3cfe1fa926109de1ad99880d98380355  http-limit-redirection-to-protocol-whitelist.patch
4f80de546d40e04d3e05d6556609a11a  http-limit-redirection-depth.patch"
sha256sums="a41e45202363be7b3e6d88688d27a08a6be200ed096da113ba603c51651911d2  git-2.4.1.tar.gz
cb6319f47d81605e199771350154cbed0a6e85ef9042a689f2b405c64039f49c  bb-tar.patch
7918837f77b4cebce70b600b2f6da00e4c0df6b946f4ff5671c797c37b2ffc4f  git-daemon.initd
aaa80bd059db549dadf4c4e27a9aa41a4b5def844f8e563c493bc8513dcd981e  git-daemon.confd
ab15c0fdfe6ff3ab990b68e65ebb4beeaddd46cf52b78ed794b0fa659ff576af  transport-add-protocol-whitelist-env-var.patch
8d3e21cec854d275e8cd6a3d9697411c01a224e818f365864fdc9e123e79c060  submodule-allow-only-certain-protocols-for-submodule-fetches.patch
94b5421675dc023191526284372c3a08db0561366324d2ac8e9ec7c7042eeac9  transport-refactor-protocol-whitelist-code.patch
408ddfa018cb98c71252cfe80b6e1f3c89f8d60082c8cddc160226b84494672a  http-limit-redirection-to-protocol-whitelist.patch
d67b5e2e8e5fc2e74644e64753237f8ec9aa1620d911bdf0dc5a2c28e2d21733  http-limit-redirection-depth.patch"
sha512sums="6cd12f21193a051f6f4a0ef4aea54e84e72c340c117a773f097167093fde718ce45c6c32a91b601178a18a836214481976a18d7f3081679cb57247df9fdc6bf2  git-2.4.1.tar.gz
6fa088a753c2a697e8dbef2032ed63e8c2a0553a41cff2fcff893c2f35c51d2c697054cc921c23ee606f77b93d0f340df85220b15e1c470bd352f7fba3986cd0  bb-tar.patch
1e707250d133d56100f0311e7c2610920d6d81809c425ebf3e6acb4a289b958707a90dc38e1c17720da6dc2758dd84bf957fe6aed3854eacea79226eb616e885  git-daemon.initd
9640f8078d68ed2678e5249da3f946fc21f50e858b94127a4221de73c6132101afcd46bc1fe33861e9a7f731c0dc9591915b8ebf376b8e690cd7135703966509  git-daemon.confd
7ef30c73d747eff3b8159d9c7b5b65e722e48cf56a63fb2abcab99c89047a012a0291a45202dfbe54a260b0fd6be76b33df299ff1171a6bd0ba26cff66dbfc22  transport-add-protocol-whitelist-env-var.patch
4af8c72fbdaf422a976af492e357ff12cfc6762d1e94290317d89725c66b32fdd9aeb1134eca697490e06e8c718c6d68a8bc16ea65405085af253680218592f2  submodule-allow-only-certain-protocols-for-submodule-fetches.patch
88fb2412790fd1317da21c4eb684139e7010def355eda05d4939c153c1e15a3ad7f0413c629e907b3a667d700084fdd39b03213515be0ec8fb94e53548a5bba6  transport-refactor-protocol-whitelist-code.patch
747b48a49e62b5a91ad6cbb6e4d845628eb3781e6ba05b3c402e4ba75f0f93f4fe2db23b3879706035172424b9c66ec950cdd732758b06e194634734b621d8ef  http-limit-redirection-to-protocol-whitelist.patch
c223b6d1d4a1cd1e97cc5ad2ae0c312525d5432904a77c7d207c11b12df8a9603a047d0731cf33b18fdb67165ec816477b77aafa09261e2cd7b83cd954e39163  http-limit-redirection-depth.patch"
