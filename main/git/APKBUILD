# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=git
pkgver=1.8.4.1
pkgrel=0
pkgdesc="A distributed version control system"
url="http://git.or.cz/"
arch="all"
license="GPL2+"
depends=
replaces="git-perl"
subpackages="$pkgname-doc $pkgname-svn $pkgname-perl"
makedepends="zlib-dev openssl-dev curl-dev expat-dev perl-dev python-dev
	pcre-dev"
source="http://git-core.googlecode.com/files/git-$pkgver.tar.gz
	0001-config-add-_cb-suffix-to-callback-functions.patch
	bb-tar.patch
	git-daemon.initd
	git-daemon.confd
	"

_makeopts="NO_ICONV=YesPlease
	NO_GETTEXT=YesPlease
	NO_NSEC=YesPlease
	NO_TCLTK=YesPlease
	NO_SVN_TESTS=YesPlease
	USE_LIBPCRE=1"

prepare() {
	cd "$srcdir"/$pkgname-$pkgver
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$srcdir"/$pkgname-$pkgver
	make prefix=/usr DESTDIR="$pkgdir" $_makeopts || return 1
}

package() {
	cd "$srcdir"/$pkgname-$pkgver
	make prefix=/usr DESTDIR="$pkgdir" $_makeopts install || return 1
	mkdir -p "$pkgdir"/var/git
	install -Dm755 "$srcdir"/git-daemon.initd \
		"$pkgdir"/etc/init.d/git-daemon || return 1
	install -Dm644 "$srcdir"/git-daemon.confd \
		"$pkgdir"/etc/conf.d/git-daemon || return 1
}

perl() {
	depends="perl git perl-net-smtp-ssl perl-authen-sasl"
	pkgdesc="Perl scripts for git"
	arch="noarch"
	replaces=""

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/perl* "$subpkgdir"/usr/lib/
	cd "$pkgdir"
	find -type f | xargs file --mime-type | grep perl | cut -d: -f1| while read f; do
		mkdir -p "$subpkgdir"/${f%/*}
		mv "$f" "$subpkgdir"/${f%/*}
	done
	find "$subpkgdir" -name perllocal.pod -delete
}

svn() {
        depends="perl git git-perl>=1.7.8.4-r1 perl-subversion"
        pkgdesc="Subversion support for git"
        arch="noarch"
        replaces=""

        mkdir -p "$subpkgdir"/usr/libexec/git-core
        mv "$pkgdir"/usr/libexec/git-core/git-svn "$subpkgdir"/usr/libexec/git-core
}

md5sums="5d8c89ad312ca0b0e603259c9357e6b8  git-1.8.4.1.tar.gz
afe28707d4055f9f0a2bf2b642c99baf  0001-config-add-_cb-suffix-to-callback-functions.patch
e63a201556c4f089de790805c09a2e5b  bb-tar.patch
c92d9339a131e708cc65e1cac1e2520a  git-daemon.initd
2258e95d389ccc6de0b5111d53d9eed6  git-daemon.confd"
sha256sums="f05c513a4a1d9d1ca1182ff43cfbccc1e8da0120f781aca415a5e3e1132451d3  git-1.8.4.1.tar.gz
aa59ccb15eb88568a021e7739f49bad5468543509552be687a3ec9cd1e3dad5a  0001-config-add-_cb-suffix-to-callback-functions.patch
cb6319f47d81605e199771350154cbed0a6e85ef9042a689f2b405c64039f49c  bb-tar.patch
02eb703e3638275104e12c8057f16b9a858ac5c8dc56d2e9ca68d7d3250a1917  git-daemon.initd
aaa80bd059db549dadf4c4e27a9aa41a4b5def844f8e563c493bc8513dcd981e  git-daemon.confd"
sha512sums="2e8d98fc8f91a46e37b46cb10ffd4f623ee30e3607fda64e382664b78d11257716cc5aed54777d1ec64b96c40eb9e0ae3b968e06bec07b3a3315b60ad314a680  git-1.8.4.1.tar.gz
29805415e7bd4e3a64805bcd2d0a8cf6824e81445636c82aee35cbfd645bb28b7673f429cec1b4cdad7051be4d77df6174bf0e04122af0e306056521959ddfb5  0001-config-add-_cb-suffix-to-callback-functions.patch
6fa088a753c2a697e8dbef2032ed63e8c2a0553a41cff2fcff893c2f35c51d2c697054cc921c23ee606f77b93d0f340df85220b15e1c470bd352f7fba3986cd0  bb-tar.patch
6321ea464f0c1d6245a0722e02ff3dc29996e41fb8d9f3c747bfdd914dc1284e6eb62a7d6057e4f99c0c8a23c3e57f9ff76f2cf18d19272f3cc599877f999c41  git-daemon.initd
9640f8078d68ed2678e5249da3f946fc21f50e858b94127a4221de73c6132101afcd46bc1fe33861e9a7f731c0dc9591915b8ebf376b8e690cd7135703966509  git-daemon.confd"
