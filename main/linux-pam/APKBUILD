# Contributor: William Pitcock <nenolod@dereferenced.org>
# Maintainer: William Pitcock <nenolod@dereferenced.org>
pkgname=linux-pam
pkgver=1.1.6
pkgrel=0
pkgdesc="pluggable authentication modules for linux"
url="http://www.kernel.org/pub/linux/libs/pam"
arch="all"
license="BSD"
depends=
depends_dev="gettext-dev"
makedepends="$depends_dev bison flex autoconf automake libtool"
install=""
subpackages="$pkgname-dev $pkgname-doc"
source="https://fedorahosted.org/releases/l/i/linux-pam/Linux-PAM-$pkgver.tar.bz2
	linux-pam-innetgr.patch
	base-auth.pamd
	base-account.pamd
	base-password.pamd
	base-session.pamd
	base-session-noninteractive.pamd
	other.pamd
	libpam-fix-build-with-eglibc-2.16.patch
	linux-pam-1.1.6-destdir.patch"

_builddir="$srcdir"/Linux-PAM-$pkgver
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	autoreconf -vif || return 1
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--libdir=/lib \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--disable-nls \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1

	# do not install pam.d files bundled with the source, they could be broken
	rm -rf "$pkgdir"/etc/pam.d

	# install our pam.d files
	mkdir "$pkgdir"/etc/pam.d
	for i in $source; do
		case $i in
		*.pamd)
			basename=$(echo $i | cut -d. -f1)
			cp "$srcdir"/$i "$pkgdir"/etc/pam.d/"$basename"
			;;
		esac
	done

	# delete pointless libtool archives.
	find "$pkgdir" -name *.la -print | xargs rm
}

md5sums="7b73e58b7ce79ffa321d408de06db2c4  Linux-PAM-1.1.6.tar.bz2
c309401e103cc86e8b25557ff3eb0b53  linux-pam-innetgr.patch
aa5bb7c9d8e4687aea1ae69b7447254a  base-auth.pamd
fafcf29cb9bab788cb4933106be31883  base-account.pamd
117535e4938f478efced1398b408cf96  base-password.pamd
baec6808544bf6cebc59e07467f8c213  base-session.pamd
afbdd8eb4db5c31dfd8e8da35c698b90  base-session-noninteractive.pamd
b8e839ece64df173f16d28520eb8d66c  other.pamd
23320dadf8e36846b6bbd7903f95ece5  libpam-fix-build-with-eglibc-2.16.patch
cc3bb10c851bb925708cc8b74967e3b7  linux-pam-1.1.6-destdir.patch"
